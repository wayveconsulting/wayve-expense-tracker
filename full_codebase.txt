

--- FILE: ./vercel.json ---

{
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        { "key": "X-Frame-Options", "value": "DENY" },
        { "key": "X-Content-Type-Options", "value": "nosniff" },
        { "key": "Referrer-Policy", "value": "strict-origin-when-cross-origin" },
        { "key": "Permissions-Policy", "value": "camera=(), microphone=(), geolocation=()" }
      ]
    }
  ],
  "rewrites": [
    {
      "source": "/api/(.*)",
      "destination": "/api/$1"
    },
    {
      "source": "/((?!api/).*)",
      "destination": "/index.html"
    }
  ]
}


--- FILE: ./index.html ---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wayve Expense Tracker</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>

--- FILE: ./package.json ---

{
  "name": "app",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "@neondatabase/serverless": "^1.0.2",
    "@vercel/blob": "^2.2.0",
    "drizzle-orm": "^0.45.1",
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "recharts": "^3.6.0",
    "resend": "^6.9.2",
    "wouter": "^3.9.0",
    "xlsx": "^0.18.5"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@types/google.maps": "^3.58.1",
    "@types/node": "^24.10.1",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@vercel/node": "^5.5.16",
    "@vitejs/plugin-react": "^5.1.1",
    "dotenv": "^17.2.3",
    "drizzle-kit": "^0.31.8",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "globals": "^16.5.0",
    "typescript": "~5.9.3",
    "typescript-eslint": "^8.46.4",
    "vite": "^7.2.4"
  }
}


--- FILE: ./tsconfig.node.json ---

{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2023",
    "lib": ["ES2023"],
    "module": "ESNext",
    "types": ["node"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["vite.config.ts"]
}


--- FILE: ./vite.config.ts ---

import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// https://vite.dev/config/
export default defineConfig({
  plugins: [react()],
  build: {
    sourcemap: false,
  },
})


--- FILE: ./public/manifest.json ---

{
  "name": "Wayve Expense Tracker",
  "short_name": "Expenses",
  "description": "Expense tracking for small businesses",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#2A9D8F",
  "icons": [
    {
      "src": "/favicon.ico",
      "sizes": "32x32",
      "type": "image/x-icon"
    },
    {
      "src": "/icon-192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "/icon-512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}

--- FILE: ./api/admin/invites/[id].ts ---

import type { VercelRequest, VercelResponse } from '@vercel/node';
import { db } from '../../../src/db/index.js';
import { users, sessions, tenants, invites } from '../../../src/db/schema.js';
import { eq } from 'drizzle-orm';
import crypto from 'crypto';
import { Resend } from 'resend';
import { escapeHtml } from '../../_lib/utils.js';

const resend = new Resend(process.env.RESEND_API_KEY);

export default async function handler(req: VercelRequest, res: VercelResponse) {
  res.setHeader('Cache-Control', 'no-store');

  if (req.method !== 'PUT') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  // Auth check — super admin only
  const cookies = req.headers.cookie || '';
  const sessionToken = cookies.split(';').map(c => c.trim()).find(c => c.startsWith('session='))?.split('=')[1];

  if (!sessionToken) return res.status(401).json({ error: 'Not authenticated' });

  const [session] = await db
    .select()
    .from(sessions)
    .where(eq(sessions.token, sessionToken))
    .limit(1);

  if (!session || new Date(session.expiresAt) < new Date()) {
    return res.status(401).json({ error: 'Session expired' });
  }

  const [user] = await db
    .select()
    .from(users)
    .where(eq(users.id, session.userId))
    .limit(1);

  if (!user || !user.isSuperAdmin) {
    return res.status(403).json({ error: 'Forbidden' });
  }

  // Get invite ID from URL
  const { id } = req.query;
  if (!id || typeof id !== 'string') {
    return res.status(400).json({ error: 'Missing invite ID' });
  }

  try {
    // Look up the invite
    const [invite] = await db
      .select()
      .from(invites)
      .where(eq(invites.id, id))
      .limit(1);

    if (!invite) {
      return res.status(404).json({ error: 'Invite not found' });
    }

    if (invite.status === 'accepted') {
      return res.status(400).json({ error: 'Invite already accepted — cannot resend' });
    }

    // Generate new token and reset expiry
    const newToken = crypto.randomBytes(32).toString('hex');
    const newExpiresAt = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000); // 30 days

    await db
      .update(invites)
      .set({
        token: newToken,
        status: 'pending',
        expiresAt: newExpiresAt,
        updatedAt: new Date(),
      })
      .where(eq(invites.id, id));

    // Get tenant name for the email
    const [tenant] = await db
      .select({ name: tenants.name })
      .from(tenants)
      .where(eq(tenants.id, invite.tenantId))
      .limit(1);

    const businessName = tenant?.name || 'your business';

    // Send email
    const inviteUrl = `https://wayveexpenses.app/invite?token=${newToken}`;
    const expiryDate = newExpiresAt.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    });

    try {
      await resend.emails.send({
        from: 'Wayve Expense Tracker <noreply@wayveconsulting.app>',
        to: invite.email,
        subject: `You've been invited to Wayve Expense Tracker`,
        text: `You've been invited to manage expenses for ${businessName} on Wayve Expense Tracker.\n\nGet started by visiting: ${inviteUrl}\n\nYou'll sign in with your Google account — no new password needed.\n\nThis invite expires on ${expiryDate}. If you have any questions, contact your administrator.\n\nWayve Consulting — Expense Tracking Made Simple`,
        html: `
          <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto; padding: 40px 20px;">
            <div style="text-align: center; margin-bottom: 32px;">
              <h1 style="color: #2A9D8F; margin: 0; font-size: 24px;">Wayve Expense Tracker</h1>
            </div>
            
            <p style="font-size: 16px; color: #333; line-height: 1.6;">
              You've been invited to manage expenses for <strong>${escapeHtml(businessName)}</strong>.
            </p>
            
            <p style="font-size: 16px; color: #333; line-height: 1.6;">
              Click the button below to set up your account. You'll sign in with your Google account — no new password needed.
            </p>
            
            <div style="text-align: center; margin: 32px 0;">
              <a href="${inviteUrl}" 
                 style="background: #2A9D8F; color: white; padding: 14px 32px; border-radius: 8px; text-decoration: none; font-size: 16px; font-weight: 600; display: inline-block;">
                Get Started
              </a>
            </div>
            
            <p style="font-size: 14px; color: #666; line-height: 1.6;">
              This invite expires on ${expiryDate}. If you have any questions, contact your administrator.
            </p>
            
            <hr style="border: none; border-top: 1px solid #eee; margin: 32px 0;" />
            
            <p style="font-size: 12px; color: #999; text-align: center;">
              Wayve Consulting &middot; Expense Tracking Made Simple
            </p>
          </div>
        `,
      });
    } catch (emailErr) {
      console.error('Failed to resend invite email:', emailErr);
    }

    return res.status(200).json({ success: true });

  } catch (err) {
    console.error('Error resending invite:', err);
    return res.status(500).json({ error: 'Failed to resend invite' });
  }
}

--- FILE: ./api/admin/invites/index.ts ---

import type { VercelRequest, VercelResponse } from '@vercel/node';
import { db } from '../../../src/db/index.js';
import { users, sessions, tenants, categories, invites } from '../../../src/db/schema.js';
import { eq, and, desc } from 'drizzle-orm';
import crypto from 'crypto';
import { Resend } from 'resend';
import { DEFAULT_CATEGORIES, UNCATEGORIZED_CATEGORY } from '../../../src/db/default-categories.js';
import { escapeHtml } from '../../_lib/utils.js';

const resend = new Resend(process.env.RESEND_API_KEY);

// Helper: authenticate and verify super admin
async function authenticateSuperAdmin(req: VercelRequest): Promise<{ user: typeof users.$inferSelect } | null> {
  const cookies = req.headers.cookie || '';
  const sessionToken = cookies.split(';').map(c => c.trim()).find(c => c.startsWith('session='))?.split('=')[1];

  if (!sessionToken) return null;

  const [session] = await db
    .select()
    .from(sessions)
    .where(eq(sessions.token, sessionToken))
    .limit(1);

  if (!session || new Date(session.expiresAt) < new Date()) return null;

  const [user] = await db
    .select()
    .from(users)
    .where(eq(users.id, session.userId))
    .limit(1);

  if (!user || !user.isSuperAdmin) return null;

  return { user };
}

export default async function handler(req: VercelRequest, res: VercelResponse) {
  res.setHeader('Cache-Control', 'no-store');

  if (req.method === 'GET') {
    return handleGet(req, res);
  } else if (req.method === 'POST') {
    return handlePost(req, res);
  } else {
    return res.status(405).json({ error: 'Method not allowed' });
  }
}

// ============================================
// GET — List all invites
// ============================================
async function handleGet(req: VercelRequest, res: VercelResponse) {
  const auth = await authenticateSuperAdmin(req);
  if (!auth) return res.status(403).json({ error: 'Forbidden' });

  try {
    const allInvites = await db
      .select({
        id: invites.id,
        email: invites.email,
        firstName: invites.firstName,
        lastName: invites.lastName,
        role: invites.role,
        status: invites.status,
        expiresAt: invites.expiresAt,
        acceptedAt: invites.acceptedAt,
        createdAt: invites.createdAt,
        tenantName: tenants.name,
        tenantSubdomain: tenants.subdomain,
        invitedByFirstName: users.firstName,
        invitedByLastName: users.lastName,
        invitedByEmail: users.email,
      })
      .from(invites)
      .innerJoin(tenants, eq(invites.tenantId, tenants.id))
      .innerJoin(users, eq(invites.invitedBy, users.id))
      .orderBy(desc(invites.createdAt));

    // Auto-expire: if pending and past expiry, mark as expired in response
    const now = new Date();
    const enriched = allInvites.map(invite => ({
      ...invite,
      status: invite.status === 'pending' && new Date(invite.expiresAt) < now
        ? 'expired'
        : invite.status,
    }));

    return res.status(200).json({ invites: enriched });
  } catch (err) {
    console.error('Error fetching invites:', err);
    return res.status(500).json({ error: 'Failed to fetch invites' });
  }
}

// ============================================
// POST — Create tenant + seed categories + invite + send email
// ============================================
async function handlePost(req: VercelRequest, res: VercelResponse) {
  const auth = await authenticateSuperAdmin(req);
  if (!auth) return res.status(403).json({ error: 'Forbidden' });

  const { email, firstName, lastName, businessName, subdomain } = req.body;

  // --- Validation ---
  if (!email || !businessName || !subdomain) {
    return res.status(400).json({ error: 'Email, business name, and subdomain are required' });
  }

  const cleanEmail = email.toLowerCase().trim();
  const cleanSubdomain = subdomain.toLowerCase().trim().replace(/[^a-z0-9]/g, '');

  if (!cleanEmail.includes('@')) {
    return res.status(400).json({ error: 'Invalid email address' });
  }

  if (cleanSubdomain.length < 3) {
    return res.status(400).json({ error: 'Subdomain must be at least 3 characters' });
  }

  if (cleanSubdomain.length > 30) {
    return res.status(400).json({ error: 'Subdomain must be 30 characters or fewer' });
  }

  // Check subdomain uniqueness
  const [existingTenant] = await db
    .select({ id: tenants.id })
    .from(tenants)
    .where(eq(tenants.subdomain, cleanSubdomain))
    .limit(1);

  if (existingTenant) {
    return res.status(409).json({ error: 'Subdomain already taken' });
  }

  // Check for duplicate pending invite
  const [existingInvite] = await db
    .select({ id: invites.id })
    .from(invites)
    .where(and(
      eq(invites.email, cleanEmail),
      eq(invites.status, 'pending'),
    ))
    .limit(1);

  if (existingInvite) {
    return res.status(409).json({ error: 'A pending invite already exists for this email' });
  }

  try {
    // --- 1. Create tenant ---
    const [newTenant] = await db
      .insert(tenants)
      .values({
        name: businessName.trim(),
        subdomain: cleanSubdomain,
        createdBy: auth.user.id,
      })
      .returning({ id: tenants.id });

    // --- 2. Seed default categories ---
    const categoryValues = [
      ...DEFAULT_CATEGORIES.map((cat, index) => ({
        tenantId: newTenant.id,
        name: cat.name,
        emoji: cat.emoji,
        expenseType: cat.expenseType,
        homeOfficeEligible: cat.homeOfficeEligible,
        isSystem: false,
        sortOrder: index + 1,
      })),
      {
        tenantId: newTenant.id,
        name: UNCATEGORIZED_CATEGORY.name,
        emoji: UNCATEGORIZED_CATEGORY.emoji,
        expenseType: UNCATEGORIZED_CATEGORY.expenseType,
        homeOfficeEligible: UNCATEGORIZED_CATEGORY.homeOfficeEligible,
        isSystem: true,
        sortOrder: 0,
      },
    ];

    await db.insert(categories).values(categoryValues);

    // --- 3. Create invite ---
    const token = crypto.randomBytes(32).toString('hex');
    const expiresAt = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000); // 30 days

    const [newInvite] = await db
      .insert(invites)
      .values({
        email: cleanEmail,
        firstName: firstName?.trim() || null,
        lastName: lastName?.trim() || null,
        tenantId: newTenant.id,
        role: 'owner',
        invitedBy: auth.user.id,
        token,
        status: 'pending',
        expiresAt,
      })
      .returning();

    // --- 4. Send invite email ---
    const inviteUrl = `https://wayveexpenses.app/invite?token=${token}`;
    const expiryDate = expiresAt.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    });

    try {
      await resend.emails.send({
        from: 'Wayve Expense Tracker <noreply@wayveconsulting.app>',
        to: cleanEmail,
        subject: `You've been invited to Wayve Expense Tracker`,
        text: `You've been invited to manage expenses for ${businessName.trim()} on Wayve Expense Tracker.\n\nGet started by visiting: ${inviteUrl}\n\nYou'll sign in with your Google account — no new password needed.\n\nThis invite expires on ${expiryDate}. If you have any questions, contact your administrator.\n\nWayve Consulting — Expense Tracking Made Simple`,
        html: `
          <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto; padding: 40px 20px;">
            <div style="text-align: center; margin-bottom: 32px;">
              <h1 style="color: #2A9D8F; margin: 0; font-size: 24px;">Wayve Expense Tracker</h1>
            </div>
            
            <p style="font-size: 16px; color: #333; line-height: 1.6;">
              You've been invited to manage expenses for <strong>${escapeHtml(businessName.trim())}</strong>.
            </p>
            
            <p style="font-size: 16px; color: #333; line-height: 1.6;">
              Click the button below to set up your account. You'll sign in with your Google account — no new password needed.
            </p>
            
            <div style="text-align: center; margin: 32px 0;">
              <a href="${inviteUrl}" 
                 style="background: #2A9D8F; color: white; padding: 14px 32px; border-radius: 8px; text-decoration: none; font-size: 16px; font-weight: 600; display: inline-block;">
                Get Started
              </a>
            </div>
            
            <p style="font-size: 14px; color: #666; line-height: 1.6;">
              This invite expires on ${expiryDate}. If you have any questions, contact your administrator.
            </p>
            
            <hr style="border: none; border-top: 1px solid #eee; margin: 32px 0;" />
            
            <p style="font-size: 12px; color: #999; text-align: center;">
              Wayve Consulting &middot; Expense Tracking Made Simple
            </p>
          </div>
        `,
      });
    } catch (emailErr) {
      // Log but don't fail — the invite is created, email can be resent
      console.error('Failed to send invite email:', emailErr);
    }

    return res.status(201).json({
      invite: newInvite,
      tenant: { id: newTenant.id, subdomain: cleanSubdomain },
      emailSent: true,
    });

  } catch (err) {
    console.error('Error creating invite:', err);
    return res.status(500).json({ error: 'Failed to create invite' });
  }
}

--- FILE: ./api/auth/google.ts ---

import type { VercelRequest, VercelResponse } from '@vercel/node';

export default async function handler(req: VercelRequest, res: VercelResponse) {
  if (req.method !== 'GET') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  const { redirect } = req.query;

  // Build state parameter (includes redirect URL, could add CSRF token later)
  const state = Buffer.from(JSON.stringify({
    redirectTo: typeof redirect === 'string' ? redirect : '/',
  })).toString('base64');

  // Determine the correct redirect URI based on environment
  const redirectUri = getRedirectUri(req);

  // Build Google OAuth URL
  const params = new URLSearchParams({
    client_id: process.env.GOOGLE_CLIENT_ID!,
    redirect_uri: redirectUri,
    response_type: 'code',
    scope: 'openid email profile',
    state,
    access_type: 'offline', // Gets refresh token (useful for future features)
    prompt: 'select_account', // Always show account picker
  });

  const googleAuthUrl = `https://accounts.google.com/o/oauth2/v2/auth?${params.toString()}`;

  res.setHeader('Cache-Control', 'no-store');
return res.redirect(googleAuthUrl);
}

function getRedirectUri(req: VercelRequest): string {
  const host = req.headers.host || 'localhost:5173';
  
  // For subdomains, OAuth callback goes to main domain
  if (host.includes('wayveexpenses.app')) {
    return 'https://wayveexpenses.app/api/auth/callback/google';
  }
  if (host.includes('vercel.app')) {
    // Use the specific Vercel deployment URL
    return `https://wayve-expense-tracker.vercel.app/api/auth/callback/google`;
  }
  
  // Local development
  return 'http://localhost:5173/api/auth/callback/google';
}

--- FILE: ./api/auth/callback/google.ts ---

import type { VercelRequest, VercelResponse } from '@vercel/node';
import { db } from '../../../src/db/index.js';
import { users, sessions, userTenantAccess, tenants, invites } from '../../../src/db/schema.js';
import { eq, and } from 'drizzle-orm';
import crypto from 'crypto';

interface GoogleTokenResponse {
  access_token: string;
  expires_in: number;
  token_type: string;
  scope: string;
  id_token?: string;
}

interface GoogleUserInfo {
  id: string;
  email: string;
  verified_email: boolean;
  name: string;
  given_name?: string;
  family_name?: string;
  picture?: string;
}

export default async function handler(req: VercelRequest, res: VercelResponse) {
  if (req.method !== 'GET') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  res.setHeader('Cache-Control', 'no-store');

  const { code, state, error } = req.query;

  // Handle OAuth errors
  if (error) {
    console.error('Google OAuth error:', error);
    return res.redirect(`/login?error=${encodeURIComponent(String(error))}`);
  }

  if (!code || typeof code !== 'string') {
    return res.redirect('/login?error=missing_code');
  }

  // Parse state to get redirect URL (and CSRF token in future)
  let redirectTo = '/';
  if (state && typeof state === 'string') {
    try {
      const stateData = JSON.parse(Buffer.from(state, 'base64').toString());
      redirectTo = stateData.redirectTo || '/';
    } catch {
      // Invalid state, use default redirect
    }
  }

  try {
    // Exchange code for tokens
    const tokenResponse = await fetch('https://oauth2.googleapis.com/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        code,
        client_id: process.env.GOOGLE_CLIENT_ID!,
        client_secret: process.env.GOOGLE_CLIENT_SECRET!,
        redirect_uri: getRedirectUri(req),
        grant_type: 'authorization_code',
      }),
    });

    if (!tokenResponse.ok) {
      const errorData = await tokenResponse.text();
      console.error('Token exchange failed:', errorData);
      return res.redirect('/login?error=token_exchange_failed');
    }

    const tokens: GoogleTokenResponse = await tokenResponse.json();

    // Get user info from Google
    const userInfoResponse = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
      headers: { Authorization: `Bearer ${tokens.access_token}` },
    });

    if (!userInfoResponse.ok) {
      console.error('Failed to get user info');
      return res.redirect('/login?error=user_info_failed');
    }

    const googleUser: GoogleUserInfo = await userInfoResponse.json();

    if (!googleUser.verified_email) {
      return res.redirect('/login?error=email_not_verified');
    }

    // Look up user by email
    const existingUsers = await db
      .select()
      .from(users)
      .where(eq(users.email, googleUser.email.toLowerCase()))
      .limit(1);

    let user = existingUsers[0];

    if (!user) {
      // User not found — check for pending invite
      const [pendingInvite] = await db
        .select()
        .from(invites)
        .where(and(
          eq(invites.email, googleUser.email.toLowerCase()),
          eq(invites.status, 'pending'),
        ))
        .limit(1);

      if (!pendingInvite) {
        console.log(`Login attempt from uninvited user (Google sub: ${googleUser.id})`);
        return res.redirect('/login?error=not_invited');
      }

      // Check if invite is expired
      if (new Date(pendingInvite.expiresAt) < new Date()) {
        console.log(`Expired invite used (Google sub: ${googleUser.id})`);
        return res.redirect('/login?error=invite_expired');
      }

      // Invite is valid — create the user
      const [newUser] = await db
        .insert(users)
        .values({
          email: googleUser.email.toLowerCase(),
          firstName: googleUser.given_name || pendingInvite.firstName || null,
          lastName: googleUser.family_name || pendingInvite.lastName || null,
          googleId: googleUser.id,
          tenantId: pendingInvite.tenantId,
          role: pendingInvite.role || 'owner',
          emailVerified: true,
          isSuperAdmin: false,
          isAccountant: false,
        })
        .returning();

      // Create tenant access record
      await db.insert(userTenantAccess).values({
        userId: newUser.id,
        tenantId: pendingInvite.tenantId,
        role: pendingInvite.role || 'owner',
      });

      // Mark invite as accepted
      await db
        .update(invites)
        .set({
          status: 'accepted',
          acceptedAt: new Date(),
          updatedAt: new Date(),
        })
        .where(eq(invites.id, pendingInvite.id));

      // Use the newly created user going forward
      user = newUser;
    }

    // Update user's Google ID if not set (first OAuth login)
    if (!user.googleId) {
      await db
        .update(users)
        .set({ 
          googleId: googleUser.id,
          updatedAt: new Date(),
        })
        .where(eq(users.id, user.id));
    } else if (user.googleId !== googleUser.id) {
      // Google ID mismatch - potential account takeover attempt
      console.error(`Google ID mismatch for user ${user.id}`);
      return res.redirect('/login?error=account_mismatch');
    }

    // Create session
    const sessionToken = crypto.randomBytes(32).toString('hex');
    const expiresAt = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000); // 30 days

    await db.insert(sessions).values({
      id: crypto.randomUUID(),
      userId: user.id,
      token: sessionToken,
      expiresAt,
      userAgent: req.headers['user-agent'] || null,
      ipAddress: (req.headers['x-forwarded-for'] as string)?.split(',')[0] || null,
    });

    // Set session cookie
    const isProduction = process.env.NODE_ENV === 'production';
    const cookieOptions = [
      `session=${sessionToken}`,
      'Path=/',
      'HttpOnly',
      'SameSite=Lax',
      `Max-Age=${30 * 24 * 60 * 60}`, // 30 days in seconds
      isProduction ? 'Secure' : '',
      isProduction ? `Domain=.wayveexpenses.app` : '',
    ].filter(Boolean).join('; ');

    res.setHeader('Set-Cookie', cookieOptions);

    // Determine where to redirect based on user type
    let finalRedirect = redirectTo;
    
    // Look up tenant access for ALL user types (including super admins)
    const tenantAccessRecords = await db
      .select({
        tenantId: userTenantAccess.tenantId,
        subdomain: tenants.subdomain,
      })
      .from(userTenantAccess)
      .innerJoin(tenants, eq(userTenantAccess.tenantId, tenants.id))
      .where(eq(userTenantAccess.userId, user.id));

    // Also check if user has a primary tenant (legacy/direct assignment)
    let allTenantAccess = [...tenantAccessRecords];
    
    if (user.tenantId) {
      const [primaryTenant] = await db
        .select({ subdomain: tenants.subdomain })
        .from(tenants)
        .where(eq(tenants.id, user.tenantId))
        .limit(1);
      
      if (primaryTenant && !allTenantAccess.some(t => t.subdomain === primaryTenant.subdomain)) {
        allTenantAccess.push({ tenantId: user.tenantId, subdomain: primaryTenant.subdomain });
      }
    }

    if (user.isSuperAdmin) {
      if (allTenantAccess.length === 1) {
        // Super admin with one tenant — redirect to their business
        finalRedirect = `/?tenant=${allTenantAccess[0].subdomain}`;
      } else if (allTenantAccess.length > 1) {
        // Super admin with multiple tenants — TODO: tenant picker
        // For now, default to first tenant
        console.log(`Super admin ${user.id} has ${allTenantAccess.length} tenants, defaulting to first`);
        finalRedirect = `/?tenant=${allTenantAccess[0].subdomain}`;
      } else {
        // Pure super admin with no tenant — go to admin
        finalRedirect = '/admin';
      }
    } else if (user.isAccountant) {
      // TODO [MVP - Option B]: Build tenant picker page for accountants
      // For now, accountants go to dashboard and will need to select a tenant
      finalRedirect = '/dashboard';
    } else {
      // Regular user
      if (allTenantAccess.length === 0) {
        return res.redirect('/login?error=no_tenant_access');
      } else if (allTenantAccess.length === 1) {
        finalRedirect = `/?tenant=${allTenantAccess[0].subdomain}`;
      } else {
        // TODO [MVP - Option B]: Multiple tenants - show tenant picker
        console.log(`User ${user.id} has ${allTenantAccess.length} tenants, defaulting to first`);
        finalRedirect = `/?tenant=${allTenantAccess[0].subdomain}`;
      }
    }

    return res.redirect(finalRedirect);

  } catch (err) {
    console.error('OAuth callback error:', err);
    return res.redirect('/login?error=server_error');
  }
}

function getRedirectUri(req: VercelRequest): string {
  const host = req.headers.host || 'localhost:5173';
  const protocol = host.includes('localhost') ? 'http' : 'https';
  
  // For subdomains, we need to use the main domain for OAuth callback
  // Google OAuth redirect URI must match exactly what's configured
  if (host.includes('wayveexpenses.app')) {
    return 'https://wayveexpenses.app/api/auth/callback/google';
  }
  if (host.includes('vercel.app')) {
    return `https://${host}/api/auth/callback/google`;
  }
  
  return `${protocol}://${host}/api/auth/callback/google`;
}

--- FILE: ./api/auth/logout.ts ---

import type { VercelRequest, VercelResponse } from '@vercel/node';
import { db } from '../../src/db/index.js';
import { sessions } from '../../src/db/schema.js';
import { eq } from 'drizzle-orm';

export default async function handler(req: VercelRequest, res: VercelResponse) {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  res.setHeader('Cache-Control', 'no-store');

  // Parse session cookie
  const cookies = parseCookies(req.headers.cookie || '');
  const sessionToken = cookies.session;

  if (sessionToken) {
    try {
      // Delete the session from database
      await db
        .delete(sessions)
        .where(eq(sessions.token, sessionToken));
    } catch (err) {
      // Log but don't fail - we still want to clear the cookie
      console.error('Error deleting session:', err);
    }
  }

  // Clear the session cookie
  const isProduction = process.env.NODE_ENV === 'production';
  const cookieOptions = [
    'session=',
    'Path=/',
    'HttpOnly',
    'SameSite=Lax',
    'Max-Age=0', // Expire immediately
    isProduction ? 'Secure' : '',
    isProduction ? 'Domain=.wayveexpenses.app' : '',
  ].filter(Boolean).join('; ');

  res.setHeader('Set-Cookie', cookieOptions);

  // Support both API calls and direct browser navigation
  const acceptHeader = req.headers.accept || '';
  if (acceptHeader.includes('application/json')) {
    return res.status(200).json({ success: true });
  }

  // Redirect to login page for browser requests
  return res.redirect('/login');
}

function parseCookies(cookieHeader: string): Record<string, string> {
  const cookies: Record<string, string> = {};
  
  cookieHeader.split(';').forEach(cookie => {
    const [name, ...rest] = cookie.trim().split('=');
    if (name && rest.length > 0) {
      cookies[name] = rest.join('=');
    }
  });
  
  return cookies;
}

--- FILE: ./api/auth/me.ts ---

import type { VercelRequest, VercelResponse } from '@vercel/node';
import { db } from '../../src/db/index.js';
import { users, sessions, tenants, userTenantAccess } from '../../src/db/schema.js';
import { eq, and, gt } from 'drizzle-orm';

export default async function handler(req: VercelRequest, res: VercelResponse) {
  if (req.method !== 'GET') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  res.setHeader('Cache-Control', 'no-store');

  // Parse session cookie
  const cookies = parseCookies(req.headers.cookie || '');
  const sessionToken = cookies.session;

  if (!sessionToken) {
    return res.status(401).json({ error: 'Not authenticated', user: null });
  }

  try {
    // Look up session (must be valid and not expired)
    const validSessions = await db
      .select()
      .from(sessions)
      .where(
        and(
          eq(sessions.token, sessionToken),
          gt(sessions.expiresAt, new Date())
        )
      )
      .limit(1);

    const session = validSessions[0];

    if (!session) {
      // Invalid or expired session - clear the cookie
      res.setHeader('Set-Cookie', 'session=; Path=/; HttpOnly; Max-Age=0');
      return res.status(401).json({ error: 'Session expired', user: null });
    }

    // Get user data
    const userResults = await db
      .select({
        id: users.id,
        email: users.email,
        firstName: users.firstName,
        lastName: users.lastName,
        tenantId: users.tenantId,
        role: users.role,
        isSuperAdmin: users.isSuperAdmin,
        isAccountant: users.isAccountant,
        theme: users.theme,
      })
      .from(users)
      .where(eq(users.id, session.userId))
      .limit(1);

    const user = userResults[0];

    if (!user) {
      // User was deleted but session still exists
      res.setHeader('Set-Cookie', 'session=; Path=/; HttpOnly; Max-Age=0');
      return res.status(401).json({ error: 'User not found', user: null });
    }

    // Get user's tenant access (all tenants they can access)
    const tenantAccessResults = await db
      .select({
        tenantId: userTenantAccess.tenantId,
        role: userTenantAccess.role,
        canEdit: userTenantAccess.canEdit,
        tenant: {
          id: tenants.id,
          name: tenants.name,
          subdomain: tenants.subdomain,
          logoUrl: tenants.logoUrl,
        },
      })
      .from(userTenantAccess)
      .innerJoin(tenants, eq(userTenantAccess.tenantId, tenants.id))
      .where(eq(userTenantAccess.userId, user.id));

    // If user has a primary tenant, get its details too
    let primaryTenant = null;
    if (user.tenantId) {
      const primaryTenantResults = await db
        .select({
          id: tenants.id,
          name: tenants.name,
          subdomain: tenants.subdomain,
          logoUrl: tenants.logoUrl,
          primaryColor: tenants.primaryColor,
          appName: tenants.appName,
        })
        .from(tenants)
        .where(eq(tenants.id, user.tenantId))
        .limit(1);
      
      primaryTenant = primaryTenantResults[0] || null;
    }

    return res.status(200).json({
      user: {
        ...user,
        primaryTenant,
        tenantAccess: tenantAccessResults,
      },
    });

  } catch (err) {
    console.error('Session validation error:', err);
    return res.status(500).json({ error: 'Server error', user: null });
  }
}

function parseCookies(cookieHeader: string): Record<string, string> {
  const cookies: Record<string, string> = {};
  
  cookieHeader.split(';').forEach(cookie => {
    const [name, ...rest] = cookie.trim().split('=');
    if (name && rest.length > 0) {
      cookies[name] = rest.join('=');
    }
  });
  
  return cookies;
}

--- FILE: ./api/tenant.ts ---

import type { VercelRequest, VercelResponse } from '@vercel/node';
import { db } from '../src/db/index.js';
import { tenants } from '../src/db/schema.js';
import { eq } from 'drizzle-orm';

export default async function handler(req: VercelRequest, res: VercelResponse) {
  // Only allow GET
  if (req.method !== 'GET') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  const subdomain = req.query.subdomain as string;

  if (!subdomain) {
    return res.status(400).json({ error: 'Subdomain is required' });
  }

  try {
    const tenant = await db
      .select({
        name: tenants.name,
        subdomain: tenants.subdomain,
        logoUrl: tenants.logoUrl,
        primaryColor: tenants.primaryColor,
        appName: tenants.appName,
        isActive: tenants.isActive,
      })
      .from(tenants)
      .where(eq(tenants.subdomain, subdomain.toLowerCase()))
      .limit(1);

    if (tenant.length === 0) {
      return res.status(404).json({ error: 'Tenant not found' });
    }

    if (!tenant[0].isActive) {
      return res.status(403).json({ error: 'Tenant is inactive' });
    }

    return res.status(200).json(tenant[0]);
  } catch (error) {
    console.error('Tenant lookup error:', error);
    return res.status(500).json({ error: 'Internal server error' });
  }
}

--- FILE: ./api/health.ts ---

import type { VercelRequest, VercelResponse } from '@vercel/node';

export default async function handler(req: VercelRequest, res: VercelResponse) {
  if (req.method !== 'GET') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  res.setHeader('Cache-Control', 'no-store');

  try {
    return res.status(200).json({
      status: 'ok',
      timestamp: new Date().toISOString()
    });
  } catch (error) {
    return res.status(503).json({
      status: 'error',
      timestamp: new Date().toISOString()
    });
  }
}


--- FILE: ./api/_lib/rate-limit-alerts.ts ---

import { Resend } from 'resend';
import { db } from '../../src/db/index.js';
import { tenants } from '../../src/db/schema.js';
import { eq } from 'drizzle-orm';

const resend = new Resend(process.env.RESEND_API_KEY);

const ALERT_RECIPIENTS = [
  'kpowers@gmail.com',
  'amber@wayveconsulting.com',
];

/**
 * Send an email alert when a rate limit is hit.
 * Failures are logged but never thrown — rate limiting still applies
 * even if the notification fails.
 */
export async function sendRateLimitAlert(
  tenantId: string,
  actionType: string,
  limitHit: string,
  current: number,
  limit: number
): Promise<void> {
  // Look up tenant name for the email
  let tenantName = tenantId;
  try {
    const [tenant] = await db
      .select({ name: tenants.name })
      .from(tenants)
      .where(eq(tenants.id, tenantId))
      .limit(1);
    if (tenant) tenantName = tenant.name;
  } catch {
    // Fall back to UUID if lookup fails
  }

  const windowLabel = limitHit.replace('per', '').toLowerCase();
  const timestamp = new Date().toISOString();

  const subject = `⚠️ Rate Limit Alert: ${actionType} — ${limitHit} limit reached`;

  const textBody = [
    `Rate Limit Alert`,
    ``,
    `Tenant: ${tenantName}`,
    `Action: ${actionType}`,
    `Window: ${windowLabel}`,
    `Usage: ${current} of ${limit} ${windowLabel} ${actionType}s used`,
    `Time: ${timestamp}`,
    ``,
    `If this is legitimate usage, Kevin can increase the limit in the database.`,
  ].join('\n');

  const htmlBody = `
    <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto; padding: 40px 20px;">
      <div style="text-align: center; margin-bottom: 32px;">
        <h1 style="color: #E76F51; margin: 0; font-size: 24px;">⚠️ Rate Limit Alert</h1>
      </div>

      <table style="width: 100%; border-collapse: collapse; margin-bottom: 24px;">
        <tr>
          <td style="padding: 8px 12px; font-weight: 600; color: #333; border-bottom: 1px solid #eee;">Tenant</td>
          <td style="padding: 8px 12px; color: #555; border-bottom: 1px solid #eee;">${tenantName}</td>
        </tr>
        <tr>
          <td style="padding: 8px 12px; font-weight: 600; color: #333; border-bottom: 1px solid #eee;">Action</td>
          <td style="padding: 8px 12px; color: #555; border-bottom: 1px solid #eee;">${actionType}</td>
        </tr>
        <tr>
          <td style="padding: 8px 12px; font-weight: 600; color: #333; border-bottom: 1px solid #eee;">Window Hit</td>
          <td style="padding: 8px 12px; color: #555; border-bottom: 1px solid #eee;">${windowLabel}</td>
        </tr>
        <tr>
          <td style="padding: 8px 12px; font-weight: 600; color: #333; border-bottom: 1px solid #eee;">Usage</td>
          <td style="padding: 8px 12px; color: #E76F51; font-weight: 600; border-bottom: 1px solid #eee;">${current} of ${limit} ${windowLabel} ${actionType}s used</td>
        </tr>
        <tr>
          <td style="padding: 8px 12px; font-weight: 600; color: #333;">Time</td>
          <td style="padding: 8px 12px; color: #555;">${timestamp}</td>
        </tr>
      </table>

      <p style="font-size: 14px; color: #666; line-height: 1.6;">
        If this is legitimate usage, Kevin can increase the limit in the database.
      </p>

      <hr style="border: none; border-top: 1px solid #eee; margin: 32px 0;" />

      <p style="font-size: 12px; color: #999; text-align: center;">
        Wayve Consulting &middot; Automated Rate Limit Alert
      </p>
    </div>
  `;

  try {
    await resend.emails.send({
      from: 'Wayve Expense Tracker <noreply@wayveconsulting.app>',
      to: ALERT_RECIPIENTS,
      subject,
      text: textBody,
      html: htmlBody,
    });
  } catch (emailErr) {
    console.error('Failed to send rate limit alert email:', emailErr);
  }
}


--- FILE: ./api/_lib/rate-limit.ts ---

import { db } from '../../src/db/index.js';
import { rateLimitUsage } from '../../src/db/schema.js';
import { eq, and, gte, sql } from 'drizzle-orm';
import { sendRateLimitAlert } from './rate-limit-alerts.js';

export interface RateLimitConfig {
  actionType: string;
  limits: {
    perMinute?: number;
    perHour?: number;
    perDay?: number;
    perMonth?: number;
  };
  alertOn?: ('daily' | 'monthly')[];
}

export interface RateLimitResult {
  allowed: boolean;
  limitHit?: string;
  current?: number;
  limit?: number;
  retryAfterSeconds?: number;
}

export const RECEIPT_SCAN_LIMITS: RateLimitConfig = {
  actionType: 'receipt_scan',
  limits: {
    perMinute: 10,
    perHour: 60,
    perDay: 100,
    perMonth: 200,
  },
  alertOn: ['daily', 'monthly'],
};

/**
 * Check whether a tenant has exceeded any rate limit window for the given action.
 * Windows are checked smallest-to-largest for fast failure.
 */
export async function checkRateLimit(
  tenantId: string,
  config: RateLimitConfig
): Promise<RateLimitResult> {
  const windows: { key: keyof RateLimitConfig['limits']; seconds: number; alertKey?: 'daily' | 'monthly' }[] = [
    { key: 'perMinute', seconds: 60 },
    { key: 'perHour', seconds: 3600 },
    { key: 'perDay', seconds: 86400, alertKey: 'daily' },
    { key: 'perMonth', seconds: 2592000, alertKey: 'monthly' },
  ];

  for (const window of windows) {
    const limit = config.limits[window.key];
    if (limit === undefined) continue;

    const since = new Date(Date.now() - window.seconds * 1000);

    const [result] = await db
      .select({ count: sql<number>`count(*)` })
      .from(rateLimitUsage)
      .where(and(
        eq(rateLimitUsage.tenantId, tenantId),
        eq(rateLimitUsage.actionType, config.actionType),
        gte(rateLimitUsage.createdAt, since)
      ));

    const current = Number(result?.count ?? 0);

    if (current >= limit) {
      // Fire alert if this window matches alertOn config
      if (window.alertKey && config.alertOn?.includes(window.alertKey)) {
        sendRateLimitAlert(tenantId, config.actionType, window.key, current, limit).catch((err) => {
          console.error('Failed to send rate limit alert:', err);
        });
      }

      return {
        allowed: false,
        limitHit: window.key,
        current,
        limit,
        retryAfterSeconds: window.seconds,
      };
    }
  }

  return { allowed: true };
}

/**
 * Record a single usage event. Call this AFTER a successful operation.
 */
export async function recordUsage(
  tenantId: string,
  actionType: string
): Promise<void> {
  await db.insert(rateLimitUsage).values({
    tenantId,
    actionType,
  });
}


--- FILE: ./api/_lib/auth.ts ---

import type { VercelRequest } from '@vercel/node';
import { db } from '../../src/db/index.js';
import { sessions, users, userTenantAccess, tenants } from '../../src/db/schema.js';
import { eq, and } from 'drizzle-orm';

export interface AuthResult {
  user: {
    id: string;
    email: string;
    isSuperAdmin: boolean;
    isAccountant: boolean;
  };
  tenantId: string;
  sessionId: string;
}

/**
 * Authenticate a request by validating the session cookie,
 * resolving the tenant from ?tenant= query param, and
 * verifying the user has access to that tenant.
 *
 * Returns null if any step fails — caller is responsible
 * for returning 401 to the client.
 */
export async function authenticateRequest(
  req: VercelRequest
): Promise<AuthResult | null> {
  // 1. Parse session token from cookie
  const sessionToken = req.cookies?.session;
  if (!sessionToken) return null;

  // 2. Look up session and verify not expired
  const [session] = await db
    .select()
    .from(sessions)
    .where(eq(sessions.token, sessionToken))
    .limit(1);

  if (!session || new Date(session.expiresAt) < new Date()) return null;

  // 3. Look up user
  const [user] = await db
    .select({
      id: users.id,
      email: users.email,
      isSuperAdmin: users.isSuperAdmin,
      isAccountant: users.isAccountant,
    })
    .from(users)
    .where(eq(users.id, session.userId))
    .limit(1);

  if (!user) return null;

  // 4. Resolve tenant from query param
  const tenantSubdomain = req.query.tenant as string | undefined;
  if (!tenantSubdomain) return null;

  const [tenant] = await db
    .select({ id: tenants.id })
    .from(tenants)
    .where(eq(tenants.subdomain, tenantSubdomain))
    .limit(1);

  if (!tenant) return null;

  // 5. Verify user has access to this tenant
  const [hasAccess] = await db
    .select()
    .from(userTenantAccess)
    .where(and(
      eq(userTenantAccess.userId, user.id),
      eq(userTenantAccess.tenantId, tenant.id)
    ))
    .limit(1);

  if (!hasAccess && !user.isSuperAdmin) return null;

  return {
    user,
    tenantId: tenant.id,
    sessionId: session.id,
  };
}


--- FILE: ./api/_lib/utils.ts ---

export function escapeHtml(str: string): string {
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}


--- FILE: ./api/attachments/[id].ts ---

import type { VercelRequest, VercelResponse } from '@vercel/node';
import { del } from '@vercel/blob';
import { db } from '../../src/db/index.js';
import { expenseAttachments } from '../../src/db/schema.js';
import { eq, and } from 'drizzle-orm';
import { authenticateRequest } from '../_lib/auth.js';

export default async function handler(req: VercelRequest, res: VercelResponse) {
  const { id } = req.query;
  if (!id || typeof id !== 'string') {
    return res.status(400).json({ error: 'Attachment ID is required' });
  }

  const auth = await authenticateRequest(req);
  if (!auth) return res.status(401).json({ error: 'Unauthorized' });

  // ============================================
  // GET — Return attachment details (blob URL)
  // ============================================
  if (req.method === 'GET') {
    try {
      const [attachment] = await db
        .select()
        .from(expenseAttachments)
        .where(
          and(
            eq(expenseAttachments.id, id),
            eq(expenseAttachments.tenantId, auth.tenantId)
          )
        )
        .limit(1);

      if (!attachment) {
        return res.status(404).json({ error: 'Attachment not found' });
      }

      res.setHeader('Cache-Control', 'no-store');
      return res.status(200).json({ attachment });
    } catch (error) {
      console.error('Get attachment error:', error);
      return res.status(500).json({ error: 'Failed to fetch attachment' });
    }
  }

  // ============================================
  // DELETE — Remove attachment record + delete blob
  // ============================================
  if (req.method === 'DELETE') {
    try {
      // Fetch the attachment (tenant-scoped)
      const [attachment] = await db
        .select()
        .from(expenseAttachments)
        .where(
          and(
            eq(expenseAttachments.id, id),
            eq(expenseAttachments.tenantId, auth.tenantId)
          )
        )
        .limit(1);

      if (!attachment) {
        return res.status(404).json({ error: 'Attachment not found' });
      }

      // Delete the blob from Vercel Blob storage
      await del(attachment.blobUrl, {
        token: process.env.BLOB_READ_WRITE_TOKEN,
      });

      // Delete the database record
      await db
        .delete(expenseAttachments)
        .where(eq(expenseAttachments.id, id));

      return res.status(200).json({ success: true });
    } catch (error) {
      console.error('Delete attachment error:', error);
      return res.status(500).json({ error: 'Failed to delete attachment' });
    }
  }

  return res.status(405).json({ error: 'Method not allowed' });
}

--- FILE: ./api/attachments/upload.ts ---

import type { VercelRequest, VercelResponse } from '@vercel/node';
import { handleUpload, type HandleUploadBody } from '@vercel/blob/client';
import { authenticateRequest } from '../_lib/auth.js';

// Allowed MIME types
const ALLOWED_TYPES = [
  'image/jpeg',
  'image/png',
  'image/heic',
  'application/pdf',
];

const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB

export default async function handler(req: VercelRequest, res: VercelResponse) {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    const auth = await authenticateRequest(req);
    if (!auth) return res.status(401).json({ error: 'Unauthorized' });

    const body = req.body as HandleUploadBody;

    const jsonResponse = await handleUpload({
      body,
      request: req as any, // VercelRequest is compatible with the expected type
      onBeforeGenerateToken: async (pathname, clientPayload) => {
        // clientPayload contains our expenseId + tenantId for validation
        // Auth already verified above — user has access to this tenant

        return {
          allowedContentTypes: ALLOWED_TYPES,
          maximumSizeInBytes: MAX_FILE_SIZE,
          addRandomSuffix: true,
          tokenPayload: JSON.stringify({
            userId: auth.user.id,
            tenantId: auth.tenantId,
            clientPayload,
          }),
        };
      },
      onUploadCompleted: async ({ blob, tokenPayload }) => {
        // This callback is called by Vercel's servers when upload completes.
        // It won't work on localhost (Vercel can't reach it).
        // We don't rely on it — the client records the attachment via POST /api/attachments.
        // This is just a safety net for production if we ever need server-side post-processing.
        console.log('Client upload completed:', blob.pathname);
      },
    });

    return res.status(200).json(jsonResponse);
  } catch (error) {
    console.error('Upload token error:', error);
    return res.status(400).json({ error: (error as Error).message });
  }
}

--- FILE: ./api/attachments/index.ts ---

import type { VercelRequest, VercelResponse } from '@vercel/node';
import { db } from '../../src/db/index.js';
import { expenseAttachments, expenses } from '../../src/db/schema.js';
import { eq, and } from 'drizzle-orm';
import { authenticateRequest } from '../_lib/auth.js';

export default async function handler(req: VercelRequest, res: VercelResponse) {
  // ============================================
  // POST — Record attachment metadata (blob already uploaded via client upload)
  // ============================================
  if (req.method === 'POST') {
    try {
      const auth = await authenticateRequest(req);
      if (!auth) return res.status(401).json({ error: 'Unauthorized' });

      const { expenseId, blobUrl, fileName, fileType, fileSize } = req.body || {};

      if (!expenseId || !blobUrl || !fileName || !fileType || !fileSize) {
        return res.status(400).json({ 
          error: 'expenseId, blobUrl, fileName, fileType, and fileSize are required' 
        });
      }

      // Verify expense belongs to this tenant
      const [expense] = await db
        .select({ id: expenses.id })
        .from(expenses)
        .where(and(eq(expenses.id, expenseId), eq(expenses.tenantId, auth.tenantId)))
        .limit(1);

      if (!expense) {
        return res.status(404).json({ error: 'Expense not found' });
      }

      // Save attachment record
      const [attachment] = await db
        .insert(expenseAttachments)
        .values({
          tenantId: auth.tenantId,
          expenseId: expenseId,
          blobUrl: blobUrl,
          fileName: fileName,
          fileSize: fileSize,
          mimeType: fileType,
          sortOrder: 0,
          uploadedBy: auth.user.id,
        })
        .returning();

      return res.status(201).json({ attachment });
    } catch (error) {
      console.error('Record attachment error:', error);
      return res.status(500).json({ error: 'Failed to record attachment' });
    }
  }

  // ============================================
  // GET — List attachments for an expense
  // ============================================
  if (req.method === 'GET') {
    try {
      const auth = await authenticateRequest(req);
      if (!auth) return res.status(401).json({ error: 'Unauthorized' });

      const expenseId = req.query.expenseId as string;
      if (!expenseId) {
        return res.status(400).json({ error: 'expenseId query param is required' });
      }

      const attachments = await db
        .select()
        .from(expenseAttachments)
        .where(
          and(
            eq(expenseAttachments.expenseId, expenseId),
            eq(expenseAttachments.tenantId, auth.tenantId)
          )
        )
        .orderBy(expenseAttachments.sortOrder, expenseAttachments.createdAt);

      res.setHeader('Cache-Control', 'no-store');
      return res.status(200).json({ attachments });
    } catch (error) {
      console.error('List attachments error:', error);
      return res.status(500).json({ error: 'Failed to fetch attachments' });
    }
  }

  return res.status(405).json({ error: 'Method not allowed' });
}

--- FILE: ./api/reports/annual.ts ---

import type { VercelRequest, VercelResponse } from '@vercel/node'
import { db } from '../../src/db/index.js'
import { expenses, categories } from '../../src/db/schema.js'
import { eq, and, gte, lt } from 'drizzle-orm'
import { authenticateRequest } from '../_lib/auth.js'

// ===========================================
// GET: Annual summary report
// ===========================================
async function handleGet(req: VercelRequest, res: VercelResponse) {
  res.setHeader('Cache-Control', 'no-store')
  const auth = await authenticateRequest(req)
  if (!auth) {
    return res.status(401).json({ error: 'Unauthorized' })
  }
  const { tenantId } = auth

  const year = req.query.year ? parseInt(req.query.year as string) : new Date().getFullYear()

  // Date range for SQL-level filtering
  const startDate = new Date(year, 0, 1)
  const endDate = new Date(year + 1, 0, 1)

  // Fetch expenses for this year only (SQL-level date filter)
  const yearExpenses = await db
    .select({
      id: expenses.id,
      amount: expenses.amount,
      date: expenses.date,
      categoryId: expenses.categoryId,
      expenseType: expenses.expenseType,
      isHomeOffice: expenses.isHomeOffice,
      homeOfficePercent: expenses.homeOfficePercent,
    })
    .from(expenses)
    .where(and(
      eq(expenses.tenantId, tenantId),
      gte(expenses.date, startDate),
      lt(expenses.date, endDate)
    ))

  // Fetch categories for this tenant
  const tenantCategories = await db
    .select()
    .from(categories)
    .where(eq(categories.tenantId, tenantId))

  const categoryMap = new Map(tenantCategories.map((c) => [c.id, c]))

  // ---- Monthly Spending ----
  const monthlyTotals = new Array(12).fill(0)
  const monthlyCounts = new Array(12).fill(0)
  for (const exp of yearExpenses) {
    const month = new Date(exp.date).getMonth()
    monthlyTotals[month] += exp.amount
    monthlyCounts[month] += 1
  }

  const monthlyBreakdown = monthlyTotals.map((total, i) => ({
    month: i + 1,
    label: new Date(year, i).toLocaleString('en-US', { month: 'short' }),
    labelFull: new Date(year, i).toLocaleString('en-US', { month: 'long' }),
    total,
    count: monthlyCounts[i],
  }))

  // ---- Category Breakdown ----
  const categoryTotals = new Map<string, { amount: number; count: number }>()
  for (const exp of yearExpenses) {
    const catId = exp.categoryId || 'uncategorized'
    const existing = categoryTotals.get(catId) || { amount: 0, count: 0 }
    existing.amount += exp.amount
    existing.count += 1
    categoryTotals.set(catId, existing)
  }

  const totalSpent = yearExpenses.reduce((sum, e) => sum + e.amount, 0)
  const totalDeductible = yearExpenses.reduce((sum, e) => {
    if (e.isHomeOffice && e.homeOfficePercent) {
      return sum + Math.round(e.amount * (e.homeOfficePercent / 100))
    }
    return sum + e.amount
  }, 0)

  const categoryBreakdown = Array.from(categoryTotals.entries())
    .map(([catId, data]) => {
      const cat = categoryMap.get(catId)
      return {
        categoryId: catId,
        name: cat?.name || 'Uncategorized',
        emoji: cat?.emoji || '❓',
        amount: data.amount,
        count: data.count,
        percentage: totalSpent > 0 ? Math.round((data.amount / totalSpent) * 1000) / 10 : 0,
      }
    })
    .sort((a, b) => b.amount - a.amount)

  // ---- Top-line Summary ----
  const expenseCount = yearExpenses.length
  const activeMonths = monthlyCounts.filter((c) => c > 0).length
  const averagePerMonth = activeMonths > 0 ? Math.round(totalSpent / activeMonths) : 0
  const highestMonth = monthlyBreakdown.reduce(
    (max, m) => (m.total > max.total ? m : max),
    monthlyBreakdown[0]
  )
  const lowestActiveMonth = monthlyBreakdown
    .filter((m) => m.total > 0)
    .reduce(
      (min, m) => (m.total < min.total ? m : min),
      monthlyBreakdown.find((m) => m.total > 0) || monthlyBreakdown[0]
    )

  const topCategory = categoryBreakdown.length > 0 ? categoryBreakdown[0] : null

  return res.status(200).json({
    year,
    summary: {
      totalSpent,
      totalDeductible,
      expenseCount,
      activeMonths,
      averagePerMonth,
      highestMonth: highestMonth ? { label: highestMonth.labelFull, total: highestMonth.total } : null,
      lowestMonth: lowestActiveMonth ? { label: lowestActiveMonth.labelFull, total: lowestActiveMonth.total } : null,
      topCategory: topCategory ? { name: topCategory.name, emoji: topCategory.emoji, amount: topCategory.amount, percentage: topCategory.percentage } : null,
    },
    monthlyBreakdown,
    categoryBreakdown,
  })
}

// ===========================================
// Main handler
// ===========================================
export default async function handler(req: VercelRequest, res: VercelResponse) {
  try {
    switch (req.method) {
      case 'GET':
        return handleGet(req, res)
      default:
        return res.status(405).json({ error: 'Method not allowed' })
    }
  } catch (error) {
    console.error('Error in annual report API:', error)
    return res.status(500).json({ error: 'Internal server error' })
  }
}

--- FILE: ./api/reports/tax-summary.ts ---

import type { VercelRequest, VercelResponse } from '@vercel/node'
import { db } from '../../src/db/index.js'
import { expenses, categories } from '../../src/db/schema.js'
import { eq, and, gte, lt } from 'drizzle-orm'
import { authenticateRequest } from '../_lib/auth.js'

// ===========================================
// Type labels and ordering
// ===========================================
const TYPE_CONFIG: Record<string, { label: string; description: string; order: number }> = {
  cogs: {
    label: 'Cost of Goods Sold (COGS)',
    description: 'Direct costs of producing goods or services sold',
    order: 1,
  },
  operating: {
    label: 'Operating Expenses',
    description: 'Day-to-day business expenses not directly tied to production',
    order: 2,
  },
  home_office: {
    label: 'Home Office Expenses',
    description: 'Expenses with home office deduction applied (partial deductibility based on sq ft percentage)',
    order: 3,
  },
}

// ===========================================
// Helper: Calculate deductible amount for an expense
// ===========================================
function getDeductibleAmount(expense: {
  amount: number
  isHomeOffice: boolean | null
  homeOfficePercent: number | null
}): number {
  if (expense.isHomeOffice && expense.homeOfficePercent != null) {
    return Math.round(expense.amount * expense.homeOfficePercent / 100)
  }
  return expense.amount
}

// ===========================================
// GET: Tax summary report
// ===========================================
async function handleGet(req: VercelRequest, res: VercelResponse) {
  res.setHeader('Cache-Control', 'no-store')
  const auth = await authenticateRequest(req)
  if (!auth) {
    return res.status(401).json({ error: 'Unauthorized' })
  }
  const { tenantId } = auth

  const year = req.query.year ? parseInt(req.query.year as string) : new Date().getFullYear()

  // Date range for SQL-level filtering
  const startDate = new Date(year, 0, 1)
  const endDate = new Date(year + 1, 0, 1)

  // Fetch expenses for this year only (SQL-level date filter)
  const yearExpenses = await db
    .select({
      id: expenses.id,
      amount: expenses.amount,
      date: expenses.date,
      categoryId: expenses.categoryId,
      expenseType: expenses.expenseType,
      vendor: expenses.vendor,
      isHomeOffice: expenses.isHomeOffice,
      homeOfficePercent: expenses.homeOfficePercent,
    })
    .from(expenses)
    .where(and(
      eq(expenses.tenantId, tenantId),
      gte(expenses.date, startDate),
      lt(expenses.date, endDate)
    ))

  // Fetch categories
  const tenantCategories = await db
    .select()
    .from(categories)
    .where(eq(categories.tenantId, tenantId))

  const categoryMap = new Map(tenantCategories.map((c) => [c.id, c]))

  // ---- Group by section ----
  const typeGroups = new Map<string, typeof yearExpenses>()

  for (const exp of yearExpenses) {
    let section: string
    if (exp.isHomeOffice) {
      section = 'home_office'
    } else {
      section = exp.expenseType || 'operating'
      if (section === 'home_office') {
        section = 'operating'
      }
    }

    if (!typeGroups.has(section)) {
      typeGroups.set(section, [])
    }
    typeGroups.get(section)!.push(exp)
  }

  // ---- Build type sections ----
  const totalSpent = yearExpenses.reduce((sum, e) => sum + e.amount, 0)
  const totalDeductible = yearExpenses.reduce((sum, e) => sum + getDeductibleAmount(e), 0)

  const sections = Object.entries(TYPE_CONFIG)
    .map(([typeKey, config]) => {
      const typeExpenses = typeGroups.get(typeKey) || []
      const typeTotal = typeExpenses.reduce((sum, e) => sum + e.amount, 0)
      const typeDeductible = typeExpenses.reduce((sum, e) => sum + getDeductibleAmount(e), 0)

      // Category breakdown within this type
      const catTotals = new Map<string, { amount: number; deductible: number; count: number }>()
      for (const exp of typeExpenses) {
        const catId = exp.categoryId || 'uncategorized'
        const existing = catTotals.get(catId) || { amount: 0, deductible: 0, count: 0 }
        existing.amount += exp.amount
        existing.deductible += getDeductibleAmount(exp)
        existing.count += 1
        catTotals.set(catId, existing)
      }

      const categoryBreakdown = Array.from(catTotals.entries())
        .map(([catId, data]) => {
          const cat = categoryMap.get(catId)
          return {
            categoryId: catId,
            name: cat?.name || 'Uncategorized',
            emoji: cat?.emoji || '❓',
            amount: data.amount,
            deductible: data.deductible,
            count: data.count,
            percentOfType: typeTotal > 0 ? Math.round((data.amount / typeTotal) * 1000) / 10 : 0,
          }
        })
        .sort((a, b) => b.amount - a.amount)

      return {
        type: typeKey,
        label: config.label,
        description: config.description,
        order: config.order,
        total: typeTotal,
        deductible: typeDeductible,
        count: typeExpenses.length,
        percentOfTotal: totalSpent > 0 ? Math.round((typeTotal / totalSpent) * 1000) / 10 : 0,
        categories: categoryBreakdown,
      }
    })
    .sort((a, b) => a.order - b.order)

  return res.status(200).json({
    year,
    totalSpent,
    totalDeductible,
    expenseCount: yearExpenses.length,
    sections,
  })
}

// ===========================================
// Main handler
// ===========================================
export default async function handler(req: VercelRequest, res: VercelResponse) {
  try {
    switch (req.method) {
      case 'GET':
        return handleGet(req, res)
      default:
        return res.status(405).json({ error: 'Method not allowed' })
    }
  } catch (error) {
    console.error('Error in tax summary API:', error)
    return res.status(500).json({ error: 'Internal server error' })
  }
}

--- FILE: ./api/reports/quarterly.ts ---

import type { VercelRequest, VercelResponse } from '@vercel/node'
import { db } from '../../src/db/index.js'
import { expenses, categories } from '../../src/db/schema.js'
import { eq, and, desc, gte, lt } from 'drizzle-orm'
import { authenticateRequest } from '../_lib/auth.js'

// ===========================================
// Helper: Get quarter (1-4) from a date
// ===========================================
function getQuarter(date: Date): number {
  return Math.floor(date.getMonth() / 3) + 1
}

// ===========================================
// GET: Quarterly breakdown by category
// ===========================================
async function handleGet(req: VercelRequest, res: VercelResponse) {
  res.setHeader('Cache-Control', 'no-store')
  const auth = await authenticateRequest(req)
  if (!auth) {
    return res.status(401).json({ error: 'Unauthorized' })
  }
  const { tenantId } = auth

  const year = req.query.year ? parseInt(req.query.year as string) : new Date().getFullYear()

  // Date range for SQL-level filtering
  const startDate = new Date(year, 0, 1)   // Jan 1 of year
  const endDate = new Date(year + 1, 0, 1) // Jan 1 of next year

  // Fetch expenses for this year only (SQL-level date filter)
  const filtered = await db
    .select({
      amount: expenses.amount,
      date: expenses.date,
      categoryId: expenses.categoryId,
      categoryName: categories.name,
      categoryEmoji: categories.emoji,
    })
    .from(expenses)
    .leftJoin(categories, eq(expenses.categoryId, categories.id))
    .where(and(
      eq(expenses.tenantId, tenantId),
      gte(expenses.date, startDate),
      lt(expenses.date, endDate)
    ))
    .orderBy(desc(expenses.date))

  // Build category × quarter matrix
  type QuarterlyRow = {
    categoryId: string
    name: string
    emoji: string | null
    q1: number
    q2: number
    q3: number
    q4: number
    total: number
  }

  const matrix = new Map<string, QuarterlyRow>()

  for (const expense of filtered) {
    const key = expense.categoryId || 'uncategorized'
    const quarter = getQuarter(new Date(expense.date))

    if (!matrix.has(key)) {
      matrix.set(key, {
        categoryId: key,
        name: expense.categoryName || 'Uncategorized',
        emoji: expense.categoryEmoji,
        q1: 0,
        q2: 0,
        q3: 0,
        q4: 0,
        total: 0,
      })
    }

    const row = matrix.get(key)!
    const qKey = `q${quarter}` as 'q1' | 'q2' | 'q3' | 'q4'
    row[qKey] += expense.amount
    row.total += expense.amount
  }

  // Sort by total descending
  const rows = Array.from(matrix.values()).sort((a, b) => b.total - a.total)

  // Calculate column totals
  const totals = {
    q1: rows.reduce((sum, r) => sum + r.q1, 0),
    q2: rows.reduce((sum, r) => sum + r.q2, 0),
    q3: rows.reduce((sum, r) => sum + r.q3, 0),
    q4: rows.reduce((sum, r) => sum + r.q4, 0),
    total: rows.reduce((sum, r) => sum + r.total, 0),
  }

  return res.status(200).json({
    year,
    rows,
    totals,
  })
}

// ===========================================
// Main handler
// ===========================================
export default async function handler(req: VercelRequest, res: VercelResponse) {
  try {
    switch (req.method) {
      case 'GET':
        return handleGet(req, res)
      default:
        return res.status(405).json({ error: 'Method not allowed' })
    }
  } catch (error) {
    console.error('Error in quarterly report API:', error)
    return res.status(500).json({ error: 'Internal server error' })
  }
}

--- FILE: ./api/reports/mileage.ts ---

import type { VercelRequest, VercelResponse } from '@vercel/node'
import { db } from '../../src/db/index.js'
import { mileageTrips } from '../../src/db/schema.js'
import { eq, and, asc, gte, lt } from 'drizzle-orm'
import { authenticateRequest } from '../_lib/auth.js'

// ===========================================
// GET: Mileage log report for a year
// ===========================================
async function handleGet(req: VercelRequest, res: VercelResponse) {
  res.setHeader('Cache-Control', 'no-store')
  const auth = await authenticateRequest(req)
  if (!auth) {
    return res.status(401).json({ error: 'Unauthorized' })
  }
  const { tenantId } = auth

  const year = req.query.year ? parseInt(req.query.year as string) : new Date().getFullYear()

  // Date range for SQL-level filtering
  const startDate = new Date(year, 0, 1)
  const endDate = new Date(year + 1, 0, 1)

  // Fetch mileage trips for this year only, sorted chronologically (oldest first for IRS report)
  const yearTrips = await db
    .select()
    .from(mileageTrips)
    .where(and(
      eq(mileageTrips.tenantId, tenantId),
      gte(mileageTrips.date, startDate),
      lt(mileageTrips.date, endDate)
    ))
    .orderBy(asc(mileageTrips.date))

  // Build report rows
  const trips = yearTrips.map((trip) => ({
    id: trip.id,
    date: trip.date,
    startLocation: trip.startLocation,
    endLocation: trip.endLocation,
    description: trip.description,
    distanceMiles: trip.distanceMiles,
    displayMiles: trip.isRoundTrip ? trip.distanceMiles * 2 : trip.distanceMiles,
    isRoundTrip: trip.isRoundTrip,
  }))

  // Calculate summary
  const totalMiles = trips.reduce((sum, t) => sum + t.displayMiles, 0)
  const tripCount = trips.length
  // IRS standard mileage rate for 2025: $0.70/mile
  const mileageRate = 70 // cents per mile
  const estimatedDeduction = Math.round((totalMiles / 100) * mileageRate)

  // Monthly breakdown
  const monthlyMiles = new Array(12).fill(0)
  for (const trip of trips) {
    const month = new Date(trip.date).getMonth()
    monthlyMiles[month] += trip.displayMiles
  }

  const monthlyBreakdown = monthlyMiles.map((miles, i) => ({
    month: i + 1,
    label: new Date(year, i).toLocaleString('en-US', { month: 'long' }),
    totalMiles: miles,
    tripCount: trips.filter((t) => new Date(t.date).getMonth() === i).length,
  })).filter((m) => m.totalMiles > 0 || m.tripCount > 0)

  return res.status(200).json({
    year,
    trips,
    summary: {
      totalMiles,
      tripCount,
      estimatedDeduction,
      mileageRate,
    },
    monthlyBreakdown,
  })
}

// ===========================================
// Main handler
// ===========================================
export default async function handler(req: VercelRequest, res: VercelResponse) {
  try {
    switch (req.method) {
      case 'GET':
        return handleGet(req, res)
      default:
        return res.status(405).json({ error: 'Method not allowed' })
    }
  } catch (error) {
    console.error('Error in mileage report API:', error)
    return res.status(500).json({ error: 'Internal server error' })
  }
}

--- FILE: ./api/exports/expenses.ts ---

import type { VercelRequest, VercelResponse } from '@vercel/node'
import { db } from '../../src/db/index.js'
import { expenses, categories } from '../../src/db/schema.js'
import { eq, and, gte, lte, desc } from 'drizzle-orm'
import { authenticateRequest } from '../_lib/auth.js'

export default async function handler(req: VercelRequest, res: VercelResponse) {
  if (req.method !== 'GET') {
    return res.status(405).json({ error: 'Method not allowed' })
  }

  try {
    const auth = await authenticateRequest(req)
    if (!auth) {
      return res.status(401).json({ error: 'Unauthorized' })
    }

    // Parse date filters
    const startDate = req.query.startDate as string | undefined
    const endDate = req.query.endDate as string | undefined

    // Build query conditions
    const conditions = [eq(expenses.tenantId, auth.tenantId)]
    
    if (startDate) {
      conditions.push(gte(expenses.date, new Date(startDate)))
    }
    if (endDate) {
      // Add one day to include the end date fully
      const endDatePlusOne = new Date(endDate)
      endDatePlusOne.setDate(endDatePlusOne.getDate() + 1)
      conditions.push(lte(expenses.date, endDatePlusOne))
    }

    // Fetch expenses with categories
    const expenseData = await db
      .select({
        id: expenses.id,
        date: expenses.date,
        amount: expenses.amount,
        vendor: expenses.vendor,
        description: expenses.description,
        expenseType: expenses.expenseType,
        categoryName: categories.name,
        createdAt: expenses.createdAt,
      })
      .from(expenses)
      .leftJoin(categories, eq(expenses.categoryId, categories.id))
      .where(and(...conditions))
      .orderBy(desc(expenses.date))

    // Generate CSV
    const csvHeaders = [
      'Date',
      'Vendor',
      'Description',
      'Category',
      'Expense Type',
      'Amount',
    ]

    const csvRows = expenseData.map(expense => [
      new Date(expense.date).toISOString().split('T')[0],
      escapeCsvField(expense.vendor || ''),
      escapeCsvField(expense.description || ''),
      escapeCsvField(expense.categoryName || 'Uncategorized'),
      expense.expenseType || 'operating',
      (expense.amount / 100).toFixed(2),
    ])

    const csvContent = [
      csvHeaders.join(','),
      ...csvRows.map(row => row.join(','))
    ].join('\n')

    // Generate filename
    const dateRange = startDate && endDate 
      ? `_${startDate}_to_${endDate}`
      : startDate 
      ? `_from_${startDate}`
      : endDate
      ? `_to_${endDate}`
      : `_${new Date().getFullYear()}`
    
    const filename = `expenses${dateRange}.csv`

    // Send CSV response
    res.setHeader('Content-Type', 'text/csv')
    res.setHeader('Content-Disposition', `attachment; filename="${filename}"`)
    return res.status(200).send(csvContent)

  } catch (error) {
    console.error('Export error:', error)
    return res.status(500).json({ error: 'Failed to export expenses' })
  }
}

// Helper to escape CSV fields
function escapeCsvField(field: string): string {
  if (field.includes(',') || field.includes('"') || field.includes('\n')) {
    return `"${field.replace(/"/g, '""')}"`
  }
  return field
}

--- FILE: ./api/expenses/[id].ts ---

import type { VercelRequest, VercelResponse } from '@vercel/node'
import { db } from '../../src/db/index.js'
import { expenses, categories, tenants } from '../../src/db/schema.js'
import { eq, and } from 'drizzle-orm'
import { authenticateRequest } from '../_lib/auth.js'

// ===========================================
// GET: Fetch single expense by ID
// ===========================================
async function handleGet(req: VercelRequest, res: VercelResponse, expenseId: string) {
  res.setHeader('Cache-Control', 'no-store')
  const auth = await authenticateRequest(req)
  if (!auth) {
    return res.status(401).json({ error: 'Unauthorized' })
  }
  const { tenantId } = auth

  const [expense] = await db
    .select({
      id: expenses.id,
      amount: expenses.amount,
      vendor: expenses.vendor,
      description: expenses.description,
      date: expenses.date,
      categoryId: expenses.categoryId,
      categoryName: categories.name,
      categoryEmoji: categories.emoji,
      expenseType: expenses.expenseType,
      isHomeOffice: expenses.isHomeOffice,
      homeOfficePercent: expenses.homeOfficePercent,
      receiptUrl: expenses.receiptUrl,
      extractedText: expenses.extractedText,
      createdAt: expenses.createdAt,
      updatedAt: expenses.updatedAt,
    })
    .from(expenses)
    .leftJoin(categories, eq(expenses.categoryId, categories.id))
    .where(and(
      eq(expenses.id, expenseId),
      eq(expenses.tenantId, tenantId)
    ))
    .limit(1)

  if (!expense) {
    return res.status(404).json({ error: 'Expense not found' })
  }

  return res.status(200).json({ expense })
}

// ===========================================
// PUT: Update expense
// ===========================================
async function handlePut(req: VercelRequest, res: VercelResponse, expenseId: string) {
  const auth = await authenticateRequest(req)
  if (!auth) {
    return res.status(401).json({ error: 'Unauthorized' })
  }
  const { user, tenantId } = auth

  // Verify expense exists and belongs to tenant
  const [existingExpense] = await db
    .select()
    .from(expenses)
    .where(and(
      eq(expenses.id, expenseId),
      eq(expenses.tenantId, tenantId)
    ))
    .limit(1)

  if (!existingExpense) {
    return res.status(404).json({ error: 'Expense not found' })
  }

  const {
    amount,
    date,
    categoryId,
    vendor,
    description,
    expenseType,
    isHomeOffice,
    extractedText,
  } = req.body

  // Validation
  const errors: string[] = []

  if (amount !== undefined) {
    if (typeof amount !== 'number' || !Number.isInteger(amount) || amount <= 0) {
      errors.push('Amount must be a positive integer (in cents)')
    }
  }

  if (date !== undefined) {
    const parsedDate = new Date(date)
    if (isNaN(parsedDate.getTime())) {
      errors.push('Date must be a valid ISO date string')
    }
  }

  if (categoryId !== undefined) {
    const [category] = await db
      .select()
      .from(categories)
      .where(and(
        eq(categories.id, categoryId),
        eq(categories.tenantId, tenantId)
      ))
      .limit(1)

    if (!category) {
      errors.push('Invalid category')
    }
  }

  const validExpenseTypes = ['cogs', 'operating', 'home_office']
  if (expenseType !== undefined && !validExpenseTypes.includes(expenseType)) {
    errors.push(`Expense type must be one of: ${validExpenseTypes.join(', ')}`)
  }

  if (errors.length > 0) {
    return res.status(400).json({ error: 'Validation failed', details: errors })
  }

  // Build update object with only provided fields
  const updateData: Record<string, unknown> = {
    updatedBy: user.id,
    updatedAt: new Date(),
  }

  if (amount !== undefined) updateData.amount = amount
  if (date !== undefined) updateData.date = new Date(date)
  if (categoryId !== undefined) updateData.categoryId = categoryId
  if (vendor !== undefined) updateData.vendor = vendor?.trim() || null
  if (description !== undefined) updateData.description = description?.trim() || null
  if (expenseType !== undefined) updateData.expenseType = expenseType
  if (extractedText !== undefined) updateData.extractedText = extractedText
  if (isHomeOffice !== undefined) {
    updateData.isHomeOffice = isHomeOffice
    if (isHomeOffice) {
      // Snapshot current deduction percentage from tenant
      const [tenant] = await db
        .select({
          homeTotalSqft: tenants.homeTotalSqft,
          homeOfficeSqft: tenants.homeOfficeSqft,
        })
        .from(tenants)
        .where(eq(tenants.id, tenantId))
        .limit(1)

      if (tenant?.homeTotalSqft && tenant?.homeOfficeSqft && tenant.homeTotalSqft > 0) {
        updateData.homeOfficePercent = Math.round((tenant.homeOfficeSqft / tenant.homeTotalSqft) * 100)
      }
    } else {
      updateData.homeOfficePercent = null
    }
  }

  // Update the expense
  const [updatedExpense] = await db
    .update(expenses)
    .set(updateData)
    .where(eq(expenses.id, expenseId))
    .returning()

  // Fetch with category info
  const [expenseWithCategory] = await db
    .select({
      id: expenses.id,
      amount: expenses.amount,
      vendor: expenses.vendor,
      description: expenses.description,
      date: expenses.date,
      categoryId: expenses.categoryId,
      categoryName: categories.name,
      categoryEmoji: categories.emoji,
      expenseType: expenses.expenseType,
      isHomeOffice: expenses.isHomeOffice,
      homeOfficePercent: expenses.homeOfficePercent,
      receiptUrl: expenses.receiptUrl,
      createdAt: expenses.createdAt,
      updatedAt: expenses.updatedAt,
    })
    .from(expenses)
    .leftJoin(categories, eq(expenses.categoryId, categories.id))
    .where(eq(expenses.id, updatedExpense.id))
    .limit(1)

  return res.status(200).json({
    message: 'Expense updated successfully',
    expense: expenseWithCategory,
  })
}

// ===========================================
// DELETE: Delete expense
// ===========================================
async function handleDelete(req: VercelRequest, res: VercelResponse, expenseId: string) {
  const auth = await authenticateRequest(req)
  if (!auth) {
    return res.status(401).json({ error: 'Unauthorized' })
  }
  const { tenantId } = auth

  // Verify expense exists and belongs to tenant
  const [existingExpense] = await db
    .select()
    .from(expenses)
    .where(and(
      eq(expenses.id, expenseId),
      eq(expenses.tenantId, tenantId)
    ))
    .limit(1)

  if (!existingExpense) {
    return res.status(404).json({ error: 'Expense not found' })
  }

  // Delete the expense
  await db
    .delete(expenses)
    .where(eq(expenses.id, expenseId))

  return res.status(200).json({
    message: 'Expense deleted successfully',
    deletedId: expenseId,
  })
}

// ===========================================
// Main handler: Route by method
// ===========================================
export default async function handler(req: VercelRequest, res: VercelResponse) {
  const expenseId = req.query.id as string

  if (!expenseId) {
    return res.status(400).json({ error: 'Expense ID is required' })
  }

  try {
    switch (req.method) {
      case 'GET':
        return handleGet(req, res, expenseId)
      case 'PUT':
        return handlePut(req, res, expenseId)
      case 'DELETE':
        return handleDelete(req, res, expenseId)
      default:
        return res.status(405).json({ error: 'Method not allowed' })
    }
  } catch (error) {
    console.error('Error in expense API:', error)
    return res.status(500).json({ error: 'Internal server error' })
  }
}


--- FILE: ./api/expenses/index.ts ---

import type { VercelRequest, VercelResponse } from '@vercel/node'
import { db } from '../../src/db/index.js'
import { expenses, categories, tenants } from '../../src/db/schema.js'
import { eq, and, desc, sql, gte, lt } from 'drizzle-orm'
import { authenticateRequest } from '../_lib/auth.js'

// ===========================================
// GET: Fetch expenses with category breakdown
// ===========================================
async function handleGet(req: VercelRequest, res: VercelResponse) {
  res.setHeader('Cache-Control', 'no-store')
  const auth = await authenticateRequest(req)
  if (!auth) {
    return res.status(401).json({ error: 'Unauthorized' })
  }
  const { tenantId } = auth

  // Get query params for filtering
  const year = req.query.year ? parseInt(req.query.year as string) : new Date().getFullYear()
  const limit = req.query.limit ? parseInt(req.query.limit as string) : 100

  // Date range for SQL-level filtering
  const startDate = new Date(year, 0, 1)
  const endDate = new Date(year + 1, 0, 1)

  // Fetch expenses for this year only (SQL-level date filter) with category info + attachment count
  const filteredExpenses = await db
    .select({
      id: expenses.id,
      amount: expenses.amount,
      vendor: expenses.vendor,
      description: expenses.description,
      date: expenses.date,
      categoryId: expenses.categoryId,
      categoryName: categories.name,
      categoryEmoji: categories.emoji,
      expenseType: expenses.expenseType,
      isHomeOffice: expenses.isHomeOffice,
      homeOfficePercent: expenses.homeOfficePercent,
      receiptUrl: expenses.receiptUrl,
      createdAt: expenses.createdAt,
      attachmentCount: sql<number>`(SELECT COUNT(*) FROM expense_attachments WHERE expense_attachments.expense_id = ${expenses.id})`.as('attachment_count'),
    })
    .from(expenses)
    .leftJoin(categories, eq(expenses.categoryId, categories.id))
    .where(and(
      eq(expenses.tenantId, tenantId),
      gte(expenses.date, startDate),
      lt(expenses.date, endDate)
    ))
    .orderBy(desc(expenses.date), desc(expenses.createdAt))
    .limit(limit)

  // Calculate summary stats
  const totalAmount = filteredExpenses.reduce((sum, e) => sum + e.amount, 0)
  const totalDeductible = filteredExpenses.reduce((sum, e) => {
    if (e.isHomeOffice && e.homeOfficePercent) {
      return sum + Math.round(e.amount * (e.homeOfficePercent / 100))
    }
    return sum + e.amount
  }, 0)
  const expenseCount = filteredExpenses.length
  const averageAmount = expenseCount > 0 ? Math.round(totalAmount / expenseCount) : 0

  // Category breakdown
  const categoryTotals = new Map<string, { name: string; emoji: string | null; total: number; count: number }>()
  for (const expense of filteredExpenses) {
    const key = expense.categoryId || 'uncategorized'
    const existing = categoryTotals.get(key)
    if (existing) {
      existing.total += expense.amount
      existing.count += 1
    } else {
      categoryTotals.set(key, {
        name: expense.categoryName || 'Uncategorized',
        emoji: expense.categoryEmoji,
        total: expense.amount,
        count: 1,
      })
    }
  }

  const categoryBreakdown = Array.from(categoryTotals.values())
    .sort((a, b) => b.total - a.total)

  return res.status(200).json({
    expenses: filteredExpenses,
    summary: {
      totalAmount,
      totalDeductible,
      expenseCount,
      averageAmount,
      year,
    },
    categoryBreakdown,
  })
}

// ===========================================
// POST: Create a new expense
// ===========================================
async function handlePost(req: VercelRequest, res: VercelResponse) {
  const auth = await authenticateRequest(req)
  if (!auth) {
    return res.status(401).json({ error: 'Unauthorized' })
  }
  const { user, tenantId } = auth

  // Parse request body
  const {
    amount,        // Required: number in cents
    date,          // Required: ISO date string
    categoryId,    // Required: UUID
    vendor,        // Optional: string
    description,   // Optional: string
    expenseType,   // Optional: 'cogs' | 'operating' | 'home_office' (defaults to 'operating')
    isHomeOffice,  // Optional: boolean — true if user checked "Home Office Expense"
    extractedText, // Optional: string — raw text from AI receipt scan
  } = req.body

  // If home office, snapshot the tenant's current deduction percentage
  let homeOfficePercent: number | null = null
  if (isHomeOffice) {
    const [tenant] = await db
      .select({
        homeTotalSqft: tenants.homeTotalSqft,
        homeOfficeSqft: tenants.homeOfficeSqft,
      })
      .from(tenants)
      .where(eq(tenants.id, tenantId))
      .limit(1)

    if (tenant?.homeTotalSqft && tenant?.homeOfficeSqft && tenant.homeTotalSqft > 0) {
      homeOfficePercent = Math.round((tenant.homeOfficeSqft / tenant.homeTotalSqft) * 100)
    }
  }

  // ===========================================
  // Validation
  // ===========================================
  const errors: string[] = []

  // Amount: required, must be positive integer
  if (amount === undefined || amount === null) {
    errors.push('Amount is required')
  } else if (typeof amount !== 'number' || !Number.isInteger(amount) || amount <= 0) {
    errors.push('Amount must be a positive integer (in cents)')
  }

  // Date: required, must be valid
  if (!date) {
    errors.push('Date is required')
  } else {
    const parsedDate = new Date(date)
    if (isNaN(parsedDate.getTime())) {
      errors.push('Date must be a valid ISO date string')
    }
  }

  // Category: required, must exist and belong to tenant
  if (!categoryId) {
    errors.push('Category is required')
  } else {
    const [category] = await db
      .select()
      .from(categories)
      .where(and(
        eq(categories.id, categoryId),
        eq(categories.tenantId, tenantId)
      ))
      .limit(1)

    if (!category) {
      errors.push('Invalid category')
    }
  }

  // Expense type: optional, but must be valid if provided
  const validExpenseTypes = ['cogs', 'operating']
  if (expenseType && !validExpenseTypes.includes(expenseType)) {
    errors.push(`Expense type must be one of: ${validExpenseTypes.join(', ')}`)
  }

  // Return all validation errors at once
  if (errors.length > 0) {
    return res.status(400).json({ error: 'Validation failed', details: errors })
  }

  // ===========================================
  // Create the expense
  // ===========================================
  const [newExpense] = await db
    .insert(expenses)
    .values({
      tenantId,
      amount,
      date: new Date(date),
      categoryId,
      vendor: vendor?.trim() || null,
      description: description?.trim() || null,
      expenseType: expenseType || 'operating',
      isHomeOffice: isHomeOffice || false,
      homeOfficePercent,
      extractedText: extractedText || null,
      createdBy: user.id,
      updatedBy: user.id,
    })
    .returning()

  // Fetch the expense with category info + attachment count to return
  const [expenseWithCategory] = await db
    .select({
      id: expenses.id,
      amount: expenses.amount,
      vendor: expenses.vendor,
      description: expenses.description,
      date: expenses.date,
      categoryId: expenses.categoryId,
      categoryName: categories.name,
      categoryEmoji: categories.emoji,
      expenseType: expenses.expenseType,
      isHomeOffice: expenses.isHomeOffice,
      homeOfficePercent: expenses.homeOfficePercent,
      receiptUrl: expenses.receiptUrl,
      createdAt: expenses.createdAt,
      attachmentCount: sql<number>`(SELECT COUNT(*) FROM expense_attachments WHERE expense_attachments.expense_id = ${expenses.id})`.as('attachment_count'),
    })
    .from(expenses)
    .leftJoin(categories, eq(expenses.categoryId, categories.id))
    .where(eq(expenses.id, newExpense.id))
    .limit(1)

  return res.status(201).json({
    message: 'Expense created successfully',
    expense: expenseWithCategory,
  })
}

// ===========================================
// Main handler: Route by method
// ===========================================
export default async function handler(req: VercelRequest, res: VercelResponse) {
  try {
    switch (req.method) {
      case 'GET':
        return handleGet(req, res)
      case 'POST':
        return handlePost(req, res)
      default:
        return res.status(405).json({ error: 'Method not allowed' })
    }
  } catch (error) {
    console.error('Error in expenses API:', error)
    return res.status(500).json({ error: 'Internal server error' })
  }
}

--- FILE: ./api/categories/[id].ts ---

import type { VercelRequest, VercelResponse } from '@vercel/node'
import { db } from '../../src/db/index.js'
import { categories, expenses } from '../../src/db/schema.js'
import { eq, and, sql } from 'drizzle-orm'
import { authenticateRequest } from '../_lib/auth.js'

// ============================================
// MAIN HANDLER
// ============================================
export default async function handler(req: VercelRequest, res: VercelResponse) {
  res.setHeader('Cache-Control', 'no-store')

  const { id } = req.query
  if (!id || typeof id !== 'string') {
    return res.status(400).json({ error: 'Missing category ID' })
  }

  if (req.method === 'PUT') {
    return handlePut(req, res, id)
  } else if (req.method === 'DELETE') {
    return handleDelete(req, res, id)
  } else {
    return res.status(405).json({ error: 'Method not allowed' })
  }
}

// ============================================
// PUT — Update a category
// ============================================
async function handlePut(req: VercelRequest, res: VercelResponse, categoryId: string) {
  try {
    const auth = await authenticateRequest(req)
    if (!auth) {
      return res.status(401).json({ error: 'Unauthorized' })
    }

    const { tenantId } = auth

    // Verify category exists and belongs to this tenant
    const [existing] = await db
      .select()
      .from(categories)
      .where(and(
        eq(categories.id, categoryId),
        eq(categories.tenantId, tenantId)
      ))
      .limit(1)

    if (!existing) {
      return res.status(404).json({ error: 'Category not found' })
    }

    const { name, emoji, expenseType, homeOfficeEligible } = req.body

    // Validation
    const errors: string[] = []
    if (name !== undefined && (typeof name !== 'string' || name.trim().length === 0)) {
      errors.push('Name cannot be empty')
    }
    if (name && name.trim().length > 100) {
      errors.push('Name must be 100 characters or less')
    }
    if (expenseType !== undefined && !['operating', 'cogs'].includes(expenseType)) {
      errors.push('Invalid expense type')
    }
    // System categories can have name/emoji edited but not deleted
    // (No restriction on editing system categories for now — just deletion)
    if (errors.length > 0) {
      return res.status(400).json({ error: 'Validation failed', details: errors })
    }

    // Check for duplicate name (excluding self)
    if (name && name.trim().toLowerCase() !== existing.name.toLowerCase()) {
      const [duplicate] = await db
        .select({ id: categories.id })
        .from(categories)
        .where(and(
          eq(categories.tenantId, tenantId),
          eq(categories.isActive, true),
          sql`lower(${categories.name}) = lower(${name.trim()})`,
          sql`${categories.id} != ${categoryId}`
        ))
        .limit(1)

      if (duplicate) {
        return res.status(409).json({ error: 'A category with this name already exists' })
      }
    }

    // Build update object — only include fields that were sent
    const updates: Record<string, unknown> = {
      updatedAt: new Date(),
    }

    if (name !== undefined) updates.name = name.trim()
    if (emoji !== undefined) updates.emoji = emoji
    if (expenseType !== undefined) updates.expenseType = expenseType
    if (homeOfficeEligible !== undefined) updates.homeOfficeEligible = homeOfficeEligible

    const [updated] = await db
      .update(categories)
      .set(updates)
      .where(eq(categories.id, categoryId))
      .returning()

    return res.status(200).json({ category: updated })

  } catch (error) {
    console.error('Error updating category:', error)
    return res.status(500).json({ error: 'Internal server error' })
  }
}

// ============================================
// DELETE — Soft-delete category, reassign expenses
// ============================================
async function handleDelete(req: VercelRequest, res: VercelResponse, categoryId: string) {
  try {
    const auth = await authenticateRequest(req)
    if (!auth) {
      return res.status(401).json({ error: 'Unauthorized' })
    }

    const { tenantId } = auth

    // Verify category exists and belongs to this tenant
    const [existing] = await db
      .select()
      .from(categories)
      .where(and(
        eq(categories.id, categoryId),
        eq(categories.tenantId, tenantId),
        eq(categories.isActive, true)
      ))
      .limit(1)

    if (!existing) {
      return res.status(404).json({ error: 'Category not found' })
    }

    // System categories cannot be deleted
    if (existing.isSystem) {
      return res.status(403).json({ error: 'System categories cannot be deleted' })
    }

    // Determine reassignment target
    const { reassignTo } = req.body || {}

    let targetCategoryId: string

    if (reassignTo) {
      // Verify the target category exists and is active
      const [target] = await db
        .select({ id: categories.id })
        .from(categories)
        .where(and(
          eq(categories.id, reassignTo),
          eq(categories.tenantId, tenantId),
          eq(categories.isActive, true)
        ))
        .limit(1)

      if (!target) {
        return res.status(400).json({ error: 'Reassignment target category not found' })
      }
      targetCategoryId = target.id
    } else {
      // Default: reassign to Uncategorized
      const [uncategorized] = await db
        .select({ id: categories.id })
        .from(categories)
        .where(and(
          eq(categories.tenantId, tenantId),
          eq(categories.isSystem, true),
          eq(categories.isActive, true)
        ))
        .limit(1)

      if (!uncategorized) {
        return res.status(500).json({ error: 'Uncategorized category not found — contact support' })
      }
      targetCategoryId = uncategorized.id
    }

    // Count affected expenses
    const [affectedResult] = await db
      .select({ count: sql<number>`count(*)` })
      .from(expenses)
      .where(and(
        eq(expenses.categoryId, categoryId),
        eq(expenses.tenantId, tenantId)
      ))

    const affectedCount = Number(affectedResult?.count || 0)

    // Reassign expenses to target category
    if (affectedCount > 0) {
      await db
        .update(expenses)
        .set({
          categoryId: targetCategoryId,
          updatedAt: new Date(),
        })
        .where(and(
          eq(expenses.categoryId, categoryId),
          eq(expenses.tenantId, tenantId)
        ))
    }

    // Soft-delete the category
    await db
      .update(categories)
      .set({
        isActive: false,
        updatedAt: new Date(),
      })
      .where(eq(categories.id, categoryId))

    return res.status(200).json({
      success: true,
      reassignedExpenses: affectedCount,
      reassignedTo: targetCategoryId,
    })

  } catch (error) {
    console.error('Error deleting category:', error)
    return res.status(500).json({ error: 'Internal server error' })
  }
}


--- FILE: ./api/categories/home-office.ts ---

import type { VercelRequest, VercelResponse } from '@vercel/node'
import { db } from '../../src/db/index.js'
import { tenants } from '../../src/db/schema.js'
import { eq } from 'drizzle-orm'
import { authenticateRequest } from '../_lib/auth.js'

// ============================================
// MAIN HANDLER — PUT only
// ============================================
export default async function handler(req: VercelRequest, res: VercelResponse) {
  res.setHeader('Cache-Control', 'no-store')

  if (req.method !== 'PUT') {
    return res.status(405).json({ error: 'Method not allowed' })
  }

  try {
    const auth = await authenticateRequest(req)
    if (!auth) {
      return res.status(401).json({ error: 'Unauthorized' })
    }

    const { tenantId } = auth
    const { homeTotalSqft, homeOfficeSqft, homeOfficeIgnored } = req.body

    // Validation
    const errors: string[] = []

    if (homeTotalSqft !== undefined && homeTotalSqft !== null) {
      const total = Number(homeTotalSqft)
      if (isNaN(total) || total < 0 || total > 100000) {
        errors.push('Total square footage must be between 0 and 100,000')
      }
    }

    if (homeOfficeSqft !== undefined && homeOfficeSqft !== null) {
      const office = Number(homeOfficeSqft)
      if (isNaN(office) || office < 0 || office > 100000) {
        errors.push('Office square footage must be between 0 and 100,000')
      }
    }

    // Office can't be bigger than home
    const totalVal = homeTotalSqft !== undefined ? Number(homeTotalSqft) : null
    const officeVal = homeOfficeSqft !== undefined ? Number(homeOfficeSqft) : null
    if (totalVal !== null && officeVal !== null && officeVal > totalVal) {
      errors.push('Office square footage cannot exceed total home square footage')
    }

    if (errors.length > 0) {
      return res.status(400).json({ error: 'Validation failed', details: errors })
    }

    // Build update
    const updates: Record<string, unknown> = {
      updatedAt: new Date(),
    }

    if (homeTotalSqft !== undefined) {
      updates.homeTotalSqft = homeTotalSqft === null ? null : Math.round(Number(homeTotalSqft))
    }
    if (homeOfficeSqft !== undefined) {
      updates.homeOfficeSqft = homeOfficeSqft === null ? null : Math.round(Number(homeOfficeSqft))
    }
    if (homeOfficeIgnored !== undefined) {
      updates.homeOfficeIgnored = Boolean(homeOfficeIgnored)
    }

    const [updated] = await db
      .update(tenants)
      .set(updates)
      .where(eq(tenants.id, tenantId))
      .returning({
        homeTotalSqft: tenants.homeTotalSqft,
        homeOfficeSqft: tenants.homeOfficeSqft,
        homeOfficeIgnored: tenants.homeOfficeIgnored,
      })

    const deductionPercent = (updated.homeTotalSqft && updated.homeOfficeSqft)
      ? Math.round((updated.homeOfficeSqft / updated.homeTotalSqft) * 10000) / 100
      : null

    return res.status(200).json({
      homeOfficeSettings: {
        homeTotalSqft: updated.homeTotalSqft,
        homeOfficeSqft: updated.homeOfficeSqft,
        homeOfficeIgnored: updated.homeOfficeIgnored,
        deductionPercent,
      },
    })

  } catch (error) {
    console.error('Error updating home office settings:', error)
    return res.status(500).json({ error: 'Internal server error' })
  }
}


--- FILE: ./api/categories/default-category.ts ---

import type { VercelRequest, VercelResponse } from '@vercel/node'
import { db } from '../../src/db/index.js'
import { tenants, categories } from '../../src/db/schema.js'
import { eq, and } from 'drizzle-orm'
import { authenticateRequest } from '../_lib/auth.js'

// ============================================
// MAIN HANDLER — PUT only
// ============================================
export default async function handler(req: VercelRequest, res: VercelResponse) {
  res.setHeader('Cache-Control', 'no-store')

  if (req.method !== 'PUT') {
    return res.status(405).json({ error: 'Method not allowed' })
  }

  try {
    const auth = await authenticateRequest(req)
    if (!auth) {
      return res.status(401).json({ error: 'Unauthorized' })
    }

    const { tenantId } = auth
    const { defaultCategoryId } = req.body

    // Allow null to clear the default
    if (defaultCategoryId !== null && defaultCategoryId !== undefined) {
      // Validate that the category belongs to this tenant
      const [category] = await db
        .select({ id: categories.id })
        .from(categories)
        .where(and(
          eq(categories.id, defaultCategoryId),
          eq(categories.tenantId, tenantId)
        ))
        .limit(1)

      if (!category) {
        return res.status(400).json({ error: 'Category not found' })
      }
    }

    await db.update(tenants)
      .set({ defaultCategoryId: defaultCategoryId || null })
      .where(eq(tenants.id, tenantId))

    return res.status(200).json({ defaultCategoryId: defaultCategoryId || null })

  } catch (err) {
    console.error('Error updating default category:', err)
    return res.status(500).json({ error: 'Internal server error' })
  }
}


--- FILE: ./api/categories/index.ts ---

import type { VercelRequest, VercelResponse } from '@vercel/node'
import { db } from '../../src/db/index.js'
import { categories, expenses, tenants } from '../../src/db/schema.js'
import { eq, and, asc, sql } from 'drizzle-orm'
import { authenticateRequest } from '../_lib/auth.js'

// ============================================
// MAIN HANDLER
// ============================================
export default async function handler(req: VercelRequest, res: VercelResponse) {
  // Set no-cache for auth routes
  res.setHeader('Cache-Control', 'no-store')

  if (req.method === 'GET') {
    return handleGet(req, res)
  } else if (req.method === 'POST') {
    return handlePost(req, res)
  } else {
    return res.status(405).json({ error: 'Method not allowed' })
  }
}

// ============================================
// GET — Fetch categories with spending totals
// ============================================
async function handleGet(req: VercelRequest, res: VercelResponse) {
  try {
    const auth = await authenticateRequest(req)
    if (!auth) {
      return res.status(401).json({ error: 'Unauthorized' })
    }

    const { tenantId } = auth

    // Determine if we should include spending data
    const includeSpending = req.query.includeSpending === 'true'
    const year = req.query.year ? parseInt(req.query.year as string) : undefined

    if (includeSpending && year) {
      // JOIN with expenses to get spending totals per category for the year
      const startDate = new Date(year, 0, 1)
      const endDate = new Date(year + 1, 0, 1)

      const categoryList = await db
        .select({
          id: categories.id,
          name: categories.name,
          emoji: categories.emoji,
          expenseType: categories.expenseType,
          homeOfficeEligible: categories.homeOfficeEligible,
          isSystem: categories.isSystem,
          sortOrder: categories.sortOrder,
          isActive: categories.isActive,
          total: sql<number>`coalesce(sum(${expenses.amount}), 0)`.as('total'),
          count: sql<number>`count(${expenses.id})`.as('count'),
        })
        .from(categories)
        .leftJoin(
          expenses,
          and(
            eq(expenses.categoryId, categories.id),
            eq(expenses.tenantId, tenantId),
            sql`${expenses.date} >= ${startDate}`,
            sql`${expenses.date} < ${endDate}`
          )
        )
        .where(and(
          eq(categories.tenantId, tenantId),
          eq(categories.isActive, true)
        ))
        .groupBy(categories.id)
        .orderBy(asc(categories.sortOrder), asc(categories.name))

      // Also fetch tenant home office settings
      const [tenant] = await db
        .select({
          homeTotalSqft: tenants.homeTotalSqft,
          homeOfficeSqft: tenants.homeOfficeSqft,
          homeOfficeIgnored: tenants.homeOfficeIgnored,
          defaultCategoryId: tenants.defaultCategoryId,
        })
        .from(tenants)
        .where(eq(tenants.id, tenantId))
        .limit(1)

      return res.status(200).json({
        categories: categoryList.map(c => ({
          ...c,
          total: Number(c.total),
          count: Number(c.count),
        })),
        homeOfficeSettings: {
          homeTotalSqft: tenant?.homeTotalSqft ?? null,
          homeOfficeSqft: tenant?.homeOfficeSqft ?? null,
          homeOfficeIgnored: tenant?.homeOfficeIgnored ?? false,
          defaultCategoryId: tenant?.defaultCategoryId ?? null,
          deductionPercent: (tenant?.homeTotalSqft && tenant?.homeOfficeSqft)
            ? Math.round((tenant.homeOfficeSqft / tenant.homeTotalSqft) * 10000) / 100
            : null,
        },
      })
    }

    // Simple fetch — no spending data (used by AddExpenseSheet, etc.)
    const categoryList = await db
      .select({
        id: categories.id,
        name: categories.name,
        emoji: categories.emoji,
        expenseType: categories.expenseType,
        homeOfficeEligible: categories.homeOfficeEligible,
        isSystem: categories.isSystem,
        sortOrder: categories.sortOrder,
      })
      .from(categories)
      .where(and(
        eq(categories.tenantId, tenantId),
        eq(categories.isActive, true)
      ))
      .orderBy(asc(categories.sortOrder), asc(categories.name))

    // Fetch tenant settings (for defaultCategoryId)
    const [tenant] = await db
      .select({
        defaultCategoryId: tenants.defaultCategoryId,
      })
      .from(tenants)
      .where(eq(tenants.id, tenantId))
      .limit(1)

    return res.status(200).json({
      categories: categoryList,
      homeOfficeSettings: {
        defaultCategoryId: tenant?.defaultCategoryId ?? null,
      },
    })
  } catch (error) {
    console.error('Error fetching categories:', error)
    return res.status(500).json({ error: 'Internal server error' })
  }
}

// ============================================
// POST — Create a new category
// ============================================
async function handlePost(req: VercelRequest, res: VercelResponse) {
  try {
    const auth = await authenticateRequest(req)
    if (!auth) {
      return res.status(401).json({ error: 'Unauthorized' })
    }

    const { tenantId } = auth
    const { name, emoji, expenseType, homeOfficeEligible } = req.body

    // Validation
    const errors: string[] = []
    if (!name || typeof name !== 'string' || name.trim().length === 0) {
      errors.push('Name is required')
    }
    if (name && name.trim().length > 100) {
      errors.push('Name must be 100 characters or less')
    }
    if (expenseType && !['operating', 'cogs'].includes(expenseType)) {
      errors.push('Invalid expense type')
    }
    if (errors.length > 0) {
      return res.status(400).json({ error: 'Validation failed', details: errors })
    }

    // Check for duplicate name within this tenant
    const [existing] = await db
      .select({ id: categories.id })
      .from(categories)
      .where(and(
        eq(categories.tenantId, tenantId),
        eq(categories.isActive, true),
        sql`lower(${categories.name}) = lower(${name.trim()})`
      ))
      .limit(1)

    if (existing) {
      return res.status(409).json({ error: 'A category with this name already exists' })
    }

    // Get next sort order
    const [maxSort] = await db
      .select({ max: sql<number>`coalesce(max(${categories.sortOrder}), 0)` })
      .from(categories)
      .where(eq(categories.tenantId, tenantId))

    const resolvedType = expenseType || 'operating'
    const resolvedEligible = homeOfficeEligible ?? false

    const [newCategory] = await db
      .insert(categories)
      .values({
        tenantId,
        name: name.trim(),
        emoji: emoji || '📁',
        expenseType: resolvedType,
        homeOfficeEligible: resolvedEligible,
        sortOrder: (Number(maxSort?.max) || 0) + 1,
      })
      .returning()

    return res.status(201).json({ category: newCategory })

  } catch (error) {
    console.error('Error creating category:', error)
    return res.status(500).json({ error: 'Internal server error' })
  }
}


--- FILE: ./api/receipts/scan.ts ---

import type { VercelRequest, VercelResponse } from '@vercel/node'
import { authenticateRequest } from '../_lib/auth.js'
import { checkRateLimit, recordUsage, RECEIPT_SCAN_LIMITS } from '../_lib/rate-limit.js'

// ===========================================
// Receipt scan prompt for Claude Vision
// ===========================================
const RECEIPT_SCAN_PROMPT = `You are a receipt data extraction assistant. Analyze this receipt image and extract the following information. Return your response as a JSON object with EXACTLY this structure — no markdown, no backticks, no explanation, ONLY the JSON:

{
  "vendor": {
    "value": "Store/business name as it appears on the receipt",
    "confidence": 0.0 to 1.0
  },
  "date": {
    "value": "YYYY-MM-DD format",
    "confidence": 0.0 to 1.0
  },
  "total": {
    "value": "Total amount as a number (e.g., 45.99, not $45.99)",
    "confidence": 0.0 to 1.0
  },
  "subtotal": {
    "value": "Subtotal before tax as a number, or null if not visible",
    "confidence": 0.0 to 1.0
  },
  "tax": {
    "value": "Tax amount as a number, or null if not visible",
    "confidence": 0.0 to 1.0
  },
  "paymentMethod": {
    "value": "VISA, MASTERCARD, AMEX, CASH, DEBIT, CHECK, or null if not visible",
    "confidence": 0.0 to 1.0
  },
  "lineItems": [
    {
      "description": "Item description",
      "amount": 0.00,
      "quantity": 1
    }
  ],
  "rawText": "Complete text content of the receipt, preserving line breaks"
}

Confidence scoring guide:
- 1.0: Clearly printed, unambiguous
- 0.8-0.9: Mostly clear, minor ambiguity
- 0.5-0.7: Partially obscured, faded, or ambiguous
- Below 0.5: Guessing based on context

If a field is completely unreadable or not present, set value to null and confidence to 0.

For the date: If the year is not visible, assume the current year. If the date format is ambiguous (e.g., 03/04/2025 could be March 4 or April 3), prefer MM/DD/YYYY format (US standard) and set confidence to 0.7.

For the total: Use the FINAL total including tax, not the subtotal. If multiple total-like numbers appear, use the largest one and note the ambiguity in confidence.`

// ===========================================
// POST: Scan a receipt image using Claude Vision
// ===========================================
export default async function handler(req: VercelRequest, res: VercelResponse) {
  res.setHeader('Cache-Control', 'no-store')

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' })
  }

  // Guard: API key must be configured
  if (!process.env.ANTHROPIC_API_KEY) {
    console.error('ANTHROPIC_API_KEY not configured')
    return res.status(503).json({ error: 'Receipt scanning not configured' })
  }

  try {
    // 2a. Authenticate
    const auth = await authenticateRequest(req)
    if (!auth) {
      return res.status(401).json({ error: 'Unauthorized' })
    }
    const { tenantId } = auth

    // 2b. Rate limit check
    const rateCheck = await checkRateLimit(tenantId, RECEIPT_SCAN_LIMITS)
    if (!rateCheck.allowed) {
      return res.status(429).json({
        error: 'Rate limit exceeded',
        limitHit: rateCheck.limitHit,
        retryAfterSeconds: rateCheck.retryAfterSeconds,
      })
    }

    // 2c. Validate blobUrl
    const { blobUrl } = req.body || {}

    if (!blobUrl || typeof blobUrl !== 'string') {
      return res.status(400).json({ error: 'blobUrl is required' })
    }

    if (!blobUrl.includes('.public.blob.vercel-storage.com')) {
      return res.status(400).json({ error: 'Invalid blob URL' })
    }

    // 2d. Fetch the image
    const imageResponse = await fetch(blobUrl)
    if (!imageResponse.ok) {
      return res.status(400).json({ error: 'Failed to fetch image from storage' })
    }

    const contentType = imageResponse.headers.get('content-type') || ''
    const supportedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/heic']

    if (!supportedTypes.some(t => contentType.includes(t))) {
      return res.status(400).json({
        error: 'Unsupported file type for scanning. Please use JPEG, PNG, or WebP images.',
        fileType: contentType,
      })
    }

    const imageBuffer = await imageResponse.arrayBuffer()
    const base64Data = Buffer.from(imageBuffer).toString('base64')

    // Determine the media type for the API (normalize content-type)
    const mediaType = contentType.split(';')[0].trim()

    // 2e. Call Claude Vision API
    const anthropicResponse = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'x-api-key': process.env.ANTHROPIC_API_KEY!,
        'anthropic-version': '2023-06-01',
        'content-type': 'application/json',
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1024,
        messages: [{
          role: 'user',
          content: [
            {
              type: 'image',
              source: {
                type: 'base64',
                media_type: mediaType,
                data: base64Data,
              },
            },
            {
              type: 'text',
              text: RECEIPT_SCAN_PROMPT,
            },
          ],
        }],
      }),
    })

    // 2g. Parse response and handle errors
    if (!anthropicResponse.ok) {
      const errorBody = await anthropicResponse.text()
      console.error('Anthropic API error:', anthropicResponse.status, errorBody)
      return res.status(500).json({ error: 'Receipt scanning service unavailable' })
    }

    const anthropicData = await anthropicResponse.json()
    const textContent = anthropicData.content?.find((block: any) => block.type === 'text')

    if (!textContent?.text) {
      return res.status(500).json({ error: 'No response from scanning service' })
    }

    // Parse the JSON response — Claude sometimes wraps in backticks despite instructions
    let scanResult
    try {
      const cleanJson = textContent.text
        .replace(/^```json?\n?/i, '')
        .replace(/\n?```$/i, '')
        .trim()
      scanResult = JSON.parse(cleanJson)
    } catch {
      console.error('Failed to parse scan result:', textContent.text)
      return res.status(500).json({ error: 'Failed to parse receipt data' })
    }

    // 2h. Record usage and return
    await recordUsage(tenantId, 'receipt_scan')

    return res.status(200).json({
      success: true,
      data: scanResult,
    })
  } catch (error) {
    console.error('Error in receipt scan API:', error)
    return res.status(500).json({ error: 'Internal server error' })
  }
}


--- FILE: ./api/invites/validate.ts ---

import type { VercelRequest, VercelResponse } from '@vercel/node';
import { db } from '../../src/db/index.js';
import { invites, tenants } from '../../src/db/schema.js';
import { eq } from 'drizzle-orm';

export default async function handler(req: VercelRequest, res: VercelResponse) {
  res.setHeader('Cache-Control', 'no-store');

  if (req.method !== 'GET') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  const { token } = req.query;

  if (!token || typeof token !== 'string') {
    return res.status(400).json({ error: 'Missing token' });
  }

  try {
    const [invite] = await db
      .select({
        id: invites.id,
        email: invites.email,
        status: invites.status,
        expiresAt: invites.expiresAt,
        tenantName: tenants.name,
      })
      .from(invites)
      .innerJoin(tenants, eq(invites.tenantId, tenants.id))
      .where(eq(invites.token, token))
      .limit(1);

    if (!invite) {
      return res.status(404).json({ error: 'Invalid invite link', valid: false });
    }

    if (invite.status === 'accepted') {
      return res.status(200).json({ valid: false, reason: 'already_used', businessName: invite.tenantName });
    }

    if (invite.status === 'expired' || new Date(invite.expiresAt) < new Date()) {
      return res.status(200).json({ valid: false, reason: 'expired', businessName: invite.tenantName });
    }

    return res.status(200).json({
      valid: true,
      businessName: invite.tenantName,
      email: invite.email,
    });

  } catch (err) {
    console.error('Error validating invite:', err);
    return res.status(500).json({ error: 'Failed to validate invite' });
  }
}

--- FILE: ./api/mileage/[id].ts ---

import type { VercelRequest, VercelResponse } from '@vercel/node'
import { db } from '../../src/db/index.js'
import { mileageTrips } from '../../src/db/schema.js'
import { eq, and } from 'drizzle-orm'
import { authenticateRequest } from '../_lib/auth.js'

// ===========================================
// GET: Fetch single trip
// ===========================================
async function handleGet(req: VercelRequest, res: VercelResponse) {
  const auth = await authenticateRequest(req)
  if (!auth) {
    return res.status(401).json({ error: 'Unauthorized' })
  }
  const { tenantId } = auth

  const tripId = req.query.id as string

  const [trip] = await db
    .select()
    .from(mileageTrips)
    .where(and(
      eq(mileageTrips.id, tripId),
      eq(mileageTrips.tenantId, tenantId)
    ))
    .limit(1)

  if (!trip) {
    return res.status(404).json({ error: 'Trip not found' })
  }

  return res.status(200).json({
    trip: {
      ...trip,
      displayMiles: trip.isRoundTrip ? trip.distanceMiles * 2 : trip.distanceMiles,
    },
  })
}

// ===========================================
// PUT: Update trip
// ===========================================
async function handlePut(req: VercelRequest, res: VercelResponse) {
  const auth = await authenticateRequest(req)
  if (!auth) {
    return res.status(401).json({ error: 'Unauthorized' })
  }
  const { user, tenantId } = auth

  const tripId = req.query.id as string

  // Verify trip exists and belongs to tenant
  const [existingTrip] = await db
    .select()
    .from(mileageTrips)
    .where(and(
      eq(mileageTrips.id, tripId),
      eq(mileageTrips.tenantId, tenantId)
    ))
    .limit(1)

  if (!existingTrip) {
    return res.status(404).json({ error: 'Trip not found' })
  }

  const { date, description, startLocation, endLocation, distanceMiles, isRoundTrip } = req.body

  // Validation
  const errors: string[] = []

  if (date !== undefined) {
    const parsedDate = new Date(date)
    if (isNaN(parsedDate.getTime())) {
      errors.push('Invalid date format')
    }
  }

  if (startLocation !== undefined && (typeof startLocation !== 'string' || startLocation.trim().length === 0)) {
    errors.push('Start location cannot be empty')
  }

  if (endLocation !== undefined && (typeof endLocation !== 'string' || endLocation.trim().length === 0)) {
    errors.push('End location cannot be empty')
  }

  if (distanceMiles !== undefined && (typeof distanceMiles !== 'number' || distanceMiles <= 0)) {
    errors.push('Distance must be a positive number')
  }

  if (errors.length > 0) {
    return res.status(400).json({ error: 'Validation failed', details: errors })
  }

  // Build update object
  const updates: Partial<typeof mileageTrips.$inferInsert> = {
    updatedBy: user.id,
    updatedAt: new Date(),
  }

  if (date !== undefined) updates.date = new Date(date)
  if (description !== undefined) updates.description = description?.trim() || null
  if (startLocation !== undefined) updates.startLocation = startLocation.trim()
  if (endLocation !== undefined) updates.endLocation = endLocation.trim()
  if (distanceMiles !== undefined) updates.distanceMiles = Math.round(distanceMiles)
  if (isRoundTrip !== undefined) updates.isRoundTrip = Boolean(isRoundTrip)

  const [updatedTrip] = await db
    .update(mileageTrips)
    .set(updates)
    .where(eq(mileageTrips.id, tripId))
    .returning()

  return res.status(200).json({
    message: 'Trip updated successfully',
    trip: {
      ...updatedTrip,
      displayMiles: updatedTrip.isRoundTrip ? updatedTrip.distanceMiles * 2 : updatedTrip.distanceMiles,
    },
  })
}

// ===========================================
// DELETE: Delete trip
// ===========================================
async function handleDelete(req: VercelRequest, res: VercelResponse) {
  const auth = await authenticateRequest(req)
  if (!auth) {
    return res.status(401).json({ error: 'Unauthorized' })
  }
  const { tenantId } = auth

  const tripId = req.query.id as string

  // Verify trip exists and belongs to tenant
  const [existingTrip] = await db
    .select()
    .from(mileageTrips)
    .where(and(
      eq(mileageTrips.id, tripId),
      eq(mileageTrips.tenantId, tenantId)
    ))
    .limit(1)

  if (!existingTrip) {
    return res.status(404).json({ error: 'Trip not found' })
  }

  await db
    .delete(mileageTrips)
    .where(eq(mileageTrips.id, tripId))

  return res.status(200).json({ message: 'Trip deleted successfully' })
}

// ===========================================
// Main handler
// ===========================================
export default async function handler(req: VercelRequest, res: VercelResponse) {
  try {
    switch (req.method) {
      case 'GET':
        return handleGet(req, res)
      case 'PUT':
        return handlePut(req, res)
      case 'DELETE':
        return handleDelete(req, res)
      default:
        return res.status(405).json({ error: 'Method not allowed' })
    }
  } catch (error) {
    console.error('Error in mileage/[id] API:', error)
    return res.status(500).json({ error: 'Internal server error' })
  }
}


--- FILE: ./api/mileage/index.ts ---

import type { VercelRequest, VercelResponse } from '@vercel/node'
import { db } from '../../src/db/index.js'
import { mileageTrips } from '../../src/db/schema.js'
import { eq, and, desc, gte, lt } from 'drizzle-orm'
import { authenticateRequest } from '../_lib/auth.js'

// ===========================================
// GET: Fetch mileage trips
// ===========================================
async function handleGet(req: VercelRequest, res: VercelResponse) {
  const auth = await authenticateRequest(req)
  if (!auth) {
    return res.status(401).json({ error: 'Unauthorized' })
  }
  const { tenantId } = auth

  // Get query params for filtering
  const year = req.query.year ? parseInt(req.query.year as string) : new Date().getFullYear()
  const limit = req.query.limit ? parseInt(req.query.limit as string) : 500

  // Date range for year filter
  const startOfYear = new Date(year, 0, 1)
  const endOfYear = new Date(year + 1, 0, 1)

  // Fetch trips
  const trips = await db
    .select({
      id: mileageTrips.id,
      date: mileageTrips.date,
      description: mileageTrips.description,
      startLocation: mileageTrips.startLocation,
      endLocation: mileageTrips.endLocation,
      distanceMiles: mileageTrips.distanceMiles,
      isRoundTrip: mileageTrips.isRoundTrip,
      createdAt: mileageTrips.createdAt,
    })
    .from(mileageTrips)
    .where(and(
      eq(mileageTrips.tenantId, tenantId),
      gte(mileageTrips.date, startOfYear),
      lt(mileageTrips.date, endOfYear)
    ))
    .orderBy(desc(mileageTrips.date))
    .limit(limit)

  // Calculate summary
  const totalMiles = trips.reduce((sum, trip) => {
    const miles = trip.isRoundTrip ? trip.distanceMiles * 2 : trip.distanceMiles
    return sum + miles
  }, 0)

  // IRS standard mileage rate for 2025 (70 cents)
  const mileageRate = 0.70
  const estimatedDeduction = (totalMiles / 100) * mileageRate

  return res.status(200).json({
    trips: trips.map(trip => ({
      ...trip,
      // Include calculated round-trip miles for display
      displayMiles: trip.isRoundTrip ? trip.distanceMiles * 2 : trip.distanceMiles,
    })),
    summary: {
      totalMiles,
      tripCount: trips.length,
      estimatedDeduction: Math.round(estimatedDeduction * 100), // Store as cents
      year,
    },
  })
}

// ===========================================
// POST: Create new mileage trip
// ===========================================
async function handlePost(req: VercelRequest, res: VercelResponse) {
  const auth = await authenticateRequest(req)
  if (!auth) {
    return res.status(401).json({ error: 'Unauthorized' })
  }
  const { user, tenantId } = auth

  // Parse request body
  const { date, description, startLocation, endLocation, distanceMiles, isRoundTrip } = req.body

  // Validation
  const errors: string[] = []

  if (!date) {
    errors.push('Date is required')
  } else {
    const parsedDate = new Date(date)
    if (isNaN(parsedDate.getTime())) {
      errors.push('Invalid date format')
    }
  }

  if (!startLocation || typeof startLocation !== 'string' || startLocation.trim().length === 0) {
    errors.push('Start location is required')
  }

  if (!endLocation || typeof endLocation !== 'string' || endLocation.trim().length === 0) {
    errors.push('End location is required')
  }

  if (distanceMiles === undefined || distanceMiles === null) {
    errors.push('Distance is required')
  } else if (typeof distanceMiles !== 'number' || distanceMiles <= 0) {
    errors.push('Distance must be a positive number')
  }

  if (errors.length > 0) {
    return res.status(400).json({ error: 'Validation failed', details: errors })
  }

  // Create the trip
  const [newTrip] = await db
    .insert(mileageTrips)
    .values({
      tenantId,
      date: new Date(date),
      description: description?.trim() || null,
      startLocation: startLocation.trim(),
      endLocation: endLocation.trim(),
      distanceMiles: Math.round(distanceMiles), // Already in miles * 100 from client
      isRoundTrip: Boolean(isRoundTrip),
      createdBy: user.id,
      updatedBy: user.id,
    })
    .returning()

  return res.status(201).json({
    message: 'Trip logged successfully',
    trip: {
      ...newTrip,
      displayMiles: newTrip.isRoundTrip ? newTrip.distanceMiles * 2 : newTrip.distanceMiles,
    },
  })
}

// ===========================================
// Main handler: Route by method
// ===========================================
export default async function handler(req: VercelRequest, res: VercelResponse) {
  try {
    switch (req.method) {
      case 'GET':
        return handleGet(req, res)
      case 'POST':
        return handlePost(req, res)
      default:
        return res.status(405).json({ error: 'Method not allowed' })
    }
  } catch (error) {
    console.error('Error in mileage API:', error)
    return res.status(500).json({ error: 'Internal server error' })
  }
}


--- FILE: ./src/components/AddMileageSheet.tsx ---

import { useState, useEffect, useRef, useCallback } from 'react'
import { useTenant } from '../hooks/useTenant'

interface AddMileageSheetProps {
  isOpen: boolean
  onClose: () => void
  onSuccess: () => void
}

interface PlaceData {
  address: string
  location: { lat: number; lng: number } | null
}

export function AddMileageSheet({ isOpen, onClose, onSuccess }: AddMileageSheetProps) {
  const { subdomain } = useTenant()
  
  // Form state
  const [date, setDate] = useState(() => {
    const now = new Date()
    return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`
  })
  const [description, setDescription] = useState('')
  const [startLocation, setStartLocation] = useState<PlaceData>({ address: '', location: null })
  const [endLocation, setEndLocation] = useState<PlaceData>({ address: '', location: null })
  const [distanceMiles, setDistanceMiles] = useState<number | null>(null)
  const [isRoundTrip, setIsRoundTrip] = useState(false)
  const [manualDistance, setManualDistance] = useState('')
  const [useManualDistance, setUseManualDistance] = useState(false)
  
  // UI state
  const [submitting, setSubmitting] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [calculatingDistance, setCalculatingDistance] = useState(false)
  const [googleLoaded, setGoogleLoaded] = useState(false)
  
  // Refs for the autocomplete containers
  const startContainerRef = useRef<HTMLDivElement>(null)
  const endContainerRef = useRef<HTMLDivElement>(null)
  const startAutocompleteRef = useRef<HTMLElement | null>(null)
  const endAutocompleteRef = useRef<HTMLElement | null>(null)

  // Load Google Maps script with beta channel for new Places API
  useEffect(() => {
    // Check if already loaded
    if (typeof window.google?.maps?.importLibrary === 'function') {
      setGoogleLoaded(true)
      return
    }

    // Check if script is already loading
    if (document.querySelector('script[src*="maps.googleapis.com"]')) {
      const checkLoaded = setInterval(() => {
        if (typeof window.google?.maps?.importLibrary === 'function') {
          setGoogleLoaded(true)
          clearInterval(checkLoaded)
        }
      }, 100)
      return () => clearInterval(checkLoaded)
    }

    // Load the script with beta channel for PlaceAutocompleteElement
    const script = document.createElement('script')
    script.src = `https://maps.googleapis.com/maps/api/js?key=${import.meta.env.VITE_GOOGLE_MAPS_API_KEY}&libraries=places&v=beta`
    script.async = true
    script.defer = true
    script.onload = () => {
      setGoogleLoaded(true)
    }
    script.onerror = () => {
      console.error('Failed to load Google Maps')
      setError('Failed to load Google Maps. You can enter addresses manually.')
      setUseManualDistance(true)
    }
    document.head.appendChild(script)
  }, [])

  // Initialize autocomplete elements when Google is loaded and sheet is open
  useEffect(() => {
    if (!googleLoaded || !isOpen) return

    const initAutocomplete = async () => {
      try {
        // Import the places library
        const { PlaceAutocompleteElement } = await window.google.maps.importLibrary('places') as google.maps.PlacesLibrary

        // Create start location autocomplete
        if (startContainerRef.current && !startAutocompleteRef.current) {
          const startAutocomplete = new PlaceAutocompleteElement({})
          startAutocomplete.style.width = '100%'
          startContainerRef.current.innerHTML = ''
          startContainerRef.current.appendChild(startAutocomplete)
          startAutocompleteRef.current = startAutocomplete

          startAutocomplete.addEventListener('gmp-select', async (event: any) => {
            const placePrediction = event.placePrediction
            if (placePrediction) {
              const place = placePrediction.toPlace()
              await place.fetchFields({ fields: ['formattedAddress', 'location'] })
              const location = place.location
              setStartLocation({
                address: place.formattedAddress || '',
                location: location ? { lat: location.lat(), lng: location.lng() } : null
              })
            }
          })
        }

        // Create end location autocomplete
        if (endContainerRef.current && !endAutocompleteRef.current) {
          const endAutocomplete = new PlaceAutocompleteElement({})
          endAutocomplete.style.width = '100%'
          endContainerRef.current.innerHTML = ''
          endContainerRef.current.appendChild(endAutocomplete)
          endAutocompleteRef.current = endAutocomplete

          endAutocomplete.addEventListener('gmp-select', async (event: any) => {
            const placePrediction = event.placePrediction
            if (placePrediction) {
              const place = placePrediction.toPlace()
              await place.fetchFields({ fields: ['formattedAddress', 'location'] })
              const location = place.location
              setEndLocation({
                address: place.formattedAddress || '',
                location: location ? { lat: location.lat(), lng: location.lng() } : null
              })
            }
          })
        }
      } catch (err) {
        console.error('Error initializing autocomplete:', err)
        setError('Failed to initialize address search. You can enter addresses manually.')
        setUseManualDistance(true)
      }
    }

    // Small delay to ensure containers are rendered
    const timer = setTimeout(initAutocomplete, 100)
    return () => clearTimeout(timer)
  }, [googleLoaded, isOpen])

  // Calculate distance when both locations are set
  const calculateDistance = useCallback(async () => {
    if (!startLocation.location || !endLocation.location) {
      return
    }

    setCalculatingDistance(true)
    setError(null)

    try {
      const { DistanceMatrixService } = await window.google.maps.importLibrary('routes') as google.maps.RoutesLibrary
      const service = new DistanceMatrixService()
      
      const response = await service.getDistanceMatrix({
        origins: [startLocation.location],
        destinations: [endLocation.location],
        travelMode: google.maps.TravelMode.DRIVING,
        unitSystem: google.maps.UnitSystem.IMPERIAL,
      })

      const element = response.rows[0]?.elements[0]
      if (element?.status === 'OK' && element.distance) {
        // Distance comes in meters, convert to miles * 100 for storage
        const miles = element.distance.value / 1609.344
        setDistanceMiles(Math.round(miles * 100))
        setUseManualDistance(false)
      } else {
        setError('Could not calculate distance. Please enter manually.')
        setUseManualDistance(true)
      }
    } catch (err) {
      console.error('Distance calculation error:', err)
      setError('Could not calculate distance. Please enter manually.')
      setUseManualDistance(true)
    } finally {
      setCalculatingDistance(false)
    }
  }, [startLocation.location, endLocation.location])

  // Trigger distance calculation when both places are selected
  useEffect(() => {
    if (startLocation.location && endLocation.location && !useManualDistance) {
      calculateDistance()
    }
  }, [startLocation.location, endLocation.location, calculateDistance, useManualDistance])

  // Reset form when sheet closes
  useEffect(() => {
    if (!isOpen) {
      const now = new Date()
      setDate(`${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`)
      setDescription('')
      setStartLocation({ address: '', location: null })
      setEndLocation({ address: '', location: null })
      setDistanceMiles(null)
      setIsRoundTrip(false)
      setManualDistance('')
      setUseManualDistance(false)
      setError(null)
      
      // Clear autocomplete elements
      if (startContainerRef.current) {
        startContainerRef.current.innerHTML = ''
      }
      if (endContainerRef.current) {
        endContainerRef.current.innerHTML = ''
      }
      startAutocompleteRef.current = null
      endAutocompleteRef.current = null
    }
  }, [isOpen])

  // Format miles for display (stored as miles * 100)
  const formatMiles = (miles: number) => (miles / 100).toFixed(1)

  // Get the effective distance (calculated or manual)
  const getEffectiveDistance = (): number | null => {
    if (useManualDistance && manualDistance) {
      return Math.round(parseFloat(manualDistance) * 100)
    }
    return distanceMiles
  }

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault()
    setError(null)

    const effectiveDistance = getEffectiveDistance()
    const startAddr = startLocation.address || (startContainerRef.current?.querySelector('input') as HTMLInputElement)?.value || ''
    const endAddr = endLocation.address || (endContainerRef.current?.querySelector('input') as HTMLInputElement)?.value || ''

    // Client-side validation
    if (!startAddr.trim()) {
      setError('Start location is required')
      return
    }
    if (!endAddr.trim()) {
      setError('End location is required')
      return
    }
    if (!effectiveDistance || effectiveDistance <= 0) {
      setError('Distance is required')
      return
    }

    setSubmitting(true)

    try {
      const response = await fetch(`/api/mileage?tenant=${subdomain}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          date: date + 'T12:00:00.000Z',
          description: description.trim() || null,
          startLocation: startAddr.trim(),
          endLocation: endAddr.trim(),
          distanceMiles: effectiveDistance,
          isRoundTrip,
        }),
      })

      if (!response.ok) {
        const data = await response.json()
        throw new Error(data.details?.join(', ') || data.error || 'Failed to log trip')
      }

      onSuccess()
      onClose()
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Something went wrong')
    } finally {
      setSubmitting(false)
    }
  }

  function handleBackdropClick(e: React.MouseEvent) {
    if (e.target === e.currentTarget) {
      onClose()
    }
  }

  const effectiveDistance = getEffectiveDistance()
  const displayDistance = effectiveDistance ? formatMiles(effectiveDistance) : null
  const tripDistance = displayDistance && isRoundTrip ? formatMiles(effectiveDistance! * 2) : displayDistance

  return (
    <>
      {/* Backdrop */}
      <div 
        className={`sheet-backdrop ${isOpen ? 'sheet-backdrop--open' : ''}`}
        onClick={handleBackdropClick}
      />

      {/* Bottom Sheet */}
      <div className={`bottom-sheet ${isOpen ? 'bottom-sheet--open' : ''}`}>
        {/* Handle bar */}
        <div className="bottom-sheet__handle" onClick={onClose}>
          <div className="bottom-sheet__handle-bar" />
        </div>

        {/* Header */}
        <div className="bottom-sheet__header">
          <h2 className="bottom-sheet__title">Log Trip</h2>
          <button 
            className="bottom-sheet__close"
            onClick={onClose}
            aria-label="Close"
          >
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path d="M18 6 6 18M6 6l12 12" />
            </svg>
          </button>
        </div>

        {/* Form */}
        <form className="bottom-sheet__form" onSubmit={handleSubmit}>
          {/* Error Message */}
          {error && (
            <div className="form-error">
              {error}
            </div>
          )}

          {/* Date */}
          <div className="form-group">
            <label htmlFor="trip-date" className="form-label">Date *</label>
            <input
              type="date"
              id="trip-date"
              className="form-input"
              value={date}
              onChange={(e) => setDate(e.target.value)}
              required
            />
          </div>

          {/* Start Location */}
          <div className="form-group">
            <label className="form-label">Start Location *</label>
            {googleLoaded && !useManualDistance ? (
              <div ref={startContainerRef} className="autocomplete-container" />
            ) : (
              <input
                type="text"
                className="form-input"
                placeholder="Enter starting address"
                value={startLocation.address}
                onChange={(e) => setStartLocation({ address: e.target.value, location: null })}
                required
              />
            )}
          </div>

          {/* End Location */}
          <div className="form-group">
            <label className="form-label">End Location *</label>
            {googleLoaded && !useManualDistance ? (
              <div ref={endContainerRef} className="autocomplete-container" />
            ) : (
              <input
                type="text"
                className="form-input"
                placeholder="Enter destination address"
                value={endLocation.address}
                onChange={(e) => setEndLocation({ address: e.target.value, location: null })}
                required
              />
            )}
          </div>

          {/* Distance Display / Manual Entry */}
          <div className="form-group">
            <label className="form-label">Distance</label>
            
            {calculatingDistance ? (
              <div className="distance-calculating">
                <span className="spinner" /> Calculating...
              </div>
            ) : displayDistance && !useManualDistance ? (
              <div className="distance-display">
                <span className="distance-value">{displayDistance} miles</span>
                {isRoundTrip && (
                  <span className="distance-round-trip">({tripDistance} mi round trip)</span>
                )}
                <button 
                  type="button" 
                  className="distance-edit-btn"
                  onClick={() => {
                    setUseManualDistance(true)
                    setManualDistance((effectiveDistance! / 100).toString())
                  }}
                >
                  Edit
                </button>
              </div>
            ) : (
              <div className="input-with-suffix">
                <input
                  type="number"
                  className="form-input form-input--with-suffix"
                  placeholder="0.0"
                  step="0.1"
                  min="0.1"
                  value={manualDistance}
                  onChange={(e) => setManualDistance(e.target.value)}
                  required={useManualDistance || !distanceMiles}
                />
                <span className="input-suffix">miles</span>
              </div>
            )}
          </div>

          {/* Round Trip Toggle */}
          <div className="form-group form-group--horizontal">
            <label htmlFor="round-trip" className="form-label">Round Trip</label>
            <button
              type="button"
              id="round-trip"
              className={`toggle ${isRoundTrip ? 'toggle--on' : ''}`}
              onClick={() => setIsRoundTrip(!isRoundTrip)}
              aria-pressed={isRoundTrip}
            >
              <span className="toggle__slider" />
            </button>
          </div>

          {/* Description (Optional) */}
          <div className="form-group">
            <label htmlFor="trip-description" className="form-label">Description (Optional)</label>
            <input
              type="text"
              id="trip-description"
              className="form-input"
              placeholder="e.g., Client meeting, Supply pickup"
              value={description}
              onChange={(e) => setDescription(e.target.value)}
            />
          </div>

          {/* Submit Button */}
          <button 
            type="submit" 
            className="btn btn--primary btn--full"
            disabled={submitting || calculatingDistance}
          >
            {submitting ? 'Saving...' : 'Log Trip'}
          </button>
        </form>
      </div>
    </>
  )
}

--- FILE: ./src/components/ExpenseDetailSheet.tsx ---

import { useState, useEffect } from 'react'
import { useTenant } from '../hooks/useTenant'
import { useScanReceipt, type ScanResult } from '../hooks/useScanReceipt'
import {
  uploadToBlob,
  linkAttachmentToExpense,
  validateFile,
  formatFileSize,
  ALLOWED_FILE_ACCEPT,
} from '../utils/attachment-upload'

// Get saved preference from localStorage
function getDefaultMode(): 'view' | 'edit' {
  if (typeof window === 'undefined') return 'view'
  return (localStorage.getItem('expenseDetailMode') as 'view' | 'edit') || 'view'
}

interface Category {
  id: string
  name: string
  emoji: string | null
  expenseType?: string
  homeOfficeEligible?: boolean
}

interface Expense {
  id: string
  amount: number
  vendor: string | null
  description: string | null
  date: string
  categoryId: string | null
  categoryName: string | null
  categoryEmoji: string | null
  expenseType?: string
  isHomeOffice?: boolean
  homeOfficePercent?: number | null
}

interface Attachment {
  id: string
  blobUrl: string
  fileName: string
  fileSize: number
  mimeType: string
  createdAt: string
}

interface ExpenseDetailSheetProps {
  expense: Expense | null
  isOpen: boolean
  onClose: () => void
  onUpdate: () => void
  onDelete: () => void
}

export function ExpenseDetailSheet({ expense, isOpen, onClose, onUpdate, onDelete }: ExpenseDetailSheetProps) {
  const { subdomain } = useTenant()
  const { scanResult, isScanning, scanError, scanReceipt, clearScan } = useScanReceipt()

  // Mode: 'view' or 'edit' (persisted to localStorage)
  const [mode, setMode] = useState<'view' | 'edit'>(getDefaultMode)
  
  // Persist mode changes to localStorage
  const handleModeChange = (newMode: 'view' | 'edit') => {
    setMode(newMode)
    localStorage.setItem('expenseDetailMode', newMode)
  }
  
  // Edit form state
  const [amount, setAmount] = useState('')
  const [vendor, setVendor] = useState('')
  const [description, setDescription] = useState('')
  const [date, setDate] = useState('')
  const [categoryId, setCategoryId] = useState('')
  const [expenseType, setExpenseType] = useState<'operating' | 'cogs'>('operating')
  const [isHomeOffice, setIsHomeOffice] = useState(false)
  const [extractedText, setExtractedText] = useState<string | null>(null)

  // UI state
  const [categories, setCategories] = useState<Category[]>([])
  const [loadingCategories, setLoadingCategories] = useState(false)
  const [submitting, setSubmitting] = useState(false)
  const [deleting, setDeleting] = useState(false)
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false)
  const [error, setError] = useState<string | null>(null)

  // Attachment state
  const [attachments, setAttachments] = useState<Attachment[]>([])
  const [loadingAttachments, setLoadingAttachments] = useState(false)
  const [uploading, setUploading] = useState(false)
  const [uploadStatus, setUploadStatus] = useState<string | null>(null)
  const [lightboxUrl, setLightboxUrl] = useState<string | null>(null)

  // Derived: is the selected category home-office-eligible?
  const selectedCategory = categories.find(c => c.id === categoryId)
  const showHomeOfficeCheckbox = selectedCategory?.homeOfficeEligible === true

  // Sync expense type and home office when category changes in edit mode
  // BUT only after categories have loaded — otherwise we'd wipe the saved value
  useEffect(() => {
    if (categories.length > 0) {
      if (selectedCategory) {
        const catType = selectedCategory.expenseType === 'home_office' ? 'operating' : selectedCategory.expenseType
        setExpenseType((catType as 'operating' | 'cogs') || 'operating')
      }
      if (!showHomeOfficeCheckbox) {
        setIsHomeOffice(false)
      }
    }
  }, [categoryId, showHomeOfficeCheckbox, categories.length])

  // Populate form when expense changes or sheet opens
  useEffect(() => {
    if (expense && isOpen) {
      setAmount(String(expense.amount / 100))
      setVendor(expense.vendor || '')
      setDescription(expense.description || '')
      setDate(expense.date.substring(0, 10))
      setCategoryId(expense.categoryId || '')
      const type = expense.expenseType === 'home_office' ? 'operating' : expense.expenseType
      setExpenseType((type as 'operating' | 'cogs') || 'operating')
      setIsHomeOffice(expense.isHomeOffice || false)
      setMode(getDefaultMode())
      setError(null)
      setShowDeleteConfirm(false)
    }
  }, [expense, isOpen])

  // Fetch categories when entering edit mode
  useEffect(() => {
    if (mode === 'edit' && categories.length === 0 && subdomain) {
      async function fetchCategories() {
        setLoadingCategories(true)
        try {
          const response = await fetch(`/api/categories?tenant=${subdomain}`)
          if (response.ok) {
            const data = await response.json()
            setCategories([...data.categories].sort((a: Category, b: Category) => a.name.localeCompare(b.name)))
          }
        } catch (err) {
          console.error('Error fetching categories:', err)
        } finally {
          setLoadingCategories(false)
        }
      }
      fetchCategories()
    }
  }, [mode, categories.length, subdomain])

  // Fetch attachments when sheet opens
  useEffect(() => {
    if (isOpen && expense && subdomain) {
      async function fetchAttachments() {
        setLoadingAttachments(true)
        try {
          const response = await fetch(`/api/attachments?expenseId=${expense!.id}&tenant=${subdomain}`)
          if (response.ok) {
            const data = await response.json()
            setAttachments(data.attachments)
          }
        } catch (err) {
          console.error('Error fetching attachments:', err)
        } finally {
          setLoadingAttachments(false)
        }
      }
      fetchAttachments()
    }
  }, [isOpen, expense, subdomain])

  // Reset when sheet closes
  useEffect(() => {
    if (!isOpen) {
      const timer = setTimeout(() => {
        setMode('view')
        setError(null)
        setShowDeleteConfirm(false)
        setAttachments([])
        setLightboxUrl(null)
        setUploadStatus(null)
        setExtractedText(null)
        clearScan()
      }, 300)
      return () => clearTimeout(timer)
    }
  }, [isOpen])

  // Handle file upload — client-side upload directly to Vercel Blob
  async function handleFileUpload(e: React.ChangeEvent<HTMLInputElement>) {
    const file = e.target.files?.[0]
    if (!file || !expense) return

    // Reset the input so the same file can be re-selected
    e.target.value = ''

    const validationError = validateFile(file)
    if (validationError) {
      setError(validationError)
      return
    }

    try {
      setUploading(true)
      setUploadStatus(null)
      setError(null)

      // Upload to Vercel Blob (compresses if needed)
      const blobPathPrefix = `${subdomain}/${expense.id}`
      const pending = await uploadToBlob(file, subdomain!, blobPathPrefix, (progress) => {
        setUploadStatus(progress.message || null)
      })

      // Record the attachment in our database
      await linkAttachmentToExpense(pending, expense.id, subdomain!)

      // Refresh attachments list
      const response = await fetch(`/api/attachments?expenseId=${expense.id}&tenant=${subdomain}`)
      if (response.ok) {
        const data = await response.json()
        setAttachments(data.attachments)
      }
      setUploadStatus(null)
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Upload failed')
      setUploadStatus(null)
    } finally {
      setUploading(false)
    }
  }

  // Handle attachment delete
  async function handleDeleteAttachment(attachmentId: string) {
    try {
      const response = await fetch(`/api/attachments/${attachmentId}?tenant=${subdomain}`, {
        method: 'DELETE',
      })

      if (!response.ok) {
        const data = await response.json()
        throw new Error(data.error || 'Failed to delete attachment')
      }

      setAttachments(prev => prev.filter(a => a.id !== attachmentId))
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to delete attachment')
    }
  }

  // Format cents to dollars for display
  const formatMoney = (cents: number) => {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
    }).format(cents / 100)
  }

  // Format date for display
  // Parse YYYY-MM-DD directly to avoid timezone shift —
  // new Date("2026-01-03") parses as UTC midnight, which shifts backward in US timezones
  const formatDate = (dateStr: string) => {
    const [year, month, day] = dateStr.substring(0, 10).split('-').map(Number)
    return new Date(year, month - 1, day).toLocaleDateString('en-US', {
      weekday: 'long',
      month: 'long',
      day: 'numeric',
      year: 'numeric',
    })
  }

  // Handle scan result — auto-fill empty fields
  function applyScanResult(result: ScanResult) {
    setExtractedText(result.rawText || null)
    if (!amount && result.total?.value != null) {
      setAmount(String(result.total.value))
    }
    if (!vendor && result.vendor?.value) {
      setVendor(String(result.vendor.value))
    }
    if (result.date?.value) {
      const parsed = result.date.value as string
      if (/^\d{4}-\d{2}-\d{2}$/.test(parsed)) {
        setDate(parsed)
      }
    }
  }

  async function handleScanAttachment(blobUrl: string) {
    if (!subdomain) return
    const result = await scanReceipt(blobUrl, subdomain)
    if (result) {
      applyScanResult(result)
    }
  }

  // Confidence indicator helper
  function confidenceDot(confidence: number | undefined) {
    if (confidence === undefined) return null
    if (confidence >= 0.8) return <span className="scan-confidence scan-confidence--high" title="High confidence" />
    if (confidence >= 0.5) return <span className="scan-confidence scan-confidence--medium" title="Review this" />
    return <span className="scan-confidence scan-confidence--low" title="Low confidence" />
  }

  function wasScanned(fieldName: 'total' | 'vendor' | 'date'): number | undefined {
    if (!scanResult) return undefined
    const field = scanResult[fieldName]
    if (field?.value != null) return field.confidence
    return undefined
  }

  function scanSuggestion(fieldName: 'total' | 'vendor' | 'date', applyFn: () => void) {
    if (!scanResult) return null
    const field = scanResult[fieldName]
    if (field?.value == null) return null
    let currentVal: string
    let scannedVal: string
    if (fieldName === 'total') { currentVal = amount; scannedVal = String(field.value) }
    else if (fieldName === 'vendor') { currentVal = vendor; scannedVal = String(field.value) }
    else { currentVal = date; scannedVal = String(field.value) }
    if (currentVal === scannedVal) return null
    if (!currentVal) return null
    return (
      <button type="button" className="scan-suggestion" onClick={applyFn}>
        Use: {fieldName === 'total' ? `$${field.value}` : String(field.value)}
      </button>
    )
  }

  // Handle save
  async function handleSave() {
    if (!expense) return
    setError(null)

    const amountNum = parseFloat(amount)
    if (!amount || isNaN(amountNum) || amountNum <= 0) {
      setError('Please enter a valid amount')
      return
    }
    if (!date) {
      setError('Please select a date')
      return
    }
    if (!categoryId) {
      setError('Please select a category')
      return
    }

    try {
      setSubmitting(true)
      const amountCents = Math.round(amountNum * 100)

      const response = await fetch(`/api/expenses/${expense.id}?tenant=${subdomain}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          amount: amountCents,
          date: date + 'T12:00:00.000Z',
          categoryId,
          vendor: vendor.trim() || null,
          description: description.trim() || null,
          expenseType,
          isHomeOffice,
          extractedText,
        }),
      })

      if (!response.ok) {
        const data = await response.json()
        throw new Error(data.details?.join(', ') || data.error || 'Failed to update expense')
      }

      onUpdate()
      onClose()
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Something went wrong')
    } finally {
      setSubmitting(false)
    }
  }

  // Handle delete
  async function handleDelete() {
    if (!expense) return

    try {
      setDeleting(true)
      const response = await fetch(`/api/expenses/${expense.id}?tenant=${subdomain}`, {
        method: 'DELETE',
      })

      if (!response.ok) {
        const data = await response.json()
        throw new Error(data.error || 'Failed to delete expense')
      }

      onDelete()
      onClose()
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Something went wrong')
      setShowDeleteConfirm(false)
    } finally {
      setDeleting(false)
    }
  }

  // Handle backdrop click
  function handleBackdropClick(e: React.MouseEvent) {
    if (e.target === e.currentTarget) {
      onClose()
    }
  }

  if (!expense) return null

  // Calculate deductible amount for display
  const deductibleAmount = (expense.isHomeOffice && expense.homeOfficePercent)
    ? Math.round(expense.amount * expense.homeOfficePercent / 100)
    : null

  return (
    <>
      {/* Backdrop */}
      <div 
        className={`sheet-backdrop ${isOpen ? 'sheet-backdrop--open' : ''}`}
        onClick={handleBackdropClick}
      />

      {/* Bottom Sheet */}
      <div className={`bottom-sheet ${isOpen ? 'bottom-sheet--open' : ''}`}>
        {/* Handle bar */}
        <div className="bottom-sheet__handle" onClick={onClose}>
          <div className="bottom-sheet__handle-bar" />
        </div>

        {/* Header */}
        <div className="bottom-sheet__header">
          <h2 className="bottom-sheet__title">
            {mode === 'view' ? 'Expense Details' : 'Edit Expense'}
          </h2>
          <div className="bottom-sheet__header-actions">
            {/* View/Edit Toggle */}
            <div className="mode-toggle">
              <button
                className={`mode-toggle__btn ${mode === 'view' ? 'mode-toggle__btn--active' : ''}`}
                onClick={() => handleModeChange('view')}
                aria-label="View mode"
                title="View mode"
              >
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                  <circle cx="12" cy="12" r="3" />
                </svg>
              </button>
              <button
                className={`mode-toggle__btn ${mode === 'edit' ? 'mode-toggle__btn--active' : ''}`}
                onClick={() => handleModeChange('edit')}
                aria-label="Edit mode"
                title="Edit mode"
              >
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                </svg>
              </button>
            </div>
            <button 
              className="bottom-sheet__close"
              onClick={onClose}
              aria-label="Close"
            >
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path d="M18 6 6 18M6 6l12 12" />
            </svg>
          </button>
          </div>
        </div>

        {/* Content */}
        <div className="bottom-sheet__form">
          {/* Error Message */}
          {error && (
            <div className="form-error">
              {error}
            </div>
          )}

          {/* Delete Confirmation */}
          {showDeleteConfirm && (
            <div className="delete-confirm">
              <p className="delete-confirm__message">
                Are you sure you want to delete this expense? This cannot be undone.
              </p>
              <div className="delete-confirm__actions">
                <button 
                  className="btn btn--secondary"
                  onClick={() => setShowDeleteConfirm(false)}
                  disabled={deleting}
                >
                  Cancel
                </button>
                <button 
                  className="btn btn--danger"
                  onClick={handleDelete}
                  disabled={deleting}
                >
                  {deleting ? 'Deleting...' : 'Delete'}
                </button>
              </div>
            </div>
          )}

          {/* View Mode */}
          {mode === 'view' && !showDeleteConfirm && (
            <>
              {/* Amount - Hero Display */}
              <div className="detail-hero">
                <span className="detail-hero__emoji">{expense.categoryEmoji || '📁'}</span>
                <span className="detail-hero__amount">{formatMoney(expense.amount)}</span>
              </div>

              {/* Home Office Deduction Callout */}
              {expense.isHomeOffice && deductibleAmount !== null && (
                <div className="home-office-deduction-callout">
                  <span className="home-office-deduction-callout__icon">🏡</span>
                  <div className="home-office-deduction-callout__details">
                    <span className="home-office-deduction-callout__amount">
                      {formatMoney(deductibleAmount)} deductible
                    </span>
                    <span className="home-office-deduction-callout__rate">
                      {expense.homeOfficePercent}% home office rate
                    </span>
                  </div>
                </div>
              )}

              {/* Details List */}
              <div className="detail-list">
                <div className="detail-row">
                  <span className="detail-row__label">Date</span>
                  <span className="detail-row__value">{formatDate(expense.date)}</span>
                </div>
                
                <div className="detail-row">
                  <span className="detail-row__label">Category</span>
                  <span className="detail-row__value">
                    {expense.categoryEmoji} {expense.categoryName || 'Uncategorized'}
                  </span>
                </div>

                {expense.vendor && (
                  <div className="detail-row">
                    <span className="detail-row__label">Vendor</span>
                    <span className="detail-row__value">{expense.vendor}</span>
                  </div>
                )}

                {expense.description && (
                  <div className="detail-row">
                    <span className="detail-row__label">Description</span>
                    <span className="detail-row__value">{expense.description}</span>
                  </div>
                )}

                <div className="detail-row">
                  <span className="detail-row__label">Type</span>
                  <span className="detail-row__value detail-row__value--capitalize">
                    {expense.expenseType?.replace('_', ' ') || 'Operating'}
                  </span>
                </div>
              </div>

              {/* Attachments Section */}
              <div className="attachments-section">
                <div className="attachments-section__header">
                  <span className="form-label">Attachments</span>
                  <label className="btn btn--small btn--secondary attachments-upload-btn">
                    <input
                      type="file"
                      accept={ALLOWED_FILE_ACCEPT}
                      onChange={handleFileUpload}
                      style={{ display: 'none' }}
                      disabled={uploading}
                    />
                    {uploading ? 'Uploading...' : '📎 Attach'}
                  </label>
                </div>

                {/* Upload status message (compression feedback) */}
                {uploadStatus && (
                  <div className="attachments-status">{uploadStatus}</div>
                )}

                {loadingAttachments && (
                  <div className="attachments-loading">Loading attachments...</div>
                )}

                {!loadingAttachments && attachments.length === 0 && (
                  <div className="attachments-empty">No attachments yet</div>
                )}

                {attachments.length > 0 && (
                  <div className="attachments-list">
                    {attachments.map(att => (
                      <div key={att.id} className="attachment-item">
                        {att.mimeType.startsWith('image/') ? (
                          <img
                            src={att.blobUrl}
                            alt={att.fileName}
                            className="attachment-item__thumbnail"
                            onClick={() => setLightboxUrl(att.blobUrl)}
                          />
                        ) : (
                          <div
                            className="attachment-item__thumbnail attachment-item__thumbnail--pdf"
                            onClick={() => window.open(att.blobUrl, '_blank')}
                          >
                            PDF
                          </div>
                        )}
                        <div className="attachment-item__info">
                          <span className="attachment-item__name">{att.fileName}</span>
                          <span className="attachment-item__size">{formatFileSize(att.fileSize)}</span>
                        </div>
                        <button
                          className="attachment-item__delete"
                          onClick={() => handleDeleteAttachment(att.id)}
                          aria-label="Delete attachment"
                        >
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <path d="M18 6 6 18M6 6l12 12" />
                          </svg>
                        </button>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* Action Buttons */}
              <div className="detail-actions">
                <button 
                  className="btn btn--secondary btn--full"
                  onClick={() => handleModeChange('edit')}
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                  </svg>
                  Edit Expense
                </button>
                <button 
                  className="btn btn--danger-outline btn--full"
                  onClick={() => setShowDeleteConfirm(true)}
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <polyline points="3 6 5 6 21 6" />
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                  </svg>
                  Delete Expense
                </button>
              </div>
            </>
          )}

          {/* Edit Mode */}
          {mode === 'edit' && !showDeleteConfirm && (
            <>
              {/* Amount */}
              <div className="form-group">
                <label htmlFor="edit-amount" className="form-label">
                  Amount * {confidenceDot(wasScanned('total'))}
                </label>
                <div className="input-with-prefix">
                  <span className="input-prefix">$</span>
                  <input
                    type="number"
                    id="edit-amount"
                    className="form-input form-input--with-prefix"
                    placeholder="0.00"
                    step="0.01"
                    min="0.01"
                    value={amount}
                    onChange={(e) => setAmount(e.target.value)}
                    required
                  />
                </div>
                {scanSuggestion('total', () => setAmount(String(scanResult!.total.value)))}
              </div>

              {/* Date */}
              <div className="form-group">
                <label htmlFor="edit-date" className="form-label">
                  Date * {confidenceDot(wasScanned('date'))}
                </label>
                <input
                  type="date"
                  id="edit-date"
                  className="form-input"
                  value={date}
                  onChange={(e) => setDate(e.target.value)}
                  required
                />
                {scanSuggestion('date', () => {
                  const val = String(scanResult!.date.value)
                  if (/^\d{4}-\d{2}-\d{2}$/.test(val)) setDate(val)
                })}
              </div>

              {/* Category */}
              <div className="form-group">
                <label htmlFor="edit-category" className="form-label">Category *</label>
                {loadingCategories ? (
                  <div className="form-input form-input--loading">Loading categories...</div>
                ) : (
                  <select
                    id="edit-category"
                    className="form-input form-select"
                    value={categoryId}
                    onChange={(e) => setCategoryId(e.target.value)}
                    required
                  >
                    <option value="" disabled>Select a category</option>
                    {categories.map((cat) => (
                      <option key={cat.id} value={cat.id}>
                        {cat.emoji} {cat.name}
                      </option>
                    ))}
                  </select>
                )}
              </div>

              {/* Home Office Checkbox — only when category is eligible */}
              {showHomeOfficeCheckbox && (
                <div className="form-group">
                  <label className="home-office-checkbox">
                    <input
                      type="checkbox"
                      checked={isHomeOffice}
                      onChange={(e) => setIsHomeOffice(e.target.checked)}
                    />
                    <span className="home-office-checkbox__label">
                      🏡 Home Office Expense
                    </span>
                    <span className="home-office-checkbox__hint">
                      Deduction percentage will be applied to this expense
                    </span>
                  </label>
                </div>
              )}

              {/* Vendor */}
              <div className="form-group">
                <label htmlFor="edit-vendor" className="form-label">
                  Vendor {confidenceDot(wasScanned('vendor'))}
                </label>
                <input
                  type="text"
                  id="edit-vendor"
                  className="form-input"
                  placeholder="e.g., Home Depot, Amazon"
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                />
                {scanSuggestion('vendor', () => setVendor(String(scanResult!.vendor.value)))}
              </div>

              {/* Description */}
              <div className="form-group">
                <label htmlFor="edit-description" className="form-label">Description</label>
                <input
                  type="text"
                  id="edit-description"
                  className="form-input"
                  placeholder="What was this for?"
                  value={description}
                  onChange={(e) => setDescription(e.target.value)}
                />
              </div>

              {/* Expense Type */}
              <div className="form-group">
                <label className="form-label">Expense Type</label>
                <div className="expense-type-group">
                  <label className={`expense-type-option ${expenseType === 'operating' ? 'expense-type-option--selected' : ''}`}>
                    <input
                      type="radio"
                      name="editExpenseType"
                      value="operating"
                      checked={expenseType === 'operating'}
                      onChange={() => setExpenseType('operating')}
                    />
                    <span>Operating</span>
                  </label>
                  <label className={`expense-type-option ${expenseType === 'cogs' ? 'expense-type-option--selected' : ''}`}>
                    <input
                      type="radio"
                      name="editExpenseType"
                      value="cogs"
                      checked={expenseType === 'cogs'}
                      onChange={() => setExpenseType('cogs')}
                    />
                    <span>COGS</span>
                  </label>
                </div>
              </div>

              {/* Attachments Section */}
              <div className="attachments-section">
                <div className="attachments-section__header">
                  <span className="form-label">Attachments</span>
                  <label className="btn btn--small btn--secondary attachments-upload-btn">
                    <input
                      type="file"
                      accept={ALLOWED_FILE_ACCEPT}
                      onChange={handleFileUpload}
                      style={{ display: 'none' }}
                      disabled={uploading}
                    />
                    {uploading ? 'Uploading...' : '📎 Attach'}
                  </label>
                </div>

                {/* Upload status message (compression feedback) */}
                {uploadStatus && (
                  <div className="attachments-status">{uploadStatus}</div>
                )}

                {/* Scan error */}
                {scanError && (
                  <div className="scan-error">{scanError}</div>
                )}

                {loadingAttachments && (
                  <div className="attachments-loading">Loading attachments...</div>
                )}

                {!loadingAttachments && attachments.length === 0 && (
                  <div className="attachments-empty">No attachments yet</div>
                )}

                {attachments.length > 0 && (
                  <div className="attachments-list">
                    {attachments.map(att => (
                      <div key={att.id} className="attachment-item">
                        <div className="attachment-item__thumb-wrapper">
                          {att.mimeType.startsWith('image/') ? (
                            <img
                              src={att.blobUrl}
                              alt={att.fileName}
                              className="attachment-item__thumbnail"
                              onClick={() => setLightboxUrl(att.blobUrl)}
                            />
                          ) : (
                            <div
                              className="attachment-item__thumbnail attachment-item__thumbnail--pdf"
                              onClick={() => window.open(att.blobUrl, '_blank')}
                            >
                              PDF
                            </div>
                          )}
                          {/* Scan button — only for images, not PDFs */}
                          {att.mimeType.startsWith('image/') && (
                            <button
                              type="button"
                              className={`scan-button ${isScanning ? 'scan-button--scanning' : ''}`}
                              onClick={() => handleScanAttachment(att.blobUrl)}
                              disabled={isScanning}
                              aria-label="Scan receipt"
                            >
                              {isScanning ? '...' : '🔍'}
                            </button>
                          )}
                        </div>
                        <div className="attachment-item__info">
                          <span className="attachment-item__name">{att.fileName}</span>
                          <span className="attachment-item__size">{formatFileSize(att.fileSize)}</span>
                        </div>
                        <button
                          className="attachment-item__delete"
                          onClick={() => handleDeleteAttachment(att.id)}
                          aria-label="Delete attachment"
                        >
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <path d="M18 6 6 18M6 6l12 12" />
                          </svg>
                        </button>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* Action Buttons */}
              <div className="edit-actions">
                <button 
                  className="btn btn--secondary"
                  onClick={() => handleModeChange('view')}
                  disabled={submitting}
                >
                  Cancel
                </button>
                <button 
                  className="btn btn--primary"
                  onClick={handleSave}
                  disabled={submitting || loadingCategories || isScanning}
                >
                  {submitting ? 'Saving...' : 'Save Changes'}
                </button>
              </div>

              {/* Delete in Edit Mode */}
              <button 
                className="btn btn--danger-outline btn--full"
                onClick={() => setShowDeleteConfirm(true)}
                disabled={submitting}
                style={{ marginTop: 'var(--spacing-md)' }}
              >
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <polyline points="3 6 5 6 21 6" />
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                </svg>
                Delete Expense
              </button>
            </>
          )}
        </div>
      </div>

      {/* Lightbox Overlay */}
      {lightboxUrl && (
        <div 
          className="lightbox-overlay"
          onClick={() => setLightboxUrl(null)}
        >
          <button 
            className="lightbox-close"
            onClick={() => setLightboxUrl(null)}
            aria-label="Close image"
          >
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path d="M18 6 6 18M6 6l12 12" />
            </svg>
          </button>
          <img
            src={lightboxUrl}
            alt="Attachment"
            className="lightbox-image"
            onClick={(e) => e.stopPropagation()}
          />
        </div>
      )}
    </>
  )
}

--- FILE: ./src/components/Layout.tsx ---

import { useState } from 'react'
import { Link, useLocation } from 'wouter'
import { useTenant } from '../hooks/useTenant'
import { useAuth } from '../hooks/useAuth'
import { useYear } from '../hooks/useYear'
import { useRefresh } from '../hooks/useRefresh'
import { useSettings } from '../hooks/useSettings'
import { AddExpenseSheet } from './AddExpenseSheet'
import { AddMileageSheet } from './AddMileageSheet'

interface LayoutProps {
  children: React.ReactNode
}

export function Layout({ children }: LayoutProps) {
  const [drawerOpen, setDrawerOpen] = useState(false)
  const [expenseSheetOpen, setExpenseSheetOpen] = useState(false)
  const [mileageSheetOpen, setMileageSheetOpen] = useState(false)
  const { tenant } = useTenant()
  const { user, logout } = useAuth()
  const [location] = useLocation()
  const { year, nextYear, prevYear } = useYear()
  const { refreshExpenses, refreshMileage } = useRefresh()
  const { showFab } = useSettings()
  const currentYear = new Date().getFullYear()

  const appName = tenant?.name || 'Expense Tracker'
  
  // Determine if we're on the mileage page
  const isOnMileagePage = location === '/mileage' || location.startsWith('/mileage/')

  const closeDrawer = () => setDrawerOpen(false)

  const handleExpenseAdded = () => {
    refreshExpenses()
  }

  const handleMileageAdded = () => {
    refreshMileage()
  }

  const handleFabClick = () => {
    if (isOnMileagePage) {
      setMileageSheetOpen(true)
    } else {
      setExpenseSheetOpen(true)
    }
  }

  return (
    <div className="layout">
      {/* Header */}
      <header className="header">
        <button 
          className="header__menu-btn"
          onClick={() => setDrawerOpen(true)}
          aria-label="Open menu"
        >
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <line x1="3" y1="6" x2="21" y2="6" />
            <line x1="3" y1="12" x2="21" y2="12" />
            <line x1="3" y1="18" x2="21" y2="18" />
          </svg>
        </button>

        <h1 className="header__title">{appName}</h1>

        {/* Spacer to center title */}
        <div className="header__spacer" />
      </header>

      {/* Navigation Drawer Overlay */}
      <div 
        className={`drawer-overlay ${drawerOpen ? 'drawer-overlay--open' : ''}`}
        onClick={closeDrawer}
      />

      {/* Navigation Drawer */}
      <nav className={`drawer ${drawerOpen ? 'drawer--open' : ''}`}>
        <div className="drawer__header">
          {tenant?.logoUrl ? (
            <img src={tenant.logoUrl} alt={tenant.name} className="drawer__logo" />
          ) : (
            <div className="drawer__logo-placeholder">
              <span>{(tenant?.name || 'W')[0]}</span>
            </div>
          )}
          <span className="drawer__app-name">{appName}</span>
        </div>

        {/* Year Selector */}
        <div className="drawer__year-selector">
          <button 
            className="year-selector__btn year-selector__btn--prev" 
            aria-label="Previous year"
            onClick={prevYear}
            disabled={year <= 2020}
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <polyline points="15 18 9 12 15 6" />
            </svg>
          </button>
          <span className="year-selector__year">{year}</span>
          <button 
            className="year-selector__btn year-selector__btn--next" 
            aria-label="Next year"
            onClick={nextYear}
            disabled={year >= currentYear}
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <polyline points="9 18 15 12 9 6" />
            </svg>
          </button>
        </div>

        {/* Navigation Links */}
        <ul className="drawer__nav">
          <NavItem icon="dashboard" label="Dashboard" href="/" currentPath={location} onClick={closeDrawer} />
          <NavItem icon="receipt" label="Expenses" href="/expenses" currentPath={location} onClick={closeDrawer} />
          <NavItem icon="car" label="Mileage" href="/mileage" currentPath={location} onClick={closeDrawer} />
          <NavItem icon="folder" label="Categories" href="/categories" currentPath={location} onClick={closeDrawer} />
          <NavItem icon="chart" label="Reports" href="/reports" currentPath={location} onClick={closeDrawer} />
          {user?.isSuperAdmin && (
            <NavItem icon="admin" label="Admin" href="/admin" currentPath={location} onClick={closeDrawer} />
          )}
          <NavItem icon="settings" label="Settings" href="/settings" currentPath={location} onClick={closeDrawer} />
        </ul>

        {/* Profile Section */}
        <div className="drawer__profile">
          <div className="drawer__profile-info">
            <div className="drawer__avatar">
              {user?.name?.[0] || user?.email?.[0]?.toUpperCase() || '?'}
            </div>
            <div className="drawer__profile-text">
              <span className="drawer__profile-name">
                {user?.name || user?.email}
              </span>
              <span className="drawer__profile-role">{user?.role || 'User'}</span>
            </div>
          </div>
          <button className="drawer__logout-btn" onClick={logout} aria-label="Sign out">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
              <polyline points="16 17 21 12 16 7" />
              <line x1="21" y1="12" x2="9" y2="12" />
            </svg>
          </button>
        </div>
      </nav>

      {/* Main Content */}
      <main className="main-content">
        {children}
      </main>

      {/* Global FAB - Context Aware */}
      {showFab && !expenseSheetOpen && !mileageSheetOpen && (
        <button 
          className={`fab ${isOnMileagePage ? 'fab--mileage' : ''}`}
          onClick={handleFabClick}
          aria-label={isOnMileagePage ? 'Add mileage' : 'Add expense'}
        >
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <line x1="12" y1="5" x2="12" y2="19" />
            <line x1="5" y1="12" x2="19" y2="12" />
          </svg>
        </button>
      )}

      {/* Global Add Expense Sheet */}
      <AddExpenseSheet
        isOpen={expenseSheetOpen}
        onClose={() => setExpenseSheetOpen(false)}
        onSuccess={handleExpenseAdded}
        preselectedCategoryName={new URLSearchParams(window.location.search).get('category')}
      />

      {/* Global Add Mileage Sheet */}
      <AddMileageSheet
        isOpen={mileageSheetOpen}
        onClose={() => setMileageSheetOpen(false)}
        onSuccess={handleMileageAdded}
      />
    </div>
  )
}

interface NavItemProps {
  icon: 'dashboard' | 'receipt' | 'car' | 'folder' | 'chart' | 'admin' | 'settings'
  label: string
  href: string
  currentPath: string
  onClick: () => void
}

function NavItem({ icon, label, href, currentPath, onClick }: NavItemProps) {
  const isActive = href === '/' ? currentPath === '/' : currentPath.startsWith(href)

  const icons = {
    dashboard: (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="3" y="3" width="7" height="9" rx="1" />
        <rect x="14" y="3" width="7" height="5" rx="1" />
        <rect x="14" y="12" width="7" height="9" rx="1" />
        <rect x="3" y="16" width="7" height="5" rx="1" />
      </svg>
    ),
    receipt: (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M4 2v20l3-2 3 2 3-2 3 2 3-2 3 2V2l-3 2-3-2-3 2-3-2-3 2-3-2z" />
        <line x1="8" y1="8" x2="16" y2="8" />
        <line x1="8" y1="12" x2="16" y2="12" />
        <line x1="8" y1="16" x2="12" y2="16" />
      </svg>
    ),
    car: (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M5 17h14v-5H5v5zm2-3h2v2H7v-2zm8 0h2v2h-2v-2z" />
        <path d="M5 12l2-5h10l2 5" />
        <circle cx="7" cy="17" r="2" />
        <circle cx="17" cy="17" r="2" />
      </svg>
    ),
    folder: (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
      </svg>
    ),
    chart: (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="18" y1="20" x2="18" y2="10" />
        <line x1="12" y1="20" x2="12" y2="4" />
        <line x1="6" y1="20" x2="6" y2="14" />
      </svg>
    ),
    admin: (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
      </svg>
    ),
    settings: (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="12" cy="12" r="3" />
        <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" />
      </svg>
    ),
  }

  return (
    <li>
      <Link 
        href={href} 
        className={`drawer__nav-item ${isActive ? 'drawer__nav-item--active' : ''}`}
        onClick={onClick}
      >
        {icons[icon]}
        <span>{label}</span>
      </Link>
    </li>
  )
}

--- FILE: ./src/components/CategorySheet.tsx ---

import { useState, useEffect } from 'react'
import { useTenant } from '../hooks/useTenant'

// ============================================
// CURATED EMOJI LIST
// Business-relevant + a few fun surprises
// ============================================
const EMOJI_OPTIONS = [
  // Business essentials
  '📦', '🛒', '🏪', '💼', '📋', '🧾', '💳', '🏦',
  // Office & supplies
  '🖨️', '📎', '✏️', '📁', '🗂️', '💻', '📱', '🖥️',
  // Home & utilities
  '🏠', '⚡', '💧', '🌐', '📡', '🔧', '🛠️', '🏗️',
  // Transport & travel
  '🚗', '⛽', '✈️', '🅿️', '🚕', '🛫', '🏨', '🧳',
  // Food & entertainment
  '🍽️', '☕', '🍕', '🎬', '🎯', '🎪', '🍩', '🧁',
  // People & services
  '👔', '🧑‍💼', '🤝', '📞', '📧', '🎓', '⚖️', '🏥',
  // Marketing & creative
  '📣', '🎨', '📸', '🖼️', '✨', '🎁', '🏷️', '📰',
  // Wildcards (the fun ones you asked for)
  '🦄', '🚀', '🔥', '💎', '🌮', '🐕', '🎸', '🤖',
]

interface CategorySheetProps {
  isOpen: boolean
  onClose: () => void
  onSuccess: () => void
  editCategory?: {
    id: string
    name: string
    emoji: string | null
    expenseType: string
    homeOfficeEligible: boolean
    isSystem: boolean
  } | null
}

export function CategorySheet({ isOpen, onClose, onSuccess, editCategory }: CategorySheetProps) {
  const { subdomain } = useTenant()
  const isEditing = !!editCategory

  // Form state
  const [name, setName] = useState('')
  const [emoji, setEmoji] = useState('📁')
  const [expenseType, setExpenseType] = useState<'operating' | 'cogs'>('operating')
  const [homeOfficeEligible, setHomeOfficeEligible] = useState(false)
  const [showEmojiPicker, setShowEmojiPicker] = useState(false)

  // UI state
  const [submitting, setSubmitting] = useState(false)
  const [error, setError] = useState<string | null>(null)

  // Populate form when editing
  useEffect(() => {
    if (isOpen && editCategory) {
      setName(editCategory.name)
      setEmoji(editCategory.emoji || '📁')
      // Normalize any legacy 'home_office' type to 'operating'
      const type = editCategory.expenseType === 'home_office' ? 'operating' : editCategory.expenseType
      setExpenseType(type as 'operating' | 'cogs')
      setHomeOfficeEligible(editCategory.homeOfficeEligible)
      setShowEmojiPicker(false)
      setError(null)
    }
  }, [isOpen, editCategory])

  // Reset form when sheet closes (only for add mode)
  useEffect(() => {
    if (!isOpen) {
      const timer = setTimeout(() => {
        if (!editCategory) {
          setName('')
          setEmoji('📁')
          setExpenseType('operating')
          setHomeOfficeEligible(false)
        }
        setShowEmojiPicker(false)
        setError(null)
      }, 300)
      return () => clearTimeout(timer)
    }
  }, [isOpen, editCategory])

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault()
    setError(null)

    if (!name.trim()) {
      setError('Please enter a category name')
      return
    }

    try {
      setSubmitting(true)

      const payload = {
        name: name.trim(),
        emoji,
        expenseType,
        homeOfficeEligible,
      }

      const url = isEditing
        ? `/api/categories/${editCategory!.id}?tenant=${subdomain}`
        : `/api/categories?tenant=${subdomain}`

      const response = await fetch(url, {
        method: isEditing ? 'PUT' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      })

      if (!response.ok) {
        const data = await response.json()
        throw new Error(data.details?.join(', ') || data.error || 'Failed to save category')
      }

      onSuccess()
      onClose()
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Something went wrong')
    } finally {
      setSubmitting(false)
    }
  }

  function handleBackdropClick(e: React.MouseEvent) {
    if (e.target === e.currentTarget) {
      onClose()
    }
  }

  return (
    <>
      {/* Backdrop */}
      <div
        className={`sheet-backdrop ${isOpen ? 'sheet-backdrop--open' : ''}`}
        onClick={handleBackdropClick}
      />

      {/* Bottom Sheet */}
      <div className={`bottom-sheet ${isOpen ? 'bottom-sheet--open' : ''}`}>
        {/* Handle bar */}
        <div className="bottom-sheet__handle" onClick={onClose}>
          <div className="bottom-sheet__handle-bar" />
        </div>

        {/* Header */}
        <div className="bottom-sheet__header">
          <h2 className="bottom-sheet__title">
            {isEditing ? 'Edit Category' : 'Add Category'}
          </h2>
          <button
            className="bottom-sheet__close"
            onClick={onClose}
            aria-label="Close"
          >
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path d="M18 6 6 18M6 6l12 12" />
            </svg>
          </button>
        </div>

        {/* Form */}
        <form className="bottom-sheet__form" onSubmit={handleSubmit}>
          {/* Error Message */}
          {error && <div className="form-error">{error}</div>}

          {/* Emoji + Name row */}
          <div className="form-group">
            <label className="form-label">Category</label>
            <div className="category-form__name-row">
              <button
                type="button"
                className="category-form__emoji-btn"
                onClick={() => setShowEmojiPicker(!showEmojiPicker)}
                aria-label="Pick emoji"
              >
                {emoji}
              </button>
              <input
                type="text"
                className="form-input"
                placeholder="Category name"
                value={name}
                onChange={(e) => setName(e.target.value)}
                maxLength={100}
                required
                autoFocus={isOpen && !isEditing}
              />
            </div>
          </div>

          {/* Emoji Picker */}
          {showEmojiPicker && (
            <div className="category-form__emoji-picker">
              {EMOJI_OPTIONS.map((e) => (
                <button
                  key={e}
                  type="button"
                  className={`category-form__emoji-option ${emoji === e ? 'category-form__emoji-option--selected' : ''}`}
                  onClick={() => {
                    setEmoji(e)
                    setShowEmojiPicker(false)
                  }}
                >
                  {e}
                </button>
              ))}
            </div>
          )}

          {/* Expense Type */}
          <div className="form-group">
            <label className="form-label">Default Expense Type</label>
            {isEditing && (
              <p className="form-hint" style={{ marginBottom: 'var(--spacing-sm)' }}>
                Changing this will not update existing expenses. It only sets the default for new expenses in this category.
              </p>
            )}
            <div className="expense-type-group">
              <label className={`expense-type-option ${expenseType === 'operating' ? 'expense-type-option--selected' : ''}`}>
                <input
                  type="radio"
                  name="catExpenseType"
                  value="operating"
                  checked={expenseType === 'operating'}
                  onChange={() => setExpenseType('operating')}
                />
                <span>Operating</span>
              </label>
              <label className={`expense-type-option ${expenseType === 'cogs' ? 'expense-type-option--selected' : ''}`}>
                <input
                  type="radio"
                  name="catExpenseType"
                  value="cogs"
                  checked={expenseType === 'cogs'}
                  onChange={() => setExpenseType('cogs')}
                />
                <span>COGS</span>
              </label>
            </div>
          </div>

          {/* Home Office Eligible toggle — always visible */}
          <div className="form-group form-group--horizontal">
            <div>
              <label className="form-label">Home Office Deduction Eligible</label>
              <span className="form-hint">
                Enable this for expenses that may apply to your home office
                (e.g., utilities, rent, insurance). When adding an expense in this
                category, you'll see a checkbox to mark it as a home office expense.
                Only checked expenses will have the sq ft deduction percentage applied.
              </span>
            </div>
            <button
              type="button"
              className={`toggle ${homeOfficeEligible ? 'toggle--on' : ''}`}
              onClick={() => setHomeOfficeEligible(!homeOfficeEligible)}
              role="switch"
              aria-checked={homeOfficeEligible}
            >
              <span className="toggle__slider" />
            </button>
          </div>

          {/* Submit Button */}
          <button
            type="submit"
            className="btn btn--primary btn--full"
            disabled={submitting}
          >
            {submitting ? 'Saving...' : isEditing ? 'Save Changes' : 'Create Category'}
          </button>
        </form>
      </div>
    </>
  )
}


--- FILE: ./src/components/AddExpenseSheet.tsx ---

import { useState, useEffect } from 'react'
import { useTenant } from '../hooks/useTenant'
import { useScanReceipt, type ScanResult } from '../hooks/useScanReceipt'
import {
  type PendingAttachment,
  type UploadProgress,
  uploadToBlob,
  linkAttachmentToExpense,
  validateFile,
  formatFileSize,
  ALLOWED_FILE_ACCEPT,
} from '../utils/attachment-upload'

const MAX_ATTACHMENTS = 2

interface Category {
  id: string
  name: string
  emoji: string | null
  sortOrder: number
  expenseType?: string
  homeOfficeEligible?: boolean
}

interface AddExpenseSheetProps {
  isOpen: boolean
  onClose: () => void
  onSuccess: () => void
  preselectedCategoryId?: string | null
  preselectedCategoryName?: string | null
}

export function AddExpenseSheet({ isOpen, onClose, onSuccess, preselectedCategoryId, preselectedCategoryName }: AddExpenseSheetProps) {
  const { subdomain } = useTenant()
  const { scanResult, isScanning, scanError, scanReceipt, clearScan } = useScanReceipt()

  // Form state
  const [amount, setAmount] = useState('')
  const [vendor, setVendor] = useState('')
  const [description, setDescription] = useState('')
  const [date, setDate] = useState(() => {
    const now = new Date()
    return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`
  })
  const [categoryId, setCategoryId] = useState('')
  const [expenseType, setExpenseType] = useState<'operating' | 'cogs'>('operating')
  const [isHomeOffice, setIsHomeOffice] = useState(false)
  const [extractedText, setExtractedText] = useState<string | null>(null)

  // UI state
  const [categories, setCategories] = useState<Category[]>([])
  const [loadingCategories, setLoadingCategories] = useState(true)
  const [submitting, setSubmitting] = useState(false)
  const [error, setError] = useState<string | null>(null)

  // Attachment state
  const [pendingAttachments, setPendingAttachments] = useState<PendingAttachment[]>([])
  const [uploadProgress, setUploadProgress] = useState<UploadProgress>({ status: 'idle' })

  // Derived: selected category properties
  const selectedCategory = categories.find(c => c.id === categoryId)
  const showHomeOfficeCheckbox = selectedCategory?.homeOfficeEligible === true

  // Sync expense type and home office checkbox when category changes
  useEffect(() => {
    if (selectedCategory) {
      const catType = selectedCategory.expenseType === 'home_office' ? 'operating' : selectedCategory.expenseType
      setExpenseType((catType as 'operating' | 'cogs') || 'operating')
    }
    if (!showHomeOfficeCheckbox) {
      setIsHomeOffice(false)
    }
  }, [categoryId, showHomeOfficeCheckbox])

  // Fetch categories when sheet opens
  useEffect(() => {
    if (!isOpen || !subdomain) return

    async function fetchCategories() {
      try {
        setLoadingCategories(true)
        const response = await fetch(`/api/categories?tenant=${subdomain}`)
        if (!response.ok) {
          throw new Error('Failed to load categories')
        }
        const data = await response.json()
        setCategories([...data.categories].sort((a: Category, b: Category) => a.name.localeCompare(b.name)))

        // Priority: URL preselect > name preselect > tenant default > blank
        if (preselectedCategoryId) {
          setCategoryId(preselectedCategoryId)
        } else if (preselectedCategoryName) {
          const match = data.categories.find((c: Category) => c.name === preselectedCategoryName)
          if (match) setCategoryId(match.id)
        } else if (data.homeOfficeSettings?.defaultCategoryId) {
          setCategoryId(data.homeOfficeSettings.defaultCategoryId)
        } else {
          setCategoryId('')
        }
      } catch (err) {
        console.error('Error fetching categories:', err)
      } finally {
        setLoadingCategories(false)
      }
    }

    fetchCategories()
  }, [isOpen, subdomain])

  // Reset form when sheet closes (including pending attachments and scan state)
  useEffect(() => {
    if (!isOpen) {
      const timer = setTimeout(() => {
        setAmount('')
        setVendor('')
        setDescription('')
        const now = new Date()
        setDate(`${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`)
        setCategoryId('')
        setExpenseType('operating')
        setIsHomeOffice(false)
        setExtractedText(null)
        setError(null)
        setPendingAttachments([])
        setUploadProgress({ status: 'idle' })
        clearScan()
      }, 300)
      return () => clearTimeout(timer)
    }
  }, [isOpen, preselectedCategoryId])

  // Handle scan result — auto-fill empty fields, show suggestions for filled ones
  function applyScanResult(result: ScanResult) {
    setExtractedText(result.rawText || null)

    // Auto-fill empty fields
    if (!amount && result.total?.value != null) {
      setAmount(String(result.total.value))
    }
    if (!vendor && result.vendor?.value) {
      setVendor(String(result.vendor.value))
    }
    if (!date.trim() || date === new Date().toISOString().split('T')[0]) {
      // Only auto-fill date if it's still the default (today)
      if (result.date?.value) {
        const parsed = result.date.value as string
        if (/^\d{4}-\d{2}-\d{2}$/.test(parsed)) {
          setDate(parsed)
        }
      }
    }
  }

  // Handle scan button click
  async function handleScan(blobUrl: string) {
    if (!subdomain) return
    const result = await scanReceipt(blobUrl, subdomain)
    if (result) {
      applyScanResult(result)
    }
  }

  // Handle file selection — uploads to Vercel Blob immediately
  async function handleFileSelect(e: React.ChangeEvent<HTMLInputElement>) {
    const file = e.target.files?.[0]
    if (!file) return

    e.target.value = ''

    if (pendingAttachments.length >= MAX_ATTACHMENTS) {
      setError(`Maximum ${MAX_ATTACHMENTS} attachments allowed`)
      return
    }

    const validationError = validateFile(file)
    if (validationError) {
      setError(validationError)
      return
    }

    try {
      setError(null)
      setUploadProgress({ status: 'uploading', message: 'Uploading...' })

      const blobPathPrefix = `${subdomain}/pending`
      const pending = await uploadToBlob(file, subdomain!, blobPathPrefix, (progress) => {
        setUploadProgress(progress)
      })

      setPendingAttachments(prev => [...prev, pending])
      setUploadProgress({ status: 'idle' })
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Upload failed')
      setUploadProgress({ status: 'error', message: 'Upload failed' })
    }
  }

  // Remove a pending attachment
  function handleRemoveAttachment(index: number) {
    setPendingAttachments(prev => prev.filter((_, i) => i !== index))
  }

  // Handle form submission
  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault()
    setError(null)

    const amountNum = parseFloat(amount)
    if (!amount || isNaN(amountNum) || amountNum <= 0) {
      setError('Please enter a valid amount')
      return
    }
    if (!date) {
      setError('Please select a date')
      return
    }
    if (!categoryId) {
      setError('Please select a category')
      return
    }

    try {
      setSubmitting(true)

      const amountCents = Math.round(amountNum * 100)

      const response = await fetch(`/api/expenses?tenant=${subdomain}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          amount: amountCents,
          date: date + 'T12:00:00.000Z',
          categoryId,
          vendor: vendor.trim() || null,
          description: description.trim() || null,
          expenseType,
          isHomeOffice,
          extractedText,
        }),
      })

      if (!response.ok) {
        const data = await response.json()
        throw new Error(data.details?.join(', ') || data.error || 'Failed to create expense')
      }

      const { expense } = await response.json()

      // Link pending attachments to the new expense
      if (pendingAttachments.length > 0) {
        const linkErrors: string[] = []
        for (const attachment of pendingAttachments) {
          try {
            await linkAttachmentToExpense(attachment, expense.id, subdomain!)
          } catch (err) {
            linkErrors.push(err instanceof Error ? err.message : 'Failed to link attachment')
          }
        }
        if (linkErrors.length > 0) {
          console.error('Attachment linking errors:', linkErrors)
        }
      }

      onSuccess()
      onClose()
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Something went wrong')
    } finally {
      setSubmitting(false)
    }
  }

  function handleBackdropClick(e: React.MouseEvent) {
    if (e.target === e.currentTarget) {
      onClose()
    }
  }

  const isUploading = uploadProgress.status === 'compressing' || uploadProgress.status === 'uploading'

  // Confidence indicator helper
  function confidenceDot(confidence: number | undefined) {
    if (confidence === undefined) return null
    if (confidence >= 0.8) return <span className="scan-confidence scan-confidence--high" title="High confidence" />
    if (confidence >= 0.5) return <span className="scan-confidence scan-confidence--medium" title="Review this" />
    return <span className="scan-confidence scan-confidence--low" title="Low confidence" />
  }

  // Check if a field was populated by scan
  function wasScanned(fieldName: 'total' | 'vendor' | 'date'): number | undefined {
    if (!scanResult) return undefined
    const field = scanResult[fieldName]
    if (field?.value != null) return field.confidence
    return undefined
  }

  // Suggestion helper: show scan suggestion when field already had data
  function scanSuggestion(fieldName: 'total' | 'vendor' | 'date', applyFn: () => void) {
    if (!scanResult) return null
    const field = scanResult[fieldName]
    if (field?.value == null) return null

    // Only show suggestion if the field currently has different data than the scan
    let currentVal: string
    let scannedVal: string
    if (fieldName === 'total') {
      currentVal = amount
      scannedVal = String(field.value)
    } else if (fieldName === 'vendor') {
      currentVal = vendor
      scannedVal = String(field.value)
    } else {
      currentVal = date
      scannedVal = String(field.value)
    }

    if (currentVal === scannedVal) return null
    if (!currentVal) return null // Already auto-filled

    return (
      <button type="button" className="scan-suggestion" onClick={applyFn}>
        Use: {fieldName === 'total' ? `$${field.value}` : String(field.value)}
      </button>
    )
  }

  return (
    <>
      {/* Backdrop */}
      <div
        className={`sheet-backdrop ${isOpen ? 'sheet-backdrop--open' : ''}`}
        onClick={handleBackdropClick}
      />

      {/* Bottom Sheet */}
      <div className={`bottom-sheet ${isOpen ? 'bottom-sheet--open' : ''}`}>
        {/* Handle bar */}
        <div className="bottom-sheet__handle" onClick={onClose}>
          <div className="bottom-sheet__handle-bar" />
        </div>

        {/* Header */}
        <div className="bottom-sheet__header">
          <h2 className="bottom-sheet__title">Add Expense</h2>
          <button
            className="bottom-sheet__close"
            onClick={onClose}
            aria-label="Close"
          >
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path d="M18 6 6 18M6 6l12 12" />
            </svg>
          </button>
        </div>

        {/* Form */}
        <form className="bottom-sheet__form" onSubmit={handleSubmit}>
          {/* Error Message */}
          {error && (
            <div className="form-error">{error}</div>
          )}

          {/* Attachment Section — moved to top so scan can fill fields below */}
          <div className="add-expense-attachments">
            <div className="add-expense-attachments__header">
              <span className="form-label">Receipts</span>
              {pendingAttachments.length > 0 && (
                <span className="add-expense-attachments__limit">
                  {pendingAttachments.length} of {MAX_ATTACHMENTS}
                </span>
              )}
            </div>

            {/* Upload progress */}
            {uploadProgress.message && (
              <div className="attachments-status">{uploadProgress.message}</div>
            )}

            {/* Scan error */}
            {scanError && (
              <div className="scan-error">{scanError}</div>
            )}

            {/* Thumbnail previews */}
            {pendingAttachments.length > 0 && (
              <div className="add-expense-attachments__preview">
                {pendingAttachments.map((att, index) => (
                  <div key={att.blobUrl} className="add-expense-attachments__thumb-wrapper">
                    {att.fileType.startsWith('image/') ? (
                      <img
                        src={att.blobUrl}
                        alt={att.fileName}
                        className="add-expense-attachments__thumb"
                      />
                    ) : (
                      <div className="add-expense-attachments__thumb add-expense-attachments__thumb--pdf">
                        PDF
                      </div>
                    )}
                    <button
                      type="button"
                      className="add-expense-attachments__remove"
                      onClick={() => handleRemoveAttachment(index)}
                      aria-label="Remove attachment"
                    >
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                        <path d="M18 6 6 18M6 6l12 12" />
                      </svg>
                    </button>
                    <span className="add-expense-attachments__file-size">{formatFileSize(att.fileSize)}</span>
                    {/* Scan button — only for images, not PDFs */}
                    {att.fileType.startsWith('image/') && (
                      <button
                        type="button"
                        className={`scan-button ${isScanning ? 'scan-button--scanning' : ''}`}
                        onClick={() => handleScan(att.blobUrl)}
                        disabled={isScanning}
                        aria-label="Scan receipt"
                      >
                        {isScanning ? '...' : '🔍'}
                      </button>
                    )}
                  </div>
                ))}
              </div>
            )}

            {/* File picker */}
            {pendingAttachments.length < MAX_ATTACHMENTS && (
              <label className={`add-expense-attachments__picker ${isUploading ? 'add-expense-attachments__picker--disabled' : ''}`}>
                <input
                  type="file"
                  accept={ALLOWED_FILE_ACCEPT}
                  onChange={handleFileSelect}
                  style={{ display: 'none' }}
                  disabled={isUploading}
                />
                {isUploading ? 'Uploading...' : '📎 Attach Receipt'}
              </label>
            )}
          </div>

          {/* Amount */}
          <div className="form-group">
            <label htmlFor="amount" className="form-label">
              Amount * {confidenceDot(wasScanned('total'))}
            </label>
            <div className="input-with-prefix">
              <span className="input-prefix">$</span>
              <input
                type="number"
                id="amount"
                className="form-input form-input--with-prefix"
                placeholder="0.00"
                step="0.01"
                min="0.01"
                value={amount}
                onChange={(e) => setAmount(e.target.value)}
                required
                autoFocus={isOpen}
              />
            </div>
            {scanSuggestion('total', () => setAmount(String(scanResult!.total.value)))}
          </div>

          {/* Date */}
          <div className="form-group">
            <label htmlFor="date" className="form-label">
              Date * {confidenceDot(wasScanned('date'))}
            </label>
            <input
              type="date"
              id="date"
              className="form-input"
              value={date}
              onChange={(e) => setDate(e.target.value)}
              required
            />
            {scanSuggestion('date', () => {
              const val = String(scanResult!.date.value)
              if (/^\d{4}-\d{2}-\d{2}$/.test(val)) setDate(val)
            })}
          </div>

          {/* Category */}
          <div className="form-group">
            <label htmlFor="category" className="form-label">Category *</label>
            {loadingCategories ? (
              <div className="form-input form-input--loading">Loading categories...</div>
            ) : (
              <select
                id="category"
                className="form-input form-select"
                value={categoryId}
                onChange={(e) => setCategoryId(e.target.value)}
                required
              >
                <option value="" disabled>Select a category</option>
                {categories.map((cat) => (
                  <option key={cat.id} value={cat.id}>
                    {cat.emoji} {cat.name}
                  </option>
                ))}
              </select>
            )}
          </div>

          {/* Home Office Checkbox */}
          {showHomeOfficeCheckbox && (
            <div className="form-group">
              <label className="home-office-checkbox">
                <input
                  type="checkbox"
                  checked={isHomeOffice}
                  onChange={(e) => setIsHomeOffice(e.target.checked)}
                />
                <span className="home-office-checkbox__label">
                  🏡 Home Office Expense
                </span>
                <span className="home-office-checkbox__hint">
                  Deduction percentage will be applied to this expense
                </span>
              </label>
            </div>
          )}

          {/* Vendor */}
          <div className="form-group">
            <label htmlFor="vendor" className="form-label">
              Vendor {confidenceDot(wasScanned('vendor'))}
            </label>
            <input
              type="text"
              id="vendor"
              className="form-input"
              placeholder="e.g., Home Depot, Amazon"
              value={vendor}
              onChange={(e) => setVendor(e.target.value)}
            />
            {scanSuggestion('vendor', () => setVendor(String(scanResult!.vendor.value)))}
          </div>

          {/* Description */}
          <div className="form-group">
            <label htmlFor="description" className="form-label">Description</label>
            <input
              type="text"
              id="description"
              className="form-input"
              placeholder="What was this for?"
              value={description}
              onChange={(e) => setDescription(e.target.value)}
            />
          </div>

          {/* Expense Type */}
          <div className="form-group">
            <label className="form-label">Expense Type</label>
            <div className="expense-type-group">
              <label className={`expense-type-option ${expenseType === 'operating' ? 'expense-type-option--selected' : ''}`}>
                <input
                  type="radio"
                  name="expenseType"
                  value="operating"
                  checked={expenseType === 'operating'}
                  onChange={() => setExpenseType('operating')}
                />
                <span>Operating</span>
              </label>
              <label className={`expense-type-option ${expenseType === 'cogs' ? 'expense-type-option--selected' : ''}`}>
                <input
                  type="radio"
                  name="expenseType"
                  value="cogs"
                  checked={expenseType === 'cogs'}
                  onChange={() => setExpenseType('cogs')}
                />
                <span>COGS</span>
              </label>
            </div>
          </div>

          {/* Submit Button */}
          <button
            type="submit"
            className="btn btn--primary btn--full"
            disabled={submitting || loadingCategories || isUploading || isScanning}
          >
            {submitting ? 'Saving...' : 'Save Expense'}
          </button>
        </form>
      </div>
    </>
  )
}


--- FILE: ./src/components/MileageDetailSheet.tsx ---

import { useState, useEffect, useRef, useCallback } from 'react'
import { useTenant } from '../hooks/useTenant'

// Get saved preference from localStorage
function getDefaultMode(): 'view' | 'edit' {
  if (typeof window === 'undefined') return 'view'
  return (localStorage.getItem('mileageDetailMode') as 'view' | 'edit') || 'view'
}

interface MileageTrip {
  id: string
  date: string
  description: string | null
  startLocation: string
  endLocation: string
  distanceMiles: number
  isRoundTrip: boolean
}

interface PlaceData {
  address: string
  location: { lat: number; lng: number } | null
}

interface MileageDetailSheetProps {
  trip: MileageTrip | null
  isOpen: boolean
  onClose: () => void
  onUpdate: () => void
  onDelete: () => void
}

export function MileageDetailSheet({ trip, isOpen, onClose, onUpdate, onDelete }: MileageDetailSheetProps) {
  const { subdomain } = useTenant()
  
  // Mode: 'view' or 'edit' (persisted to localStorage)
  const [mode, setMode] = useState<'view' | 'edit'>(getDefaultMode)
  
  // Persist mode changes to localStorage
  const handleModeChange = (newMode: 'view' | 'edit') => {
    setMode(newMode)
    localStorage.setItem('mileageDetailMode', newMode)
  }
  
  // Edit form state
  const [date, setDate] = useState('')
  const [description, setDescription] = useState('')
  const [startLocation, setStartLocation] = useState<PlaceData>({ address: '', location: null })
  const [endLocation, setEndLocation] = useState<PlaceData>({ address: '', location: null })
  const [distanceMiles, setDistanceMiles] = useState('')
  const [isRoundTrip, setIsRoundTrip] = useState(false)
  
  // UI state
  const [submitting, setSubmitting] = useState(false)
  const [deleting, setDeleting] = useState(false)
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [calculatingDistance, setCalculatingDistance] = useState(false)
  const [googleLoaded, setGoogleLoaded] = useState(false)

  // Refs for autocomplete containers
  const startContainerRef = useRef<HTMLDivElement>(null)
  const endContainerRef = useRef<HTMLDivElement>(null)
  const startAutocompleteRef = useRef<HTMLElement | null>(null)
  const endAutocompleteRef = useRef<HTMLElement | null>(null)

  // Load Google Maps script (same pattern as AddMileageSheet)
  useEffect(() => {
    if (typeof window.google?.maps?.importLibrary === 'function') {
      setGoogleLoaded(true)
      return
    }

    if (document.querySelector('script[src*="maps.googleapis.com"]')) {
      const checkLoaded = setInterval(() => {
        if (typeof window.google?.maps?.importLibrary === 'function') {
          setGoogleLoaded(true)
          clearInterval(checkLoaded)
        }
      }, 100)
      return () => clearInterval(checkLoaded)
    }

    const script = document.createElement('script')
    script.src = `https://maps.googleapis.com/maps/api/js?key=${import.meta.env.VITE_GOOGLE_MAPS_API_KEY}&libraries=places&v=beta`
    script.async = true
    script.defer = true
    script.onload = () => {
      setGoogleLoaded(true)
    }
    script.onerror = () => {
      console.error('Failed to load Google Maps')
    }
    document.head.appendChild(script)
  }, [])

  // Calculate distance when both locations have geometry
  const calculateDistance = useCallback(async () => {
    if (!startLocation.location || !endLocation.location) return

    setCalculatingDistance(true)
    setError(null)

    try {
      const { DistanceMatrixService } = await window.google.maps.importLibrary('routes') as google.maps.RoutesLibrary

      const service = new DistanceMatrixService()
      const response = await new Promise<google.maps.DistanceMatrixResponse>((resolve, reject) => {
        service.getDistanceMatrix(
          {
            origins: [new google.maps.LatLng(startLocation.location!.lat, startLocation.location!.lng)],
            destinations: [new google.maps.LatLng(endLocation.location!.lat, endLocation.location!.lng)],
            travelMode: google.maps.TravelMode.DRIVING,
            unitSystem: google.maps.UnitSystem.IMPERIAL,
          },
          (response, status) => {
            if (status === 'OK' && response) {
              resolve(response)
            } else {
              reject(new Error(`Distance calculation failed: ${status}`))
            }
          }
        )
      })

      const element = response.rows[0]?.elements[0]
      if (element?.status === 'OK' && element.distance) {
        // Distance comes in meters, convert to miles
        const miles = element.distance.value / 1609.344
        setDistanceMiles(miles.toFixed(1))
      } else {
        setError('Could not calculate distance. Please enter manually.')
      }
    } catch (err) {
      console.error('Distance calculation error:', err)
      setError('Could not calculate distance. Please enter manually.')
    } finally {
      setCalculatingDistance(false)
    }
  }, [startLocation.location, endLocation.location])

  // Auto-calculate when both locations have geometry
  useEffect(() => {
    if (startLocation.location && endLocation.location) {
      calculateDistance()
    }
  }, [startLocation.location, endLocation.location, calculateDistance])

  // Initialize autocomplete elements when in edit mode
  useEffect(() => {
    if (!googleLoaded || !isOpen || mode !== 'edit') return

    // Clean up previous autocomplete elements when re-entering edit mode
    startAutocompleteRef.current = null
    endAutocompleteRef.current = null

    const initAutocomplete = async () => {
      try {
        const { PlaceAutocompleteElement } = await window.google.maps.importLibrary('places') as google.maps.PlacesLibrary

        // Create start location autocomplete
        if (startContainerRef.current && !startAutocompleteRef.current) {
          const startAutocomplete = new PlaceAutocompleteElement({})
          startAutocomplete.style.width = '100%'
          startContainerRef.current.innerHTML = ''
          startContainerRef.current.appendChild(startAutocomplete)
          startAutocompleteRef.current = startAutocomplete

          startAutocomplete.addEventListener('gmp-select', async (event: any) => {
            const placePrediction = event.placePrediction
            if (placePrediction) {
              const place = placePrediction.toPlace()
              await place.fetchFields({ fields: ['formattedAddress', 'location'] })
              const location = place.location
              setStartLocation({
                address: place.formattedAddress || '',
                location: location ? { lat: location.lat(), lng: location.lng() } : null
              })
            }
          })
        }

        // Create end location autocomplete
        if (endContainerRef.current && !endAutocompleteRef.current) {
          const endAutocomplete = new PlaceAutocompleteElement({})
          endAutocomplete.style.width = '100%'
          endContainerRef.current.innerHTML = ''
          endContainerRef.current.appendChild(endAutocomplete)
          endAutocompleteRef.current = endAutocomplete

          endAutocomplete.addEventListener('gmp-select', async (event: any) => {
            const placePrediction = event.placePrediction
            if (placePrediction) {
              const place = placePrediction.toPlace()
              await place.fetchFields({ fields: ['formattedAddress', 'location'] })
              const location = place.location
              setEndLocation({
                address: place.formattedAddress || '',
                location: location ? { lat: location.lat(), lng: location.lng() } : null
              })
            }
          })
        }
      } catch (err) {
        console.error('Error initializing autocomplete:', err)
      }
    }

    const timer = setTimeout(initAutocomplete, 150)
    return () => clearTimeout(timer)
  }, [googleLoaded, isOpen, mode])

  // Populate form when trip changes or sheet opens
  useEffect(() => {
    if (trip && isOpen) {
      setDate(trip.date.substring(0, 10))
      setDescription(trip.description || '')
      // Addresses load as text-only (no geometry) — user must re-select from
      // autocomplete to get geometry for distance recalculation
      setStartLocation({ address: trip.startLocation, location: null })
      setEndLocation({ address: trip.endLocation, location: null })
      setDistanceMiles(String(trip.distanceMiles / 100))
      setIsRoundTrip(trip.isRoundTrip)
      setMode(getDefaultMode())
      setError(null)
      setShowDeleteConfirm(false)
    }
  }, [trip, isOpen])

  // Clean up autocomplete refs when sheet closes
  useEffect(() => {
    if (!isOpen) {
      const timer = setTimeout(() => {
        setMode('view')
        setError(null)
        setShowDeleteConfirm(false)
        startAutocompleteRef.current = null
        endAutocompleteRef.current = null
      }, 300)
      return () => clearTimeout(timer)
    }
  }, [isOpen])

  // Format miles for display (stored as miles * 100)
  const formatMiles = (miles: number) => (miles / 100).toFixed(1)

  // Format date for display (timezone-safe)
  const formatDate = (dateStr: string) => {
    const [year, month, day] = dateStr.substring(0, 10).split('-').map(Number)
    return new Date(year, month - 1, day).toLocaleDateString('en-US', {
      weekday: 'long',
      month: 'long',
      day: 'numeric',
      year: 'numeric',
    })
  }

  // Calculate estimated deduction (IRS rate for 2025: $0.70/mile)
  const calculateDeduction = (miles: number, roundTrip: boolean) => {
    const effectiveMiles = roundTrip ? miles * 2 : miles
    return ((effectiveMiles / 100) * 0.70).toFixed(2)
  }

  // Handle save
  async function handleSave() {
    if (!trip) return
    setError(null)

    const distanceNum = parseFloat(distanceMiles)
    if (!distanceMiles || isNaN(distanceNum) || distanceNum <= 0) {
      setError('Please enter a valid distance')
      return
    }
    if (!date) {
      setError('Please select a date')
      return
    }
    // Use the autocomplete address if selected, otherwise use original trip address
    const finalStart = startLocation.address.trim()
    const finalEnd = endLocation.address.trim()
    if (!finalStart) {
      setError('Please enter a start location')
      return
    }
    if (!finalEnd) {
      setError('Please enter an end location')
      return
    }

    try {
      setSubmitting(true)
      const distanceStored = Math.round(distanceNum * 100)

      const response = await fetch(`/api/mileage/${trip.id}?tenant=${subdomain}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          date: date + 'T12:00:00.000Z',
          description: description.trim() || null,
          startLocation: finalStart,
          endLocation: finalEnd,
          distanceMiles: distanceStored,
          isRoundTrip,
        }),
      })

      if (!response.ok) {
        const data = await response.json()
        throw new Error(data.details?.join(', ') || data.error || 'Failed to update trip')
      }

      onUpdate()
      onClose()
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Something went wrong')
    } finally {
      setSubmitting(false)
    }
  }

  // Handle delete
  async function handleDelete() {
    if (!trip) return

    try {
      setDeleting(true)
      const response = await fetch(`/api/mileage/${trip.id}?tenant=${subdomain}`, {
        method: 'DELETE',
      })

      if (!response.ok) {
        const data = await response.json()
        throw new Error(data.error || 'Failed to delete trip')
      }

      onDelete()
      onClose()
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Something went wrong')
      setShowDeleteConfirm(false)
    } finally {
      setDeleting(false)
    }
  }

  // Handle backdrop click
  function handleBackdropClick(e: React.MouseEvent) {
    if (e.target === e.currentTarget) {
      onClose()
    }
  }

  if (!trip) return null

  const effectiveMiles = trip.isRoundTrip ? trip.distanceMiles * 2 : trip.distanceMiles

  return (
    <>
      {/* Backdrop */}
      <div 
        className={`sheet-backdrop ${isOpen ? 'sheet-backdrop--open' : ''}`}
        onClick={handleBackdropClick}
      />

      {/* Bottom Sheet */}
      <div className={`bottom-sheet ${isOpen ? 'bottom-sheet--open' : ''}`}>
        {/* Handle bar */}
        <div className="bottom-sheet__handle" onClick={onClose}>
          <div className="bottom-sheet__handle-bar" />
        </div>

        {/* Header */}
        <div className="bottom-sheet__header">
          <h2 className="bottom-sheet__title">
            {mode === 'view' ? 'Trip Details' : 'Edit Trip'}
          </h2>
          <div className="bottom-sheet__header-actions">
            {/* View/Edit Toggle */}
            <div className="mode-toggle">
              <button
                className={`mode-toggle__btn ${mode === 'view' ? 'mode-toggle__btn--active' : ''}`}
                onClick={() => handleModeChange('view')}
                aria-label="View mode"
                title="View mode"
              >
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                  <circle cx="12" cy="12" r="3" />
                </svg>
              </button>
              <button
                className={`mode-toggle__btn ${mode === 'edit' ? 'mode-toggle__btn--active' : ''}`}
                onClick={() => handleModeChange('edit')}
                aria-label="Edit mode"
                title="Edit mode"
              >
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                </svg>
              </button>
            </div>
            <button 
              className="bottom-sheet__close"
              onClick={onClose}
              aria-label="Close"
            >
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M18 6 6 18M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>

        {/* Content */}
        <div className="bottom-sheet__form">
          {/* Error Message */}
          {error && (
            <div className="form-error">
              {error}
            </div>
          )}

          {/* Delete Confirmation */}
          {showDeleteConfirm && (
            <div className="delete-confirm">
              <p className="delete-confirm__message">
                Are you sure you want to delete this trip? This cannot be undone.
              </p>
              <div className="delete-confirm__actions">
                <button 
                  className="btn btn--secondary"
                  onClick={() => setShowDeleteConfirm(false)}
                  disabled={deleting}
                >
                  Cancel
                </button>
                <button 
                  className="btn btn--danger"
                  onClick={handleDelete}
                  disabled={deleting}
                >
                  {deleting ? 'Deleting...' : 'Delete'}
                </button>
              </div>
            </div>
          )}

          {/* View Mode */}
          {mode === 'view' && !showDeleteConfirm && (
            <>
              {/* Miles - Hero Display */}
              <div className="detail-hero">
                <span className="detail-hero__emoji">🚗</span>
                <span className="detail-hero__amount">{formatMiles(effectiveMiles)} mi</span>
              </div>

              {/* Details List */}
              <div className="detail-list">
                <div className="detail-row">
                  <span className="detail-row__label">Date</span>
                  <span className="detail-row__value">{formatDate(trip.date)}</span>
                </div>
                
                <div className="detail-row">
                  <span className="detail-row__label">From</span>
                  <span className="detail-row__value">{trip.startLocation}</span>
                </div>

                <div className="detail-row">
                  <span className="detail-row__label">To</span>
                  <span className="detail-row__value">{trip.endLocation}</span>
                </div>

                <div className="detail-row">
                  <span className="detail-row__label">Distance</span>
                  <span className="detail-row__value">
                    {formatMiles(trip.distanceMiles)} mi
                    {trip.isRoundTrip && ` × 2 = ${formatMiles(effectiveMiles)} mi`}
                  </span>
                </div>

                <div className="detail-row">
                  <span className="detail-row__label">Round Trip</span>
                  <span className="detail-row__value">{trip.isRoundTrip ? 'Yes' : 'No'}</span>
                </div>

                {trip.description && (
                  <div className="detail-row">
                    <span className="detail-row__label">Description</span>
                    <span className="detail-row__value">{trip.description}</span>
                  </div>
                )}

                <div className="detail-row">
                  <span className="detail-row__label">Est. Deduction</span>
                  <span className="detail-row__value">${calculateDeduction(trip.distanceMiles, trip.isRoundTrip)}</span>
                </div>
              </div>

              {/* Action Buttons */}
              <div className="detail-actions">
                <button 
                  className="btn btn--secondary btn--full"
                  onClick={() => handleModeChange('edit')}
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                  </svg>
                  Edit Trip
                </button>
                <button 
                  className="btn btn--danger-outline btn--full"
                  onClick={() => setShowDeleteConfirm(true)}
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <polyline points="3 6 5 6 21 6" />
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                  </svg>
                  Delete Trip
                </button>
              </div>
            </>
          )}

          {/* Edit Mode */}
          {mode === 'edit' && !showDeleteConfirm && (
            <>
              {/* Date */}
              <div className="form-group">
                <label htmlFor="edit-trip-date" className="form-label">Date *</label>
                <input
                  type="date"
                  id="edit-trip-date"
                  className="form-input"
                  value={date}
                  onChange={(e) => setDate(e.target.value)}
                  required
                />
              </div>

              {/* Start Location — Google Places Autocomplete */}
              <div className="form-group">
                <label className="form-label">Start Location *</label>
                <div ref={startContainerRef} className="autocomplete-container">
                  {/* PlaceAutocompleteElement gets injected here */}
                  <input
                    type="text"
                    className="form-input"
                    placeholder="Loading address search..."
                    value={startLocation.address}
                    onChange={(e) => setStartLocation({ address: e.target.value, location: null })}
                  />
                </div>
                {startLocation.address && !startLocation.location && (
                  <span className="form-hint">Select from dropdown to enable distance calculation</span>
                )}
              </div>

              {/* End Location — Google Places Autocomplete */}
              <div className="form-group">
                <label className="form-label">End Location *</label>
                <div ref={endContainerRef} className="autocomplete-container">
                  {/* PlaceAutocompleteElement gets injected here */}
                  <input
                    type="text"
                    className="form-input"
                    placeholder="Loading address search..."
                    value={endLocation.address}
                    onChange={(e) => setEndLocation({ address: e.target.value, location: null })}
                  />
                </div>
                {endLocation.address && !endLocation.location && (
                  <span className="form-hint">Select from dropdown to enable distance calculation</span>
                )}
              </div>

              {/* Distance */}
              <div className="form-group">
                <label htmlFor="edit-distance" className="form-label">
                  Distance (miles) *
                  {calculatingDistance && <span className="form-label__status"> — Calculating...</span>}
                </label>
                <div className="input-with-suffix">
                  <input
                    type="number"
                    id="edit-distance"
                    className="form-input form-input--with-suffix"
                    placeholder="0.0"
                    step="0.1"
                    min="0.1"
                    value={distanceMiles}
                    onChange={(e) => setDistanceMiles(e.target.value)}
                    required
                  />
                  <span className="input-suffix">miles</span>
                </div>
              </div>

              {/* Round Trip Toggle */}
              <div className="form-group form-group--horizontal">
                <label htmlFor="edit-round-trip" className="form-label">Round Trip</label>
                <button
                  type="button"
                  id="edit-round-trip"
                  className={`toggle ${isRoundTrip ? 'toggle--on' : ''}`}
                  onClick={() => setIsRoundTrip(!isRoundTrip)}
                  aria-pressed={isRoundTrip}
                >
                  <span className="toggle__slider" />
                </button>
              </div>

              {/* Description */}
              <div className="form-group">
                <label htmlFor="edit-trip-description" className="form-label">Description (Optional)</label>
                <input
                  type="text"
                  id="edit-trip-description"
                  className="form-input"
                  placeholder="e.g., Client meeting, Supply pickup"
                  value={description}
                  onChange={(e) => setDescription(e.target.value)}
                />
              </div>

              {/* Action Buttons */}
              <div className="edit-actions">
                <button 
                  className="btn btn--secondary"
                  onClick={() => handleModeChange('view')}
                  disabled={submitting}
                >
                  Cancel
                </button>
                <button 
                  className="btn btn--primary"
                  onClick={handleSave}
                  disabled={submitting || calculatingDistance}
                >
                  {submitting ? 'Saving...' : calculatingDistance ? 'Calculating...' : 'Save Changes'}
                </button>
              </div>

              {/* Delete in Edit Mode */}
              <button 
                className="btn btn--danger-outline btn--full"
                onClick={() => setShowDeleteConfirm(true)}
                disabled={submitting}
                style={{ marginTop: 'var(--spacing-md)' }}
              >
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <polyline points="3 6 5 6 21 6" />
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                </svg>
                Delete Trip
              </button>
            </>
          )}
        </div>
      </div>
    </>
  )
}


--- FILE: ./src/db/default-categories.ts ---

// Default categories seeded for every new tenant
// Users can edit/delete these freely — they're just starting points

export interface DefaultCategory {
  emoji: string;
  name: string;
  expenseType: 'operating' | 'cogs';
  homeOfficeEligible: boolean;
  isSystem?: boolean;
}

export const DEFAULT_CATEGORIES: DefaultCategory[] = [
  // --- Operating Expenses ---
  { emoji: '📎', name: 'Office Supplies', expenseType: 'operating', homeOfficeEligible: false },
  { emoji: '🛡️', name: 'Business Insurance', expenseType: 'operating', homeOfficeEligible: false },
  { emoji: '✈️', name: 'Travel', expenseType: 'operating', homeOfficeEligible: false },
  { emoji: '💻', name: 'Software & Subscriptions', expenseType: 'operating', homeOfficeEligible: false },
  { emoji: '🖥️', name: 'Hardware (under $500)', expenseType: 'operating', homeOfficeEligible: false },
  { emoji: '🎓', name: 'Continuing Education', expenseType: 'operating', homeOfficeEligible: false },
  { emoji: '🤝', name: 'Contractors', expenseType: 'operating', homeOfficeEligible: false },
  { emoji: '⚖️', name: 'Professional Fees', expenseType: 'operating', homeOfficeEligible: false },
  { emoji: '📜', name: 'Business Licenses & Fees', expenseType: 'operating', homeOfficeEligible: false },
  { emoji: '🎁', name: 'Gifts to Clients', expenseType: 'operating', homeOfficeEligible: false },
  { emoji: '🍽️', name: 'Meals', expenseType: 'operating', homeOfficeEligible: false },
  { emoji: '📣', name: 'Advertising & Marketing', expenseType: 'operating', homeOfficeEligible: false },
  { emoji: '💳', name: 'Merchant Fees', expenseType: 'operating', homeOfficeEligible: false },
  { emoji: '🏦', name: 'Bank Fees', expenseType: 'operating', homeOfficeEligible: false },
  { emoji: '💰', name: 'Interest Paid', expenseType: 'operating', homeOfficeEligible: false },
  { emoji: '🌍', name: 'Web Expense', expenseType: 'operating', homeOfficeEligible: false },
  { emoji: '📋', name: 'Equipment Rental', expenseType: 'operating', homeOfficeEligible: false },
  { emoji: '📬', name: 'Postage & Delivery', expenseType: 'operating', homeOfficeEligible: false },

  // --- COGS ---
  { emoji: '🔧', name: 'Small Tools', expenseType: 'cogs', homeOfficeEligible: false },
  { emoji: '📦', name: 'General Supplies', expenseType: 'cogs', homeOfficeEligible: false },

  // --- Home Office Eligible (all Operating) ---
  { emoji: '🔨', name: 'Repairs', expenseType: 'operating', homeOfficeEligible: true },
  { emoji: '🏠', name: 'Rent', expenseType: 'operating', homeOfficeEligible: true },
  { emoji: '📞', name: 'Telephone', expenseType: 'operating', homeOfficeEligible: true },
  { emoji: '🌐', name: 'Internet', expenseType: 'operating', homeOfficeEligible: true },
  { emoji: '🏡', name: 'Homeowners Insurance', expenseType: 'operating', homeOfficeEligible: true },
  { emoji: '🔑', name: 'Renters Insurance', expenseType: 'operating', homeOfficeEligible: true },
  { emoji: '⚡', name: 'Gas / Electric', expenseType: 'operating', homeOfficeEligible: true },
  { emoji: '💧', name: 'Water', expenseType: 'operating', homeOfficeEligible: true },
  { emoji: '🏛️', name: 'Mortgage Interest', expenseType: 'operating', homeOfficeEligible: true },
  { emoji: '🏷️', name: 'Property Taxes', expenseType: 'operating', homeOfficeEligible: true },
];

// System category — always seeded, cannot be deleted
export const UNCATEGORIZED_CATEGORY: DefaultCategory = {
  emoji: '📂',
  name: 'Uncategorized',
  expenseType: 'operating',
  homeOfficeEligible: false,
  isSystem: true,
};

--- FILE: ./src/db/index.ts ---

import { neon } from '@neondatabase/serverless';
import { drizzle } from 'drizzle-orm/neon-http';
import * as schema from './schema.js';

if (!process.env.DATABASE_URL) {
  throw new Error('DATABASE_URL environment variable is not set');
}

const sql = neon(process.env.DATABASE_URL);

export const db = drizzle(sql, { schema });

--- FILE: ./src/db/schema.ts ---

import { pgTable, uuid, varchar, text, timestamp, boolean, integer, unique, index } from 'drizzle-orm/pg-core';

// ============================================
// TENANTS (Organizations/Businesses)
// ============================================
export const tenants = pgTable('tenants', {
  id: uuid('id').primaryKey().defaultRandom(),
  
  // Basic info
  name: varchar('name', { length: 255 }).notNull(),
  subdomain: varchar('subdomain', { length: 63 }).notNull().unique(), // e.g., "izrgrooming"
  
  // Branding (white-label ready)
  logoUrl: text('logo_url'),
  primaryColor: varchar('primary_color', { length: 7 }).default('#2A9D8F'), // hex color
  appName: varchar('app_name', { length: 255 }), // custom app name, falls back to global default
  
  // White-label custom domain (future)
  customDomain: varchar('custom_domain', { length: 255 }), // e.g., "expenses.sarahcpa.com"
  
  // Home Office settings (tenant-level — applies to all home_office categories equally)
  homeTotalSqft: integer('home_total_sqft'), // total home square footage
  homeOfficeSqft: integer('home_office_sqft'), // dedicated office square footage
  homeOfficeIgnored: boolean('home_office_ignored').default(false).notNull(), // user explicitly dismissed home office setup
  
  // Settings
  defaultCategoryId: uuid('default_category_id'), // user-configured default for Add Expense
  isActive: boolean('is_active').default(true).notNull(),
  
  // Billing attribution - who created this tenant?
  createdBy: uuid('created_by'), // references users.id, but can't use FK due to circular dependency
  
  // Audit fields
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

// ============================================
// USERS
// ============================================
export const users = pgTable('users', {
  id: uuid('id').primaryKey().defaultRandom(),
  tenantId: uuid('tenant_id').references(() => tenants.id), // nullable for super admins who exist outside tenants
  
  // Auth
  email: varchar('email', { length: 255 }).notNull(),
  passwordHash: varchar('password_hash', { length: 255 }), // nullable - OAuth users won't have one
  emailVerified: boolean('email_verified').default(false).notNull(),
  
  // OAuth providers (store provider's user ID for linking)
  googleId: varchar('google_id', { length: 255 }),
  appleId: varchar('apple_id', { length: 255 }),
  
  // Profile
  firstName: varchar('first_name', { length: 100 }),
  lastName: varchar('last_name', { length: 100 }),
  
  // Role: 'owner' | 'admin' | 'editor' | 'data_entry' | 'viewer' | 'accountant'
  // NOTE: This is the user's role within their PRIMARY tenant (tenantId above)
  // For multi-tenant access, see user_tenant_access table
  role: varchar('role', { length: 50 }).default('viewer').notNull(),
  
  // Special user types (exist above tenant level)
  isSuperAdmin: boolean('is_super_admin').default(false).notNull(), // Amber - can see/do everything
  isAccountant: boolean('is_accountant').default(false).notNull(), // CPAs - can access multiple tenants
  
  // Preferences
  theme: varchar('theme', { length: 50 }).default('teal-tide'),
  
  // Audit fields
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
  lastLoginAt: timestamp('last_login_at'),
});

// ============================================
// USER TENANT ACCESS (Junction table for multi-tenant access)
// ============================================
export const userTenantAccess = pgTable('user_tenant_access', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
  tenantId: uuid('tenant_id').notNull().references(() => tenants.id, { onDelete: 'cascade' }),
  
  // Role within THIS tenant: 'owner' | 'admin' | 'editor' | 'data_entry' | 'viewer' | 'accountant'
  role: varchar('role', { length: 50 }).notNull(),
  
  // For accountants: can they edit expenses? (default: no, read-only)
  canEdit: boolean('can_edit').default(false).notNull(),
  
  // Who invited this user to this tenant?
  invitedBy: uuid('invited_by').references(() => users.id),
  
  // Audit fields
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
}, (table) => [
  // Each user can only have one access record per tenant
  unique('user_tenant_unique').on(table.userId, table.tenantId),
]);

// ============================================
// CATEGORIES
// ============================================
export const categories = pgTable('categories', {
  id: uuid('id').primaryKey().defaultRandom(),
  tenantId: uuid('tenant_id').notNull().references(() => tenants.id),
  
  // Display
  name: varchar('name', { length: 100 }).notNull(),
  emoji: varchar('emoji', { length: 10 }).default('📁'), // emoji icon
  
  // Classification default — when an expense uses this category, default to this type
  expenseType: varchar('expense_type', { length: 50 }).default('operating').notNull(), // 'cogs' | 'operating' | 'home_office'
  
  // Home Office — only relevant when expenseType = 'home_office'
  homeOfficeEligible: boolean('home_office_eligible').default(false).notNull(),
  
  // System categories can't be deleted (e.g., "Uncategorized")
  isSystem: boolean('is_system').default(false).notNull(),
  
  // Sorting
  sortOrder: integer('sort_order').default(0),
  
  // Soft delete (for "move expenses to uncategorized" flow)
  isActive: boolean('is_active').default(true).notNull(),
  
  // Audit fields
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

// ============================================
// EXPENSES
// ============================================
export const expenses = pgTable('expenses', {
  id: uuid('id').primaryKey().defaultRandom(),
  tenantId: uuid('tenant_id').notNull().references(() => tenants.id),
  
  // Core fields
  amount: integer('amount').notNull(), // stored in cents to avoid floating point nonsense
  vendor: varchar('vendor', { length: 255 }),
  description: text('description'),
  date: timestamp('date').notNull(),
  
  // Classification
  categoryId: uuid('category_id').references(() => categories.id),
  expenseType: varchar('expense_type', { length: 50 }).default('operating').notNull(), // 'cogs' | 'operating' | 'home_office'
  
  // Home office specific
  isHomeOffice: boolean('is_home_office').default(false).notNull(),
  homeOfficePercent: integer('home_office_percent'), // snapshot of deduction % at time of creation
  
  // Receipt
  receiptUrl: text('receipt_url'),
  extractedText: text('extracted_text'), // from AI scan, for full-text search
  
  // Recurring expense link
  recurringExpenseId: uuid('recurring_expense_id'), // we'll add the FK after creating that table
  
  // Audit fields
  createdBy: uuid('created_by').references(() => users.id),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedBy: uuid('updated_by').references(() => users.id),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

// ============================================
// EXPENSE ATTACHMENTS (Receipt images, PDFs)
// ============================================
export const expenseAttachments = pgTable('expense_attachments', {
  id: uuid('id').primaryKey().defaultRandom(),
  tenantId: uuid('tenant_id').notNull().references(() => tenants.id),
  expenseId: uuid('expense_id').notNull().references(() => expenses.id, { onDelete: 'cascade' }),
  
  // File metadata
  blobUrl: text('blob_url').notNull(), // Vercel Blob URL
  fileName: varchar('file_name', { length: 500 }).notNull(), // original filename
  fileSize: integer('file_size').notNull(), // bytes
  mimeType: varchar('mime_type', { length: 100 }).notNull(), // image/jpeg, image/png, image/heic, application/pdf
  
  // Display ordering
  sortOrder: integer('sort_order').default(0).notNull(),
  
  // Audit fields
  uploadedBy: uuid('uploaded_by').references(() => users.id),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

// ============================================
// EXPENSE HISTORY (Audit Trail)
// ============================================
export const expenseHistory = pgTable('expense_history', {
  id: uuid('id').primaryKey().defaultRandom(),
  expenseId: uuid('expense_id').notNull().references(() => expenses.id),
  tenantId: uuid('tenant_id').notNull().references(() => tenants.id),
  
  // What changed
  action: varchar('action', { length: 20 }).notNull(), // 'create' | 'update' | 'delete'
  
  // Snapshot of the expense at this point in time
  previousValues: text('previous_values'), // JSON blob of old values (null on create)
  newValues: text('new_values'), // JSON blob of new values (null on delete)
  
  // Who did it and when
  changedBy: uuid('changed_by').references(() => users.id),
  changedAt: timestamp('changed_at').defaultNow().notNull(),
});

// ============================================
// MILEAGE TRIPS
// ============================================
export const mileageTrips = pgTable('mileage_trips', {
  id: uuid('id').primaryKey().defaultRandom(),
  tenantId: uuid('tenant_id').notNull().references(() => tenants.id),
  
  // Trip details
  date: timestamp('date').notNull(),
  description: varchar('description', { length: 255 }),
  
  // Locations
  startLocation: varchar('start_location', { length: 500 }).notNull(),
  endLocation: varchar('end_location', { length: 500 }).notNull(),
  
  // Distance
  distanceMiles: integer('distance_miles').notNull(), // stored as miles * 100 for precision (e.g., 12.5 miles = 1250)
  isRoundTrip: boolean('is_round_trip').default(false).notNull(),
  
  // Audit fields
  createdBy: uuid('created_by').references(() => users.id),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedBy: uuid('updated_by').references(() => users.id),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

// ============================================
// SAVED LOCATIONS (for quick mileage entry)
// ============================================
export const savedLocations = pgTable('saved_locations', {
  id: uuid('id').primaryKey().defaultRandom(),
  tenantId: uuid('tenant_id').notNull().references(() => tenants.id),
  
  // Location info
  name: varchar('name', { length: 100 }).notNull(), // e.g., "Office", "Home", "Client HQ"
  address: varchar('address', { length: 500 }).notNull(),
  
  // Sorting
  sortOrder: integer('sort_order').default(0),
  
  // Audit fields
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

// ============================================
// VENDOR CATEGORY MAPPINGS (learns from user behavior)
// ============================================
export const vendorCategoryMappings = pgTable('vendor_category_mappings', {
  id: uuid('id').primaryKey().defaultRandom(),
  tenantId: uuid('tenant_id').notNull().references(() => tenants.id),
  
  // The mapping
  vendorPattern: varchar('vendor_pattern', { length: 255 }).notNull(), // lowercase, trimmed vendor name
  categoryId: uuid('category_id').notNull().references(() => categories.id),
  
  // How confident are we? (increments each time user confirms this mapping)
  useCount: integer('use_count').default(1).notNull(),
  
  // Audit fields
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

// ============================================
// RECURRING EXPENSES (templates for auto-generation)
// ============================================
export const recurringExpenses = pgTable('recurring_expenses', {
  id: uuid('id').primaryKey().defaultRandom(),
  tenantId: uuid('tenant_id').notNull().references(() => tenants.id),
  
  // Template details (mirrors expense fields)
  amount: integer('amount').notNull(), // cents
  vendor: varchar('vendor', { length: 255 }),
  description: text('description'),
  categoryId: uuid('category_id').references(() => categories.id),
  expenseType: varchar('expense_type', { length: 50 }).default('operating').notNull(),
  
  // Schedule
  frequency: varchar('frequency', { length: 20 }).default('monthly').notNull(), // 'monthly' | 'quarterly' | 'yearly'
  dayOfMonth: integer('day_of_month').default(1), // 1-31, when to generate
  
  // Tracking
  lastGeneratedAt: timestamp('last_generated_at'),
  nextGenerationAt: timestamp('next_generation_at'),
  isActive: boolean('is_active').default(true).notNull(),
  
  // Audit fields
  createdBy: uuid('created_by').references(() => users.id),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

// ============================================
// SESSIONS (for authentication)
// ============================================
export const sessions = pgTable('sessions', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').notNull().references(() => users.id),
  tenantId: uuid('tenant_id').references(() => tenants.id), // nullable for super admins/accountants
  
  // Session token (stored in HTTP-only cookie)
  token: varchar('token', { length: 255 }).notNull().unique(),
  
  // Expiration
  expiresAt: timestamp('expires_at').notNull(),
  
  // Metadata
  userAgent: text('user_agent'),
  ipAddress: varchar('ip_address', { length: 45 }), // supports IPv6
  
  // Audit
  createdAt: timestamp('created_at').defaultNow().notNull(),
});

// ============================================
// ACCOUNTANT INVITES
// ============================================
export const accountantInvites = pgTable('accountant_invites', {
  id: uuid('id').primaryKey().defaultRandom(),
  tenantId: uuid('tenant_id').notNull().references(() => tenants.id),
  
  // Invite details
  email: varchar('email', { length: 255 }).notNull(),
  inviteToken: varchar('invite_token', { length: 255 }).notNull().unique(),
  
  // Status
  status: varchar('status', { length: 20 }).default('pending').notNull(), // 'pending' | 'accepted' | 'revoked'
  expiresAt: timestamp('expires_at').notNull(),
  
  // If accepted, links to the accountant user record
  acceptedByUserId: uuid('accepted_by_user_id').references(() => users.id),
  acceptedAt: timestamp('accepted_at'),
  
  // Audit
  invitedBy: uuid('invited_by').references(() => users.id),
  createdAt: timestamp('created_at').defaultNow().notNull(),
});

// ============================================
// INVITES (Super Admin → New Client Onboarding)
// ============================================
export const invites = pgTable('invites', {
  id: uuid('id').primaryKey().defaultRandom(),
  
  // Who is being invited
  email: varchar('email', { length: 255 }).notNull(),
  firstName: varchar('first_name', { length: 100 }),
  lastName: varchar('last_name', { length: 100 }),
  
  // Which tenant they'll own
  tenantId: uuid('tenant_id').notNull().references(() => tenants.id),
  
  // Role to assign on acceptance
  role: varchar('role', { length: 50 }).default('owner').notNull(),
  
  // Who sent the invite
  invitedBy: uuid('invited_by').notNull().references(() => users.id),
  
  // Invite token (in the email link)
  token: varchar('token', { length: 255 }).notNull().unique(),
  
  // Status tracking
  status: varchar('status', { length: 20 }).default('pending').notNull(), // 'pending' | 'accepted' | 'expired'
  expiresAt: timestamp('expires_at').notNull(),
  acceptedAt: timestamp('accepted_at'),
  
  // Audit fields
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

// ============================================
// EXPENSE POLICIES (per sub-user rules)
// ============================================
export const expensePolicies = pgTable('expense_policies', {
  id: uuid('id').primaryKey().defaultRandom(),
  tenantId: uuid('tenant_id').notNull().references(() => tenants.id),
  userId: uuid('user_id').notNull().references(() => users.id), // the sub-user this policy applies to

  // Policy rules (all optional - null means no restriction)
  maxExpenseAmount: integer('max_expense_amount'), // cents - flag expenses over this
  requireNotesAbove: integer('require_notes_above'), // cents - require notes for expenses over this
  allowedCategories: text('allowed_categories'), // JSON array of category IDs, null = all allowed

  // Audit
  createdBy: uuid('created_by').references(() => users.id),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

// ============================================
// RATE LIMIT USAGE (tracks API usage per tenant)
// ============================================
export const rateLimitUsage = pgTable('rate_limit_usage', {
  id: uuid('id').defaultRandom().primaryKey(),
  tenantId: uuid('tenant_id').notNull().references(() => tenants.id),
  actionType: varchar('action_type', { length: 50 }).notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
}, (table) => [
  index('rate_limit_tenant_action_time_idx').on(table.tenantId, table.actionType, table.createdAt),
]);


--- FILE: ./src/pages/CategoriesPage.tsx ---

import { useState, useEffect } from 'react'
import { useLocation } from 'wouter'
import { useTenant } from '../hooks/useTenant'
import { useYear } from '../hooks/useYear'
import { useRefresh } from '../hooks/useRefresh'
import { CategorySheet } from '../components/CategorySheet'

interface Category {
  id: string
  name: string
  emoji: string | null
  expenseType: string
  homeOfficeEligible: boolean
  isSystem: boolean
  sortOrder: number
  isActive: boolean
  total: number
  count: number
}

interface HomeOfficeSettings {
  homeTotalSqft: number | null
  homeOfficeSqft: number | null
  homeOfficeIgnored: boolean
  deductionPercent: number | null
}

export default function CategoriesPage() {
  const { subdomain } = useTenant()
  const { year } = useYear()
  const { expenseKey, refreshExpenses } = useRefresh()
  const [, setLocation] = useLocation()

  // Data state
  const [categories, setCategories] = useState<Category[]>([])
  const [homeOfficeSettings, setHomeOfficeSettings] = useState<HomeOfficeSettings>({
    homeTotalSqft: null,
    homeOfficeSqft: null,
    homeOfficeIgnored: false,
    deductionPercent: null,
  })
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  // Sheet state
  const [sheetOpen, setSheetOpen] = useState(false)
  const [editingCategory, setEditingCategory] = useState<Category | null>(null)

  // Delete confirmation state
  const [deletingCategory, setDeletingCategory] = useState<Category | null>(null)
  const [deleteReassignTo, setDeleteReassignTo] = useState<string>('')
  const [deleteSubmitting, setDeleteSubmitting] = useState(false)

  // Home Office edit state
  const [editingHomeOffice, setEditingHomeOffice] = useState(false)
  const [hoTotalSqft, setHoTotalSqft] = useState('')
  const [hoOfficeSqft, setHoOfficeSqft] = useState('')
  const [hoSaving, setHoSaving] = useState(false)
  const [hoError, setHoError] = useState<string | null>(null)

  // Home Office ignore confirmation state
  const [showIgnoreConfirm, setShowIgnoreConfirm] = useState(false)
  const [ignoreSaving, setIgnoreSaving] = useState(false)

  // Local refresh key for category changes that don't affect expenses
  const [categoryKey, setCategoryKey] = useState(0)

  // ============================================
  // DERIVED STATE
  // ============================================
  const homeOfficeComplete = homeOfficeSettings.homeTotalSqft !== null && homeOfficeSettings.homeOfficeSqft !== null
  const homeOfficeIgnored = homeOfficeSettings.homeOfficeIgnored
  const hasHomeOfficeCategories = categories.some(c => c.homeOfficeEligible)
  // Show above categories when: has eligible categories, NOT complete, NOT ignored
  const showHomeOfficeAbove = hasHomeOfficeCategories && !homeOfficeComplete && !homeOfficeIgnored
  // Show below categories when: has eligible categories AND (complete OR ignored)
  const showHomeOfficeBelow = hasHomeOfficeCategories && (homeOfficeComplete || homeOfficeIgnored)

  // ============================================
  // FETCH CATEGORIES WITH SPENDING DATA
  // ============================================
  useEffect(() => {
    async function fetchCategories() {
      try {
        setLoading(true)
        const params = new URLSearchParams()
        if (subdomain) params.set('tenant', subdomain)
        params.set('includeSpending', 'true')
        params.set('year', String(year))

        const response = await fetch(`/api/categories?${params}`)
        if (!response.ok) {
          const err = await response.json()
          throw new Error(err.error || 'Failed to fetch categories')
        }

        const result = await response.json()
        setCategories(result.categories)
        if (result.homeOfficeSettings) {
          setHomeOfficeSettings(result.homeOfficeSettings)
          // Sync local inputs
          setHoTotalSqft(result.homeOfficeSettings.homeTotalSqft?.toString() || '')
          setHoOfficeSqft(result.homeOfficeSettings.homeOfficeSqft?.toString() || '')
        }
      } catch (err) {
        setError(err instanceof Error ? err.message : 'Unknown error')
      } finally {
        setLoading(false)
      }
    }

    fetchCategories()
  }, [subdomain, year, expenseKey, categoryKey])

  // ============================================
  // HELPERS
  // ============================================
  const formatMoney = (cents: number) => {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
    }).format(cents / 100)
  }

  const handleCategoryClick = (categoryName: string) => {
    setLocation(`/expenses?category=${encodeURIComponent(categoryName)}`)
  }

  const totalSpent = categories.reduce((sum, cat) => sum + cat.total, 0)
  const totalCount = categories.reduce((sum, cat) => sum + cat.count, 0)

  // ============================================
  // ADD / EDIT HANDLERS
  // ============================================
  function handleAdd() {
    setEditingCategory(null)
    setSheetOpen(true)
  }

  function handleEdit(e: React.MouseEvent, category: Category) {
    e.stopPropagation() // Don't trigger card click → navigate
    setEditingCategory(category)
    setSheetOpen(true)
  }

  function handleSheetSuccess() {
    setCategoryKey(k => k + 1)
    refreshExpenses() // Category changes may affect expense displays
  }

  // ============================================
  // DELETE HANDLERS
  // ============================================
  function handleDeleteClick(e: React.MouseEvent, category: Category) {
    e.stopPropagation()
    setDeletingCategory(category)
    setDeleteReassignTo('') // Default = Uncategorized (empty means server picks it)
  }

  async function handleDeleteConfirm() {
    if (!deletingCategory) return

    try {
      setDeleteSubmitting(true)

      const body: Record<string, string> = {}
      if (deleteReassignTo) {
        body.reassignTo = deleteReassignTo
      }

      const response = await fetch(
        `/api/categories/${deletingCategory.id}?tenant=${subdomain}`,
        {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        }
      )

      if (!response.ok) {
        const data = await response.json()
        throw new Error(data.error || 'Failed to delete category')
      }

      setDeletingCategory(null)
      setCategoryKey(k => k + 1)
      refreshExpenses()
    } catch (err) {
      alert(err instanceof Error ? err.message : 'Something went wrong')
    } finally {
      setDeleteSubmitting(false)
    }
  }

  // ============================================
  // HOME OFFICE SETTINGS HANDLERS
  // ============================================
  async function handleHomeOfficeSave() {
    setHoError(null)

    const total = hoTotalSqft ? parseInt(hoTotalSqft) : null
    const office = hoOfficeSqft ? parseInt(hoOfficeSqft) : null

    if (total !== null && office !== null && office > total) {
      setHoError('Office space can\'t be larger than total home')
      return
    }

    try {
      setHoSaving(true)

      const response = await fetch(`/api/categories/home-office?tenant=${subdomain}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          homeTotalSqft: total,
          homeOfficeSqft: office,
        }),
      })

      if (!response.ok) {
        const data = await response.json()
        throw new Error(data.details?.join(', ') || data.error || 'Failed to save')
      }

      const result = await response.json()
      setHomeOfficeSettings(result.homeOfficeSettings)
      setEditingHomeOffice(false)
    } catch (err) {
      setHoError(err instanceof Error ? err.message : 'Something went wrong')
    } finally {
      setHoSaving(false)
    }
  }

  // ============================================
  // HOME OFFICE IGNORE HANDLERS
  // ============================================
  async function handleIgnoreConfirm() {
    try {
      setIgnoreSaving(true)

      const response = await fetch(`/api/categories/home-office?tenant=${subdomain}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ homeOfficeIgnored: true }),
      })

      if (!response.ok) {
        const data = await response.json()
        throw new Error(data.error || 'Failed to save')
      }

      const result = await response.json()
      setHomeOfficeSettings(result.homeOfficeSettings)
      setShowIgnoreConfirm(false)
    } catch (err) {
      alert(err instanceof Error ? err.message : 'Something went wrong')
    } finally {
      setIgnoreSaving(false)
    }
  }

  async function handleUnignore() {
    try {
      setIgnoreSaving(true)

      const response = await fetch(`/api/categories/home-office?tenant=${subdomain}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ homeOfficeIgnored: false }),
      })

      if (!response.ok) {
        const data = await response.json()
        throw new Error(data.error || 'Failed to save')
      }

      const result = await response.json()
      setHomeOfficeSettings(result.homeOfficeSettings)

      // Scroll to top so user sees the section in its new position
      window.scrollTo({ top: 0, behavior: 'smooth' })
    } catch (err) {
      alert(err instanceof Error ? err.message : 'Something went wrong')
    } finally {
      setIgnoreSaving(false)
    }
  }

  // ============================================
  // RENDER: HOME OFFICE SECTION (reusable)
  // ============================================
  function renderHomeOfficeSection() {
    return (
      <div className="home-office-config">
        <div className="home-office-config__header">
          <div>
            <h2 className="home-office-config__title">🏡 Home Office Deduction</h2>
            <p className="home-office-config__desc">
              Set your home dimensions to calculate the deduction percentage applied to eligible categories.
            </p>
          </div>
          {!editingHomeOffice && homeOfficeComplete && (
            <button
              className="btn btn--secondary btn--sm"
              onClick={() => setEditingHomeOffice(true)}
            >
              Edit
            </button>
          )}
          {!editingHomeOffice && !homeOfficeComplete && (
            <button
              className="btn btn--secondary btn--sm"
              onClick={() => setEditingHomeOffice(true)}
            >
              Set Up
            </button>
          )}
        </div>

        {/* Ignore checkbox — show when incomplete (above position) or when ignored (below position) */}
        {(!homeOfficeComplete) && (
          <label className="home-office-config__ignore-label">
            <input
              type="checkbox"
              checked={homeOfficeIgnored}
              onChange={(e) => {
                if (e.target.checked) {
                  setShowIgnoreConfirm(true)
                } else {
                  handleUnignore()
                }
              }}
              disabled={ignoreSaving}
            />
            <span>I don't have a home office</span>
          </label>
        )}

        {editingHomeOffice ? (
          <div className="home-office-config__form">
            {hoError && <div className="form-error">{hoError}</div>}
            <div className="home-office-config__inputs">
              <div className="form-group">
                <label htmlFor="hoTotal" className="form-label">Total Home (sq ft)</label>
                <input
                  type="number"
                  id="hoTotal"
                  className="form-input"
                  placeholder="e.g., 1500"
                  min="0"
                  max="100000"
                  value={hoTotalSqft}
                  onChange={(e) => setHoTotalSqft(e.target.value)}
                />
              </div>
              <div className="form-group">
                <label htmlFor="hoOffice" className="form-label">Office Space (sq ft)</label>
                <input
                  type="number"
                  id="hoOffice"
                  className="form-input"
                  placeholder="e.g., 200"
                  min="0"
                  max="100000"
                  value={hoOfficeSqft}
                  onChange={(e) => setHoOfficeSqft(e.target.value)}
                />
              </div>
            </div>
            {hoTotalSqft && hoOfficeSqft && parseInt(hoOfficeSqft) <= parseInt(hoTotalSqft) && (
              <div className="home-office-config__preview">
                Deduction Rate: <strong>{((parseInt(hoOfficeSqft) / parseInt(hoTotalSqft)) * 100).toFixed(1)}%</strong>
              </div>
            )}
            <div className="home-office-config__actions">
              <button
                className="btn btn--secondary btn--sm"
                onClick={() => {
                  setEditingHomeOffice(false)
                  setHoError(null)
                  // Reset to saved values
                  setHoTotalSqft(homeOfficeSettings.homeTotalSqft?.toString() || '')
                  setHoOfficeSqft(homeOfficeSettings.homeOfficeSqft?.toString() || '')
                }}
              >
                Cancel
              </button>
              <button
                className="btn btn--primary btn--sm"
                onClick={handleHomeOfficeSave}
                disabled={hoSaving}
              >
                {hoSaving ? 'Saving...' : 'Save'}
              </button>
            </div>
          </div>
        ) : homeOfficeComplete ? (
          <div className="home-office-config__display">
            <div className="home-office-config__stat">
              <span className="home-office-config__stat-label">Total Home</span>
              <span className="home-office-config__stat-value">
                {homeOfficeSettings.homeTotalSqft!.toLocaleString()} sq ft
              </span>
            </div>
            <div className="home-office-config__stat">
              <span className="home-office-config__stat-label">Office Space</span>
              <span className="home-office-config__stat-value">
                {homeOfficeSettings.homeOfficeSqft?.toLocaleString() || '—'} sq ft
              </span>
            </div>
            <div className="home-office-config__stat home-office-config__stat--highlight">
              <span className="home-office-config__stat-label">Deduction Rate</span>
              <span className="home-office-config__stat-value">
                {homeOfficeSettings.deductionPercent !== null
                  ? `${homeOfficeSettings.deductionPercent}%`
                  : '—'}
              </span>
            </div>
          </div>
        ) : !homeOfficeIgnored ? (
          <div className="home-office-config__empty">
            Set your home and office dimensions to see your deduction rate.
          </div>
        ) : null}

        {/* Home Office Warnings */}
        {homeOfficeSettings.homeTotalSqft && homeOfficeSettings.homeOfficeSqft && (
          <div className="home-office-config__warnings">
            {homeOfficeSettings.homeOfficeSqft > 300 && (
              <div className="home-office-config__warning">
                <span className="home-office-config__warning-icon">💡</span>
                <span>Your office exceeds 300 sq ft — the IRS simplified method caps at 300 sq ft ($1,500 max deduction). You're using the regular method, which has no cap, but keep documentation handy.</span>
              </div>
            )}
            {homeOfficeSettings.deductionPercent !== null && homeOfficeSettings.deductionPercent > 33 && (
              <div className="home-office-config__warning home-office-config__warning--caution">
                <span className="home-office-config__warning-icon">⚠️</span>
                <span>Claiming over 33% of your home as office space may increase audit scrutiny. Make sure you have documentation (photos, floor plan) to support your claim.</span>
              </div>
            )}
          </div>
        )}

        {/* Eligible categories list */}
        {homeOfficeSettings.deductionPercent !== null && (
          <div className="home-office-config__eligible">
            <span className="home-office-config__eligible-label">Eligible categories:</span>
            {categories.filter(c => c.homeOfficeEligible).map(c => (
              <span key={c.id} className="home-office-config__eligible-tag">
                {c.emoji} {c.name}
              </span>
            ))}
          </div>
        )}
      </div>
    )
  }

  // ============================================
  // RENDER
  // ============================================
  if (loading) {
    return (
      <div className="page">
        <p style={{ color: 'var(--color-text-secondary)' }}>Loading categories...</p>
      </div>
    )
  }

  if (error) {
    return (
      <div className="page">
        <div className="card" style={{ borderLeft: '4px solid var(--color-error)' }}>
          <h2 style={{ margin: 0, color: 'var(--color-error)' }}>Error</h2>
          <p style={{ marginBottom: 0 }}>{error}</p>
        </div>
      </div>
    )
  }

  // Categories sorted alphabetically by name
  const sortedCategories = [...categories].sort((a, b) => a.name.localeCompare(b.name))

  const maxTotal = sortedCategories.length > 0
    ? Math.max(...sortedCategories.map(c => c.total))
    : 0

  return (
    <div className="page categories-page">
      <div className="categories-page__header">
        <h1 className="page__title">Categories</h1>
        <button className="btn btn--primary btn--sm" onClick={handleAdd}>
          + Add
        </button>
      </div>

      {/* Summary */}
      <div className="categories-page__summary">
        <span>{categories.length} categories</span>
        <span className="categories-page__dot">·</span>
        <span>{totalCount} expenses</span>
        <span className="categories-page__dot">·</span>
        <span>{formatMoney(totalSpent)} total</span>
      </div>

      {/* Home Office ABOVE categories (incomplete + not ignored) */}
      {showHomeOfficeAbove && (
        <>
          {renderHomeOfficeSection()}
          <div className="categories-page__divider" />
        </>
      )}

      {/* Category Cards */}
      {sortedCategories.length === 0 ? (
        <div className="card">
          <p style={{ color: 'var(--color-text-secondary)', margin: 0 }}>
            No categories yet. Add one to get started!
          </p>
        </div>
      ) : (
        <div className="category-grid">
          {sortedCategories.map((category) => (
            <div
              key={category.id}
              className="category-card category-card--clickable"
              onClick={() => category.count > 0 ? handleCategoryClick(category.name) : undefined}
              role={category.count > 0 ? 'button' : undefined}
              tabIndex={category.count > 0 ? 0 : undefined}
              onKeyDown={(e) => {
                if ((e.key === 'Enter' || e.key === ' ') && category.count > 0) {
                  e.preventDefault()
                  handleCategoryClick(category.name)
                }
              }}
            >
              <div className="category-card__header">
                <span className="category-card__emoji">{category.emoji || '📁'}</span>
                <span className="category-card__name">
                  {category.name}
                  {category.homeOfficeEligible && (
                    <span className="category-card__badge" title="Home Office Eligible">🏡</span>
                  )}
                  {category.isSystem && (
                    <span className="category-card__badge category-card__badge--system" title="System category">🔒</span>
                  )}
                </span>
                <div className="category-card__actions">
                  <button
                    className="category-card__action-btn"
                    onClick={(e) => handleEdit(e, category)}
                    aria-label={`Edit ${category.name}`}
                    title="Edit"
                  >
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                    </svg>
                  </button>
                  {!category.isSystem && (
                    <button
                      className="category-card__action-btn category-card__action-btn--danger"
                      onClick={(e) => handleDeleteClick(e, category)}
                      aria-label={`Delete ${category.name}`}
                      title="Delete"
                    >
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <polyline points="3 6 5 6 21 6" />
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                      </svg>
                    </button>
                  )}
                </div>
              </div>
              <div className="category-card__stats">
                <div className="category-card__total">
                  {category.total > 0 ? formatMoney(category.total) : '—'}
                </div>
                <div className="category-card__count">
                  {category.count > 0
                    ? `${category.count} expense${category.count !== 1 ? 's' : ''}`
                    : 'No expenses'}
                </div>
              </div>
              {category.total > 0 && maxTotal > 0 && (
                <>
                  <div className="category-card__bar-container">
                    <div
                      className="category-card__bar"
                      style={{ width: `${(category.total / maxTotal) * 100}%` }}
                    />
                  </div>
                  <div className="category-card__percent">
                    {((category.total / totalSpent) * 100).toFixed(1)}% of total
                  </div>
                </>
              )}
              {category.total === 0 && (
                <div className="category-card__type-badge">
                  {category.expenseType === 'cogs' ? 'COGS' :
                   category.expenseType === 'home_office' ? 'Home Office' : 'Operating'}
                </div>
              )}
            </div>
          ))}
        </div>
      )}

      {/* Home Office BELOW categories (complete OR ignored) */}
      {showHomeOfficeBelow && (
        <>
          <div className="categories-page__divider" />
          {renderHomeOfficeSection()}
        </>
      )}

      {/* ============================================
         IGNORE CONFIRMATION MODAL
         ============================================ */}
      {showIgnoreConfirm && (
        <>
          <div className="sheet-backdrop sheet-backdrop--open" onClick={() => setShowIgnoreConfirm(false)} />
          <div className="delete-modal">
            <h3 className="delete-modal__title">Ignore Home Office Deduction?</h3>
            <div className="delete-modal__body">
              <p>
                This setting is for businesses that <strong>do not claim a home office deduction</strong> on their taxes.
              </p>
              <p>
                You can re-enable this at any time from the Home Office section at the bottom of the Categories page.
              </p>
            </div>
            <div className="delete-modal__actions">
              <button
                className="btn btn--secondary"
                onClick={() => setShowIgnoreConfirm(false)}
                disabled={ignoreSaving}
              >
                Cancel
              </button>
              <button
                className="btn btn--primary"
                onClick={handleIgnoreConfirm}
                disabled={ignoreSaving}
              >
                {ignoreSaving ? 'Saving...' : 'Yes, Ignore'}
              </button>
            </div>
          </div>
        </>
      )}

      {/* ============================================
         DELETE CONFIRMATION MODAL
         ============================================ */}
      {deletingCategory && (
        <>
          <div className="sheet-backdrop sheet-backdrop--open" onClick={() => setDeletingCategory(null)} />
          <div className="delete-modal">
            <h3 className="delete-modal__title">Delete "{deletingCategory.name}"?</h3>

            {deletingCategory.count > 0 ? (
              <div className="delete-modal__body">
                <p className="delete-modal__warning">
                  This category has <strong>{deletingCategory.count} expense{deletingCategory.count !== 1 ? 's' : ''}</strong> totaling{' '}
                  <strong>{formatMoney(deletingCategory.total)}</strong>.
                </p>
                <p>These expenses will be reassigned to:</p>
                <select
                  className="form-input form-select"
                  value={deleteReassignTo}
                  onChange={(e) => setDeleteReassignTo(e.target.value)}
                >
                  <option value="">📂 Uncategorized (default)</option>
                  {categories
                    .filter(c => c.id !== deletingCategory.id && !c.isSystem)
                    .map(c => (
                      <option key={c.id} value={c.id}>
                        {c.emoji} {c.name}
                      </option>
                    ))}
                </select>
              </div>
            ) : (
              <p className="delete-modal__body">
                This category has no expenses and will be removed.
              </p>
            )}

            <div className="delete-modal__actions">
              <button
                className="btn btn--secondary"
                onClick={() => setDeletingCategory(null)}
                disabled={deleteSubmitting}
              >
                Cancel
              </button>
              <button
                className="btn btn--danger"
                onClick={handleDeleteConfirm}
                disabled={deleteSubmitting}
              >
                {deleteSubmitting ? 'Deleting...' : 'Delete Category'}
              </button>
            </div>
          </div>
        </>
      )}

      {/* ============================================
         CATEGORY SHEET (Add/Edit)
         ============================================ */}
      <CategorySheet
        isOpen={sheetOpen}
        onClose={() => setSheetOpen(false)}
        onSuccess={handleSheetSuccess}
        editCategory={editingCategory}
      />
    </div>
  )
}

--- FILE: ./src/pages/InvitePage.tsx ---

import { useState, useEffect } from 'react'

export default function InvitePage() {
  const [loading, setLoading] = useState(true)
  const [valid, setValid] = useState(false)
  const [businessName, setBusinessName] = useState('')
  const [reason, setReason] = useState<string | null>(null)

  const params = new URLSearchParams(window.location.search)
  const token = params.get('token')

  useEffect(() => {
    if (!token) {
      setLoading(false)
      setReason('missing_token')
      return
    }

    async function validate() {
      try {
        const response = await fetch(`/api/invites/validate?token=${token}`)
        const data = await response.json()

        if (data.valid) {
          setValid(true)
          setBusinessName(data.businessName)
        } else {
          setValid(false)
          setReason(data.reason || 'invalid')
          setBusinessName(data.businessName || '')
        }
      } catch {
        setReason('error')
      } finally {
        setLoading(false)
      }
    }

    validate()
  }, [token])

  const handleSignIn = () => {
    window.location.href = '/api/auth/google'
  }

  if (loading) {
    return (
      <div className="invite-page">
        <div className="invite-page__card">
          <p className="invite-page__loading">Validating invite...</p>
        </div>
      </div>
    )
  }

  if (!valid) {
    return (
      <div className="invite-page">
        <div className="invite-page__card">
          <h1 className="invite-page__title">Wayve Expense Tracker</h1>
          {reason === 'missing_token' && (
            <p className="invite-page__error">Invalid invite link. Please check the link from your email.</p>
          )}
          {reason === 'expired' && (
            <>
              <p className="invite-page__error">This invite has expired.</p>
              {businessName && <p className="invite-page__detail">Business: {businessName}</p>}
              <p className="invite-page__detail">Please contact your administrator to request a new invite.</p>
            </>
          )}
          {reason === 'already_used' && (
            <>
              <p className="invite-page__error">This invite has already been used.</p>
              {businessName && <p className="invite-page__detail">Business: {businessName}</p>}
              <p className="invite-page__detail">
                <a href="/login" className="invite-page__link">Sign in here</a> if you already have an account.
              </p>
            </>
          )}
          {reason === 'invalid' && (
            <p className="invite-page__error">Invalid invite link. Please check the link from your email.</p>
          )}
          {reason === 'error' && (
            <p className="invite-page__error">Something went wrong. Please try again later.</p>
          )}
        </div>
      </div>
    )
  }

  return (
    <div className="invite-page">
      <div className="invite-page__card">
        <h1 className="invite-page__title">Wayve Expense Tracker</h1>
        <p className="invite-page__welcome">
          You've been invited to manage expenses for
        </p>
        <p className="invite-page__business">{businessName}</p>
        <button className="invite-page__google-btn" onClick={handleSignIn}>
          <svg width="20" height="20" viewBox="0 0 24 24">
            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/>
            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
          </svg>
          Sign in with Google
        </button>
        <p className="invite-page__note">
          You'll use your Google account to sign in. No new password needed.
        </p>
      </div>
    </div>
  )
}

--- FILE: ./src/pages/DashboardPage.tsx ---

import { useState, useEffect, useCallback } from 'react'
import { useLocation } from 'wouter'
import { useTenant } from '../hooks/useTenant'
import { useYear } from '../hooks/useYear'
import { useRefresh } from '../hooks/useRefresh'
import { ExpenseDetailSheet } from '../components/ExpenseDetailSheet'
import { MileageDetailSheet } from '../components/MileageDetailSheet'
import { PieChart, Pie, Cell, ResponsiveContainer, Tooltip } from 'recharts'

interface Expense {
  id: string
  amount: number
  vendor: string | null
  description: string | null
  date: string
  categoryId: string | null
  categoryName: string | null
  categoryEmoji: string | null
  expenseType?: string
}

interface CategoryBreakdown {
  name: string
  emoji: string | null
  total: number
  count: number
}

interface DashboardData {
  expenses: Expense[]
  summary: {
    totalAmount: number
    totalDeductible: number
    expenseCount: number
    averageAmount: number
    year: number
  }
  categoryBreakdown: CategoryBreakdown[]
}

interface MileageTrip {
  id: string
  date: string
  description: string | null
  startLocation: string
  endLocation: string
  distanceMiles: number
  displayMiles: number
  isRoundTrip: boolean
}

interface MileageData {
  trips: MileageTrip[]
  summary: {
    totalMiles: number
    tripCount: number
    estimatedDeduction: number
    year: number
  }
}

// Color palette for donut chart (colorblind-friendly)
const CHART_COLORS = [
  '#2A9D8F', // teal (primary)
  '#E9C46A', // gold
  '#F4A261', // orange
  '#E76F51', // coral
  '#264653', // dark blue
  '#8AB17D', // sage
  '#A06CD5', // purple
  '#6B9AC4', // sky blue
  '#D4A5A5', // dusty rose
  '#9DC183', // olive
  '#F0B5B3', // blush
  '#7EB6C4', // teal light
]

export default function DashboardPage() {
  const { subdomain } = useTenant()
  const { year } = useYear()
  const { expenseKey, mileageKey, refreshExpenses, refreshMileage } = useRefresh()
  const [, setLocation] = useLocation()
  const [data, setData] = useState<DashboardData | null>(null)
  const [mileageData, setMileageData] = useState<MileageData | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  // Detail sheet state
  const [selectedExpense, setSelectedExpense] = useState<Expense | null>(null)
  const [expenseSheetOpen, setExpenseSheetOpen] = useState(false)
  const [selectedTrip, setSelectedTrip] = useState<MileageTrip | null>(null)
  const [tripSheetOpen, setTripSheetOpen] = useState(false)

  const fetchDashboard = useCallback(async () => {
    try {
      setLoading(true)
      const params = new URLSearchParams()
      if (subdomain) params.set('tenant', subdomain)
      params.set('year', String(year))
      params.set('limit', '500')

      // Fetch expenses and mileage in parallel
      const [expenseResponse, mileageResponse] = await Promise.all([
        fetch(`/api/expenses?${params}`),
        fetch(`/api/mileage?${params}`)
      ])

      if (!expenseResponse.ok) {
        const err = await expenseResponse.json()
        throw new Error(err.error || 'Failed to fetch expenses')
      }

      const expenseResult = await expenseResponse.json()
      setData(expenseResult)

      // Mileage is optional - don't fail if it errors
      if (mileageResponse.ok) {
        const mileageResult = await mileageResponse.json()
        setMileageData(mileageResult)
      }
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Unknown error')
    } finally {
      setLoading(false)
    }
  }, [subdomain, year])

  useEffect(() => {
    fetchDashboard()
  }, [fetchDashboard, expenseKey, mileageKey])

  // Navigate to expenses filtered by category
  const handleCategoryClick = (categoryName: string) => {
    setLocation(`/expenses?category=${encodeURIComponent(categoryName)}`)
  }

  // Open expense detail sheet
  const handleExpenseClick = (expense: Expense) => {
    setSelectedExpense(expense)
    setExpenseSheetOpen(true)
  }

  // Open trip detail sheet
  const handleTripClick = (trip: MileageTrip) => {
    setSelectedTrip(trip)
    setTripSheetOpen(true)
  }

  if (loading) {
    return (
      <div className="page">
        <p style={{ color: 'var(--color-text-secondary)' }}>Loading dashboard...</p>
      </div>
    )
  }

  if (error) {
    return (
      <div className="page">
        <div className="card" style={{ borderLeft: '4px solid var(--color-error)' }}>
          <h2 style={{ margin: 0, color: 'var(--color-error)' }}>Error</h2>
          <p style={{ marginBottom: 0 }}>{error}</p>
        </div>
      </div>
    )
  }

  if (!data) return null

  const { summary, categoryBreakdown, expenses } = data

  // Format cents to dollars
  const formatMoney = (cents: number) => {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
    }).format(cents / 100)
  }

  // Format miles (stored as miles * 100)
  const formatMiles = (miles: number) => (miles / 100).toFixed(1)

  // Format date (timezone-safe)
  const formatDate = (dateStr: string) => {
    const [year, month, day] = dateStr.substring(0, 10).split('-').map(Number)
    return new Date(year, month - 1, day).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
    })
  }

  // Get recent expenses (last 10)
  const recentExpenses = expenses.slice(0, 10)

  // Get recent trips (last 5)
  const recentTrips = mileageData?.trips.slice(0, 5) || []

  // Prepare donut chart data (top 6 categories + "Other")
  const prepareChartData = () => {
    if (categoryBreakdown.length === 0) return []
    
    const topCategories = categoryBreakdown.slice(0, 6)
    const otherCategories = categoryBreakdown.slice(6)
    
    const chartData = topCategories.map((cat, index) => ({
      name: cat.name,
      value: cat.total,
      emoji: cat.emoji,
      color: CHART_COLORS[index % CHART_COLORS.length],
    }))
    
    if (otherCategories.length > 0) {
      const otherTotal = otherCategories.reduce((sum, cat) => sum + cat.total, 0)
      chartData.push({
        name: 'Other',
        value: otherTotal,
        emoji: '📁',
        color: CHART_COLORS[6],
      })
    }
    
    return chartData
  }

  const chartData = prepareChartData()

  // Custom tooltip for donut chart
  const CustomTooltip = ({ active, payload }: { active?: boolean; payload?: Array<{ payload: { name: string; value: number; emoji: string } }> }) => {
    if (active && payload && payload.length) {
      const data = payload[0].payload
      return (
        <div className="donut-tooltip">
          <span className="donut-tooltip__emoji">{data.emoji}</span>
          <span className="donut-tooltip__name">{data.name}</span>
          <span className="donut-tooltip__value">{formatMoney(data.value)}</span>
        </div>
      )
    }
    return null
  }

  return (
    <div className="page dashboard">
      <h1 className="page__title">Dashboard</h1>

      {/* ==================== DONUT CHART ==================== */}
      {chartData.length > 0 && (
        <div className="card donut-card">
          <h2 className="card__title">Spending by Category</h2>
          <div className="donut-container">
            <div className="donut-chart">
              <ResponsiveContainer width="100%" height={200}>
                <PieChart>
                  <Pie
                    data={chartData}
                    cx="50%"
                    cy="50%"
                    innerRadius={50}
                    outerRadius={80}
                    paddingAngle={2}
                    dataKey="value"
                  >
                    {chartData.map((entry, index) => (
                      <Cell key={`cell-${index}`} fill={entry.color} />
                    ))}
                  </Pie>
                  <Tooltip content={<CustomTooltip />} />
                </PieChart>
              </ResponsiveContainer>
              <div className="donut-center">
                <span className="donut-center__amount">{formatMoney(summary.totalAmount)}</span>
                <span className="donut-center__label">Total</span>
              </div>
            </div>
            <ul className="donut-legend">
              {chartData.map((entry, index) => (
                <li 
                  key={index} 
                  className="donut-legend__item"
                  onClick={() => entry.name !== 'Other' && handleCategoryClick(entry.name)}
                  role={entry.name !== 'Other' ? 'button' : undefined}
                  tabIndex={entry.name !== 'Other' ? 0 : undefined}
                  onKeyDown={(e) => {
                    if (entry.name !== 'Other' && (e.key === 'Enter' || e.key === ' ')) {
                      e.preventDefault()
                      handleCategoryClick(entry.name)
                    }
                  }}
                >
                  <span 
                    className="donut-legend__color" 
                    style={{ backgroundColor: entry.color }}
                  />
                  <span className="donut-legend__emoji">{entry.emoji}</span>
                  <span className="donut-legend__name">{entry.name}</span>
                  <span className="donut-legend__value">{formatMoney(entry.value)}</span>
                </li>
              ))}
            </ul>
          </div>
        </div>
      )}

      {/* ==================== EXPENSES SECTION ==================== */}
      
      {/* Expense Summary Cards */}
      <div className="dashboard__summary dashboard__summary--half">
        <div 
          className="summary-card summary-card--clickable"
          onClick={() => setLocation('/reports')}
          role="button"
          tabIndex={0}
          onKeyDown={(e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault()
              setLocation('/reports')
            }
          }}
        >
          <span className="summary-card__label">Total Deductible</span>
          <span className="summary-card__value">{formatMoney(summary.totalDeductible)}</span>
          <span className="summary-card__sub">
            {summary.totalDeductible !== summary.totalAmount
              ? `${formatMoney(summary.totalAmount)} spent`
              : `${summary.year}`}
          </span>
        </div>
        <div 
          className="summary-card summary-card--clickable"
          onClick={() => setLocation('/expenses')}
          role="button"
          tabIndex={0}
          onKeyDown={(e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault()
              setLocation('/expenses')
            }
          }}
        >
          <span className="summary-card__label">Expenses</span>
          <span className="summary-card__value">{summary.expenseCount}</span>
          <span className="summary-card__sub">transactions</span>
        </div>
      </div>

      {/* Expense Details Grid */}
      <div className="dashboard__grid">
        {/* Recent Expenses */}
        <div className="card">
          <h2 
            className="card__title card__title--clickable"
            onClick={() => setLocation('/expenses')}
            role="button"
            tabIndex={0}
            onKeyDown={(e) => {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault()
                setLocation('/expenses')
              }
            }}
          >
            Recent Expenses →
          </h2>
          {recentExpenses.length === 0 ? (
            <p style={{ color: 'var(--color-text-secondary)' }}>No expenses yet</p>
          ) : (
            <ul className="expense-list">
              {recentExpenses.map((expense) => (
                <li 
                  key={expense.id} 
                  className="expense-list__item expense-list__item--clickable"
                  onClick={() => handleExpenseClick(expense)}
                  role="button"
                  tabIndex={0}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                      e.preventDefault()
                      handleExpenseClick(expense)
                    }
                  }}
                >
                  <div className="expense-list__icon">
                    {expense.categoryEmoji || '📁'}
                  </div>
                  <div className="expense-list__details">
                    <span className="expense-list__vendor">
                      {expense.vendor || expense.description || 'Expense'}
                    </span>
                    <span className="expense-list__meta">
                      {expense.categoryName || 'Uncategorized'} • {formatDate(expense.date)}
                    </span>
                  </div>
                  <span className="expense-list__amount">
                    {formatMoney(expense.amount)}
                  </span>
                </li>
              ))}
            </ul>
          )}
        </div>

        {/* Category Breakdown */}
        <div className="card">
          <h2 className="card__title">By Category</h2>
          {categoryBreakdown.length === 0 ? (
            <p style={{ color: 'var(--color-text-secondary)' }}>No categories yet</p>
          ) : (
            <ul className="category-list">
              {categoryBreakdown.slice(0, 8).map((cat) => (
                <li 
                  key={cat.name} 
                  className="category-list__item category-list__item--clickable"
                  onClick={() => handleCategoryClick(cat.name)}
                  role="button"
                  tabIndex={0}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                      e.preventDefault()
                      handleCategoryClick(cat.name)
                    }
                  }}
                >
                  <div className="category-list__info">
                    <span className="category-list__emoji">{cat.emoji || '📁'}</span>
                    <span className="category-list__name">{cat.name}</span>
                    <span className="category-list__count">{cat.count}</span>
                  </div>
                  <div className="category-list__bar-container">
                    <div 
                      className="category-list__bar" 
                      style={{ 
                        width: `${(cat.total / categoryBreakdown[0].total) * 100}%` 
                      }}
                    />
                  </div>
                  <span className="category-list__total">{formatMoney(cat.total)}</span>
                </li>
              ))}
            </ul>
          )}
        </div>
      </div>

      {/* Section Divider */}
      <div className="dashboard__divider" />

      {/* ==================== MILEAGE SECTION ==================== */}
      
      {/* Mileage Summary Cards */}
      <div className="dashboard__summary dashboard__summary--half">
        <div 
          className="summary-card summary-card--clickable"
          onClick={() => setLocation('/mileage')}
          role="button"
          tabIndex={0}
          onKeyDown={(e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault()
              setLocation('/mileage')
            }
          }}
        >
          <span className="summary-card__label">Total Miles</span>
          <span className="summary-card__value">
            {mileageData?.summary ? formatMiles(mileageData.summary.totalMiles) : '0'}
          </span>
          <span className="summary-card__sub">{year}</span>
        </div>
        <div 
          className="summary-card summary-card--clickable"
          onClick={() => setLocation('/mileage')}
          role="button"
          tabIndex={0}
          onKeyDown={(e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault()
              setLocation('/mileage')
            }
          }}
        >
          <span className="summary-card__label">Trips</span>
          <span className="summary-card__value">
            {mileageData?.summary?.tripCount || 0}
          </span>
          <span className="summary-card__sub">logged</span>
        </div>
      </div>

      {/* Mileage Details Grid */}
      <div className="dashboard__grid">
        {/* Recent Trips */}
        <div className="card">
          <h2 
            className="card__title card__title--clickable"
            onClick={() => setLocation('/mileage')}
            role="button"
            tabIndex={0}
            onKeyDown={(e) => {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault()
                setLocation('/mileage')
              }
            }}
          >
            Recent Trips →
          </h2>
          {recentTrips.length === 0 ? (
            <p style={{ color: 'var(--color-text-secondary)' }}>No trips logged yet</p>
          ) : (
            <ul className="trip-list">
              {recentTrips.map((trip) => (
                <li 
                  key={trip.id} 
                  className="trip-list__item trip-list__item--clickable"
                  onClick={() => handleTripClick(trip)}
                  role="button"
                  tabIndex={0}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                      e.preventDefault()
                      handleTripClick(trip)
                    }
                  }}
                >
                  <div className="trip-list__icon">
                    {trip.isRoundTrip ? '🔄' : '📍'}
                  </div>
                  <div className="trip-list__details">
                    <span className="trip-list__route">
                      {trip.description || `${truncateLocation(trip.startLocation)} → ${truncateLocation(trip.endLocation)}`}
                    </span>
                    <span className="trip-list__meta">
                      {formatDate(trip.date)}
                      {trip.isRoundTrip && ' · Round trip'}
                    </span>
                  </div>
                  <span className="trip-list__miles">
                    {formatMiles(trip.displayMiles)} mi
                  </span>
                </li>
              ))}
            </ul>
          )}
        </div>

        {/* Estimated Deduction Card */}
        <div className="card">
          <h2 className="card__title">Est. Tax Deduction</h2>
          <div className="deduction-display">
            <span className="deduction-display__value">
              {mileageData?.summary ? formatMoney(mileageData.summary.estimatedDeduction) : '$0.00'}
            </span>
            <span className="deduction-display__rate">@ 70¢/mile (2025 IRS rate)</span>
            <p className="deduction-display__note">
              This is an estimate based on IRS standard mileage rates. Consult a tax professional for actual deductions.
            </p>
          </div>
        </div>
      </div>

      {/* Expense Detail Sheet */}
      <ExpenseDetailSheet
        expense={selectedExpense}
        isOpen={expenseSheetOpen}
        onClose={() => setExpenseSheetOpen(false)}
        onUpdate={refreshExpenses}
        onDelete={refreshExpenses}
      />

      {/* Mileage Detail Sheet */}
      <MileageDetailSheet
        trip={selectedTrip}
        isOpen={tripSheetOpen}
        onClose={() => setTripSheetOpen(false)}
        onUpdate={refreshMileage}
        onDelete={refreshMileage}
      />
    </div>
  )
}

// Helper to truncate long addresses
function truncateLocation(location: string, maxLength = 20): string {
  if (location.length <= maxLength) return location
  const commaIndex = location.indexOf(',')
  if (commaIndex > 0 && commaIndex <= maxLength) {
    return location.substring(0, commaIndex)
  }
  return location.substring(0, maxLength) + '...'
}

--- FILE: ./src/pages/AnnualSummaryPage.tsx ---

import { useState, useEffect } from 'react'
import { useYear } from '../hooks/useYear'
import { useTenant } from '../hooks/useTenant'
import { Link } from 'wouter'
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
} from 'recharts'

interface MonthlySummary {
  month: number
  label: string
  labelFull: string
  total: number
  count: number
}

interface CategorySummary {
  categoryId: string
  name: string
  emoji: string
  amount: number
  count: number
  percentage: number
}

interface AnnualReportData {
  year: number
  summary: {
    totalSpent: number
    totalDeductible: number
    expenseCount: number
    activeMonths: number
    averagePerMonth: number
    highestMonth: { label: string; total: number } | null
    lowestMonth: { label: string; total: number } | null
    topCategory: { name: string; emoji: string; amount: number; percentage: number } | null
  }
  monthlyBreakdown: MonthlySummary[]
  categoryBreakdown: CategorySummary[]
}

function formatDollars(cents: number): string {
  return (cents / 100).toLocaleString('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  })
}

function formatDollarsShort(cents: number): string {
  const dollars = cents / 100
  if (dollars >= 10000) {
    return '$' + (dollars / 1000).toFixed(1) + 'k'
  }
  return formatDollars(cents)
}

// Custom tooltip for monthly chart
function MonthlyTooltip({ active, payload, label }: { active?: boolean; payload?: Array<{ value: number }>; label?: string }) {
  if (!active || !payload || !payload.length) return null
  return (
    <div className="annual-chart-tooltip">
      <p className="annual-chart-tooltip__label">{label}</p>
      <p className="annual-chart-tooltip__value">{formatDollars(payload[0].value)}</p>
    </div>
  )
}

export default function AnnualSummaryPage() {
  const { year, nextYear, prevYear } = useYear()
  const { subdomain } = useTenant()
  const [data, setData] = useState<AnnualReportData | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  const currentYear = new Date().getFullYear()

  useEffect(() => {
    if (!subdomain) return

    async function fetchData() {
      setLoading(true)
      setError(null)
      try {
        const params = new URLSearchParams({
          tenant: subdomain!,
          year: year.toString(),
        })
        const response = await fetch(`/api/reports/annual?${params}`)
        if (!response.ok) throw new Error('Failed to fetch annual report')
        const result = await response.json()
        setData(result)
      } catch (err) {
        console.error('Annual report error:', err)
        setError('Failed to load annual report')
      } finally {
        setLoading(false)
      }
    }

    fetchData()
  }, [subdomain, year])

  // Prepare chart data — always show all 12 months
  const chartData = data
    ? data.monthlyBreakdown.map((m) => ({
        name: m.label,
        total: m.total,
      }))
    : []

  return (
    <div className="page annual-report-page">
      <div className="annual-report-page__nav">
        <Link href="/reports" className="back-link">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <polyline points="15 18 9 12 15 6" />
          </svg>
          Reports
        </Link>
      </div>

      <div className="annual-report-page__header">
        <h1 className="annual-report-page__title">Annual Summary</h1>
        <div className="annual-report-page__year-selector">
          <button
            className="year-nav-btn"
            onClick={prevYear}
            disabled={year <= 2020}
            aria-label="Previous year"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <polyline points="15 18 9 12 15 6" />
            </svg>
          </button>
          <span className="annual-report-page__year">{year}</span>
          <button
            className="year-nav-btn"
            onClick={nextYear}
            disabled={year >= currentYear}
            aria-label="Next year"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <polyline points="9 18 15 12 9 6" />
            </svg>
          </button>
        </div>
      </div>

      <p className="annual-report-page__description">
        Complete spending overview for {year}.
      </p>

      {loading && (
        <div className="card" style={{ textAlign: 'center', padding: 'var(--spacing-2xl)' }}>
          <p style={{ color: 'var(--color-text-secondary)' }}>Loading annual data...</p>
        </div>
      )}

      {error && (
        <div className="card" style={{ textAlign: 'center', padding: 'var(--spacing-2xl)' }}>
          <p style={{ color: 'var(--color-error)' }}>{error}</p>
        </div>
      )}

      {!loading && !error && data && (
        <>
          {data.summary.expenseCount === 0 ? (
            <div className="card" style={{ textAlign: 'center', padding: 'var(--spacing-2xl)' }}>
              <p className="empty-state__icon">📊</p>
              <p style={{ color: 'var(--color-text-secondary)' }}>No expenses recorded for {year}.</p>
            </div>
          ) : (
            <>
              {/* Summary Cards */}
              <div className="annual-report__summary">
                <div className="annual-report__stat-card annual-report__stat-card--primary">
                  <span className="annual-report__stat-label">Total Deductible</span>
                  <span className="annual-report__stat-value">{formatDollars(data.summary.totalDeductible)}</span>
                  <span className="annual-report__stat-sub">
                    {data.summary.totalDeductible !== data.summary.totalSpent
                      ? `${formatDollars(data.summary.totalSpent)} spent · ${data.summary.expenseCount} transactions`
                      : `${data.summary.expenseCount} transactions`}
                  </span>
                </div>
                <div className="annual-report__stat-card">
                  <span className="annual-report__stat-label">Avg / Month</span>
                  <span className="annual-report__stat-value">{formatDollars(data.summary.averagePerMonth)}</span>
                  <span className="annual-report__stat-sub">{data.summary.activeMonths} active month{data.summary.activeMonths !== 1 ? 's' : ''}</span>
                </div>
                {data.summary.topCategory && (
                  <div className="annual-report__stat-card">
                    <span className="annual-report__stat-label">Top Category</span>
                    <span className="annual-report__stat-value">
                      {data.summary.topCategory.emoji} {data.summary.topCategory.name}
                    </span>
                    <span className="annual-report__stat-sub">
                      {formatDollars(data.summary.topCategory.amount)} ({data.summary.topCategory.percentage}%)
                    </span>
                  </div>
                )}
              </div>

              {/* High / Low months */}
              {data.summary.highestMonth && data.summary.lowestMonth && data.summary.activeMonths > 1 && (
                <div className="annual-report__highlights">
                  <div className="annual-report__highlight">
                    <span className="annual-report__highlight-icon">📈</span>
                    <div>
                      <span className="annual-report__highlight-label">Highest</span>
                      <span className="annual-report__highlight-value">
                        {data.summary.highestMonth.label} — {formatDollars(data.summary.highestMonth.total)}
                      </span>
                    </div>
                  </div>
                  <div className="annual-report__highlight">
                    <span className="annual-report__highlight-icon">📉</span>
                    <div>
                      <span className="annual-report__highlight-label">Lowest</span>
                      <span className="annual-report__highlight-value">
                        {data.summary.lowestMonth.label} — {formatDollars(data.summary.lowestMonth.total)}
                      </span>
                    </div>
                  </div>
                </div>
              )}

              {/* Monthly Spending Chart */}
              <div className="card annual-report__chart-card">
                <h2 className="card__title">Monthly Spending</h2>
                <div className="annual-report__chart">
                  <ResponsiveContainer width="100%" height={280}>
                    <BarChart data={chartData} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
                      <CartesianGrid strokeDasharray="3 3" stroke="var(--color-border)" />
                      <XAxis
                        dataKey="name"
                        tick={{ fontSize: 12, fill: 'var(--color-text-secondary)' }}
                        axisLine={{ stroke: 'var(--color-border)' }}
                        tickLine={false}
                      />
                      <YAxis
                        tickFormatter={(v: number) => formatDollarsShort(v)}
                        tick={{ fontSize: 12, fill: 'var(--color-text-secondary)' }}
                        axisLine={false}
                        tickLine={false}
                        width={55}
                      />
                      <Tooltip content={<MonthlyTooltip />} cursor={{ fill: 'rgba(0,0,0,0.04)' }} />
                      <Bar
                        dataKey="total"
                        fill="var(--color-primary)"
                        radius={[4, 4, 0, 0]}
                        maxBarSize={40}
                      />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </div>

              {/* Category Breakdown Table */}
              <div className="card annual-report__category-card">
                <h2 className="card__title">By Category</h2>
                <div className="annual-report__category-list">
                  {data.categoryBreakdown.map((cat) => (
                    <div key={cat.categoryId} className="annual-report__category-row">
                      <div className="annual-report__category-info">
                        <span className="annual-report__category-emoji">{cat.emoji}</span>
                        <span className="annual-report__category-name">{cat.name}</span>
                      </div>
                      <div className="annual-report__category-stats">
                        <span className="annual-report__category-count">{cat.count} txn{cat.count !== 1 ? 's' : ''}</span>
                        <span className="annual-report__category-pct">{cat.percentage}%</span>
                        <span className="annual-report__category-amount">{formatDollars(cat.amount)}</span>
                      </div>
                      <div className="annual-report__category-bar-track">
                        <div
                          className="annual-report__category-bar-fill"
                          style={{ width: `${cat.percentage}%` }}
                        />
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </>
          )}
        </>
      )}
    </div>
  )
}


--- FILE: ./src/pages/TaxSummaryPage.tsx ---

import { useState, useEffect } from 'react'
import { useYear } from '../hooks/useYear'
import { useTenant } from '../hooks/useTenant'
import { Link } from 'wouter'

interface CategoryDetail {
  categoryId: string
  name: string
  emoji: string
  amount: number
  deductible: number
  count: number
  percentOfType: number
}

interface TypeSection {
  type: string
  label: string
  description: string
  order: number
  total: number
  deductible: number
  count: number
  percentOfTotal: number
  categories: CategoryDetail[]
}

interface TaxSummaryData {
  year: number
  totalSpent: number
  totalDeductible: number
  expenseCount: number
  sections: TypeSection[]
}

const TYPE_COLORS: Record<string, string> = {
  cogs: '#e76f51',
  operating: '#2a9d8f',
  home_office: '#e9c46a',
}

function formatDollars(cents: number): string {
  return (cents / 100).toLocaleString('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  })
}

export default function TaxSummaryPage() {
  const { year, nextYear, prevYear } = useYear()
  const { subdomain } = useTenant()
  const [data, setData] = useState<TaxSummaryData | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [expandedSections, setExpandedSections] = useState<Set<string>>(new Set())

  const currentYear = new Date().getFullYear()

  useEffect(() => {
    if (!subdomain) return

    async function fetchData() {
      setLoading(true)
      setError(null)
      try {
        const params = new URLSearchParams({
          tenant: subdomain!,
          year: year.toString(),
        })
        const response = await fetch(`/api/reports/tax-summary?${params}`)
        if (!response.ok) throw new Error('Failed to fetch tax summary')
        const result = await response.json()
        setData(result)
      } catch (err) {
        console.error('Tax summary error:', err)
        setError('Failed to load tax summary')
      } finally {
        setLoading(false)
      }
    }

    fetchData()
  }, [subdomain, year])

  function toggleSection(type: string) {
    setExpandedSections((prev) => {
      const next = new Set(prev)
      if (next.has(type)) {
        next.delete(type)
      } else {
        next.add(type)
      }
      return next
    })
  }

  return (
    <div className="page tax-summary-page">
      <div className="tax-summary-page__nav">
        <Link href="/reports" className="back-link">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <polyline points="15 18 9 12 15 6" />
          </svg>
          Reports
        </Link>
      </div>

      <div className="tax-summary-page__header">
        <h1 className="tax-summary-page__title">Tax Summary</h1>
        <div className="tax-summary-page__year-selector">
          <button
            className="year-nav-btn"
            onClick={prevYear}
            disabled={year <= 2020}
            aria-label="Previous year"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <polyline points="15 18 9 12 15 6" />
            </svg>
          </button>
          <span className="tax-summary-page__year">{year}</span>
          <button
            className="year-nav-btn"
            onClick={nextYear}
            disabled={year >= currentYear}
            aria-label="Next year"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <polyline points="9 18 15 12 9 6" />
            </svg>
          </button>
        </div>
      </div>

      <p className="tax-summary-page__description">
        Expenses grouped by tax classification for {year}. Tap a section to see category details.
      </p>

      {loading && (
        <div className="card" style={{ textAlign: 'center', padding: 'var(--spacing-2xl)' }}>
          <p style={{ color: 'var(--color-text-secondary)' }}>Loading tax data...</p>
        </div>
      )}

      {error && (
        <div className="card" style={{ textAlign: 'center', padding: 'var(--spacing-2xl)' }}>
          <p style={{ color: 'var(--color-error)' }}>{error}</p>
        </div>
      )}

      {!loading && !error && data && (
        <>
          {data.expenseCount === 0 ? (
            <div className="card" style={{ textAlign: 'center', padding: 'var(--spacing-2xl)' }}>
              <p className="empty-state__icon">🧾</p>
              <p style={{ color: 'var(--color-text-secondary)' }}>No expenses recorded for {year}.</p>
            </div>
          ) : (
            <>
              {/* Grand Total */}
              <div className="tax-summary__grand-total">
                <span className="tax-summary__grand-total-label">Total Deductible</span>
                <span className="tax-summary__grand-total-value">{formatDollars(data.totalDeductible)}</span>
                <span className="tax-summary__grand-total-sub">{data.expenseCount} transactions</span>
                {data.totalDeductible !== data.totalSpent && (
                  <span className="tax-summary__grand-total-deductible">
                    💰 {formatDollars(data.totalSpent)} total spent
                  </span>
                )}
              </div>

              {/* Composition Bar */}
              <div className="tax-summary__composition-bar">
                {data.sections
                  .filter((s) => s.total > 0)
                  .map((section) => (
                    <div
                      key={section.type}
                      className="tax-summary__composition-segment"
                      style={{
                        width: `${section.percentOfTotal}%`,
                        backgroundColor: TYPE_COLORS[section.type] || 'var(--color-text-secondary)',
                      }}
                      title={`${section.label}: ${section.percentOfTotal}%`}
                    />
                  ))}
              </div>

              {/* Composition Legend */}
              <div className="tax-summary__composition-legend">
                {data.sections
                  .filter((s) => s.total > 0)
                  .map((section) => (
                    <div key={section.type} className="tax-summary__legend-item">
                      <span
                        className="tax-summary__legend-dot"
                        style={{ backgroundColor: TYPE_COLORS[section.type] || 'var(--color-text-secondary)' }}
                      />
                      <span className="tax-summary__legend-label">{section.label.split('(')[0].trim()}</span>
                      <span className="tax-summary__legend-pct">{section.percentOfTotal}%</span>
                    </div>
                  ))}
              </div>

              {/* Type Sections */}
              <div className="tax-summary__sections">
                {data.sections.map((section) => {
                  const isExpanded = expandedSections.has(section.type)
                  const accentColor = TYPE_COLORS[section.type] || 'var(--color-text-secondary)'
                  const hasPartialDeduction = section.deductible !== section.total

                  return (
                    <div key={section.type} className="tax-summary__section">
                      <button
                        className="tax-summary__section-header"
                        onClick={() => toggleSection(section.type)}
                        aria-expanded={isExpanded}
                      >
                        <div className="tax-summary__section-left">
                          <span
                            className="tax-summary__section-indicator"
                            style={{ backgroundColor: accentColor }}
                          />
                          <div>
                            <span className="tax-summary__section-title">{section.label}</span>
                            <span className="tax-summary__section-desc">{section.description}</span>
                          </div>
                        </div>
                        <div className="tax-summary__section-right">
                          <div className="tax-summary__section-stats">
                            <span className="tax-summary__section-amount">{formatDollars(section.total)}</span>
                            {hasPartialDeduction && (
                              <span className="tax-summary__section-deductible">
                                {formatDollars(section.deductible)} deductible
                              </span>
                            )}
                            <span className="tax-summary__section-meta">
                              {section.count} txn{section.count !== 1 ? 's' : ''} · {section.percentOfTotal}%
                            </span>
                          </div>
                          <svg
                            className={`tax-summary__section-chevron ${isExpanded ? 'tax-summary__section-chevron--open' : ''}`}
                            width="20"
                            height="20"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            strokeWidth="2"
                          >
                            <polyline points="6 9 12 15 18 9" />
                          </svg>
                        </div>
                      </button>

                      {isExpanded && section.categories.length > 0 && (
                        <div className="tax-summary__section-details">
                          {section.categories.map((cat) => {
                            const catHasPartial = cat.deductible !== cat.amount
                            return (
                              <div key={cat.categoryId} className="tax-summary__cat-row">
                                <span className="tax-summary__cat-emoji">{cat.emoji}</span>
                                <div className="tax-summary__cat-info">
                                  <span className="tax-summary__cat-name">{cat.name}</span>
                                  {catHasPartial && (
                                    <span className="tax-summary__cat-deductible">
                                      {formatDollars(cat.deductible)} deductible
                                    </span>
                                  )}
                                </div>
                                <span className="tax-summary__cat-count">{cat.count}</span>
                                <span className="tax-summary__cat-amount">{formatDollars(cat.amount)}</span>
                              </div>
                            )
                          })}
                        </div>
                      )}

                      {isExpanded && section.categories.length === 0 && (
                        <div className="tax-summary__section-details">
                          <p className="tax-summary__section-empty">No expenses in this category for {year}.</p>
                        </div>
                      )}
                    </div>
                  )
                })}
              </div>

              {/* Disclaimer */}
              <p className="tax-summary__disclaimer">
                This summary groups expenses by their assigned classification. It is not tax advice. 
                Consult a qualified tax professional for actual tax preparation and filing.
              </p>
            </>
          )}
        </>
      )}
    </div>
  )
}


--- FILE: ./src/pages/MileagePage.tsx ---

import { useState, useEffect } from 'react'
import { useTenant } from '../hooks/useTenant'
import { useYear } from '../hooks/useYear'
import { useRefresh } from '../hooks/useRefresh'
import { AddMileageSheet } from '../components/AddMileageSheet'
import { MileageDetailSheet } from '../components/MileageDetailSheet'

interface MileageTrip {
  id: string
  date: string
  description: string | null
  startLocation: string
  endLocation: string
  distanceMiles: number
  displayMiles: number
  isRoundTrip: boolean
}

export default function MileagePage() {
  const { subdomain } = useTenant()
  const { year } = useYear()
  const { mileageKey, refreshMileage } = useRefresh()
  
  const [trips, setTrips] = useState<MileageTrip[]>([])
  const [loading, setLoading] = useState(true)
  const [sheetOpen, setSheetOpen] = useState(false)
  const [selectedTrip, setSelectedTrip] = useState<MileageTrip | null>(null)
  const [detailSheetOpen, setDetailSheetOpen] = useState(false)
  const [searchQuery, setSearchQuery] = useState('')

  useEffect(() => {
    async function fetchMileage() {
      if (!subdomain) return
      
      try {
        setLoading(true)
        const params = new URLSearchParams()
        params.set('tenant', subdomain)
        params.set('year', String(year))

        const response = await fetch(`/api/mileage?${params}`)
        
        if (!response.ok) {
          throw new Error('Failed to fetch mileage')
        }

        const data = await response.json()
        setTrips(data.trips || [])
      } catch (err) {
        console.error('Error fetching mileage:', err)
        setTrips([])
      } finally {
        setLoading(false)
      }
    }

    fetchMileage()
  }, [subdomain, year, mileageKey])

  // Format miles (stored as miles * 100)
  const formatMiles = (miles: number) => (miles / 100).toFixed(1)

  // Format date (timezone-safe)
  const formatDate = (dateStr: string) => {
    const [year, month, day] = dateStr.substring(0, 10).split('-').map(Number)
    return new Date(year, month - 1, day).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
    })
  }

  // Filter trips by search query
  const filteredTrips = trips.filter((trip) => {
    if (!searchQuery.trim()) return true
    const query = searchQuery.toLowerCase()
    return (
      trip.startLocation.toLowerCase().includes(query) ||
      trip.endLocation.toLowerCase().includes(query) ||
      (trip.description?.toLowerCase().includes(query) ?? false)
    )
  })

  // Group trips by month
  const tripsByMonth = filteredTrips.reduce((acc, trip) => {
    const [yr, mo, dy] = trip.date.substring(0, 10).split('-').map(Number)
    const date = new Date(yr, mo - 1, dy)
    const monthKey = `${yr}-${String(mo).padStart(2, '0')}`
    const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })
    
    if (!acc[monthKey]) {
      acc[monthKey] = { name: monthName, trips: [], totalMiles: 0 }
    }
    acc[monthKey].trips.push(trip)
    acc[monthKey].totalMiles += trip.displayMiles
    return acc
  }, {} as Record<string, { name: string; trips: MileageTrip[]; totalMiles: number }>)

  const sortedMonths = Object.entries(tripsByMonth).sort(([a], [b]) => b.localeCompare(a))

  // Calculate totals for filtered results
  const totalFilteredMiles = filteredTrips.reduce((sum, trip) => sum + trip.displayMiles, 0)

  function handleTripAdded() {
    refreshMileage()
  }

  function handleTripClick(trip: MileageTrip) {
    setSelectedTrip(trip)
    setDetailSheetOpen(true)
  }

  function handleTripUpdated() {
    refreshMileage()
  }

  function handleTripDeleted() {
    refreshMileage()
  }

  if (loading) {
    return (
      <div className="page">
        <p style={{ color: 'var(--color-text-secondary)' }}>Loading mileage...</p>
      </div>
    )
  }

  return (
    <div className="page mileage-page">
      <h1 className="page__title">Mileage</h1>
      
      {trips.length === 0 ? (
        /* Empty State */
        <div className="empty-state">
          <div className="empty-state__icon">🚗</div>
          <h2 className="empty-state__title">No mileage tracked yet</h2>
          <p className="empty-state__description">
            Track your business miles to maximize your tax deductions. 
            The IRS standard mileage rate for 2025 is 70¢ per mile.
          </p>
          <button 
            className="empty-state__btn"
            onClick={() => setSheetOpen(true)}
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path d="M12 5v14M5 12h14" />
            </svg>
            Log Your First Trip
          </button>
        </div>
      ) : (
        <>
          {/* Search Bar */}
          <div className="search-bar">
            <svg className="search-bar__icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <circle cx="11" cy="11" r="8" />
              <path d="m21 21-4.35-4.35" />
            </svg>
            <input
              type="text"
              className="search-bar__input"
              placeholder="Search trips..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
            />
            {searchQuery && (
              <button 
                className="search-bar__clear"
                onClick={() => setSearchQuery('')}
                aria-label="Clear search"
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <path d="M18 6 6 18M6 6l12 12" />
                </svg>
              </button>
            )}
          </div>

          <button className="add-link" onClick={() => setSheetOpen(true)}>
            + Log Trip
          </button>

          {/* Summary line */}
          <p className="mileage-page__summary">
            {filteredTrips.length} trip{filteredTrips.length !== 1 ? 's' : ''} · {formatMiles(totalFilteredMiles)} miles
            {searchQuery && ` matching "${searchQuery}"`}
          </p>

          {/* Trips by Month */}
          {filteredTrips.length === 0 ? (
            <p style={{ color: 'var(--color-text-secondary)', textAlign: 'center', padding: 'var(--spacing-xl)' }}>
              No trips match your search
            </p>
          ) : (
            sortedMonths.map(([monthKey, { name, trips: monthTrips, totalMiles }]) => (
              <div key={monthKey} className="card">
                <div className="card__header">
                  <h2 className="card__title">{name}</h2>
                  <span className="card__subtitle">{formatMiles(totalMiles)} mi</span>
                </div>
                <ul className="trip-list">
                  {monthTrips.map((trip) => (
                    <li 
                      key={trip.id} 
                      className="trip-list__item trip-list__item--clickable"
                      onClick={() => handleTripClick(trip)}
                    >
                      <div className="trip-list__icon">
                        {trip.isRoundTrip ? '🔄' : '📍'}
                      </div>
                      <div className="trip-list__details">
                        <span className="trip-list__route">
                          {trip.description || `${truncateLocation(trip.startLocation)} → ${truncateLocation(trip.endLocation)}`}
                        </span>
                        <span className="trip-list__meta">
                          {formatDate(trip.date)}
                          {trip.isRoundTrip && ' · Round trip'}
                        </span>
                      </div>
                      <span className="trip-list__miles">
                        {formatMiles(trip.displayMiles)} mi
                      </span>
                    </li>
                  ))}
                </ul>
              </div>
            ))
          )}
        </>
      )}

      {/* Add Mileage Bottom Sheet */}
      <AddMileageSheet
        isOpen={sheetOpen}
        onClose={() => setSheetOpen(false)}
        onSuccess={handleTripAdded}
      />

      {/* Mileage Detail Sheet */}
      <MileageDetailSheet
        trip={selectedTrip}
        isOpen={detailSheetOpen}
        onClose={() => setDetailSheetOpen(false)}
        onUpdate={handleTripUpdated}
        onDelete={handleTripDeleted}
      />
    </div>
  )
}

// Helper to truncate long addresses
function truncateLocation(location: string, maxLength = 25): string {
  if (location.length <= maxLength) return location
  // Try to find a comma and truncate there
  const commaIndex = location.indexOf(',')
  if (commaIndex > 0 && commaIndex <= maxLength) {
    return location.substring(0, commaIndex)
  }
  return location.substring(0, maxLength) + '...'
}

--- FILE: ./src/pages/LoginPage.tsx ---

import { useEffect, useState } from 'react';
import { useAuth } from '../hooks/useAuth';
import { useTenant } from '../hooks/useTenant';

export function LoginPage() {
  const { isAuthenticated, isLoading: authLoading, login } = useAuth();
  const { tenant, isLoading: tenantLoading } = useTenant();
  const [error, setError] = useState<string | null>(null);

  // Check for error in URL params
  useEffect(() => {
    const params = new URLSearchParams(window.location.search);
    const errorParam = params.get('error');
    
    if (errorParam) {
      const errorMessages: Record<string, string> = {
        'not_invited': 'Your account has not been invited to this application. Please contact your administrator.',
        'email_not_verified': 'Your Google email is not verified. Please verify your email and try again.',
        'account_mismatch': 'This Google account is linked to a different user. Please contact support.',
        'no_tenant_access': 'Your account does not have access to any organizations. Please contact your administrator.',
        'token_exchange_failed': 'Authentication failed. Please try again.',
        'user_info_failed': 'Could not retrieve your account information. Please try again.',
        'server_error': 'An unexpected error occurred. Please try again.',
        'missing_code': 'Authentication was cancelled or failed. Please try again.',
      };
      
      setError(errorMessages[errorParam] || `Authentication error: ${errorParam}`);
      
      // Clean up URL
      window.history.replaceState({}, '', window.location.pathname);
    }
  }, []);

  // Redirect if already authenticated
  useEffect(() => {
    if (!authLoading && isAuthenticated) {
      window.location.href = '/';
    }
  }, [authLoading, isAuthenticated]);

  const handleGoogleLogin = () => {
    setError(null);
    login();
  };

  const isLoading = authLoading || tenantLoading;

  // Get branding from tenant (if on a subdomain) or use defaults
  const appName = tenant?.appName || 'Wayve Expense Tracker';
  const logoUrl = tenant?.logoUrl;

  return (
    <div style={styles.container}>
      <div style={styles.card}>
        {/* Logo / App Name */}
        <div style={styles.header}>
          {logoUrl ? (
            <img src={logoUrl} alt={appName} style={styles.logo} />
          ) : (
            <img src="/icon-192.png" alt={appName} style={styles.logo} />
          )}
          <h1 style={styles.title}>{appName}</h1>
          {tenant && (
            <p style={styles.subtitle}>{tenant.name}</p>
          )}
        </div>

        {/* Error Message */}
        {error && (
          <div style={styles.error}>
            {error}
          </div>
        )}

        {/* Login Button */}
        {isLoading ? (
          <div style={styles.loading}>Loading...</div>
        ) : (
          <div style={styles.buttons}>
            <button
              onClick={handleGoogleLogin}
              style={styles.googleButton}
            >
              <svg style={styles.googleIcon} viewBox="0 0 24 24">
                <path
                  fill="#4285F4"
                  d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                />
                <path
                  fill="#34A853"
                  d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                />
                <path
                  fill="#FBBC05"
                  d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                />
                <path
                  fill="#EA4335"
                  d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                />
              </svg>
              Sign in with Google
            </button>
          </div>
        )}

        {/* Footer */}
        <p style={styles.footer}>
          Don't have an account? Contact your administrator for an invite.
        </p>
      </div>
    </div>
  );
}

// Inline styles (we'll move to CSS later)
const styles: Record<string, React.CSSProperties> = {
  container: {
    minHeight: '100vh',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    backgroundColor: '#f5f5f5',
    padding: '20px',
  },
  card: {
    backgroundColor: 'white',
    borderRadius: '12px',
    padding: '40px',
    maxWidth: '400px',
    width: '100%',
    boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)',
    textAlign: 'center',
  },
  header: {
    marginBottom: '32px',
  },
  logo: {
    width: '80px',
    height: '80px',
    objectFit: 'contain',
    marginBottom: '16px',
  },
  logoPlaceholder: {
    width: '80px',
    height: '80px',
    borderRadius: '16px',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    margin: '0 auto 16px',
    fontSize: '36px',
    fontWeight: 'bold',
    color: 'white',
  },
  title: {
    fontSize: '24px',
    fontWeight: '600',
    color: '#264653',
    margin: '0 0 8px 0',
  },
  subtitle: {
    fontSize: '14px',
    color: '#666',
    margin: 0,
  },
  error: {
    backgroundColor: '#fee2e2',
    border: '1px solid #ef4444',
    borderRadius: '8px',
    padding: '12px 16px',
    marginBottom: '24px',
    color: '#dc2626',
    fontSize: '14px',
    textAlign: 'left',
  },
  loading: {
    color: '#666',
    fontSize: '14px',
  },
  buttons: {
    display: 'flex',
    flexDirection: 'column',
    gap: '12px',
  },
  googleButton: {
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    gap: '12px',
    width: '100%',
    padding: '12px 24px',
    fontSize: '16px',
    fontWeight: '500',
    color: '#333',
    backgroundColor: 'white',
    border: '1px solid #ddd',
    borderRadius: '8px',
    cursor: 'pointer',
    transition: 'background-color 0.2s, box-shadow 0.2s',
  },
  googleIcon: {
    width: '20px',
    height: '20px',
  },
  footer: {
    marginTop: '32px',
    fontSize: '13px',
    color: '#888',
  },
};

--- FILE: ./src/pages/QuarterlyReportPage.tsx ---

import { useState, useEffect } from 'react'
import { useYear } from '../hooks/useYear'
import { useTenant } from '../hooks/useTenant'
import { Link } from 'wouter'
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  Legend,
} from 'recharts'

interface QuarterlyRow {
  categoryId: string
  name: string
  emoji: string | null
  q1: number
  q2: number
  q3: number
  q4: number
  total: number
}

interface QuarterlyData {
  year: number
  rows: QuarterlyRow[]
  totals: {
    q1: number
    q2: number
    q3: number
    q4: number
    total: number
  }
}

// Same color palette as dashboard donut chart
const CHART_COLORS = [
  '#2A9D8F', // teal (primary)
  '#E9C46A', // gold
  '#F4A261', // orange
  '#E76F51', // coral
  '#264653', // dark blue
  '#8AB17D', // sage
  '#A06CD5', // purple
  '#6B9AC4', // sky blue
  '#D4A5A5', // dusty rose
  '#9DC183', // olive
  '#F0B5B3', // blush
  '#7EB6C4', // teal light
]

function formatDollars(cents: number): string {
  return (cents / 100).toLocaleString('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  })
}

// Tooltip for the stacked bar chart
function ChartTooltip({ active, payload, label }: {
  active?: boolean
  payload?: Array<{ name: string; value: number; color: string }>
  label?: string
}) {
  if (!active || !payload || !payload.length) return null

  // Filter out zero values and sort descending
  const nonZero = payload.filter(p => p.value > 0).sort((a, b) => b.value - a.value)
  if (nonZero.length === 0) return null

  const total = nonZero.reduce((sum, p) => sum + p.value, 0)

  return (
    <div className="stacked-chart-tooltip">
      <p className="stacked-chart-tooltip__label">{label}</p>
      {nonZero.map((entry, i) => (
        <div key={i} className="stacked-chart-tooltip__row">
          <span
            className="stacked-chart-tooltip__color"
            style={{ backgroundColor: entry.color }}
          />
          <span className="stacked-chart-tooltip__name">{entry.name}</span>
          <span className="stacked-chart-tooltip__value">{formatDollars(entry.value)}</span>
        </div>
      ))}
      <div className="stacked-chart-tooltip__total">
        <span>Total</span>
        <span>{formatDollars(total)}</span>
      </div>
    </div>
  )
}

export default function QuarterlyReportPage() {
  const { year, nextYear, prevYear } = useYear()
  const { subdomain } = useTenant()
  const [data, setData] = useState<QuarterlyData | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  const currentYear = new Date().getFullYear()

  useEffect(() => {
    if (!subdomain) return

    async function fetchData() {
      setLoading(true)
      setError(null)
      try {
        const params = new URLSearchParams({
          tenant: subdomain!,
          year: year.toString(),
        })
        const response = await fetch(`/api/reports/quarterly?${params}`)
        if (!response.ok) throw new Error('Failed to fetch quarterly data')
        const result = await response.json()
        setData(result)
      } catch (err) {
        console.error('Quarterly report error:', err)
        setError('Failed to load quarterly report')
      } finally {
        setLoading(false)
      }
    }

    fetchData()
  }, [subdomain, year])

  // Prepare stacked bar chart data from quarterly rows
  const prepareChartData = () => {
    if (!data || data.rows.length === 0) return { chartBars: [], chartData: [] }

    // Top 6 categories by total, rest grouped as "Other"
    const topCategories = data.rows.slice(0, 6)
    const otherCategories = data.rows.slice(6)

    const quarters = ['Q1', 'Q2', 'Q3', 'Q4']
    const qKeys: Array<'q1' | 'q2' | 'q3' | 'q4'> = ['q1', 'q2', 'q3', 'q4']

    const chartData = quarters.map((label, qi) => {
      const point: Record<string, string | number> = { quarter: label }
      topCategories.forEach((row) => {
        point[row.name] = row[qKeys[qi]]
      })
      if (otherCategories.length > 0) {
        point['Other'] = otherCategories.reduce((sum, row) => sum + row[qKeys[qi]], 0)
      }
      return point
    })

    const chartBars = topCategories.map((row, i) => ({
      key: row.name,
      color: CHART_COLORS[i % CHART_COLORS.length],
    }))
    if (otherCategories.length > 0) {
      chartBars.push({
        key: 'Other',
        color: CHART_COLORS[6],
      })
    }

    return { chartBars, chartData }
  }

  const { chartBars, chartData } = prepareChartData()

  return (
    <div className="page quarterly-report-page">
      <div className="quarterly-report-page__nav">
        <Link href="/reports" className="back-link">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <polyline points="15 18 9 12 15 6" />
          </svg>
          Reports
        </Link>
      </div>

      <div className="quarterly-report-page__header">
        <h1 className="quarterly-report-page__title">Quarterly Report</h1>
        <div className="quarterly-report-page__year-selector">
          <button
            className="year-nav-btn"
            onClick={prevYear}
            disabled={year <= 2020}
            aria-label="Previous year"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <polyline points="15 18 9 12 15 6" />
            </svg>
          </button>
          <span className="quarterly-report-page__year">{year}</span>
          <button
            className="year-nav-btn"
            onClick={nextYear}
            disabled={year >= currentYear}
            aria-label="Next year"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <polyline points="9 18 15 12 9 6" />
            </svg>
          </button>
        </div>
      </div>

      <p className="quarterly-report-page__description">
        Category spending breakdown by quarter for {year}.
      </p>

      {loading && (
        <div className="card" style={{ textAlign: 'center', padding: 'var(--spacing-2xl)' }}>
          <p style={{ color: 'var(--color-text-secondary)' }}>Loading quarterly data...</p>
        </div>
      )}

      {error && (
        <div className="card" style={{ textAlign: 'center', padding: 'var(--spacing-2xl)' }}>
          <p style={{ color: 'var(--color-error)' }}>{error}</p>
        </div>
      )}

      {!loading && !error && data && (
        <>
          {data.rows.length === 0 ? (
            <div className="card" style={{ textAlign: 'center', padding: 'var(--spacing-2xl)' }}>
              <p className="empty-state__icon">📅</p>
              <p style={{ color: 'var(--color-text-secondary)' }}>No expenses recorded for {year}.</p>
            </div>
          ) : (
            <>
              {/* Stacked Bar Chart */}
              <div className="card stacked-chart-card">
                <h2 className="card__title">Quarterly Comparison</h2>
                <div className="stacked-chart">
                  <ResponsiveContainer width="100%" height={300}>
                    <BarChart data={chartData} margin={{ top: 10, right: 10, left: 0, bottom: 5 }}>
                      <CartesianGrid
                        strokeDasharray="3 3"
                        vertical={false}
                        stroke="var(--color-border)"
                      />
                      <XAxis
                        dataKey="quarter"
                        tick={{ fill: 'var(--color-text-secondary)', fontSize: 13 }}
                        axisLine={{ stroke: 'var(--color-border)' }}
                        tickLine={false}
                      />
                      <YAxis
                        tickFormatter={(value: number) => formatDollars(value)}
                        tick={{ fill: 'var(--color-text-secondary)', fontSize: 12 }}
                        axisLine={false}
                        tickLine={false}
                        width={70}
                      />
                      <Tooltip content={<ChartTooltip />} cursor={{ fill: 'var(--color-bg-hover, rgba(0,0,0,0.04))' }} />
                      <Legend
                        wrapperStyle={{ fontSize: '0.8125rem', paddingTop: '8px' }}
                        iconType="square"
                        iconSize={10}
                      />
                      {chartBars.map((bar) => (
                        <Bar
                          key={bar.key}
                          dataKey={bar.key}
                          stackId="spending"
                          fill={bar.color}
                          radius={[0, 0, 0, 0]}
                        />
                      ))}
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </div>

              {/* Quarterly Table */}
              <div className="quarterly-table-wrapper">
                <table className="quarterly-table">
                  <thead>
                    <tr>
                      <th className="quarterly-table__category-header">Category</th>
                      <th className="quarterly-table__quarter-header">Q1</th>
                      <th className="quarterly-table__quarter-header">Q2</th>
                      <th className="quarterly-table__quarter-header">Q3</th>
                      <th className="quarterly-table__quarter-header">Q4</th>
                      <th className="quarterly-table__total-header">Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    {data.rows.map((row) => (
                      <tr key={row.categoryId} className="quarterly-table__row">
                        <td className="quarterly-table__category-cell">
                          <span className="quarterly-table__emoji">{row.emoji}</span>
                          <span className="quarterly-table__name">{row.name}</span>
                        </td>
                        <td className={`quarterly-table__amount-cell ${row.q1 === 0 ? 'quarterly-table__amount-cell--zero' : ''}`}>
                          {row.q1 === 0 ? '—' : formatDollars(row.q1)}
                        </td>
                        <td className={`quarterly-table__amount-cell ${row.q2 === 0 ? 'quarterly-table__amount-cell--zero' : ''}`}>
                          {row.q2 === 0 ? '—' : formatDollars(row.q2)}
                        </td>
                        <td className={`quarterly-table__amount-cell ${row.q3 === 0 ? 'quarterly-table__amount-cell--zero' : ''}`}>
                          {row.q3 === 0 ? '—' : formatDollars(row.q3)}
                        </td>
                        <td className={`quarterly-table__amount-cell ${row.q4 === 0 ? 'quarterly-table__amount-cell--zero' : ''}`}>
                          {row.q4 === 0 ? '—' : formatDollars(row.q4)}
                        </td>
                        <td className="quarterly-table__amount-cell quarterly-table__amount-cell--total">
                          {formatDollars(row.total)}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                  <tfoot>
                    <tr className="quarterly-table__totals-row">
                      <td className="quarterly-table__category-cell quarterly-table__category-cell--total">TOTAL</td>
                      <td className="quarterly-table__amount-cell quarterly-table__amount-cell--total">
                        {formatDollars(data.totals.q1)}
                      </td>
                      <td className="quarterly-table__amount-cell quarterly-table__amount-cell--total">
                        {formatDollars(data.totals.q2)}
                      </td>
                      <td className="quarterly-table__amount-cell quarterly-table__amount-cell--total">
                        {formatDollars(data.totals.q3)}
                      </td>
                      <td className="quarterly-table__amount-cell quarterly-table__amount-cell--total">
                        {formatDollars(data.totals.q4)}
                      </td>
                      <td className="quarterly-table__amount-cell quarterly-table__amount-cell--grand-total">
                        {formatDollars(data.totals.total)}
                      </td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </>
          )}
        </>
      )}
    </div>
  )
}


--- FILE: ./src/pages/ExpensesPage.tsx ---

import { useState, useEffect, useCallback } from 'react'
import { useSearch } from 'wouter'
import { useTenant } from '../hooks/useTenant'
import { useYear } from '../hooks/useYear'
import { useRefresh } from '../hooks/useRefresh'
import { ExpenseDetailSheet } from '../components/ExpenseDetailSheet'
import { AddExpenseSheet } from '../components/AddExpenseSheet'

interface Expense {
  id: string
  amount: number
  vendor: string | null
  description: string | null
  date: string
  categoryId: string | null
  categoryName: string | null
  categoryEmoji: string | null
  expenseType?: string
  isHomeOffice?: boolean
  homeOfficePercent?: number | null
  attachmentCount?: number
}

export default function ExpensesPage() {
  const { subdomain } = useTenant()
  const { year } = useYear()
  const { expenseKey, refreshExpenses } = useRefresh()
  const searchString = useSearch()
  const [expenses, setExpenses] = useState<Expense[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [searchTerm, setSearchTerm] = useState('')
  
  // Category filter from URL
  const urlParams = new URLSearchParams(searchString)
  const categoryFilter = urlParams.get('category')
  
  // Sheet states
  const [detailSheetOpen, setDetailSheetOpen] = useState(false)
  const [selectedExpense, setSelectedExpense] = useState<Expense | null>(null)
  const [addSheetOpen, setAddSheetOpen] = useState(false)

  const fetchExpenses = useCallback(async () => {
    try {
      setLoading(true)
      const params = new URLSearchParams()
      if (subdomain) params.set('tenant', subdomain)
      params.set('year', String(year))
      params.set('limit', '1000')

      const response = await fetch(`/api/expenses?${params}`)
      if (!response.ok) {
        const err = await response.json()
        throw new Error(err.error || 'Failed to fetch expenses')
      }

      const result = await response.json()
      setExpenses(result.expenses)
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Unknown error')
    } finally {
      setLoading(false)
    }
  }, [subdomain, year])

  useEffect(() => {
    fetchExpenses()
  }, [fetchExpenses, expenseKey])

  // Format cents to dollars
  const formatMoney = (cents: number) => {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
    }).format(cents / 100)
  }

  // Format date (timezone-safe)
  const formatDate = (dateStr: string) => {
    const [year, month, day] = dateStr.substring(0, 10).split('-').map(Number)
    return new Date(year, month - 1, day).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric',
    })
  }

  // Filter expenses by search term AND category filter
  const filteredExpenses = expenses.filter(expense => {
    // First apply category filter from URL
    if (categoryFilter && expense.categoryName !== categoryFilter) {
      return false
    }
    
    // Then apply search term
    if (!searchTerm) return true
    const term = searchTerm.toLowerCase()
    return (
      expense.vendor?.toLowerCase().includes(term) ||
      expense.description?.toLowerCase().includes(term) ||
      expense.categoryName?.toLowerCase().includes(term)
    )
  })

  // Group expenses by month
  const expensesByMonth = filteredExpenses.reduce((acc, expense) => {
    const [yr, mo, dy] = expense.date.substring(0, 10).split('-').map(Number)
    const date = new Date(yr, mo - 1, dy)
    const monthKey = `${yr}-${String(mo).padStart(2, '0')}`
    const monthLabel = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })
    
    if (!acc[monthKey]) {
      acc[monthKey] = { label: monthLabel, expenses: [], total: 0 }
    }
    acc[monthKey].expenses.push(expense)
    acc[monthKey].total += expense.amount
    return acc
  }, {} as Record<string, { label: string; expenses: Expense[]; total: number }>)

  // Sort months descending (newest first)
  const sortedMonths = Object.entries(expensesByMonth).sort((a, b) => b[0].localeCompare(a[0]))

  // Handle expense click
  const handleExpenseClick = (expense: Expense) => {
    setSelectedExpense(expense)
    setDetailSheetOpen(true)
  }

  // Handle successful expense update
  const handleExpenseUpdated = () => {
    refreshExpenses()
  }

  // Handle successful expense deletion
  const handleExpenseDeleted = () => {
    refreshExpenses()
  }

  // Clear category filter
  const clearCategoryFilter = () => {
    window.history.replaceState({}, '', '/expenses')
    window.location.href = '/expenses'
  }

  if (loading) {
    return (
      <div className="page">
        <p style={{ color: 'var(--color-text-secondary)' }}>Loading expenses...</p>
      </div>
    )
  }

  if (error) {
    return (
      <div className="page">
        <div className="card" style={{ borderLeft: '4px solid var(--color-error)' }}>
          <h2 style={{ margin: 0, color: 'var(--color-error)' }}>Error</h2>
          <p style={{ marginBottom: 0 }}>{error}</p>
        </div>
      </div>
    )
  }

  return (
    <div className="page expenses-page">
      <h1 className="page__title">Expenses</h1>
      {/* Category Filter Banner */}
      {categoryFilter && (
        <div className="filter-banner">
          <span className="filter-banner__text">
            Showing: <strong>{categoryFilter}</strong>
          </span>
          <button 
            className="filter-banner__clear"
            onClick={clearCategoryFilter}
            aria-label="Clear filter"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path d="M18 6 6 18M6 6l12 12" />
            </svg>
            Clear
          </button>
        </div>
      )}

      {/* Search Bar */}
      <div className="search-bar">
        <svg className="search-bar__icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <circle cx="11" cy="11" r="8" />
          <path d="m21 21-4.35-4.35" />
        </svg>
        <input
          type="text"
          className="search-bar__input"
          placeholder="Search expenses..."
          value={searchTerm}
          onChange={(e) => setSearchTerm(e.target.value)}
        />
        {searchTerm && (
          <button 
            className="search-bar__clear"
            onClick={() => setSearchTerm('')}
            aria-label="Clear search"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path d="M18 6 6 18M6 6l12 12" />
            </svg>
          </button>
        )}
      </div>

      <button className="add-link" onClick={() => setAddSheetOpen(true)}>
        + Add Expense
      </button>

      {/* Results Summary */}
      <p className="expenses-page__summary">
        {filteredExpenses.length} expense{filteredExpenses.length !== 1 ? 's' : ''}
        {categoryFilter && ` in ${categoryFilter}`}
        {searchTerm && ` matching "${searchTerm}"`}
        {' · '}
        {formatMoney(filteredExpenses.reduce((sum, e) => sum + e.amount, 0))} total
      </p>

      {/* Expense List by Month */}
      {sortedMonths.length === 0 ? (
        <div className="empty-state">
          <div className="empty-state__icon">🧾</div>
          <h2 className="empty-state__title">
            {searchTerm || categoryFilter ? 'No matches found' : 'No expenses yet'}
          </h2>
          <p className="empty-state__description">
            {searchTerm 
              ? `No expenses match "${searchTerm}". Try a different search term.`
              : categoryFilter
              ? `No expenses in "${categoryFilter}" for ${year}.`
              : 'Start tracking your business expenses by adding your first one.'}
          </p>
        </div>
      ) : (
        sortedMonths.map(([monthKey, { label, expenses: monthExpenses, total }]) => (
          <div key={monthKey} className="expense-month">
            <div className="expense-month__header">
              <h2 className="expense-month__title">{label}</h2>
              <span className="expense-month__total">{formatMoney(total)}</span>
            </div>
            <div className="card expense-month__list">
              {monthExpenses.map((expense) => (
                <div 
                  key={expense.id} 
                  className="expense-row expense-row--clickable"
                  onClick={() => handleExpenseClick(expense)}
                  role="button"
                  tabIndex={0}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                      e.preventDefault()
                      handleExpenseClick(expense)
                    }
                  }}
                >
                  <div className="expense-row__icon">
                    {expense.categoryEmoji || '📁'}
                  </div>
                  <div className="expense-row__details">
                    <span className="expense-row__vendor">
                      {expense.vendor || expense.description || 'Expense'}
                    </span>
                    <span className="expense-row__meta">
                      {expense.categoryName || 'Uncategorized'} · {formatDate(expense.date)}
                    </span>
                  </div>
                  <span className="expense-row__amount">
                    {formatMoney(expense.amount)}
                    {expense.isHomeOffice && <span className="expense-row__home-icon" title="Home Office Expense">🏡</span>}
                    {Number(expense.attachmentCount) > 0 && <span className="attachment-indicator" title="Has attachments">📎</span>}
                  </span>
                </div>
              ))}
            </div>
          </div>
        ))
      )}

      {/* Expense Detail Bottom Sheet */}
      <ExpenseDetailSheet
        expense={selectedExpense}
        isOpen={detailSheetOpen}
        onClose={() => setDetailSheetOpen(false)}
        onUpdate={handleExpenseUpdated}
        onDelete={handleExpenseDeleted}
      />

      <AddExpenseSheet
        isOpen={addSheetOpen}
        onClose={() => setAddSheetOpen(false)}
        onSuccess={() => {
          setAddSheetOpen(false)
          refreshExpenses()
        }}
      />

    </div>
  )
}

--- FILE: ./src/pages/AdminPage.tsx ---

import { useState, useEffect } from 'react'
import { useAuth } from '../hooks/useAuth'
import { Link } from 'wouter'

interface Invite {
  id: string
  email: string
  firstName: string | null
  lastName: string | null
  role: string
  status: string
  expiresAt: string
  acceptedAt: string | null
  createdAt: string
  tenantName: string
  tenantSubdomain: string
  invitedByFirstName: string | null
  invitedByLastName: string | null
  invitedByEmail: string
}

export default function AdminPage() {
  const { isSuperAdmin } = useAuth()
  const [listRefreshKey, setListRefreshKey] = useState(0)

  if (!isSuperAdmin) {
    return (
      <div className="page">
        <div className="admin-forbidden">
          <h1>🔐 Access Denied</h1>
          <p>You don't have access to this page.</p>
          <Link href="/" className="btn btn--primary">Back to Dashboard</Link>
        </div>
      </div>
    )
  }

  return (
    <div className="page">
      <h2 className="page-title">Admin</h2>
      <InviteForm onSuccess={() => setListRefreshKey(k => k + 1)} />
      <InviteList refreshKey={listRefreshKey} />
    </div>
  )
}

// ============================================
// INVITE FORM
// ============================================
function InviteForm({ onSuccess }: { onSuccess: () => void }) {
  const [firstName, setFirstName] = useState('')
  const [lastName, setLastName] = useState('')
  const [email, setEmail] = useState('')
  const [businessName, setBusinessName] = useState('')
  const [subdomain, setSubdomain] = useState('')
  const [subdomainEdited, setSubdomainEdited] = useState(false)
  const [submitting, setSubmitting] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [success, setSuccess] = useState<string | null>(null)

  useEffect(() => {
    if (!subdomainEdited && businessName) {
      const suggested = businessName
        .toLowerCase()
        .replace(/[^a-z0-9]/g, '')
        .slice(0, 30)
      setSubdomain(suggested)
    }
  }, [businessName, subdomainEdited])

  const handleSubdomainChange = (value: string) => {
    setSubdomain(value.toLowerCase().replace(/[^a-z0-9]/g, '').slice(0, 30))
    setSubdomainEdited(true)
  }

  const handleSubmit = async () => {
    setError(null)
    setSuccess(null)

    if (!email || !businessName || !subdomain) {
      setError('Email, business name, and subdomain are required')
      return
    }

    if (subdomain.length < 3) {
      setError('Subdomain must be at least 3 characters')
      return
    }

    setSubmitting(true)

    try {
      const response = await fetch('/api/admin/invites', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: email.trim(),
          firstName: firstName.trim() || null,
          lastName: lastName.trim() || null,
          businessName: businessName.trim(),
          subdomain,
        }),
      })

      if (!response.ok) {
        const data = await response.json()
        setError(data.error || 'Failed to send invite')
        return
      }

      const data = await response.json()
      setSuccess(`Invite sent to ${email} for ${businessName} (${data.tenant.subdomain}.wayveexpenses.app)`)

      setFirstName('')
      setLastName('')
      setEmail('')
      setBusinessName('')
      setSubdomain('')
      setSubdomainEdited(false)
      onSuccess()
    } catch {
      setError('Network error — please try again')
    } finally {
      setSubmitting(false)
    }
  }

  return (
    <div className="admin-section">
      <h3 className="admin-section__title">Invite New Client</h3>

      {error && <div className="admin-alert admin-alert--error">{error}</div>}
      {success && <div className="admin-alert admin-alert--success">{success}</div>}

      <div className="admin-form">
        <div className="admin-form__row">
          <div className="admin-form__field">
            <label className="admin-form__label">First Name</label>
            <input
              type="text"
              className="admin-form__input"
              value={firstName}
              onChange={e => setFirstName(e.target.value)}
              placeholder="Joe"
            />
          </div>
          <div className="admin-form__field">
            <label className="admin-form__label">Last Name</label>
            <input
              type="text"
              className="admin-form__input"
              value={lastName}
              onChange={e => setLastName(e.target.value)}
              placeholder="Smith"
            />
          </div>
        </div>

        <div className="admin-form__field">
          <label className="admin-form__label">Email *</label>
          <input
            type="email"
            className="admin-form__input"
            value={email}
            onChange={e => setEmail(e.target.value)}
            placeholder="joe@example.com"
          />
        </div>

        <div className="admin-form__field">
          <label className="admin-form__label">Business Name *</label>
          <input
            type="text"
            className="admin-form__input"
            value={businessName}
            onChange={e => setBusinessName(e.target.value)}
            placeholder="Joe's Plumbing"
          />
        </div>

        <div className="admin-form__field">
          <label className="admin-form__label">Subdomain *</label>
          <div className="admin-form__subdomain-wrapper">
            <input
              type="text"
              className="admin-form__input admin-form__input--subdomain"
              value={subdomain}
              onChange={e => handleSubdomainChange(e.target.value)}
              placeholder="joesplumbing"
            />
            <span className="admin-form__subdomain-suffix">.wayveexpenses.app</span>
          </div>
        </div>

        <button
          className="btn btn--primary btn--full"
          onClick={handleSubmit}
          disabled={submitting}
        >
          {submitting ? 'Sending...' : 'Send Invite'}
        </button>
      </div>
    </div>
  )
}

// ============================================
// INVITE LIST
// ============================================
function InviteList({ refreshKey }: { refreshKey: number }) {
  const [invitesList, setInvitesList] = useState<Invite[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [resending, setResending] = useState<string | null>(null)

  const fetchInvites = async () => {
    try {
      const response = await fetch('/api/admin/invites', {
        credentials: 'include',
      })
      if (response.ok) {
        const data = await response.json()
        setInvitesList(data.invites)
      } else {
        setError('Failed to load invites')
      }
    } catch {
      setError('Network error')
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    fetchInvites()
  }, [refreshKey])

  const handleResend = async (inviteId: string) => {
    setResending(inviteId)
    try {
      const response = await fetch(`/api/admin/invites/${inviteId}`, {
        method: 'PUT',
        credentials: 'include',
      })
      if (response.ok) {
        await fetchInvites()
      }
    } catch {
      // Silent fail — user can try again
    } finally {
      setResending(null)
    }
  }

  if (loading) {
    return (
      <div className="admin-section">
        <h3 className="admin-section__title">Invites</h3>
        <p className="admin-section__loading">Loading...</p>
      </div>
    )
  }

  return (
    <div className="admin-section">
      <h3 className="admin-section__title">Invites ({invitesList.length})</h3>

      {error && <div className="admin-alert admin-alert--error">{error}</div>}

      {invitesList.length === 0 ? (
        <p className="admin-section__empty">No invites sent yet.</p>
      ) : (
        <div className="admin-invite-list">
          {invitesList.map(invite => (
            <div key={invite.id} className="admin-invite-card">
              <div className="admin-invite-card__header">
                <div className="admin-invite-card__business">{invite.tenantName}</div>
                <span className={`admin-invite-card__badge admin-invite-card__badge--${invite.status}`}>
                  {invite.status}
                </span>
              </div>

              <div className="admin-invite-card__details">
                <div className="admin-invite-card__row">
                  <span className="admin-invite-card__label">Email</span>
                  <span className="admin-invite-card__value">{invite.email}</span>
                </div>
                {(invite.firstName || invite.lastName) && (
                  <div className="admin-invite-card__row">
                    <span className="admin-invite-card__label">Name</span>
                    <span className="admin-invite-card__value">
                      {[invite.firstName, invite.lastName].filter(Boolean).join(' ')}
                    </span>
                  </div>
                )}
                <div className="admin-invite-card__row">
                  <span className="admin-invite-card__label">Subdomain</span>
                  <span className="admin-invite-card__value">{invite.tenantSubdomain}.wayveexpenses.app</span>
                </div>
                <div className="admin-invite-card__row">
                  <span className="admin-invite-card__label">Sent</span>
                  <span className="admin-invite-card__value">
                    {new Date(invite.createdAt).toLocaleDateString()}
                  </span>
                </div>
                <div className="admin-invite-card__row">
                  <span className="admin-invite-card__label">Expires</span>
                  <span className="admin-invite-card__value">
                    {new Date(invite.expiresAt).toLocaleDateString()}
                  </span>
                </div>
              </div>

              {(invite.status === 'pending' || invite.status === 'expired') && (
                <button
                  className="btn btn--outline btn--full admin-invite-card__resend"
                  onClick={() => handleResend(invite.id)}
                  disabled={resending === invite.id}
                >
                  {resending === invite.id ? 'Resending...' : 'Resend Invite'}
                </button>
              )}
            </div>
          ))}
        </div>
      )}
    </div>
  )
}

--- FILE: ./src/pages/ReportsPage.tsx ---

import { useState, useEffect } from 'react'
import { useYear } from '../hooks/useYear'
import { useTenant } from '../hooks/useTenant'
import { Link } from 'wouter'

export default function ReportsPage() {
  const { year, nextYear, prevYear } = useYear()
  const { subdomain } = useTenant()
  
  // Date range state - initialize based on current year
  const [startDate, setStartDate] = useState(`${year}-01-01`)
  const [endDate, setEndDate] = useState(`${year}-12-31`)
  const [exporting, setExporting] = useState<string | null>(null)

  // Update date range when year changes
  useEffect(() => {
    setStartDate(`${year}-01-01`)
    setEndDate(`${year}-12-31`)
  }, [year])

  const currentYear = new Date().getFullYear()

  // Handle CSV export
  const handleCsvExport = async () => {
    if (!subdomain) return
    
    setExporting('csv')
    try {
      const params = new URLSearchParams({
        tenant: subdomain,
        startDate,
        endDate,
      })
      
      const response = await fetch(`/api/exports/expenses?${params}`)
      
      if (!response.ok) {
        throw new Error('Export failed')
      }
      
      // Get the blob and trigger download
      const blob = await response.blob()
      const url = window.URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = `expenses_${startDate}_to_${endDate}.csv`
      document.body.appendChild(a)
      a.click()
      document.body.removeChild(a)
      window.URL.revokeObjectURL(url)
    } catch (error) {
      console.error('Export error:', error)
      alert('Failed to export. Please try again.')
    } finally {
      setExporting(null)
    }
  }

  // Quick date range presets
  const setPreset = (preset: 'ytd' | 'year' | 'q1' | 'q2' | 'q3' | 'q4' | 'last30' | 'last90') => {
    const now = new Date()
    
    switch (preset) {
      case 'ytd':
        setStartDate(`${year}-01-01`)
        // If viewing past year, YTD = full year
        if (year < currentYear) {
          setEndDate(`${year}-12-31`)
        } else {
          setEndDate(now.toISOString().split('T')[0])
        }
        break
      case 'year':
        setStartDate(`${year}-01-01`)
        setEndDate(`${year}-12-31`)
        break
      case 'q1':
        setStartDate(`${year}-01-01`)
        setEndDate(`${year}-03-31`)
        break
      case 'q2':
        setStartDate(`${year}-04-01`)
        setEndDate(`${year}-06-30`)
        break
      case 'q3':
        setStartDate(`${year}-07-01`)
        setEndDate(`${year}-09-30`)
        break
      case 'q4':
        setStartDate(`${year}-10-01`)
        setEndDate(`${year}-12-31`)
        break
      case 'last30': {
        const thirtyAgo = new Date(now)
        thirtyAgo.setDate(thirtyAgo.getDate() - 30)
        setStartDate(thirtyAgo.toISOString().split('T')[0])
        setEndDate(now.toISOString().split('T')[0])
        break
      }
      case 'last90': {
        const ninetyAgo = new Date(now)
        ninetyAgo.setDate(ninetyAgo.getDate() - 90)
        setStartDate(ninetyAgo.toISOString().split('T')[0])
        setEndDate(now.toISOString().split('T')[0])
        break
      }
    }
  }

  const reportTypes = [
    {
      icon: '📊',
      title: 'Annual Summary',
      description: 'Complete breakdown of expenses by category for the year',
      available: true,
      href: '/reports/annual',
    },
    {
      icon: '📅',
      title: 'Quarterly Report',
      description: 'Side-by-side comparison of Q1, Q2, Q3, Q4 spending by category',
      available: true,
      href: '/reports/quarterly',
    },
    {
      icon: '🚗',
      title: 'Mileage Log',
      description: 'IRS-ready mileage report with dates, destinations, and totals',
      available: true,
      href: '/reports/mileage',
    },
    {
      icon: '📎',
      title: 'Receipts Export',
      description: 'Download all receipts as a ZIP file organized by month',
      available: false,
      href: '/reports/receipts',
    },
    {
      icon: '🧾',
      title: 'Tax Summary',
      description: 'Expenses grouped by tax category (COGS, Operating, Home Office)',
      available: true,
      href: '/reports/tax',
    },
  ]

  return (
    <div className="page reports-page">
      <div className="reports-page__header">
        <h1 className="reports-page__title">Reports</h1>
      </div>

      <p className="reports-page__description">
        Generate reports and export your expense data.
      </p>

      {/* Date Range Selector */}
      <div className="card date-range-card">
        <div className="date-range-card__header">
          <h2 className="date-range-card__title">Date Range</h2>
          <div className="date-range-card__year-selector">
            <button 
              className="year-nav-btn"
              onClick={prevYear}
              disabled={year <= 2020}
              aria-label="Previous year"
            >
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="15 18 9 12 15 6" />
              </svg>
            </button>
            <span className="date-range-card__year">{year}</span>
            <button 
              className="year-nav-btn"
              onClick={nextYear}
              disabled={year >= currentYear}
              aria-label="Next year"
            >
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="9 18 15 12 9 6" />
              </svg>
            </button>
          </div>
        </div>
        
        <div className="date-range-card__inputs">
          <div className="form-group">
            <label htmlFor="startDate" className="form-label">From</label>
            <input
              type="date"
              id="startDate"
              className="form-input"
              value={startDate}
              onChange={(e) => setStartDate(e.target.value)}
            />
          </div>
          <div className="form-group">
            <label htmlFor="endDate" className="form-label">To</label>
            <input
              type="date"
              id="endDate"
              className="form-input"
              value={endDate}
              onChange={(e) => setEndDate(e.target.value)}
            />
          </div>
        </div>

        <div className="date-range-card__presets">
          <button className="preset-btn" onClick={() => setPreset('ytd')}>YTD</button>
          <button className="preset-btn" onClick={() => setPreset('year')}>Full Year</button>
          <button className="preset-btn" onClick={() => setPreset('q1')}>Q1</button>
          <button className="preset-btn" onClick={() => setPreset('q2')}>Q2</button>
          <button className="preset-btn" onClick={() => setPreset('q3')}>Q3</button>
          <button className="preset-btn" onClick={() => setPreset('q4')}>Q4</button>
          <button className="preset-btn" onClick={() => setPreset('last30')}>Last 30</button>
          <button className="preset-btn" onClick={() => setPreset('last90')}>Last 90</button>
        </div>
      </div>

      {/* CSV Export - Now Functional */}
      <div className="card export-card">
        <div className="export-card__icon">📑</div>
        <div className="export-card__content">
          <h3 className="export-card__title">CSV Export</h3>
          <p className="export-card__description">
            Download expenses as a spreadsheet-friendly CSV file
          </p>
        </div>
        <button 
          className="btn btn--primary"
          onClick={handleCsvExport}
          disabled={exporting === 'csv'}
        >
          {exporting === 'csv' ? 'Exporting...' : 'Download CSV'}
        </button>
      </div>

      {/* Other Report Types */}
      <h2 className="reports-page__section-title">More Reports</h2>
      <div className="report-grid">
        {reportTypes.map((report) => (
          report.available ? (
            <Link
              key={report.title}
              href={report.href}
              className="report-card report-card--available"
            >
              <span className="report-card__icon">{report.icon}</span>
              <div className="report-card__content">
                <span className="report-card__title">{report.title}</span>
                <span className="report-card__description">{report.description}</span>
              </div>
              <span className="report-card__badge report-card__badge--live">View</span>
            </Link>
          ) : (
            <button
              key={report.title}
              className="report-card"
              disabled
            >
              <span className="report-card__icon">{report.icon}</span>
              <div className="report-card__content">
                <span className="report-card__title">{report.title}</span>
                <span className="report-card__description">{report.description}</span>
              </div>
              <span className="report-card__badge">Coming Soon</span>
            </button>
          )
        ))}
      </div>
    </div>
  )
}

--- FILE: ./src/pages/SettingsPage.tsx ---

import { useState, useEffect } from 'react'
import { useAuth } from '../hooks/useAuth'
import { useTenant } from '../hooks/useTenant'
import { useSettings } from '../hooks/useSettings'

interface Category {
  id: string
  name: string
  emoji: string
}

export default function SettingsPage() {
  const { user, logout } = useAuth()
  const { tenant, subdomain } = useTenant()
  const { darkMode, setDarkMode, showFab, setShowFab } = useSettings()

  // Default category state
  const [categories, setCategories] = useState<Category[]>([])
  const [defaultCategoryId, setDefaultCategoryId] = useState<string>('')
  const [savingDefault, setSavingDefault] = useState(false)
  const [defaultSaved, setDefaultSaved] = useState(false)

  // Fetch categories and current default on mount
  useEffect(() => {
    if (!subdomain) return
    async function fetchData() {
      try {
        const response = await fetch(`/api/categories?tenant=${subdomain}`)
        if (!response.ok) return
        const data = await response.json()
        setCategories(
          [...data.categories]
            .sort((a: Category, b: Category) => a.name.localeCompare(b.name))
        )
        setDefaultCategoryId(data.homeOfficeSettings?.defaultCategoryId || '')
      } catch (err) {
        console.error('Error fetching categories:', err)
      }
    }
    fetchData()
  }, [subdomain])

  // Save default category
  async function handleDefaultCategoryChange(categoryId: string) {
    setDefaultCategoryId(categoryId)
    setDefaultSaved(false)
    setSavingDefault(true)
    try {
      const response = await fetch(`/api/categories/default-category?tenant=${subdomain}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ defaultCategoryId: categoryId || null }),
      })
      if (response.ok) {
        setDefaultSaved(true)
        setTimeout(() => setDefaultSaved(false), 2000)
      }
    } catch (err) {
      console.error('Error saving default category:', err)
    } finally {
      setSavingDefault(false)
    }
  }

  return (
    <div className="page settings-page">
      <h1 className="settings-page__title">Settings</h1>

      {/* Profile Section */}
      <section className="settings-section">
        <h2 className="settings-section__title">Profile</h2>
        <div className="card">
          <div className="profile-display">
            <div className="profile-display__avatar">
              {user?.name?.[0] || user?.email?.[0]?.toUpperCase() || '?'}
            </div>
            <div className="profile-display__info">
              <span className="profile-display__name">{user?.name || 'User'}</span>
              <span className="profile-display__email">{user?.email}</span>
              <span className="profile-display__role">
                {user?.isSuperAdmin ? 'Super Admin' : user?.isAccountant ? 'Accountant' : user?.role || 'User'}
              </span>
            </div>
          </div>
        </div>
      </section>

      {/* Business Section */}
      {tenant && (
        <section className="settings-section">
          <h2 className="settings-section__title">Business</h2>
          <div className="card">
            <div className="settings-row">
              <div className="settings-row__label">
                <span className="settings-row__title">Business Name</span>
              </div>
              <span className="settings-row__value">{tenant.name}</span>
            </div>
            <div className="settings-row settings-row--last">
              <div className="settings-row__label">
                <span className="settings-row__title">Subdomain</span>
              </div>
              <span className="settings-row__value">{tenant.subdomain}.wayveexpenses.app</span>
            </div>
          </div>
        </section>
      )}

      {/* Preferences Section */}
      <section className="settings-section">
        <h2 className="settings-section__title">Preferences</h2>
        <div className="card">
          {/* Default Category */}
          <div className="settings-row">
            <div className="settings-row__label">
              <span className="settings-row__title">Default Category</span>
              <span className="settings-row__description">
                Pre-select this category when adding expenses
                {defaultSaved && <span className="settings-row__saved"> — Saved!</span>}
              </span>
            </div>
            <select
              className="form-input settings-row__select"
              value={defaultCategoryId}
              onChange={(e) => handleDefaultCategoryChange(e.target.value)}
              disabled={savingDefault}
            >
              <option value="">None (require selection)</option>
              {categories.map(c => (
                <option key={c.id} value={c.id}>{c.emoji} {c.name}</option>
              ))}
            </select>
          </div>
          {/* Dark Mode */}
          <div className="settings-row">
            <div className="settings-row__label">
              <span className="settings-row__title">Dark Mode</span>
              <span className="settings-row__description">Use dark theme throughout the app</span>
            </div>
            <button
              className={`toggle ${darkMode ? 'toggle--active' : ''}`}
              onClick={() => setDarkMode(!darkMode)}
              role="switch"
              aria-checked={darkMode}
            >
              <span className="toggle__slider" />
            </button>
          </div>
          {/* Email Notifications */}
          <div className="settings-row">
            <div className="settings-row__label">
              <span className="settings-row__title">Email Notifications</span>
              <span className="settings-row__description">Receive weekly expense summaries</span>
            </div>
            <button className="toggle toggle--disabled" disabled>
              <span className="toggle__slider" />
            </button>
          </div>
          {/* Quick Add Button */}
          <div className="settings-row settings-row--last">
            <div className="settings-row__label">
              <span className="settings-row__title">Quick Add Button</span>
              <span className="settings-row__description">Show floating button to add expenses</span>
            </div>
            <button
              className={`toggle ${showFab ? 'toggle--active' : ''}`}
              onClick={() => setShowFab(!showFab)}
              role="switch"
              aria-checked={showFab}
            >
              <span className="toggle__slider" />
            </button>
          </div>
        </div>
      </section>

      {/* Account Section */}
      <section className="settings-section">
        <h2 className="settings-section__title">Account</h2>
        <div className="card">
          <div className="settings-row settings-row--last">
            <div className="settings-row__label">
              <span className="settings-row__title">Sign Out</span>
              <span className="settings-row__description">Sign out of your account on this device</span>
            </div>
            <button className="btn btn--danger" onClick={logout}>
              Sign Out
            </button>
          </div>
        </div>
      </section>
    </div>
  )
}


--- FILE: ./src/pages/MileageReportPage.tsx ---

import { useState, useEffect } from 'react'
import { useYear } from '../hooks/useYear'
import { useTenant } from '../hooks/useTenant'
import { Link } from 'wouter'

interface MileageTrip {
  id: string
  date: string
  startLocation: string
  endLocation: string
  description: string | null
  distanceMiles: number
  displayMiles: number
  isRoundTrip: boolean
}

interface MonthlyBreakdown {
  month: number
  label: string
  totalMiles: number
  tripCount: number
}

interface MileageReportData {
  year: number
  trips: MileageTrip[]
  summary: {
    totalMiles: number
    tripCount: number
    estimatedDeduction: number
    mileageRate: number
  }
  monthlyBreakdown: MonthlyBreakdown[]
}

function formatMiles(miles: number): string {
  return (miles / 100).toFixed(1)
}

function formatDollars(cents: number): string {
  return (cents / 100).toLocaleString('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  })
}

function formatDate(dateStr: string): string {
  const [year, month, day] = dateStr.substring(0, 10).split('-').map(Number)
  return new Date(year, month - 1, day).toLocaleDateString('en-US', {
    month: '2-digit',
    day: '2-digit',
    year: 'numeric',
  })
}

function formatDateShort(dateStr: string): string {
  const [year, month, day] = dateStr.substring(0, 10).split('-').map(Number)
  return new Date(year, month - 1, day).toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
  })
}

// Truncate long addresses for mobile display
function truncateLocation(location: string, maxLength = 30): string {
  if (location.length <= maxLength) return location
  const commaIndex = location.indexOf(',')
  if (commaIndex > 0 && commaIndex <= maxLength) {
    return location.substring(0, commaIndex)
  }
  return location.substring(0, maxLength) + '...'
}

export default function MileageReportPage() {
  const { year, nextYear, prevYear } = useYear()
  const { subdomain } = useTenant()
  const [data, setData] = useState<MileageReportData | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  const currentYear = new Date().getFullYear()

  useEffect(() => {
    if (!subdomain) return

    async function fetchData() {
      setLoading(true)
      setError(null)
      try {
        const params = new URLSearchParams({
          tenant: subdomain!,
          year: year.toString(),
        })
        const response = await fetch(`/api/reports/mileage?${params}`)
        if (!response.ok) throw new Error('Failed to fetch mileage report')
        const result = await response.json()
        setData(result)
      } catch (err) {
        console.error('Mileage report error:', err)
        setError('Failed to load mileage report')
      } finally {
        setLoading(false)
      }
    }

    fetchData()
  }, [subdomain, year])

  return (
    <div className="page mileage-report-page">
      <div className="mileage-report-page__nav">
        <Link href="/reports" className="back-link">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <polyline points="15 18 9 12 15 6" />
          </svg>
          Reports
        </Link>
      </div>

      <div className="mileage-report-page__header">
        <h1 className="mileage-report-page__title">Mileage Log</h1>
        <div className="mileage-report-page__year-selector">
          <button
            className="year-nav-btn"
            onClick={prevYear}
            disabled={year <= 2020}
            aria-label="Previous year"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <polyline points="15 18 9 12 15 6" />
            </svg>
          </button>
          <span className="mileage-report-page__year">{year}</span>
          <button
            className="year-nav-btn"
            onClick={nextYear}
            disabled={year >= currentYear}
            aria-label="Next year"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <polyline points="9 18 15 12 9 6" />
            </svg>
          </button>
        </div>
      </div>

      <p className="mileage-report-page__description">
        IRS-ready mileage log for {year}. All business trips with dates, destinations, purpose, and distance.
      </p>

      {loading && (
        <div className="card" style={{ textAlign: 'center', padding: 'var(--spacing-2xl)' }}>
          <p style={{ color: 'var(--color-text-secondary)' }}>Loading mileage data...</p>
        </div>
      )}

      {error && (
        <div className="card" style={{ textAlign: 'center', padding: 'var(--spacing-2xl)' }}>
          <p style={{ color: 'var(--color-error)' }}>{error}</p>
        </div>
      )}

      {!loading && !error && data && (
        <>
          {data.trips.length === 0 ? (
            <div className="card" style={{ textAlign: 'center', padding: 'var(--spacing-2xl)' }}>
              <p className="empty-state__icon">🚗</p>
              <p style={{ color: 'var(--color-text-secondary)' }}>No mileage trips recorded for {year}.</p>
            </div>
          ) : (
            <>
              {/* Summary Cards */}
              <div className="mileage-report__summary">
                <div className="mileage-report__stat-card">
                  <span className="mileage-report__stat-label">Total Miles</span>
                  <span className="mileage-report__stat-value">{formatMiles(data.summary.totalMiles)}</span>
                </div>
                <div className="mileage-report__stat-card">
                  <span className="mileage-report__stat-label">Total Trips</span>
                  <span className="mileage-report__stat-value">{data.summary.tripCount}</span>
                </div>
                <div className="mileage-report__stat-card">
                  <span className="mileage-report__stat-label">Est. Deduction</span>
                  <span className="mileage-report__stat-value mileage-report__stat-value--highlight">
                    {formatDollars(data.summary.estimatedDeduction)}
                  </span>
                  <span className="mileage-report__stat-sub">@ {data.summary.mileageRate}¢/mile</span>
                </div>
              </div>

              {/* Monthly Breakdown */}
              {data.monthlyBreakdown.length > 0 && (
                <div className="card mileage-report__monthly-card">
                  <h2 className="card__title">Monthly Summary</h2>
                  <div className="mileage-report__monthly-grid">
                    {data.monthlyBreakdown.map((month) => (
                      <div key={month.month} className="mileage-report__monthly-row">
                        <span className="mileage-report__monthly-label">{month.label}</span>
                        <span className="mileage-report__monthly-trips">
                          {month.tripCount} trip{month.tripCount !== 1 ? 's' : ''}
                        </span>
                        <span className="mileage-report__monthly-miles">
                          {formatMiles(month.totalMiles)} mi
                        </span>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Trip Log Table */}
              <div className="mileage-table-wrapper">
                <table className="mileage-table">
                  <thead>
                    <tr>
                      <th className="mileage-table__date-header">Date</th>
                      <th className="mileage-table__dest-header">Destination</th>
                      <th className="mileage-table__purpose-header">Business Purpose</th>
                      <th className="mileage-table__miles-header">Miles</th>
                    </tr>
                  </thead>
                  <tbody>
                    {data.trips.map((trip) => (
                      <tr key={trip.id} className="mileage-table__row">
                        <td className="mileage-table__date-cell">
                          <span className="mileage-table__date-full">{formatDate(trip.date)}</span>
                          <span className="mileage-table__date-short">{formatDateShort(trip.date)}</span>
                        </td>
                        <td className="mileage-table__dest-cell">
                          <span className="mileage-table__dest-full">
                            {trip.startLocation} → {trip.endLocation}
                          </span>
                          <span className="mileage-table__dest-short">
                            {truncateLocation(trip.startLocation)} → {truncateLocation(trip.endLocation)}
                          </span>
                          {trip.isRoundTrip && (
                            <span className="mileage-table__round-trip-badge">Round Trip</span>
                          )}
                        </td>
                        <td className="mileage-table__purpose-cell">
                          {trip.description || '—'}
                        </td>
                        <td className="mileage-table__miles-cell">
                          {formatMiles(trip.displayMiles)}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                  <tfoot>
                    <tr className="mileage-table__totals-row">
                      <td className="mileage-table__totals-label" colSpan={3}>
                        TOTAL ({data.summary.tripCount} trips)
                      </td>
                      <td className="mileage-table__miles-cell mileage-table__miles-cell--total">
                        {formatMiles(data.summary.totalMiles)}
                      </td>
                    </tr>
                  </tfoot>
                </table>
              </div>

              {/* IRS Disclaimer */}
              <p className="mileage-report__disclaimer">
                This log is based on IRS standard mileage rate guidelines. The {year} rate 
                is {data.summary.mileageRate}¢ per business mile. Consult a tax professional 
                for actual deduction calculations. Retain this log and supporting documentation 
                for your records.
              </p>
            </>
          )}
        </>
      )}
    </div>
  )
}


--- FILE: ./src/types/google-maps.d.ts ---

// Extend Google Maps types for beta PlaceAutocompleteElement
declare namespace google.maps.places {
  class PlaceAutocompleteElement extends HTMLElement {
    constructor(options?: PlaceAutocompleteElementOptions)
    style: CSSStyleDeclaration
  }

  interface PlaceAutocompleteElementOptions {
    componentRestrictions?: ComponentRestrictions
    fields?: string[]
    types?: string[]
  }
}

declare namespace google.maps {
  interface PlacesLibrary {
    PlaceAutocompleteElement: typeof google.maps.places.PlaceAutocompleteElement
  }
  
  interface RoutesLibrary {
    DistanceMatrixService: typeof google.maps.DistanceMatrixService
  }
}

--- FILE: ./src/utils/date-utils.ts ---

/**
 * Parse a date string (YYYY-MM-DD or ISO timestamp) into a local Date object
 * without UTC timezone shift. Prevents the off-by-one bug where
 * new Date("2026-01-03") becomes Jan 2 in US timezones.
 */
export function parseLocalDate(dateStr: string): Date {
  const [year, month, day] = dateStr.substring(0, 10).split('-').map(Number)
  return new Date(year, month - 1, day)
}

/**
 * Format a date string for display (e.g., "Friday, January 3, 2026")
 */
export function formatDateLong(dateStr: string): string {
  return parseLocalDate(dateStr).toLocaleDateString('en-US', {
    weekday: 'long',
    month: 'long',
    day: 'numeric',
    year: 'numeric',
  })
}

/**
 * Format a date string short (e.g., "Jan 3, 2026")
 */
export function formatDateShort(dateStr: string): string {
  return parseLocalDate(dateStr).toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric',
  })
}

/**
 * Get today's date as YYYY-MM-DD in local timezone
 */
export function todayLocal(): string {
  const now = new Date()
  return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`
}

--- FILE: ./src/utils/attachment-upload.ts ---

import { upload } from '@vercel/blob/client'

// ============================================
// Types
// ============================================

export interface PendingAttachment {
  blobUrl: string
  fileName: string
  fileType: string
  fileSize: number
}

export interface UploadProgress {
  status: 'idle' | 'compressing' | 'uploading' | 'done' | 'error'
  message?: string
}

// ============================================
// Constants
// ============================================

const COMPRESSION_THRESHOLD = 4 * 1024 * 1024 // 4MB — compress if larger
const MAX_UPLOAD_SIZE = 10 * 1024 * 1024       // 10MB — reject if larger (pre-compression)
const MAX_DIMENSION = 2048                      // Resize longest edge to this

export const ALLOWED_FILE_TYPES = ['image/jpeg', 'image/png', 'image/heic', 'image/webp', 'application/pdf']
export const ALLOWED_FILE_ACCEPT = 'image/jpeg,image/png,image/heic,image/webp,application/pdf'

// ============================================
// Client-side image compression via Canvas API
// Only compresses images over 4MB. PDFs and small files pass through.
// ============================================

export async function compressImageFile(file: File): Promise<File> {
  // PDFs: never compress
  if (file.type === 'application/pdf') return file

  // Images under threshold: pass through untouched
  if (file.size <= COMPRESSION_THRESHOLD) return file

  // Image over 4MB — compress via Canvas API
  const img = await loadImage(file)
  const qualitySteps = [0.92, 0.85, 0.75]

  for (const quality of qualitySteps) {
    const compressedBlob = await resizeAndCompress(img, quality)

    if (compressedBlob.size <= COMPRESSION_THRESHOLD) {
      const compressedName = file.name.replace(/\.[^.]+$/, '') + '.jpg'
      return new File([compressedBlob], compressedName, { type: 'image/jpeg' })
    }
  }

  // Even at 75% quality it's still over 4MB — use the last attempt anyway
  const lastBlob = await resizeAndCompress(img, 0.75)
  const compressedName = file.name.replace(/\.[^.]+$/, '') + '.jpg'
  return new File([lastBlob], compressedName, { type: 'image/jpeg' })
}

function loadImage(file: File): Promise<HTMLImageElement> {
  return new Promise((resolve, reject) => {
    const img = new Image()
    img.onload = () => {
      URL.revokeObjectURL(img.src)
      resolve(img)
    }
    img.onerror = reject
    img.src = URL.createObjectURL(file)
  })
}

async function resizeAndCompress(img: HTMLImageElement, quality: number): Promise<Blob> {
  let { width, height } = img
  if (width > MAX_DIMENSION || height > MAX_DIMENSION) {
    if (width > height) {
      height = Math.round(height * (MAX_DIMENSION / width))
      width = MAX_DIMENSION
    } else {
      width = Math.round(width * (MAX_DIMENSION / height))
      height = MAX_DIMENSION
    }
  }

  const canvas = document.createElement('canvas')
  canvas.width = width
  canvas.height = height
  const ctx = canvas.getContext('2d')!
  ctx.drawImage(img, 0, 0, width, height)

  return new Promise<Blob>((resolve, reject) => {
    canvas.toBlob(
      (b) => b ? resolve(b) : reject(new Error('Canvas compression failed')),
      'image/jpeg',
      quality
    )
  })
}

// ============================================
// Format file size for display
// ============================================

export function formatFileSize(bytes: number): string {
  if (bytes < 1024) return `${bytes} B`
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(0)} KB`
  return `${(bytes / (1024 * 1024)).toFixed(1)} MB`
}

// ============================================
// Validate a file for upload
// Returns error message or null if valid
// ============================================

export function validateFile(file: File): string | null {
  if (!ALLOWED_FILE_TYPES.includes(file.type)) {
    return 'File type not allowed. Accepted: JPEG, PNG, HEIC, WebP, PDF'
  }
  if (file.size > MAX_UPLOAD_SIZE) {
    return 'File too large. Maximum size is 10MB.'
  }
  return null
}

// ============================================
// Upload a file to Vercel Blob (compress first if needed)
// Does NOT call POST /api/attachments — that happens separately
// ============================================

export async function uploadToBlob(
  file: File,
  tenantSubdomain: string,
  blobPathPrefix: string,
  onProgress?: (progress: UploadProgress) => void
): Promise<PendingAttachment> {
  // Step 1: Compress if needed (images >4MB)
  let fileToUpload = file
  if (file.size > COMPRESSION_THRESHOLD && file.type.startsWith('image/')) {
    onProgress?.({ status: 'compressing', message: 'Compressing image...' })
    fileToUpload = await compressImageFile(file)
    const savedPct = Math.round((1 - fileToUpload.size / file.size) * 100)
    onProgress?.({
      status: 'uploading',
      message: `Compressed: ${formatFileSize(file.size)} → ${formatFileSize(fileToUpload.size)} (${savedPct}% smaller) • Uploading...`,
    })
  } else {
    onProgress?.({ status: 'uploading', message: 'Uploading...' })
  }

  // Step 2: Upload directly to Vercel Blob via client upload
  const blobPath = `${blobPathPrefix}/${Date.now()}-${fileToUpload.name}`
  const blob = await upload(blobPath, fileToUpload, {
    access: 'public',
    handleUploadUrl: `/api/attachments/upload?tenant=${tenantSubdomain}`,
  })

  onProgress?.({ status: 'done' })

  return {
    blobUrl: blob.url,
    fileName: fileToUpload.name,
    fileType: fileToUpload.type,
    fileSize: fileToUpload.size,
  }
}

// ============================================
// Link a blob attachment to an expense (POST /api/attachments)
// ============================================

export async function linkAttachmentToExpense(
  attachment: PendingAttachment,
  expenseId: string,
  tenantSubdomain: string
): Promise<void> {
  const response = await fetch(`/api/attachments?tenant=${tenantSubdomain}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      expenseId,
      blobUrl: attachment.blobUrl,
      fileName: attachment.fileName,
      fileType: attachment.fileType,
      fileSize: attachment.fileSize,
    }),
  })

  if (!response.ok) {
    const data = await response.json()
    throw new Error(data.error || 'Failed to link attachment')
  }
}


--- FILE: ./src/styles/theme.css ---

:root {
  /* ========================================
     WAYVE EXPENSE TRACKER - THEME VARIABLES
     White-label ready: override these per-tenant
     ======================================== */

  /* Primary Brand Colors */
  --color-primary: #2A9D8F;
  --color-primary-hover: #238377;
  --color-primary-light: #3AB5A6;
  --color-primary-subtle: rgba(42, 157, 143, 0.1);

  /* Text Colors */
  --color-text-primary: #264653;
  --color-text-secondary: #5C6B73;
  --color-text-muted: #9CA3AF;
  --color-text-inverse: #FFFFFF;

  /* Background Colors */
  --color-bg-primary: #FFFFFF;
  --color-bg-secondary: #F8F9FA;
  --color-bg-tertiary: #E9ECEF;
  --color-bg-card: #FFFFFF;

  /* Border Colors */
  --color-border: #E5E7EB;
  --color-border-light: #F3F4F6;

  /* Status Colors */
  --color-success: #10B981;
  --color-warning: #F59E0B;
  --color-error: #EF4444;
  --color-info: #3B82F6;

  /* Shadows */
  --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
  --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
  --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);

  /* Spacing Scale */
  --spacing-xs: 0.25rem;
  --spacing-sm: 0.5rem;
  --spacing-md: 1rem;
  --spacing-lg: 1.5rem;
  --spacing-xl: 2rem;
  --spacing-2xl: 3rem;

  /* Border Radius */
  --radius-sm: 0.25rem;
  --radius-md: 0.5rem;
  --radius-lg: 0.75rem;
  --radius-full: 9999px;

  /* Typography */
  --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  --font-size-xs: 0.75rem;
  --font-size-sm: 0.875rem;
  --font-size-md: 1rem;
  --font-size-lg: 1.125rem;
  --font-size-xl: 1.25rem;
  --font-size-2xl: 1.5rem;
  --font-size-3xl: 2rem;

  /* Transitions */
  --transition-fast: 150ms ease;
  --transition-normal: 250ms ease;
}

/* ========================================
   BASE RESET & DEFAULTS
   ======================================== */

*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html {
  font-size: 16px;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

body {
  font-family: var(--font-family);
  font-size: var(--font-size-md);
  color: var(--color-text-primary);
  background-color: var(--color-bg-secondary);
  line-height: 1.5;
}

a {
  color: var(--color-primary);
  text-decoration: none;
}

a:hover {
  color: var(--color-primary-hover);
}

button {
  cursor: pointer;
  font-family: inherit;
}

/* ========================================
   UTILITY CLASSES
   ======================================== */

.container {
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 var(--spacing-md);
}

.card {
  background: var(--color-bg-card);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-sm);
  padding: var(--spacing-lg);
}

.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  border: 0;
}

/* ========================================
   DARK THEME
   ======================================== */

[data-theme="dark"] {
  /* Primary Brand Colors - slightly brighter for dark mode */
  --color-primary: #3AB5A6;
  --color-primary-hover: #4DC4B5;
  --color-primary-light: #2A9D8F;
  --color-primary-subtle: rgba(58, 181, 166, 0.15);

  /* Text Colors */
  --color-text-primary: #F1F5F9;
  --color-text-secondary: #94A3B8;
  --color-text-muted: #64748B;
  --color-text-inverse: #0F172A;

  /* Background Colors */
  --color-bg-primary: #1E293B;
  --color-bg-secondary: #0F172A;
  --color-bg-tertiary: #334155;
  --color-bg-card: #1E293B;

  /* Border Colors */
  --color-border: #334155;
  --color-border-light: #1E293B;

  /* Status Colors - slightly adjusted for contrast */
  --color-success: #34D399;
  --color-warning: #FBBF24;
  --color-error: #F87171;
  --color-info: #60A5FA;

  /* Shadows - more subtle in dark mode */
  --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
  --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
  --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.5);
}



--- FILE: ./src/styles/layout.css ---

/* ============================================
   LAYOUT SHELL
   ============================================ */

.layout {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* ============================================
   HEADER
   ============================================ */

.header {
  position: sticky;
  top: 0;
  z-index: 100;
  display: flex;
  align-items: center;
  height: 56px;
  padding: 0 var(--spacing-md);
  background: var(--color-bg-primary);
  border-bottom: 1px solid var(--color-border);
}

.header__menu-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  padding: 0;
  background: transparent;
  border: none;
  border-radius: var(--radius-md);
  color: var(--color-text-primary);
  cursor: pointer;
  transition: background-color 0.15s ease;
}

.header__menu-btn:hover {
  background: var(--color-bg-tertiary);
}

.header__title {
  flex: 1;
  margin: 0;
  font-size: 1.125rem;
  font-weight: 600;
  text-align: center;
  color: var(--color-text-primary);
}

.header__spacer {
  width: 40px; /* Same as menu button to center title */
}

/* ============================================
   DRAWER OVERLAY
   ============================================ */

.drawer-overlay {
  position: fixed;
  inset: 0;
  z-index: 200;
  background: rgba(0, 0, 0, 0.5);
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.25s ease, visibility 0.25s ease;
}

.drawer-overlay--open {
  opacity: 1;
  visibility: visible;
}

/* ============================================
   NAVIGATION DRAWER
   ============================================ */

.drawer {
  position: fixed;
  top: 0;
  left: 0;
  z-index: 300;
  display: flex;
  flex-direction: column;
  width: 280px;
  max-width: 85vw;
  height: 100vh;
  height: 100dvh; /* Dynamic viewport height - respects mobile browser chrome */
  background: var(--color-bg-primary);
  box-shadow: var(--shadow-lg);
  transform: translateX(-100%);
  transition: transform 0.25s ease;
}

.drawer--open {
  transform: translateX(0);
}

.drawer__header {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
  padding: var(--spacing-lg);
  border-bottom: 1px solid var(--color-border);
}

.drawer__logo {
  width: 40px;
  height: 40px;
  border-radius: var(--radius-md);
  object-fit: contain;
}

.drawer__logo-placeholder {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  background: var(--color-primary);
  border-radius: var(--radius-md);
  color: white;
  font-size: 1.25rem;
  font-weight: 600;
}

.drawer__app-name {
  font-size: 1rem;
  font-weight: 600;
  color: var(--color-text-primary);
}

/* ============================================
   YEAR SELECTOR
   ============================================ */

.drawer__year-selector {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-md);
  padding: var(--spacing-md) var(--spacing-lg);
  background: var(--color-bg-secondary);
}

.year-selector__btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  padding: 0;
  background: transparent;
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  color: var(--color-text-secondary);
  cursor: pointer;
  transition: all 0.15s ease;
}

.year-selector__btn:hover {
  background: var(--color-bg-tertiary);
  color: var(--color-text-primary);
  border-color: var(--color-text-secondary);
}

.year-selector__year {
  min-width: 60px;
  font-size: 1.125rem;
  font-weight: 600;
  text-align: center;
  color: var(--color-text-primary);
}

/* ============================================
   NAVIGATION LINKS
   ============================================ */

.drawer__nav {
  flex: 1;
  overflow-y: auto;
  padding: var(--spacing-md) 0;
  margin: 0;
  list-style: none;
}

.drawer__nav-item {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
  padding: var(--spacing-sm) var(--spacing-lg);
  margin: 0 var(--spacing-sm);
  border-radius: var(--radius-md);
  color: var(--color-text-secondary);
  text-decoration: none;
  font-size: 0.9375rem;
  transition: all 0.15s ease;
}

.drawer__nav-item:hover {
  background: var(--color-bg-tertiary);
  color: var(--color-text-primary);
}

.drawer__nav-item--active {
  background: var(--color-primary);
  color: #fff;
  font-weight: 500;
}
.drawer__nav-item--active:hover {
  background: var(--color-primary-hover);
}

.drawer__nav-item svg {
  flex-shrink: 0;
}

/* ============================================
   PROFILE SECTION
   ============================================ */

.drawer__profile {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--spacing-md) var(--spacing-lg);
  border-top: 1px solid var(--color-border);
  background: var(--color-bg-secondary);
  margin-top: auto; /* Push to bottom */
  flex-shrink: 0; /* Don't let it shrink */
}

.drawer__profile-info {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  min-width: 0; /* Allow text truncation */
}

.drawer__avatar {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  background: var(--color-primary);
  border-radius: 50%;
  color: white;
  font-size: 0.875rem;
  font-weight: 600;
  flex-shrink: 0;
}

.drawer__profile-text {
  display: flex;
  flex-direction: column;
  min-width: 0;
}

.drawer__profile-name {
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--color-text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.drawer__profile-role {
  font-size: 0.75rem;
  color: var(--color-text-secondary);
  text-transform: capitalize;
}

.drawer__logout-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  padding: 0;
  background: transparent;
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  color: var(--color-text-secondary);
  cursor: pointer;
  transition: all 0.15s ease;
}

.drawer__logout-btn:hover {
  background: var(--color-error-light, #fef2f2);
  border-color: var(--color-error);
  color: var(--color-error);
}

/* ============================================
   MAIN CONTENT
   ============================================ */

.main-content {
  flex: 1;
  padding: var(--spacing-md);
}

/* ============================================
   RESPONSIVE - LARGER SCREENS
   ============================================ */

@media (min-width: 768px) {
  .header {
    height: 64px;
    padding: 0 var(--spacing-lg);
  }

  .header__title {
    font-size: 1.25rem;
  }

  .main-content {
    padding: var(--spacing-lg);
  }
}

/* ============================================
   PAGE BASE
   ============================================ */

.page {
  max-width: 1200px;
  margin: 0 auto;
}

/* ============================================
   DASHBOARD
   ============================================ */

.dashboard__summary {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: var(--spacing-md);
  margin-bottom: var(--spacing-lg);
}

.summary-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: var(--spacing-lg);
  background: var(--color-bg-primary);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  text-align: center;
}

.summary-card__label {
  font-size: 0.75rem;
  font-weight: 500;
  color: var(--color-text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: var(--spacing-xs);
}

.summary-card__value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--color-text-primary);
  line-height: 1.2;
}

.summary-card__sub {
  font-size: 0.75rem;
  color: var(--color-text-secondary);
  margin-top: var(--spacing-xs);
}

.dashboard__grid {
  display: grid;
  gap: var(--spacing-lg);
}

/* ============================================
   DONUT CHART
   ============================================ */

.donut-card {
  margin-bottom: var(--spacing-lg);
}

.donut-container {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-lg);
}

@media (min-width: 768px) {
  .donut-container {
    flex-direction: row;
    align-items: center;
  }
  
  .donut-chart {
    width: 300px;
  }
}

.donut-chart {
  position: relative;
  flex-shrink: 0;
}

.donut-center {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  pointer-events: none;
}

.donut-center__amount {
  display: block;
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--color-text-primary);
}

.donut-center__label {
  display: block;
  font-size: 0.75rem;
  color: var(--color-text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.donut-legend {
  list-style: none;
  margin: 0;
  padding: 0;
  flex: 1;
}

.donut-legend__item {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-xs) 0;
  font-size: 0.875rem;
  cursor: pointer;
  border-radius: var(--radius-sm);
  transition: background-color 0.15s ease;
}

.donut-legend__item:hover {
  background: var(--color-bg-secondary);
}

.donut-legend__item[role="button"] {
  margin: 0 calc(var(--spacing-xs) * -1);
  padding: var(--spacing-xs);
}

.donut-legend__color {
  width: 12px;
  height: 12px;
  border-radius: 2px;
  flex-shrink: 0;
}

.donut-legend__emoji {
  font-size: 1rem;
  line-height: 1;
}

.donut-legend__name {
  flex: 1;
  color: var(--color-text-primary);
}

.donut-legend__value {
  font-weight: 600;
  color: var(--color-text-primary);
}

/* Tooltip */
.donut-tooltip {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  background: var(--color-bg-primary);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  padding: var(--spacing-sm) var(--spacing-md);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.donut-tooltip__emoji {
  font-size: 1.25rem;
}

.donut-tooltip__name {
  font-size: 0.875rem;
  color: var(--color-text-secondary);
}

.donut-tooltip__value {
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--color-text-primary);
}

/* ============================================
   CARD STYLES
   ============================================ */

.card__title {
  margin: 0 0 var(--spacing-md) 0;
  font-size: 1rem;
  font-weight: 600;
  color: var(--color-text-primary);
}

/* ============================================
   EXPENSE LIST
   ============================================ */

.expense-list {
  list-style: none;
  margin: 0;
  padding: 0;
}

.expense-list__item {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
  padding: var(--spacing-sm) 0;
  border-bottom: 1px solid var(--color-border);
}

.expense-list__item:last-child {
  border-bottom: none;
}

.expense-list__item--clickable {
  cursor: pointer;
  border-radius: var(--radius-sm);
  margin: 0 calc(var(--spacing-sm) * -1);
  padding: var(--spacing-sm);
  transition: background-color 0.15s ease;
}

.expense-list__item--clickable:hover {
  background: var(--color-bg-secondary);
}

.expense-list__item--clickable:active {
  background: var(--color-border);
}

.expense-list__icon {
  font-size: 1.5rem;
  line-height: 1;
}

.expense-list__details {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.expense-list__vendor {
  font-size: 0.9375rem;
  font-weight: 500;
  color: var(--color-text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.expense-list__meta {
  font-size: 0.75rem;
  color: var(--color-text-secondary);
}

.expense-list__amount {
  font-size: 0.9375rem;
  font-weight: 600;
  color: var(--color-text-primary);
  white-space: nowrap;
}

/* ============================================
   CATEGORY LIST
   ============================================ */

.category-list {
  list-style: none;
  margin: 0;
  padding: 0;
}

.category-list__item {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: var(--spacing-sm);
  padding: var(--spacing-sm) 0;
  border-bottom: 1px solid var(--color-border);
}

.category-list__item:last-child {
  border-bottom: none;
}

.category-list__info {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  min-width: 0;
}

.category-list__emoji {
  font-size: 1.25rem;
  line-height: 1;
}

.category-list__name {
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--color-text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.category-list__count {
  font-size: 0.75rem;
  color: var(--color-text-secondary);
  background: var(--color-bg-tertiary);
  padding: 2px 6px;
  border-radius: var(--radius-sm);
}

.category-list__bar-container {
  grid-column: 1 / -1;
  height: 4px;
  background: var(--color-bg-tertiary);
  border-radius: 2px;
  overflow: hidden;
}

.category-list__bar {
  height: 100%;
  background: var(--color-primary);
  border-radius: 2px;
  transition: width 0.3s ease;
}

.category-list__total {
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--color-text-primary);
  text-align: right;
}

/* ============================================
   RESPONSIVE - SMALL SCREENS
   ============================================ */

@media (max-width: 480px) {
  .dashboard__summary {
    grid-template-columns: 1fr;
  }

  .summary-card {
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-md);
  }

  .summary-card__label {
    margin-bottom: 0;
  }

  .summary-card__value {
    font-size: 1.25rem;
  }

  .summary-card__sub {
    display: none;
  }
}

/* ============================================
   RESPONSIVE - LARGER SCREENS (DASHBOARD)
   ============================================ */
@media (min-width: 768px) {
  .dashboard__grid {
    grid-template-columns: 1fr 1fr;
  }

  .summary-card__value {
    font-size: 2rem;
  }
}

/* Dashboard Summary - Half Width (2 cards) */
.dashboard__summary--half {
  grid-template-columns: repeat(2, 1fr);
}

@media (max-width: 480px) {
  .dashboard__summary--half {
    grid-template-columns: 1fr;
  }
}

/* Dashboard Section Divider */
.dashboard__divider {
  height: 1px;
  background: var(--color-border);
  margin: var(--spacing-xl) 0;
}

/* Deduction Display */
.deduction-display {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  padding: var(--spacing-lg) 0;
}

.deduction-display__value {
  font-size: 2.5rem;
  font-weight: 700;
  color: var(--color-primary);
  line-height: 1.2;
}

.deduction-display__rate {
  font-size: 0.875rem;
  color: var(--color-text-secondary);
  margin-top: var(--spacing-xs);
}

.deduction-display__note {
  font-size: 0.75rem;
  color: var(--color-text-secondary);
  margin: var(--spacing-md) 0 0 0;
  line-height: 1.4;
  max-width: 280px;
}

/* ============================================
   SEARCH BAR
   ============================================ */

.search-bar {
  position: relative;
  margin-bottom: var(--spacing-md);
}

.search-bar__icon {
  position: absolute;
  left: var(--spacing-md);
  top: 50%;
  transform: translateY(-50%);
  color: var(--color-text-secondary);
  pointer-events: none;
}

.search-bar__input {
  width: 100%;
  padding: var(--spacing-sm) var(--spacing-md);
  padding-left: calc(var(--spacing-md) + 28px);
  padding-right: calc(var(--spacing-md) + 28px);
  font-size: 1rem;
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  background: var(--color-bg-primary);
  color: var(--color-text-primary);
  transition: border-color 0.15s ease, box-shadow 0.15s ease;
}

.search-bar__input:focus {
  outline: none;
  border-color: var(--color-primary);
  box-shadow: 0 0 0 3px rgba(42, 157, 143, 0.1);
}

.search-bar__input::placeholder {
  color: var(--color-text-secondary);
}

.search-bar__clear {
  position: absolute;
  right: var(--spacing-sm);
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  padding: 0;
  background: var(--color-bg-tertiary);
  border: none;
  border-radius: 50%;
  color: var(--color-text-secondary);
  cursor: pointer;
  transition: background-color 0.15s ease, color 0.15s ease;
}

.search-bar__clear:hover {
  background: var(--color-bg-secondary);
  color: var(--color-text-primary);
}

/* ============================================
   EXPENSES PAGE
   ============================================ */

.expenses-page__summary {
  font-size: 0.875rem;
  color: var(--color-text-secondary);
  margin: 0 0 var(--spacing-lg) 0;
}

.expense-month {
  margin-bottom: var(--spacing-lg);
}

.expense-month__header {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: var(--spacing-sm);
  padding: 0 var(--spacing-xs);
}

.expense-month__title {
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--color-text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin: 0;
}

.expense-month__total {
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--color-text-primary);
}

.expense-month__list {
  padding: 0;
}

.expense-row {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
  padding: var(--spacing-md);
  border-bottom: 1px solid var(--color-border);
  cursor: pointer;
  transition: background-color 0.15s ease;
}

.expense-row:last-child {
  border-bottom: none;
}

.expense-row:hover {
  background: var(--color-bg-secondary);
}

.expense-row__icon {
  font-size: 1.5rem;
  line-height: 1;
  flex-shrink: 0;
}

.expense-row__details {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.expense-row__vendor {
  font-size: 0.9375rem;
  font-weight: 500;
  color: var(--color-text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.expense-row__meta {
  font-size: 0.75rem;
  color: var(--color-text-secondary);
}

.expense-row__amount {
  font-size: 0.9375rem;
  font-weight: 600;
  color: var(--color-text-primary);
  white-space: nowrap;
}

/* ============================================
   CATEGORIES PAGE
   ============================================ */

.categories-page__summary {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  font-size: 0.875rem;
  color: var(--color-text-secondary);
  margin-bottom: var(--spacing-lg);
}

.categories-page__dot {
  color: var(--color-border);
}

.category-grid {
  display: grid;
  gap: var(--spacing-md);
}

.category-card {
  background: var(--color-bg-primary);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  padding: var(--spacing-lg);
  transition: box-shadow 0.15s ease, border-color 0.15s ease;
}

.category-card:hover {
  border-color: var(--color-primary);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.category-card__header {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  margin-bottom: var(--spacing-md);
}

.category-card__emoji {
  font-size: 1.75rem;
  line-height: 1;
}

.category-card__name {
  font-size: 1rem;
  font-weight: 600;
  color: var(--color-text-primary);
}

.category-card__stats {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: var(--spacing-sm);
}

.category-card__total {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--color-text-primary);
}

.category-card__count {
  font-size: 0.875rem;
  color: var(--color-text-secondary);
}

.category-card__bar-container {
  height: 6px;
  background: var(--color-bg-tertiary);
  border-radius: 3px;
  overflow: hidden;
  margin-bottom: var(--spacing-sm);
}

.category-card__bar {
  height: 100%;
  background: var(--color-primary);
  border-radius: 3px;
  transition: width 0.3s ease;
}

.category-card__percent {
  font-size: 0.75rem;
  color: var(--color-text-secondary);
}

@media (min-width: 640px) {
  .category-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (min-width: 1024px) {
  .category-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}

/* ============================================
   EMPTY STATE
   ============================================ */

.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: var(--spacing-2xl) var(--spacing-lg);
  min-height: 60vh;
}

.empty-state__icon {
  font-size: 4rem;
  line-height: 1;
  margin-bottom: var(--spacing-lg);
}

.empty-state__title {
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--color-text-primary);
  margin: 0 0 var(--spacing-sm) 0;
}

.empty-state__description {
  font-size: 0.9375rem;
  color: var(--color-text-secondary);
  max-width: 320px;
  margin: 0 0 var(--spacing-xl) 0;
  line-height: 1.5;
}

.empty-state__btn {
  display: inline-flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-sm) var(--spacing-lg);
  font-size: 0.9375rem;
  font-weight: 500;
  color: white;
  background: var(--color-primary);
  border: none;
  border-radius: var(--radius-lg);
  cursor: pointer;
  transition: background-color 0.15s ease, transform 0.15s ease;
}

.empty-state__btn:hover:not(:disabled) {
  background: var(--color-primary-dark, #238579);
  transform: translateY(-1px);
}

.empty-state__btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

/* ============================================
   MILEAGE PAGE
   ============================================ */

.mileage-summary {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: var(--spacing-md);
  margin-bottom: var(--spacing-lg);
}

.trip-list {
  list-style: none;
  margin: 0;
  padding: 0;
}

.trip-list__item {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
  padding: var(--spacing-sm) 0;
  border-bottom: 1px solid var(--color-border);
}

.trip-list__item:last-child {
  border-bottom: none;
}

.trip-list__icon {
  font-size: 1.25rem;
  line-height: 1;
}

.trip-list__details {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.trip-list__route {
  font-size: 0.9375rem;
  font-weight: 500;
  color: var(--color-text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.trip-list__meta {
  font-size: 0.75rem;
  color: var(--color-text-secondary);
}

.trip-list__miles {
  font-size: 0.9375rem;
  font-weight: 600;
  color: var(--color-text-primary);
  white-space: nowrap;
}

@media (max-width: 480px) {
  .mileage-summary {
    grid-template-columns: 1fr;
  }
}

/* ============================================
   REPORTS PAGE
   ============================================ */

.reports-page__header {
  display: flex;
  align-items: baseline;
  gap: var(--spacing-md);
  margin-bottom: var(--spacing-sm);
}

.reports-page__title {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--color-text-primary);
  margin: 0;
}

.reports-page__year {
  font-size: 1rem;
  font-weight: 500;
  color: var(--color-text-secondary);
}

.reports-page__description {
  font-size: 0.9375rem;
  color: var(--color-text-secondary);
  margin: 0 0 var(--spacing-lg) 0;
}

.report-grid {
  display: grid;
  gap: var(--spacing-md);
}

.report-card {
  display: flex;
  align-items: flex-start;
  gap: var(--spacing-md);
  padding: var(--spacing-lg);
  background: var(--color-bg-primary);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  text-align: left;
  cursor: pointer;
  transition: border-color 0.15s ease, box-shadow 0.15s ease;
  position: relative;
}

.report-card:hover:not(:disabled) {
  border-color: var(--color-primary);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.report-card:disabled {
  cursor: not-allowed;
  opacity: 0.7;
}

.report-card__icon {
  font-size: 2rem;
  line-height: 1;
  flex-shrink: 0;
}

.report-card__content {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
}

.report-card__title {
  font-size: 1rem;
  font-weight: 600;
  color: var(--color-text-primary);
}

.report-card__description {
  font-size: 0.875rem;
  color: var(--color-text-secondary);
  line-height: 1.4;
}

.report-card__badge {
  position: absolute;
  top: var(--spacing-sm);
  right: var(--spacing-sm);
  font-size: 0.6875rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: #fff;
  background: var(--color-primary);
  padding: 4px 8px;
  border-radius: var(--radius-sm);
}

@media (min-width: 768px) {
  .report-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* ============================================
   SETTINGS PAGE
   ============================================ */

.settings-page__title {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--color-text-primary);
  margin: 0 0 var(--spacing-lg) 0;
}

.settings-section {
  margin-bottom: var(--spacing-xl);
}

.settings-section__title {
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--color-text-secondary);
  margin: 0 0 var(--spacing-sm) var(--spacing-xs);
}

.settings-section__note {
  font-size: 0.75rem;
  color: var(--color-text-secondary);
  margin: var(--spacing-sm) 0 0 var(--spacing-xs);
  font-style: italic;
}

.profile-display {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
  padding: var(--spacing-sm) 0;
}

.profile-display__avatar {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 56px;
  height: 56px;
  background: var(--color-primary);
  border-radius: 50%;
  color: white;
  font-size: 1.5rem;
  font-weight: 600;
  flex-shrink: 0;
}

.profile-display__info {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.profile-display__name {
  font-size: 1.125rem;
  font-weight: 600;
  color: var(--color-text-primary);
}

.profile-display__email {
  font-size: 0.875rem;
  color: var(--color-text-secondary);
}

.profile-display__role {
  font-size: 0.75rem;
  font-weight: 500;
  color: var(--color-primary);
  text-transform: capitalize;
}

.settings-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: var(--spacing-md);
  padding: var(--spacing-md) 0;
  border-bottom: 1px solid var(--color-border);
}

.settings-row--last {
  border-bottom: none;
}

.settings-row__label {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.settings-row__title {
  font-size: 0.9375rem;
  font-weight: 500;
  color: var(--color-text-primary);
}

.settings-row__description {
  font-size: 0.8125rem;
  color: var(--color-text-secondary);
}

.settings-row__value {
  font-size: 0.9375rem;
  color: var(--color-text-secondary);
  text-align: right;
}
.settings-row__select {
  max-width: 200px;
  font-size: 0.875rem;
}
.settings-row__saved {
  color: var(--color-success, #16a34a);
  font-weight: 500;
}

/* Toggle Switch */
.toggle {
  position: relative;
  width: 44px;
  height: 24px;
  background: var(--color-bg-tertiary);
  border: none;
  border-radius: 12px;
  cursor: pointer;
  transition: background-color 0.2s ease;
  flex-shrink: 0;
}

.toggle--active,
.toggle--on {
  background: var(--color-primary);
}

.toggle--disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.toggle__slider {
  position: absolute;
  top: 2px;
  left: 2px;
  width: 20px;
  height: 20px;
  background: white;
  border-radius: 50%;
  transition: transform 0.2s ease;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

.toggle--active .toggle__slider,
.toggle--on .toggle__slider {
  transform: translateX(20px);
}

/* Buttons */
.btn {
  padding: var(--spacing-sm) var(--spacing-md);
  font-size: 0.875rem;
  font-weight: 500;
  border: none;
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: background-color 0.15s ease, transform 0.15s ease;
}

.btn--danger {
  color: var(--color-error);
  background: var(--color-error-light, #fef2f2);
}

.btn--danger:hover {
  background: #fee2e2;
}

/* ============================================
   FLOATING ACTION BUTTON (FAB)
   ============================================ */

.main-content:has(.home-office-config__form) ~ .fab {
  display: none;
}

.fab {
  position: fixed;
  bottom: calc(var(--spacing-lg) + env(safe-area-inset-bottom, 0px));
  right: var(--spacing-lg);
  z-index: 50;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 56px;
  height: 56px;
  background: var(--color-primary);
  border: none;
  border-radius: 50%;
  color: white;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1);
  transition: transform 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
}

.fab:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2), 0 3px 6px rgba(0, 0, 0, 0.1);
}

.fab:active {
  transform: scale(0.95);
}

.fab svg {
  width: 24px;
  height: 24px;
}

/* FAB Mileage Variant (blue) */
.fab--mileage {
  background: var(--color-info, #3b82f6);
}

.fab--mileage:hover {
  background: var(--color-info-dark, #2563eb);
}

/* ============================================
   BOTTOM SHEET
   ============================================ */

.sheet-backdrop {
  position: fixed;
  inset: 0;
  z-index: 400;
  background: rgba(0, 0, 0, 0.5);
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}

.sheet-backdrop--open {
  opacity: 1;
  visibility: visible;
}

.bottom-sheet {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 500;
  max-height: 90vh;
  background: var(--color-bg-primary);
  border-radius: var(--radius-xl, 16px) var(--radius-xl, 16px) 0 0;
  box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
  transform: translateY(100%);
  transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.bottom-sheet--open {
  transform: translateY(0);
}

.bottom-sheet__handle {
  display: flex;
  justify-content: center;
  padding: var(--spacing-sm) 0;
  cursor: pointer;
  flex-shrink: 0;
}

.bottom-sheet__handle-bar {
  width: 36px;
  height: 4px;
  background: var(--color-border);
  border-radius: 2px;
}

.bottom-sheet__header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 var(--spacing-lg) var(--spacing-md);
  border-bottom: 1px solid var(--color-border);
  flex-shrink: 0;
}

.bottom-sheet__title {
  font-size: 1.125rem;
  font-weight: 600;
  color: var(--color-text-primary);
  margin: 0;
}

.bottom-sheet__close {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  padding: 0;
  background: transparent;
  border: none;
  border-radius: var(--radius-md);
  color: var(--color-text-secondary);
  cursor: pointer;
  transition: background-color 0.15s ease, color 0.15s ease;
}

.bottom-sheet__close:hover {
  background: var(--color-bg-tertiary);
  color: var(--color-text-primary);
}

.bottom-sheet__form {
  flex: 1;
  overflow-y: auto;
  padding: var(--spacing-lg);
  padding-bottom: calc(var(--spacing-lg) + env(safe-area-inset-bottom, 0px));
  display: flex;
  flex-direction: column;
  gap: var(--spacing-md);
}

/* ============================================
   FORM ELEMENTS
   ============================================ */

.form-group {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
}

.form-label {
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--color-text-primary);
}
.form-label__status {
  font-weight: normal;
  color: var(--color-text-secondary);
  font-size: 0.85em;
}

.form-input {
  width: 100%;
  padding: var(--spacing-sm) var(--spacing-md);
  font-size: 1rem;
  color: var(--color-text-primary);
  background: var(--color-bg-primary);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  transition: border-color 0.15s ease, box-shadow 0.15s ease;
}

.form-input:focus {
  outline: none;
  border-color: var(--color-primary);
  box-shadow: 0 0 0 3px var(--color-primary-light, rgba(42, 157, 143, 0.15));
}

.form-input::placeholder {
  color: var(--color-text-tertiary, #9ca3af);
}

.form-input--loading {
  color: var(--color-text-secondary);
  background: var(--color-bg-secondary);
}

.form-select {
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right var(--spacing-md) center;
  padding-right: calc(var(--spacing-md) * 2 + 16px);
  cursor: pointer;
}

/* Input with prefix (for $ sign) */
.input-with-prefix {
  position: relative;
  display: flex;
  align-items: stretch;
}

.input-prefix {
  display: flex;
  align-items: center;
  padding: 0 var(--spacing-sm) 0 var(--spacing-md);
  font-size: 1rem;
  font-weight: 500;
  color: var(--color-text-secondary);
  background: var(--color-bg-secondary);
  border: 1px solid var(--color-border);
  border-right: none;
  border-radius: var(--radius-md) 0 0 var(--radius-md);
}

.form-input--with-prefix {
  border-radius: 0 var(--radius-md) var(--radius-md) 0;
}

/* Form error */
.form-error {
  padding: var(--spacing-sm) var(--spacing-md);
  font-size: 0.875rem;
  color: var(--color-error);
  background: var(--color-error-light, #fef2f2);
  border: 1px solid var(--color-error);
  border-radius: var(--radius-md);
}

/* Expense type selector */
.expense-type-group {
  display: flex;
  gap: var(--spacing-sm);
}

.expense-type-option {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: var(--spacing-sm) var(--spacing-md);
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--color-text-secondary);
  background: var(--color-bg-primary);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all 0.15s ease;
}

.expense-type-option:hover {
  border-color: var(--color-text-secondary);
}

.expense-type-option--selected {
  color: #fff;
  background: var(--color-primary);
  border-color: var(--color-primary);
}

.expense-type-option input {
  position: absolute;
  opacity: 0;
  pointer-events: none;
}

/* ============================================
   BUTTON ADDITIONS
   ============================================ */

.btn--primary {
  color: white;
  background: var(--color-primary);
}

.btn--primary:hover:not(:disabled) {
  background: var(--color-primary-dark, #238579);
}

.btn--primary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.btn--full {
  width: 100%;
  padding: var(--spacing-md);
  font-size: 1rem;
  margin-top: var(--spacing-sm);
}

/* ============================================
   RESPONSIVE ADJUSTMENTS
   ============================================ */

@media (min-width: 768px) {
  .fab {
    bottom: var(--spacing-xl);
    right: var(--spacing-xl);
  }

  .bottom-sheet {
    max-width: 480px;
    left: 50%;
    transform: translateX(-50%) translateY(100%);
    border-radius: var(--radius-xl, 16px);
    bottom: var(--spacing-lg);
    max-height: 85vh;
  }

  .bottom-sheet--open {
    transform: translateX(-50%) translateY(0);
  }
}

/* ============================================
   EXPENSE DETAIL SHEET
   ============================================ */

.detail-hero {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: var(--spacing-lg) 0;
  gap: var(--spacing-sm);
}

.detail-hero__emoji {
  font-size: 3rem;
  line-height: 1;
}

.detail-hero__amount {
  font-size: 2.5rem;
  font-weight: 700;
  color: var(--color-text-primary);
}

.detail-list {
  display: flex;
  flex-direction: column;
  background: var(--color-bg-secondary);
  border-radius: var(--radius-lg);
  overflow: hidden;
  margin-bottom: var(--spacing-lg);
}

.detail-row {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  padding: var(--spacing-md);
  border-bottom: 1px solid var(--color-border);
  gap: var(--spacing-md);
}

.detail-row:last-child {
  border-bottom: none;
}

.detail-row__label {
  font-size: 0.875rem;
  color: var(--color-text-secondary);
  flex-shrink: 0;
}

.detail-row__value {
  font-size: 0.9375rem;
  font-weight: 500;
  color: var(--color-text-primary);
  text-align: right;
  word-break: break-word;
}

.detail-row__value--capitalize {
  text-transform: capitalize;
}

.detail-actions {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-sm);
}

.edit-actions {
  display: flex;
  gap: var(--spacing-sm);
  margin-top: var(--spacing-sm);
}

.edit-actions .btn {
  flex: 1;
  padding: var(--spacing-md);
  font-size: 1rem;
}

/* ============================================
   DELETE CONFIRMATION
   ============================================ */

.delete-confirm {
  background: var(--color-error-light, #fef2f2);
  border: 1px solid var(--color-error);
  border-radius: var(--radius-lg);
  padding: var(--spacing-lg);
  margin-bottom: var(--spacing-md);
}

.delete-confirm__message {
  font-size: 0.9375rem;
  color: var(--color-error-dark, #991b1b);
  margin: 0 0 var(--spacing-md) 0;
  line-height: 1.5;
}

.delete-confirm__actions {
  display: flex;
  gap: var(--spacing-sm);
}

.delete-confirm__actions .btn {
  flex: 1;
}

/* ============================================
   BUTTON ADDITIONS
   ============================================ */

.btn--secondary {
  color: var(--color-text-primary);
  background: var(--color-bg-secondary);
  border: 1px solid var(--color-border);
}

.btn--secondary:hover:not(:disabled) {
  background: var(--color-bg-tertiary);
  border-color: var(--color-text-secondary);
}

.btn--danger-outline {
  color: var(--color-error);
  background: transparent;
  border: 1px solid var(--color-error);
}

.btn--danger-outline:hover:not(:disabled) {
  background: var(--color-error-light, #fef2f2);
}

.btn svg {
  flex-shrink: 0;
}

.btn--full {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-sm);
}

/* ============================================
   CLICKABLE EXPENSE ROWS
   ============================================ */

.expense-row--clickable {
  cursor: pointer;
  transition: background-color 0.15s ease;
}

.expense-row--clickable:hover {
  background: var(--color-bg-secondary);
}

.expense-row--clickable:active {
  background: var(--color-bg-tertiary);
}

/* ============================================
   MODE TOGGLE
   ============================================ */

.bottom-sheet__header-actions {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

.mode-toggle {
  display: flex;
  background: var(--color-bg-secondary);
  border-radius: var(--radius-md);
  padding: 2px;
}

.mode-toggle__btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  padding: 0;
  background: transparent;
  border: none;
  border-radius: var(--radius-sm);
  color: var(--color-text-secondary);
  cursor: pointer;
  transition: all 0.15s ease;
}

.mode-toggle__btn:hover {
  color: var(--color-text-primary);
}

.mode-toggle__btn--active {
  background: var(--color-bg-primary);
  color: var(--color-primary);
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

/* ============================================
   CATEGORY CARD CLICKABLE
   ============================================ */

.category-card--clickable {
  cursor: pointer;
  transition: transform 0.15s ease, box-shadow 0.15s ease;
}

.category-card--clickable:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md, 0 4px 6px -1px rgba(0, 0, 0, 0.1));
}

.category-card--clickable:active {
  transform: translateY(0);
}

/* ============================================
   FILTER BANNER
   ============================================ */

.filter-banner {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--spacing-sm) var(--spacing-md);
  margin-bottom: var(--spacing-md);
  background: var(--color-primary-light, rgba(42, 157, 143, 0.1));
  border: 1px solid var(--color-primary);
  border-radius: var(--radius-md);
}

.filter-banner__text {
  font-size: 0.875rem;
  color: var(--color-text-primary);
}

.filter-banner__clear {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  padding: var(--spacing-xs) var(--spacing-sm);
  font-size: 0.8125rem;
  font-weight: 500;
  color: var(--color-primary);
  background: transparent;
  border: 1px solid var(--color-primary);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.15s ease;
}

.filter-banner__clear:hover {
  background: var(--color-primary);
  color: white;
}

/* ============================================
   CATEGORY LIST CLICKABLE
   ============================================ */

.category-list__item--clickable {
  cursor: pointer;
  transition: background-color 0.15s ease;
  margin: 0 calc(var(--spacing-sm) * -1);
  padding-left: var(--spacing-sm);
  padding-right: var(--spacing-sm);
  border-radius: var(--radius-md);
}

.category-list__item--clickable:hover {
  background: var(--color-bg-secondary);
}

.category-list__item--clickable:active {
  background: var(--color-bg-tertiary);
}

/* ============================================
   DATE RANGE CARD
   ============================================ */

.date-range-card__title {
  font-size: 1rem;
  font-weight: 600;
  color: var(--color-text-primary);
  margin-bottom: var(--spacing-md);
}

.date-range-card__inputs {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--spacing-md);
  margin-bottom: var(--spacing-md);
}

.date-range-card__presets {
  display: flex;
  flex-wrap: wrap;
  gap: var(--spacing-xs);
}

.preset-btn {
  padding: var(--spacing-xs) var(--spacing-sm);
  font-size: 0.8125rem;
  font-weight: 500;
  color: var(--color-text-secondary);
  background: var(--color-bg-secondary);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all 0.15s ease;
}

.preset-btn:hover {
  color: var(--color-primary);
  border-color: var(--color-primary);
  background: var(--color-primary-subtle);
}

/* ============================================
   EXPORT CARD
   ============================================ */

.export-card {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
  margin-bottom: var(--spacing-lg);
}

.export-card__icon {
  font-size: 2rem;
  flex-shrink: 0;
}

.export-card__content {
  flex: 1;
}

.export-card__title {
  font-size: 1rem;
  font-weight: 600;
  color: var(--color-text-primary);
  margin: 0 0 var(--spacing-xs) 0;
}

.export-card__description {
  font-size: 0.875rem;
  color: var(--color-text-secondary);
  margin: 0;
}

/* ============================================
   REPORTS PAGE ADDITIONS
   ============================================ */

.reports-page__section-title {
  font-size: 1.125rem;
  font-weight: 600;
  color: var(--color-text-primary);
  margin-bottom: var(--spacing-md);
}

@media (max-width: 480px) {
  .export-card {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .export-card .btn {
    width: 100%;
  }
}

/* ============================================
   DATE RANGE CARD HEADER
   ============================================ */

.date-range-card__header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: var(--spacing-md);
}

.date-range-card__year-selector {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

.date-range-card__year {
  font-size: 1.125rem;
  font-weight: 600;
  color: var(--color-text-primary);
  min-width: 50px;
  text-align: center;
}

.year-nav-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  padding: 0;
  background: var(--color-bg-secondary);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  color: var(--color-text-secondary);
  cursor: pointer;
  transition: all 0.15s ease;
}

.year-nav-btn:hover:not(:disabled) {
  background: var(--color-bg-tertiary);
  color: var(--color-text-primary);
  border-color: var(--color-text-secondary);
}

.year-nav-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

/* ============================================
   SUMMARY CARD CLICKABLE
   ============================================ */

.summary-card--clickable {
  cursor: pointer;
  transition: transform 0.15s ease, box-shadow 0.15s ease;
}

.summary-card--clickable:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.summary-card--clickable:active {
  transform: translateY(0);
}

/* ============================================
   CARD TITLE CLICKABLE
   ============================================ */

.card__title--clickable {
  cursor: pointer;
  transition: color 0.15s ease;
}

.card__title--clickable:hover {
  color: var(--color-primary);
}

/* ============================================
   MILEAGE PAGE ADDITIONS
   ============================================ */

.mileage-summary {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: var(--spacing-sm);
  margin-bottom: var(--spacing-lg);
}

@media (max-width: 480px) {
  .mileage-summary {
    grid-template-columns: 1fr;
  }
}

.trip-list {
  list-style: none;
  margin: 0;
  padding: 0;
}

.trip-list__item {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
  padding: var(--spacing-sm) 0;
  border-bottom: 1px solid var(--color-border);
}

.trip-list__item:last-child {
  border-bottom: none;
}

.trip-list__icon {
  font-size: 1.25rem;
  line-height: 1;
  flex-shrink: 0;
}

.trip-list__details {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.trip-list__route {
  font-size: 0.9375rem;
  font-weight: 500;
  color: var(--color-text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.trip-list__meta {
  font-size: 0.75rem;
  color: var(--color-text-secondary);
}

.trip-list__miles {
  font-size: 0.9375rem;
  font-weight: 600;
  color: var(--color-text-primary);
  white-space: nowrap;
}

/* Clickable trip list items */
.trip-list__item--clickable {
  cursor: pointer;
  margin: 0 calc(var(--spacing-sm) * -1);
  padding-left: var(--spacing-sm);
  padding-right: var(--spacing-sm);
  border-radius: var(--radius-md);
  transition: background-color 0.15s ease;
}

.trip-list__item--clickable:hover {
  background: var(--color-bg-secondary);
}

.trip-list__item--clickable:active {
  background: var(--color-bg-tertiary);
}

/* Card header with subtitle */
.card__header {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: var(--spacing-sm);
}

.card__subtitle {
  font-size: 0.875rem;
  color: var(--color-text-secondary);
  font-weight: 500;
}

/* ============================================
   ADD MILEAGE SHEET ADDITIONS
   ============================================ */

/* Distance calculating spinner */
.distance-calculating {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  color: var(--color-text-secondary);
  font-size: 0.875rem;
  padding: var(--spacing-sm) 0;
}

.spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid var(--color-border);
  border-top-color: var(--color-primary);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Distance display with edit button */
.distance-display {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-sm) 0;
}

.distance-value {
  font-size: 1.125rem;
  font-weight: 600;
  color: var(--color-text-primary);
}

.distance-round-trip {
  font-size: 0.875rem;
  color: var(--color-text-secondary);
}

.distance-edit-btn {
  margin-left: auto;
  padding: var(--spacing-xs) var(--spacing-sm);
  font-size: 0.75rem;
  color: var(--color-primary);
  background: transparent;
  border: 1px solid var(--color-primary);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.15s ease;
}

.distance-edit-btn:hover {
  background: var(--color-primary);
  color: white;
}

/* Input with suffix (miles) */
.input-with-suffix {
  position: relative;
  display: flex;
  align-items: center;
}

.form-input--with-suffix {
  padding-right: 60px;
}

.input-suffix {
  position: absolute;
  right: var(--spacing-md);
  color: var(--color-text-secondary);
  font-size: 0.875rem;
  pointer-events: none;
}

/* Horizontal form group (for toggle) */
.form-group--horizontal {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.form-group--horizontal .form-label {
  margin-bottom: 0;
}

/* Google Places Autocomplete dropdown styling */
.pac-container {
  background-color: var(--color-bg-primary);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-lg);
  font-family: inherit;
  z-index: 10000;
}

.pac-item {
  padding: var(--spacing-sm) var(--spacing-md);
  color: var(--color-text-primary);
  cursor: pointer;
  border-top: 1px solid var(--color-border);
}

.pac-item:first-child {
  border-top: none;
}

.pac-item:hover,
.pac-item-selected {
  background-color: var(--color-bg-secondary);
}

.pac-item-query {
  font-weight: 500;
  color: var(--color-text-primary);
}

.pac-matched {
  font-weight: 600;
}

/* Dark mode overrides for Google Places */
[data-theme="dark"] .pac-container {
  background-color: var(--color-bg-primary);
  border-color: var(--color-border);
}

[data-theme="dark"] .pac-item {
  color: var(--color-text-primary);
  border-color: var(--color-border);
}

[data-theme="dark"] .pac-item:hover,
[data-theme="dark"] .pac-item-selected {
  background-color: var(--color-bg-secondary);
}

[data-theme="dark"] .pac-item-query {
  color: var(--color-text-primary);
}

/* ============================================
   PAGE TITLES
   ============================================ */
.page__title {
  font-size: 1.75rem;
  font-weight: 600;
  margin: 0 0 1rem 0;
  color: var(--color-text-primary);
}

/* ============================================
   ADD LINK (below search)
   ============================================ */
.add-link {
  background: none;
  border: none;
  color: var(--color-primary);
  font-size: 0.9rem;
  font-weight: 500;
  padding: 0.5rem 0;
  margin-bottom: 1rem;
  cursor: pointer;
  text-align: left;
  display: block;
}

.add-link:hover {
  text-decoration: underline;
}

/* ============================================
   MILEAGE PAGE SUMMARY
   ============================================ */

.mileage-page__summary {
  font-size: 0.875rem;
  color: var(--color-text-secondary);
  margin: 0 0 var(--spacing-lg) 0;
}

/* ============================================
   REPORT CARD - AVAILABLE STATE
   ============================================ */

.report-card--available {
  text-decoration: none;
  opacity: 1;
  cursor: pointer;
}

.report-card--available:hover {
  border-color: var(--color-primary);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.report-card__badge--live {
  color: #fff;
  background: var(--color-primary);
}

/* ============================================
   QUARTERLY REPORT PAGE
   ============================================ */

.quarterly-report-page__nav {
  margin-bottom: var(--spacing-md);
}

.back-link {
  display: inline-flex;
  align-items: center;
  gap: var(--spacing-xs);
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--color-primary);
  text-decoration: none;
  transition: opacity 0.15s ease;
}

.back-link:hover {
  opacity: 0.8;
}

.quarterly-report-page__header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: var(--spacing-sm);
}

.quarterly-report-page__title {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--color-text-primary);
  margin: 0;
}

.quarterly-report-page__year-selector {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

.quarterly-report-page__year {
  font-size: 1.125rem;
  font-weight: 600;
  color: var(--color-text-primary);
  min-width: 3.5rem;
  text-align: center;
}

.quarterly-report-page__description {
  font-size: 0.9375rem;
  color: var(--color-text-secondary);
  margin: 0 0 var(--spacing-lg) 0;
}

.quarterly-table-wrapper {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  background: var(--color-bg-primary);
}

.quarterly-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.875rem;
  min-width: 500px;
}

.quarterly-table thead {
  border-bottom: 2px solid var(--color-border);
}

.quarterly-table th {
  padding: var(--spacing-md);
  font-weight: 600;
  font-size: 0.8125rem;
  text-transform: uppercase;
  letter-spacing: 0.03em;
  color: var(--color-text-secondary);
}

.quarterly-table__category-header {
  text-align: left;
}

.quarterly-table__quarter-header {
  text-align: right;
}

.quarterly-table__total-header {
  text-align: right;
  color: var(--color-text-primary);
}

.quarterly-table__row {
  border-bottom: 1px solid var(--color-border);
  transition: background-color 0.15s ease;
}

.quarterly-table__row:hover {
  background: var(--color-bg-hover, rgba(0, 0, 0, 0.02));
}

.quarterly-table__category-cell {
  padding: var(--spacing-md);
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  white-space: nowrap;
}

.quarterly-table__category-cell--total {
  font-weight: 700;
  color: var(--color-text-primary);
  padding: var(--spacing-md);
}

.quarterly-table__emoji {
  font-size: 1.125rem;
  line-height: 1;
}

.quarterly-table__name {
  font-weight: 500;
  color: var(--color-text-primary);
}

.quarterly-table__amount-cell {
  padding: var(--spacing-md);
  text-align: right;
  font-variant-numeric: tabular-nums;
  color: var(--color-text-primary);
  white-space: nowrap;
}

.quarterly-table__amount-cell--zero {
  color: var(--color-text-tertiary, var(--color-text-secondary));
  opacity: 0.5;
}

.quarterly-table__amount-cell--total {
  font-weight: 700;
  color: var(--color-text-primary);
}

.quarterly-table__amount-cell--grand-total {
  font-weight: 700;
  color: var(--color-primary);
}

.quarterly-table tfoot {
  border-top: 2px solid var(--color-border);
}

.quarterly-table__totals-row {
  background: var(--color-bg-secondary, var(--color-bg-primary));
}

/* ============================================
   STACKED BAR CHART (Quarterly Report)
   ============================================ */

.stacked-chart-card {
  margin-bottom: var(--spacing-lg);
}

.stacked-chart {
  margin-top: var(--spacing-md);
}

.stacked-chart-tooltip {
  background: var(--color-bg-primary);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  padding: var(--spacing-md);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  font-size: 0.8125rem;
  min-width: 180px;
}

.stacked-chart-tooltip__label {
  font-weight: 700;
  color: var(--color-text-primary);
  margin: 0 0 var(--spacing-sm) 0;
  font-size: 0.875rem;
}

.stacked-chart-tooltip__row {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: 2px 0;
}

.stacked-chart-tooltip__color {
  width: 10px;
  height: 10px;
  border-radius: 2px;
  flex-shrink: 0;
}

.stacked-chart-tooltip__name {
  flex: 1;
  color: var(--color-text-secondary);
}

.stacked-chart-tooltip__value {
  font-weight: 600;
  color: var(--color-text-primary);
  font-variant-numeric: tabular-nums;
}

.stacked-chart-tooltip__total {
  display: flex;
  justify-content: space-between;
  margin-top: var(--spacing-sm);
  padding-top: var(--spacing-sm);
  border-top: 1px solid var(--color-border);
  font-weight: 700;
  color: var(--color-text-primary);
  font-variant-numeric: tabular-nums;
}

/* ============================================
   MILEAGE REPORT PAGE
   ============================================ */

.mileage-report-page__nav {
  margin-bottom: var(--spacing-md);
}

.mileage-report-page__header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: var(--spacing-sm);
}

.mileage-report-page__title {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--color-text-primary);
  margin: 0;
}

.mileage-report-page__year-selector {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

.mileage-report-page__year {
  font-size: 1.125rem;
  font-weight: 600;
  color: var(--color-text-primary);
  min-width: 3.5rem;
  text-align: center;
}

.mileage-report-page__description {
  font-size: 0.9375rem;
  color: var(--color-text-secondary);
  margin: 0 0 var(--spacing-lg) 0;
}

/* Summary stat cards */
.mileage-report__summary {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: var(--spacing-md);
  margin-bottom: var(--spacing-lg);
}

.mileage-report__stat-card {
  background: var(--color-bg-primary);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  padding: var(--spacing-lg);
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  gap: var(--spacing-xs);
}

.mileage-report__stat-label {
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--color-text-secondary);
}

.mileage-report__stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--color-text-primary);
  font-variant-numeric: tabular-nums;
}

.mileage-report__stat-value--highlight {
  color: var(--color-primary);
}

.mileage-report__stat-sub {
  font-size: 0.75rem;
  color: var(--color-text-secondary);
}

@media (max-width: 480px) {
  .mileage-report__summary {
    grid-template-columns: 1fr;
  }

  .mileage-report__stat-card {
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-md);
  }

  .mileage-report__stat-value {
    font-size: 1.25rem;
  }
}

/* Monthly breakdown */
.mileage-report__monthly-card {
  margin-bottom: var(--spacing-lg);
}

.mileage-report__monthly-grid {
  display: flex;
  flex-direction: column;
  gap: 0;
}

.mileage-report__monthly-row {
  display: flex;
  align-items: center;
  padding: var(--spacing-sm) 0;
  border-bottom: 1px solid var(--color-border);
  font-size: 0.875rem;
}

.mileage-report__monthly-row:last-child {
  border-bottom: none;
}

.mileage-report__monthly-label {
  flex: 1;
  font-weight: 500;
  color: var(--color-text-primary);
}

.mileage-report__monthly-trips {
  color: var(--color-text-secondary);
  margin-right: var(--spacing-lg);
  min-width: 60px;
  text-align: right;
}

.mileage-report__monthly-miles {
  font-weight: 600;
  color: var(--color-text-primary);
  font-variant-numeric: tabular-nums;
  min-width: 70px;
  text-align: right;
}

/* Trip log table */
.mileage-table-wrapper {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  background: var(--color-bg-primary);
}

.mileage-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.875rem;
  min-width: 500px;
}

.mileage-table thead {
  border-bottom: 2px solid var(--color-border);
}

.mileage-table th {
  padding: var(--spacing-md);
  font-weight: 600;
  font-size: 0.8125rem;
  text-transform: uppercase;
  letter-spacing: 0.03em;
  color: var(--color-text-secondary);
}

.mileage-table__date-header {
  text-align: left;
  white-space: nowrap;
}

.mileage-table__dest-header {
  text-align: left;
}

.mileage-table__purpose-header {
  text-align: left;
}

.mileage-table__miles-header {
  text-align: right;
}

.mileage-table__row {
  border-bottom: 1px solid var(--color-border);
  transition: background-color 0.15s ease;
}

.mileage-table__row:hover {
  background: var(--color-bg-hover, rgba(0, 0, 0, 0.02));
}

.mileage-table__date-cell {
  padding: var(--spacing-md);
  white-space: nowrap;
  color: var(--color-text-primary);
}

.mileage-table__date-short {
  display: none;
}

.mileage-table__dest-cell {
  padding: var(--spacing-md);
  color: var(--color-text-primary);
  line-height: 1.4;
}

.mileage-table__dest-short {
  display: none;
}

.mileage-table__round-trip-badge {
  display: inline-block;
  font-size: 0.6875rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.03em;
  color: var(--color-info, #3b82f6);
  background: rgba(59, 130, 246, 0.1);
  padding: 2px 6px;
  border-radius: var(--radius-sm);
  margin-left: var(--spacing-sm);
  vertical-align: middle;
}

.mileage-table__purpose-cell {
  padding: var(--spacing-md);
  color: var(--color-text-secondary);
  max-width: 200px;
}

.mileage-table__miles-cell {
  padding: var(--spacing-md);
  text-align: right;
  font-weight: 500;
  font-variant-numeric: tabular-nums;
  color: var(--color-text-primary);
  white-space: nowrap;
}

.mileage-table__miles-cell--total {
  font-weight: 700;
  color: var(--color-primary);
}

.mileage-table__totals-row {
  background: var(--color-bg-secondary, var(--color-bg-primary));
}

.mileage-table tfoot {
  border-top: 2px solid var(--color-border);
}

.mileage-table__totals-label {
  padding: var(--spacing-md);
  font-weight: 700;
  color: var(--color-text-primary);
}

/* Responsive: swap full addresses for short on mobile */
@media (max-width: 600px) {
  .mileage-table__date-full {
    display: none;
  }
  .mileage-table__date-short {
    display: inline;
  }
  .mileage-table__dest-full {
    display: none;
  }
  .mileage-table__dest-short {
    display: inline;
  }
}

/* IRS disclaimer */
.mileage-report__disclaimer {
  font-size: 0.8125rem;
  color: var(--color-text-secondary);
  margin-top: var(--spacing-lg);
  padding: var(--spacing-md);
  background: var(--color-bg-secondary);
  border-radius: var(--radius-md);
  line-height: 1.5;
}

/* ============================================
   ANNUAL SUMMARY REPORT PAGE
   ============================================ */

.annual-report-page__nav {
  margin-bottom: var(--spacing-md);
}

.annual-report-page__header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: var(--spacing-sm);
}

.annual-report-page__title {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--color-text-primary);
  margin: 0;
}

.annual-report-page__year-selector {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

.annual-report-page__year {
  font-size: 1.125rem;
  font-weight: 600;
  color: var(--color-text-primary);
  min-width: 3.5rem;
  text-align: center;
}

.annual-report-page__description {
  font-size: 0.9375rem;
  color: var(--color-text-secondary);
  margin: 0 0 var(--spacing-lg) 0;
}

/* Summary stat cards */
.annual-report__summary {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: var(--spacing-md);
  margin-bottom: var(--spacing-lg);
}

.annual-report__stat-card {
  background: var(--color-bg-primary);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  padding: var(--spacing-lg);
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  gap: var(--spacing-xs);
}

.annual-report__stat-card--primary {
  border-color: var(--color-primary);
  border-width: 2px;
}

.annual-report__stat-label {
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--color-text-secondary);
}

.annual-report__stat-value {
  font-size: 1.375rem;
  font-weight: 700;
  color: var(--color-text-primary);
  font-variant-numeric: tabular-nums;
}

.annual-report__stat-card--primary .annual-report__stat-value {
  color: var(--color-primary);
}

.annual-report__stat-sub {
  font-size: 0.75rem;
  color: var(--color-text-secondary);
}

@media (max-width: 540px) {
  .annual-report__summary {
    grid-template-columns: 1fr;
  }

  .annual-report__stat-card {
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-md);
    text-align: left;
  }

  .annual-report__stat-card--primary {
    flex-direction: column;
    text-align: center;
  }

  .annual-report__stat-value {
    font-size: 1.25rem;
  }
}

/* High / Low highlights */
.annual-report__highlights {
  display: flex;
  gap: var(--spacing-md);
  margin-bottom: var(--spacing-lg);
}

.annual-report__highlight {
  flex: 1;
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  background: var(--color-bg-primary);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  padding: var(--spacing-md);
}

.annual-report__highlight-icon {
  font-size: 1.25rem;
  flex-shrink: 0;
}

.annual-report__highlight-label {
  display: block;
  font-size: 0.6875rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--color-text-secondary);
}

.annual-report__highlight-value {
  display: block;
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--color-text-primary);
}

@media (max-width: 480px) {
  .annual-report__highlights {
    flex-direction: column;
  }
}

/* Monthly chart */
.annual-report__chart-card {
  margin-bottom: var(--spacing-lg);
}

.annual-report__chart {
  margin-top: var(--spacing-md);
}

.annual-chart-tooltip {
  background: var(--color-bg-primary);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  padding: var(--spacing-sm) var(--spacing-md);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.annual-chart-tooltip__label {
  font-size: 0.8125rem;
  font-weight: 600;
  color: var(--color-text-secondary);
  margin: 0;
}

.annual-chart-tooltip__value {
  font-size: 1rem;
  font-weight: 700;
  color: var(--color-text-primary);
  margin: 2px 0 0 0;
  font-variant-numeric: tabular-nums;
}

/* Category breakdown */
.annual-report__category-card {
  margin-bottom: var(--spacing-lg);
}

.annual-report__category-list {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-sm);
}

.annual-report__category-row {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  padding: var(--spacing-sm) 0;
  border-bottom: 1px solid var(--color-border);
  gap: var(--spacing-sm);
}

.annual-report__category-row:last-child {
  border-bottom: none;
}

.annual-report__category-info {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  min-width: 140px;
  flex: 1;
}

.annual-report__category-emoji {
  font-size: 1.125rem;
  flex-shrink: 0;
}

.annual-report__category-name {
  font-weight: 500;
  color: var(--color-text-primary);
  font-size: 0.875rem;
}

.annual-report__category-stats {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
  margin-left: auto;
}

.annual-report__category-count {
  font-size: 0.75rem;
  color: var(--color-text-secondary);
  min-width: 50px;
  text-align: right;
}

.annual-report__category-pct {
  font-size: 0.8125rem;
  font-weight: 600;
  color: var(--color-text-secondary);
  min-width: 40px;
  text-align: right;
  font-variant-numeric: tabular-nums;
}

.annual-report__category-amount {
  font-size: 0.875rem;
  font-weight: 700;
  color: var(--color-text-primary);
  min-width: 90px;
  text-align: right;
  font-variant-numeric: tabular-nums;
}

/* Percentage bar */
.annual-report__category-bar-track {
  width: 100%;
  height: 4px;
  background: var(--color-border);
  border-radius: 2px;
  overflow: hidden;
}

.annual-report__category-bar-fill {
  height: 100%;
  background: var(--color-primary);
  border-radius: 2px;
  transition: width 0.3s ease;
  min-width: 2px;
}

@media (max-width: 480px) {
  .annual-report__category-stats {
    width: 100%;
    justify-content: flex-end;
    padding-left: calc(1.125rem + var(--spacing-sm));
  }
}

/* ============================================
   TAX SUMMARY REPORT PAGE
   ============================================ */

.tax-summary-page__nav {
  margin-bottom: var(--spacing-md);
}

.tax-summary-page__header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: var(--spacing-sm);
}

.tax-summary-page__title {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--color-text-primary);
  margin: 0;
}

.tax-summary-page__year-selector {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

.tax-summary-page__year {
  font-size: 1.125rem;
  font-weight: 600;
  color: var(--color-text-primary);
  min-width: 3.5rem;
  text-align: center;
}

.tax-summary-page__description {
  font-size: 0.9375rem;
  color: var(--color-text-secondary);
  margin: 0 0 var(--spacing-lg) 0;
}

.expense-row__home-icon {
  margin-left: 6px;
  font-size: 0.85em;
}

/* Grand total */
.tax-summary__grand-total {
  background: var(--color-bg-primary);
  border: 2px solid var(--color-primary);
  border-radius: var(--radius-lg);
  padding: var(--spacing-xl);
  text-align: center;
  margin-bottom: var(--spacing-lg);
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
}

.tax-summary__grand-total-label {
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--color-text-secondary);
}

/* Grand total deductible line */
.tax-summary__grand-total-deductible {
  display: block;
  font-size: 0.85rem;
  color: var(--color-success, #16a34a);
  font-weight: 500;
  margin-top: var(--spacing-xs);
}

/* Section header deductible sub-line */
.tax-summary__section-deductible {
  display: block;
  font-size: 0.75rem;
  color: var(--color-success, #16a34a);
  font-weight: 500;
  line-height: 1.3;
}

.tax-summary__grand-total-value {
  font-size: 2rem;
  font-weight: 800;
  color: var(--color-primary);
  font-variant-numeric: tabular-nums;
}

.tax-summary__grand-total-sub {
  font-size: 0.8125rem;
  color: var(--color-text-secondary);
}

/* Composition bar */
.tax-summary__composition-bar {
  display: flex;
  height: 12px;
  border-radius: 6px;
  overflow: hidden;
  margin-bottom: var(--spacing-sm);
  gap: 2px;
}

.tax-summary__composition-segment {
  min-width: 4px;
  transition: width 0.3s ease;
}

/* Composition legend */
.tax-summary__composition-legend {
  display: flex;
  flex-wrap: wrap;
  gap: var(--spacing-md);
  margin-bottom: var(--spacing-xl);
}

.tax-summary__legend-item {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  font-size: 0.8125rem;
}

.tax-summary__legend-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
}

.tax-summary__legend-label {
  color: var(--color-text-secondary);
}

.tax-summary__legend-pct {
  font-weight: 600;
  color: var(--color-text-primary);
  font-variant-numeric: tabular-nums;
}

/* Type sections */
.tax-summary__sections {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-md);
  margin-bottom: var(--spacing-lg);
}

.tax-summary__section {
  background: var(--color-bg-primary);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  overflow: hidden;
}

.tax-summary__section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--spacing-lg);
  width: 100%;
  background: none;
  border: none;
  cursor: pointer;
  text-align: left;
  color: inherit;
  font-family: inherit;
  gap: var(--spacing-md);
  transition: background-color 0.15s ease;
}

.tax-summary__section-header:hover {
  background: var(--color-bg-hover, rgba(0, 0, 0, 0.02));
}

.tax-summary__section-left {
  display: flex;
  align-items: flex-start;
  gap: var(--spacing-md);
  flex: 1;
  min-width: 0;
}

.tax-summary__section-indicator {
  width: 4px;
  height: 36px;
  border-radius: 2px;
  flex-shrink: 0;
  margin-top: 2px;
}

.tax-summary__section-title {
  display: block;
  font-weight: 600;
  font-size: 0.9375rem;
  color: var(--color-text-primary);
}

.tax-summary__section-desc {
  display: block;
  font-size: 0.8125rem;
  color: var(--color-text-secondary);
  margin-top: 2px;
}

.tax-summary__section-right {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  flex-shrink: 0;
}

.tax-summary__section-stats {
  text-align: right;
}

.tax-summary__section-amount {
  display: block;
  font-weight: 700;
  font-size: 1rem;
  color: var(--color-text-primary);
  font-variant-numeric: tabular-nums;
}

.tax-summary__section-meta {
  display: block;
  font-size: 0.75rem;
  color: var(--color-text-secondary);
}

.tax-summary__section-chevron {
  color: var(--color-text-secondary);
  transition: transform 0.2s ease;
  flex-shrink: 0;
}

.tax-summary__section-chevron--open {
  transform: rotate(180deg);
}

/* Section details (expanded) */
.tax-summary__section-details {
  border-top: 1px solid var(--color-border);
  padding: var(--spacing-md) var(--spacing-lg);
}

.tax-summary__cat-row {
  display: flex;
  align-items: center;
  padding: var(--spacing-sm) 0;
  border-bottom: 1px solid var(--color-border);
  font-size: 0.875rem;
  gap: var(--spacing-sm);
}

.tax-summary__cat-row:last-child {
  border-bottom: none;
}

.tax-summary__cat-emoji {
  font-size: 1rem;
  flex-shrink: 0;
}

.tax-summary__cat-info {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.tax-summary__cat-name {
  font-weight: 500;
  color: var(--color-text-primary);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.tax-summary__cat-deductible {
  font-size: 0.7rem;
  color: var(--color-success, #16a34a);
  font-weight: 500;
}

.tax-summary__cat-count {
  font-size: 0.75rem;
  color: var(--color-text-secondary);
  min-width: 24px;
  text-align: right;
}

.tax-summary__cat-amount {
  font-weight: 600;
  color: var(--color-text-primary);
  font-variant-numeric: tabular-nums;
  min-width: 80px;
  text-align: right;
}

.tax-summary__section-empty {
  font-size: 0.875rem;
  color: var(--color-text-secondary);
  text-align: center;
  padding: var(--spacing-md) 0;
  margin: 0;
}

/* Responsive */
@media (max-width: 480px) {
  .tax-summary__grand-total-value {
    font-size: 1.5rem;
  }

  .tax-summary__section-header {
    flex-wrap: wrap;
    padding: var(--spacing-md);
  }

  .tax-summary__section-desc {
    display: none;
  }

  .tax-summary__section-right {
    width: 100%;
    justify-content: flex-end;
    margin-top: var(--spacing-xs);
  }
}

/* Disclaimer */
.tax-summary__disclaimer {
  font-size: 0.8125rem;
  color: var(--color-text-secondary);
  margin-top: var(--spacing-lg);
  padding: var(--spacing-md);
  background: var(--color-bg-secondary);
  border-radius: var(--radius-md);
  line-height: 1.5;
}

/* ============================================
   CATEGORIES PAGE — MANAGEMENT HEADER
   ============================================ */

.categories-page__header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: var(--spacing-sm);
}

.categories-page__header .page__title {
  margin-bottom: 0;
}

.btn--sm {
  padding: var(--spacing-xs) var(--spacing-md);
  font-size: 0.8125rem;
}

/* ============================================
   CATEGORY CARD — ACTION BUTTONS
   ============================================ */

.category-card__header {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  margin-bottom: var(--spacing-md);
}

.category-card__name {
  flex: 1;
  font-size: 1rem;
  font-weight: 600;
  color: var(--color-text-primary);
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
}

.category-card__badge {
  font-size: 0.75rem;
  line-height: 1;
}

.category-card__badge--system {
  font-size: 0.625rem;
  opacity: 0.6;
}

.category-card__actions {
  display: flex;
  gap: 2px;
  margin-left: auto;
  opacity: 0;
  transition: opacity 0.15s ease;
}

.category-card:hover .category-card__actions,
.category-card:focus-within .category-card__actions {
  opacity: 1;
}

/* Always show on mobile (no hover) */
@media (hover: none) {
  .category-card__actions {
    opacity: 1;
  }
}

.category-card__action-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  padding: 0;
  background: transparent;
  border: none;
  border-radius: var(--radius-sm);
  color: var(--color-text-secondary);
  cursor: pointer;
  transition: background-color 0.15s ease, color 0.15s ease;
}

.category-card__action-btn:hover {
  background: var(--color-bg-tertiary);
  color: var(--color-text-primary);
}

.category-card__action-btn--danger:hover {
  background: var(--color-error-light, #fef2f2);
  color: var(--color-error);
}

/* Type badge for zero-expense categories */
.category-card__type-badge {
  display: inline-block;
  margin-top: var(--spacing-sm);
  padding: 2px var(--spacing-sm);
  font-size: 0.6875rem;
  font-weight: 500;
  color: var(--color-text-secondary);
  background: var(--color-bg-secondary);
  border-radius: var(--radius-sm);
}

/* ============================================
   CATEGORY FORM — EMOJI + NAME
   ============================================ */

.category-form__name-row {
  display: flex;
  gap: var(--spacing-sm);
  align-items: stretch;
}

.category-form__emoji-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 48px;
  min-width: 48px;
  font-size: 1.5rem;
  background: var(--color-bg-secondary);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: border-color 0.15s ease, box-shadow 0.15s ease;
}

.category-form__emoji-btn:hover {
  border-color: var(--color-primary);
}

.category-form__emoji-btn:focus {
  outline: none;
  border-color: var(--color-primary);
  box-shadow: 0 0 0 3px var(--color-primary-light, rgba(42, 157, 143, 0.15));
}

/* ============================================
   EMOJI PICKER GRID
   ============================================ */

.category-form__emoji-picker {
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  gap: 4px;
  padding: var(--spacing-sm);
  background: var(--color-bg-secondary);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  max-height: 200px;
  overflow-y: auto;
}

.category-form__emoji-option {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  aspect-ratio: 1;
  font-size: 1.25rem;
  background: transparent;
  border: 2px solid transparent;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: background-color 0.1s ease, border-color 0.1s ease, transform 0.1s ease;
}

.category-form__emoji-option:hover {
  background: var(--color-bg-tertiary);
  transform: scale(1.15);
}

.category-form__emoji-option--selected {
  border-color: var(--color-primary);
  background: var(--color-primary-light, rgba(42, 157, 143, 0.1));
}

/* Smaller grid on very small screens */
@media (max-width: 360px) {
  .category-form__emoji-picker {
    grid-template-columns: repeat(6, 1fr);
  }
}

/* ============================================
   FORM HINT TEXT
   ============================================ */

.form-hint {
  display: block;
  font-size: 0.75rem;
  color: var(--color-text-secondary);
  margin-top: 2px;
}

/* ============================================
   DELETE CONFIRMATION MODAL
   ============================================ */

.delete-modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 500;
  width: calc(100% - var(--spacing-lg) * 2);
  max-width: 400px;
  background: var(--color-bg-primary);
  border-radius: var(--radius-lg);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  padding: var(--spacing-lg);
}

.delete-modal__title {
  font-size: 1.125rem;
  font-weight: 600;
  color: var(--color-text-primary);
  margin: 0 0 var(--spacing-md) 0;
}

.delete-modal__body {
  margin-bottom: var(--spacing-lg);
  color: var(--color-text-primary);
  font-size: 0.9375rem;
  line-height: 1.5;
}

.delete-modal__body p {
  margin: 0 0 var(--spacing-sm) 0;
}

.delete-modal__warning {
  padding: var(--spacing-sm) var(--spacing-md);
  background: var(--color-error-light, #fef2f2);
  border-radius: var(--radius-md);
  color: var(--color-error-dark, #991b1b);
  font-size: 0.875rem;
}

.delete-modal__body .form-select {
  margin-top: var(--spacing-sm);
}

.delete-modal__actions {
  display: flex;
  gap: var(--spacing-sm);
  justify-content: flex-end;
}

.btn--danger {
  color: white;
  background: var(--color-error);
  border: none;
}

.btn--danger:hover:not(:disabled) {
  background: var(--color-error-dark, #991b1b);
}

.btn--danger:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

/* ============================================
   CATEGORIES PAGE — DIVIDER
   ============================================ */

.categories-page__divider {
  height: 1px;
  background: var(--color-border);
  margin: var(--spacing-xl) 0;
}

/* ============================================
   HOME OFFICE CONFIG SECTION
   ============================================ */

.home-office-config {
  background: var(--color-bg-primary);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  padding: var(--spacing-lg);
}

.home-office-config__header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: var(--spacing-md);
  margin-bottom: var(--spacing-md);
}

.home-office-config__title {
  font-size: 1.125rem;
  font-weight: 600;
  color: var(--color-text-primary);
  margin: 0;
}

.home-office-config__desc {
  font-size: 0.8125rem;
  color: var(--color-text-secondary);
  margin: var(--spacing-xs) 0 0 0;
  line-height: 1.4;
}

/* Ignore checkbox */
.home-office-config__ignore-label {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  font-size: 0.875rem;
  color: var(--color-text-secondary);
  cursor: pointer;
  margin-bottom: var(--spacing-md);
}

.home-office-config__ignore-label input[type="checkbox"] {
  width: 18px;
  height: 18px;
  accent-color: var(--color-primary);
  cursor: pointer;
}

/* Edit form */
.home-office-config__form {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-md);
}

.home-office-config__inputs {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--spacing-md);
}

.home-office-config__preview {
  font-size: 0.9375rem;
  color: #fff;
  padding: var(--spacing-sm) var(--spacing-md);
  background: var(--color-primary);
  border-radius: var(--radius-md);
}

.home-office-config__preview strong {
  color: #fff;
  font-size: 1.125rem;
}

.home-office-config__actions {
  display: flex;
  gap: var(--spacing-sm);
  justify-content: flex-end;
}

/* Display mode (saved values) */
.home-office-config__display {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: var(--spacing-md);
}

.home-office-config__stat {
  text-align: center;
  padding: var(--spacing-md);
  background: var(--color-bg-secondary);
  border-radius: var(--radius-md);
}

.home-office-config__stat--highlight {
  background: var(--color-bg-secondary);
  border: 2px solid var(--color-primary);
}

.home-office-config__stat-label {
  display: block;
  font-size: 0.75rem;
  font-weight: 500;
  color: var(--color-text-secondary);
  margin-bottom: var(--spacing-xs);
  text-transform: uppercase;
  letter-spacing: 0.03em;
}

.home-office-config__stat-value {
  display: block;
  font-size: 1.125rem;
  font-weight: 700;
  color: var(--color-text-primary);
}

.home-office-config__stat--highlight .home-office-config__stat-value {
  color: var(--color-primary);
}

/* Empty state */
.home-office-config__empty {
  font-size: 0.875rem;
  color: var(--color-text-secondary);
  padding: var(--spacing-md);
  background: var(--color-bg-secondary);
  border-radius: var(--radius-md);
  text-align: center;
}

/* Eligible categories list */
.home-office-config__eligible {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: var(--spacing-xs);
  margin-top: var(--spacing-md);
  padding-top: var(--spacing-md);
  border-top: 1px solid var(--color-border);
}

.home-office-config__eligible-label {
  font-size: 0.8125rem;
  color: var(--color-text-secondary);
  margin-right: var(--spacing-xs);
}

.home-office-config__eligible-tag {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px var(--spacing-sm);
  font-size: 0.8125rem;
  color: var(--color-text-primary);
  background: var(--color-bg-secondary);
  border-radius: var(--radius-sm);
}

/* Responsive: stack stats on mobile */
@media (max-width: 480px) {
  .home-office-config__display {
    grid-template-columns: 1fr;
  }

  .home-office-config__inputs {
    grid-template-columns: 1fr;
  }
}

/* Home Office Warnings */
.home-office-config__warnings {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-sm);
  margin-top: var(--spacing-md);
}

.home-office-config__warning {
  display: flex;
  align-items: flex-start;
  gap: var(--spacing-sm);
  padding: var(--spacing-sm) var(--spacing-md);
  font-size: 0.8125rem;
  line-height: 1.5;
  color: var(--color-text-secondary);
  background: var(--color-bg-secondary);
  border-left: 3px solid var(--color-primary);
  border-radius: var(--radius-sm);
}

.home-office-config__warning--caution {
  border-left-color: var(--color-warning, #e9c46a);
}

.home-office-config__warning-icon {
  flex-shrink: 0;
  font-size: 1rem;
  line-height: 1.5;
}

/* ============================================
   HOME OFFICE CHECKBOX (AddExpense / EditExpense)
   ============================================ */

.home-office-checkbox {
  display: flex;
  flex-wrap: wrap;
  align-items: flex-start;
  gap: var(--spacing-xs);
  cursor: pointer;
  padding: var(--spacing-sm) var(--spacing-md);
  background: var(--color-primary-light, rgba(42, 157, 143, 0.1));
  border: 1px solid var(--color-primary);
  border-radius: var(--radius-md);
}

.home-office-checkbox input[type="checkbox"] {
  margin-top: 2px;
  accent-color: var(--color-primary);
}

.home-office-checkbox__label {
  font-size: 0.9375rem;
  font-weight: 600;
  color: var(--color-text-primary);
}

.home-office-checkbox__hint {
  width: 100%;
  font-size: 0.75rem;
  color: var(--color-text-secondary);
  padding-left: 20px;
}

/* ============================================
   HOME OFFICE DEDUCTION CALLOUT (ExpenseDetail)
   ============================================ */

.home-office-deduction-callout {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-sm) var(--spacing-md);
  background: var(--color-bg-secondary);
  border: 1px solid var(--color-primary);
  border-radius: var(--radius-md);
  margin-bottom: var(--spacing-md);
}

.home-office-deduction-callout__icon {
  font-size: 1.25rem;
  flex-shrink: 0;
}

.home-office-deduction-callout__details {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.home-office-deduction-callout__amount {
  font-size: 0.9375rem;
  font-weight: 700;
  color: var(--color-primary);
}

.home-office-deduction-callout__rate {
  font-size: 0.75rem;
  color: var(--color-text-secondary);
}

/* ============================================
   ADMIN PAGE
   ============================================ */

.admin-forbidden {
  text-align: center;
  padding: var(--spacing-2xl) var(--spacing-md);
}

.admin-forbidden h1 {
  font-size: 1.5rem;
  margin-bottom: var(--spacing-sm);
}

.admin-forbidden p {
  color: var(--color-text-secondary);
  margin-bottom: var(--spacing-lg);
}

.admin-section {
  margin-bottom: var(--spacing-xl);
}

.admin-section__title {
  font-size: 1.125rem;
  font-weight: 600;
  margin-bottom: var(--spacing-md);
}

.admin-section__loading,
.admin-section__empty {
  color: var(--color-text-secondary);
  font-size: 0.875rem;
}

.admin-alert {
  padding: var(--spacing-sm) var(--spacing-md);
  border-radius: var(--radius-md);
  margin-bottom: var(--spacing-md);
  font-size: 0.875rem;
}

.admin-alert--error {
  background: #fef2f2;
  color: #991b1b;
  border: 1px solid #fecaca;
}

.admin-alert--success {
  background: #f0fdf4;
  color: #166534;
  border: 1px solid #bbf7d0;
}

/* Admin Form */

.admin-form {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-md);
}

.admin-form__row {
  display: flex;
  gap: var(--spacing-md);
}

.admin-form__row > .admin-form__field {
  flex: 1;
}

.admin-form__field {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
}

.admin-form__label {
  font-size: 0.8125rem;
  font-weight: 600;
  color: var(--color-text-secondary);
}

.admin-form__input {
  padding: var(--spacing-sm) var(--spacing-md);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  font-size: 0.9375rem;
  background: var(--color-bg-primary);
  color: var(--color-text-primary);
}

.admin-form__input:focus {
  outline: none;
  border-color: var(--color-primary);
}

.admin-form__subdomain-wrapper {
  display: flex;
  align-items: center;
  gap: 0;
}

.admin-form__input--subdomain {
  border-radius: var(--radius-md) 0 0 var(--radius-md);
  border-right: none;
  flex: 1;
}

.admin-form__subdomain-suffix {
  padding: var(--spacing-sm) var(--spacing-md);
  background: var(--color-bg-secondary);
  border: 1px solid var(--color-border);
  border-radius: 0 var(--radius-md) var(--radius-md) 0;
  font-size: 0.8125rem;
  color: var(--color-text-secondary);
  white-space: nowrap;
}

/* Admin Invite Cards */

.admin-invite-list {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-md);
}

.admin-invite-card {
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  padding: var(--spacing-md);
  background: var(--color-bg-primary);
}

.admin-invite-card__header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--spacing-sm);
}

.admin-invite-card__business {
  font-weight: 600;
  font-size: 1rem;
}

.admin-invite-card__badge {
  font-size: 0.75rem;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 999px;
  text-transform: capitalize;
}

.admin-invite-card__badge--pending {
  background: #fef3c7;
  color: #92400e;
}

.admin-invite-card__badge--accepted {
  background: #d1fae5;
  color: #065f46;
}

.admin-invite-card__badge--expired {
  background: #fee2e2;
  color: #991b1b;
}

.admin-invite-card__details {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
  margin-bottom: var(--spacing-sm);
}

.admin-invite-card__row {
  display: flex;
  justify-content: space-between;
  font-size: 0.8125rem;
}

.admin-invite-card__label {
  color: var(--color-text-secondary);
}

.admin-invite-card__value {
  color: var(--color-text-primary);
  text-align: right;
}

.admin-invite-card__resend {
  margin-top: var(--spacing-xs);
}

/* ============================================
   INVITE LANDING PAGE
   ============================================ */

.invite-page {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: var(--spacing-lg);
  background: var(--color-bg-secondary);
}

.invite-page__card {
  background: var(--color-bg-primary);
  border-radius: var(--radius-lg);
  padding: var(--spacing-2xl) var(--spacing-xl);
  max-width: 420px;
  width: 100%;
  text-align: center;
  box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
}

.invite-page__title {
  color: var(--color-primary);
  font-size: 1.5rem;
  margin-bottom: var(--spacing-lg);
}

.invite-page__loading {
  color: var(--color-text-secondary);
}

.invite-page__welcome {
  font-size: 1rem;
  color: var(--color-text-secondary);
  margin-bottom: var(--spacing-xs);
}

.invite-page__business {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--color-text-primary);
  margin-bottom: var(--spacing-xl);
}

.invite-page__google-btn {
  display: inline-flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-sm) var(--spacing-xl);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  background: var(--color-bg-primary);
  font-size: 1rem;
  font-weight: 500;
  color: var(--color-text-primary);
  cursor: pointer;
  transition: background 0.15s;
}

.invite-page__google-btn:hover {
  background: var(--color-bg-secondary);
}

.invite-page__note {
  font-size: 0.8125rem;
  color: var(--color-text-secondary);
  margin-top: var(--spacing-md);
}

.invite-page__error {
  color: #991b1b;
  font-weight: 500;
  margin-bottom: var(--spacing-sm);
}

.invite-page__detail {
  font-size: 0.875rem;
  color: var(--color-text-secondary);
  margin-bottom: var(--spacing-sm);
}

.invite-page__link {
  color: var(--color-primary);
  text-decoration: underline;
}

/* ============================================
   DARK MODE — ADMIN & INVITE
   ============================================ */

@media (prefers-color-scheme: dark) {
  .admin-alert--error {
    background: rgba(153, 27, 27, 0.15);
    border-color: rgba(153, 27, 27, 0.3);
  }

  .admin-alert--success {
    background: rgba(22, 101, 52, 0.15);
    border-color: rgba(22, 101, 52, 0.3);
  }

  .invite-page__error {
    color: #fca5a5;
  }
}

[data-theme="dark"] .admin-alert--error {
  background: rgba(153, 27, 27, 0.15);
  border-color: rgba(153, 27, 27, 0.3);
}

[data-theme="dark"] .admin-alert--success {
  background: rgba(22, 101, 52, 0.15);
  border-color: rgba(22, 101, 52, 0.3);
}

[data-theme="dark"] .invite-page__error {
  color: #fca5a5;
}

/* ============================================
   ATTACHMENTS
   ============================================ */

.attachments-section {
  margin-top: var(--spacing-lg);
  padding-top: var(--spacing-lg);
  border-top: 1px solid var(--color-border);
}

.attachments-section__header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--spacing-sm);
}

.attachments-upload-btn {
  cursor: pointer;
  font-size: 0.85rem;
  padding: var(--spacing-xs) var(--spacing-sm);
}

.attachments-loading,
.attachments-empty {
  color: var(--color-text-secondary);
  font-size: 0.85rem;
  padding: var(--spacing-sm) 0;
}

.attachments-list {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-sm);
}

.attachment-item {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-sm);
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md, 8px);
}

.attachment-item__thumbnail {
  width: 48px;
  height: 48px;
  object-fit: cover;
  border-radius: var(--radius-sm, 4px);
  cursor: pointer;
  flex-shrink: 0;
}

.attachment-item__thumbnail--pdf {
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--color-primary);
  color: white;
  font-size: 0.75rem;
  font-weight: 700;
}

.attachment-item__info {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.attachment-item__name {
  font-size: 0.85rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.attachment-item__size {
  font-size: 0.75rem;
  color: var(--color-text-secondary);
}

.attachment-item__delete {
  background: none;
  border: none;
  color: var(--color-text-secondary);
  cursor: pointer;
  padding: var(--spacing-xs);
  flex-shrink: 0;
}

.attachment-item__delete:hover {
  color: var(--color-danger, #e74c3c);
}

/* ============================================
   LIGHTBOX
   ============================================ */

.lightbox-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.9);
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

.lightbox-close {
  position: absolute;
  top: var(--spacing-md);
  right: var(--spacing-md);
  background: none;
  border: none;
  color: white;
  cursor: pointer;
  z-index: 10001;
}

.lightbox-image {
  max-width: 90vw;
  max-height: 90vh;
  object-fit: contain;
  cursor: default;
  border-radius: var(--radius-sm, 4px);
}

/* ============================================
   ATTACHMENT INDICATOR (for expense list rows)
   ============================================ */

.attachment-indicator {
  font-size: 0.8rem;
  margin-left: var(--spacing-xs);
  opacity: 0.7;
}

/* ============================================
   DARK MODE — Attachments
   ============================================ */

[data-theme="dark"] .attachment-item {
  background: var(--color-surface);
  border-color: var(--color-border);
}

[data-theme="dark"] .lightbox-close {
  color: #ccc;
}

[data-theme="dark"] .attachment-item__delete:hover {
  color: #ff6b6b;
}

/* ============================================
   FORM HINT
   ============================================ */

.form-hint {
  font-size: 0.8rem;
  color: var(--color-text-secondary);
  text-align: center;
  padding: var(--spacing-sm) 0;
}

/* ============================================
   ATTACHMENT UPLOAD STATUS
   ============================================ */

.attachments-status {
  font-size: 0.8rem;
  color: var(--color-primary);
  padding: var(--spacing-xs) 0;
  font-style: italic;
}

/* ============================================
   ADD EXPENSE — ATTACHMENT PICKER
   ============================================ */

.add-expense-attachments {
  margin-top: var(--spacing-md);
  padding-top: var(--spacing-md);
  border-top: 1px solid var(--color-border);
}

.add-expense-attachments__header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--spacing-sm);
}

.add-expense-attachments__limit {
  font-size: 0.75rem;
  color: var(--color-text-muted);
}

.add-expense-attachments__picker {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: var(--spacing-sm) var(--spacing-md);
  border: 1.5px dashed var(--color-border);
  border-radius: var(--radius-md);
  color: var(--color-text-secondary);
  font-size: 0.875rem;
  cursor: pointer;
  min-height: 44px;
  transition: border-color var(--transition-fast), color var(--transition-fast);
}

.add-expense-attachments__picker:active {
  border-color: var(--color-primary);
  color: var(--color-primary);
}

.add-expense-attachments__picker--disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.add-expense-attachments__preview {
  display: flex;
  gap: var(--spacing-sm);
  margin-bottom: var(--spacing-sm);
}

.add-expense-attachments__thumb-wrapper {
  position: relative;
  flex-shrink: 0;
}

.add-expense-attachments__thumb {
  width: 72px;
  height: 72px;
  object-fit: cover;
  border-radius: var(--radius-md);
  border: 1px solid var(--color-border);
}

.add-expense-attachments__thumb--pdf {
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--color-primary);
  color: white;
  font-size: 0.75rem;
  font-weight: 700;
}

.add-expense-attachments__remove {
  position: absolute;
  top: -6px;
  right: -6px;
  width: 24px;
  height: 24px;
  border-radius: var(--radius-full);
  background: var(--color-bg-primary);
  border: 1px solid var(--color-border);
  color: var(--color-text-secondary);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  padding: 0;
  /* Expand touch target to 44px without changing visual size */
}

.add-expense-attachments__remove::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 44px;
  height: 44px;
  transform: translate(-50%, -50%);
}

.add-expense-attachments__file-size {
  display: block;
  text-align: center;
  font-size: 0.65rem;
  color: var(--color-text-muted);
  margin-top: 2px;
}

/* ============================================
   DARK MODE — Add Expense Attachments
   ============================================ */

[data-theme="dark"] .add-expense-attachments {
  border-top-color: var(--color-border);
}

[data-theme="dark"] .add-expense-attachments__picker {
  border-color: var(--color-border);
  color: var(--color-text-secondary);
}

[data-theme="dark"] .add-expense-attachments__picker:active {
  border-color: var(--color-primary);
  color: var(--color-primary);
}

[data-theme="dark"] .add-expense-attachments__thumb {
  border-color: var(--color-border);
}

[data-theme="dark"] .add-expense-attachments__remove {
  background: var(--color-bg-primary);
  border-color: var(--color-border);
  color: var(--color-text-secondary);
}

/* ============================================
   RECEIPT SCAN UI
   ============================================ */

/* Scan button — overlayed on attachment thumbnails */
.scan-button {
  position: absolute;
  bottom: 4px;
  left: 4px;
  width: 28px;
  height: 28px;
  border-radius: var(--radius-full);
  background: var(--color-bg-primary);
  border: 1px solid var(--color-border);
  font-size: 0.8rem;
  line-height: 1;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  box-shadow: var(--shadow-sm);
  transition: background-color 0.15s ease, transform 0.1s ease;
}

.scan-button:active {
  transform: scale(0.9);
}

.scan-button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.scan-button--scanning {
  animation: scan-pulse 1.2s ease-in-out infinite;
}

@keyframes scan-pulse {
  0%, 100% { opacity: 0.6; }
  50% { opacity: 1; }
}

/* Confidence dot — inline next to form labels */
.scan-confidence {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: var(--radius-full);
  margin-left: 4px;
  vertical-align: middle;
}

.scan-confidence--high {
  background-color: var(--color-success, #22c55e);
}

.scan-confidence--medium {
  background-color: var(--color-warning, #f59e0b);
}

.scan-confidence--low {
  background-color: var(--color-danger, #ef4444);
}

/* Scan suggestion button — below fields when scanned value differs */
.scan-suggestion {
  display: inline-block;
  margin-top: 4px;
  padding: 2px 8px;
  font-size: 0.75rem;
  line-height: 1.4;
  color: var(--color-primary);
  background: transparent;
  border: 1px solid var(--color-primary);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: background-color 0.15s ease;
}

.scan-suggestion:active {
  background: var(--color-primary);
  color: #fff;
}

/* Scan error message */
.scan-error {
  font-size: 0.8rem;
  color: var(--color-danger, #ef4444);
  padding: var(--spacing-xs) 0;
}

/* Wrapper for thumbnail + scan button positioning */
.attachment-item__thumb-wrapper {
  position: relative;
  flex-shrink: 0;
}

/* ============================================
   DARK MODE — Receipt Scan UI
   ============================================ */

[data-theme="dark"] .scan-button {
  background: var(--color-bg-secondary);
  border-color: var(--color-border);
}

[data-theme="dark"] .scan-suggestion {
  color: var(--color-primary-light, var(--color-primary));
  border-color: var(--color-primary-light, var(--color-primary));
}

[data-theme="dark"] .scan-suggestion:active {
  background: var(--color-primary);
  color: #fff;
}



--- FILE: ./src/App.tsx ---

import { Route, Switch } from 'wouter'
import { useTenant } from './hooks/useTenant'
import { useAuth } from './hooks/useAuth'
import { LoginPage } from './pages/LoginPage'
import { Layout } from './components/Layout'
import DashboardPage from './pages/DashboardPage'
import ExpensesPage from './pages/ExpensesPage'
import MileagePage from './pages/MileagePage'
import CategoriesPage from './pages/CategoriesPage'
import ReportsPage from './pages/ReportsPage'
import QuarterlyReportPage from './pages/QuarterlyReportPage'
import MileageReportPage from './pages/MileageReportPage'
import AnnualSummaryPage from './pages/AnnualSummaryPage'
import TaxSummaryPage from './pages/TaxSummaryPage'
import SettingsPage from './pages/SettingsPage'
import AdminPage from './pages/AdminPage'
import InvitePage from './pages/InvitePage'

function App() {
  const { isLoading: tenantLoading } = useTenant()
  const { isLoading: authLoading, isAuthenticated } = useAuth()

  // Simple routing based on path - login and invite don't need Layout
  const path = window.location.pathname
  if (path === '/login') {
    return <LoginPage />
  }
  if (path === '/invite') {
    return <InvitePage />
  }

  const isLoading = tenantLoading || authLoading

  // Show loading state
  if (isLoading) {
    return (
      <div className="container">
        <div className="card" style={{ marginTop: 'var(--spacing-2xl)', textAlign: 'center' }}>
          <p style={{ color: 'var(--color-text-secondary)' }}>Loading...</p>
        </div>
      </div>
    )
  }

  // If not authenticated, redirect to login
  if (!isAuthenticated) {
    window.location.href = '/login'
    return null
  }

  // Main app (authenticated) with routing
  return (
    <Layout>
      <Switch>
        <Route path="/" component={DashboardPage} />
        <Route path="/expenses" component={ExpensesPage} />
        <Route path="/mileage" component={MileagePage} />
        <Route path="/categories" component={CategoriesPage} />
        <Route path="/reports/tax" component={TaxSummaryPage} />
        <Route path="/reports/annual" component={AnnualSummaryPage} />
        <Route path="/reports/mileage" component={MileageReportPage} />
        <Route path="/reports/quarterly" component={QuarterlyReportPage} />
        <Route path="/reports" component={ReportsPage} />
        <Route path="/admin" component={AdminPage} />
        <Route path="/settings" component={SettingsPage} />
        <Route>
          <div className="page">
            <h1>404</h1>
            <p>Page not found</p>
          </div>
        </Route>
      </Switch>
    </Layout>
  )
}

export default App

--- FILE: ./src/main.tsx ---

import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import './styles/theme.css'
import './styles/layout.css'
import { TenantProvider } from './hooks/useTenant.tsx'
import { AuthProvider } from './hooks/useAuth.tsx'
import { YearProvider } from './hooks/useYear.tsx'
import { RefreshProvider } from './hooks/useRefresh.tsx'
import { SettingsProvider } from './hooks/useSettings.tsx'
import App from './App.tsx'

createRoot(document.getElementById('root')!).render(
  <StrictMode>
    <SettingsProvider>
      <AuthProvider>
        <TenantProvider>
          <YearProvider>
            <RefreshProvider>
              <App />
            </RefreshProvider>
          </YearProvider>
        </TenantProvider>
      </AuthProvider>
    </SettingsProvider>
  </StrictMode>,
)

--- FILE: ./src/hooks/useRefresh.tsx ---

import { createContext, useContext, useState, useCallback, type ReactNode } from 'react'

interface RefreshContextType {
  /** Increments every time expenses refresh is triggered */
  expenseKey: number
  /** Increments every time mileage refresh is triggered */
  mileageKey: number
  /** Call this to trigger expense refresh across all subscribed components */
  refreshExpenses: () => void
  /** Call this to trigger mileage refresh across all subscribed components */
  refreshMileage: () => void
  /** Call this to trigger all refreshes */
  refreshAll: () => void
}

const RefreshContext = createContext<RefreshContextType>({
  expenseKey: 0,
  mileageKey: 0,
  refreshExpenses: () => {},
  refreshMileage: () => {},
  refreshAll: () => {},
})

export function useRefresh() {
  return useContext(RefreshContext)
}

interface RefreshProviderProps {
  children: ReactNode
}

export function RefreshProvider({ children }: RefreshProviderProps) {
  const [expenseKey, setExpenseKey] = useState(0)
  const [mileageKey, setMileageKey] = useState(0)

  const refreshExpenses = useCallback(() => {
    setExpenseKey(prev => prev + 1)
  }, [])

  const refreshMileage = useCallback(() => {
    setMileageKey(prev => prev + 1)
  }, [])

  const refreshAll = useCallback(() => {
    setExpenseKey(prev => prev + 1)
    setMileageKey(prev => prev + 1)
  }, [])

  return (
    <RefreshContext.Provider value={{ 
      expenseKey, 
      mileageKey, 
      refreshExpenses, 
      refreshMileage, 
      refreshAll 
    }}>
      {children}
    </RefreshContext.Provider>
  )
}


--- FILE: ./src/hooks/useScanReceipt.ts ---

import { useState } from 'react'

export interface ScanField {
  value: string | number | null
  confidence: number
}

export interface ScanResult {
  vendor: ScanField
  date: ScanField
  total: ScanField
  subtotal: ScanField
  tax: ScanField
  paymentMethod: ScanField
  lineItems: Array<{ description: string; amount: number; quantity: number }>
  rawText: string
}

export interface UseScanReceiptReturn {
  scanResult: ScanResult | null
  isScanning: boolean
  scanError: string | null
  scanReceipt: (blobUrl: string, tenantSubdomain: string) => Promise<ScanResult | null>
  clearScan: () => void
}

export function useScanReceipt(): UseScanReceiptReturn {
  const [scanResult, setScanResult] = useState<ScanResult | null>(null)
  const [isScanning, setIsScanning] = useState(false)
  const [scanError, setScanError] = useState<string | null>(null)

  const scanReceipt = async (blobUrl: string, tenantSubdomain: string): Promise<ScanResult | null> => {
    setIsScanning(true)
    setScanError(null)

    try {
      const response = await fetch(`/api/receipts/scan?tenant=${tenantSubdomain}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ blobUrl }),
      })

      if (response.status === 429) {
        const data = await response.json()
        const minutes = Math.ceil((data.retryAfterSeconds || 60) / 60)
        setScanError(`Scanning limit reached. Try again in ${minutes} minute${minutes > 1 ? 's' : ''}.`)
        return null
      }

      if (!response.ok) {
        const data = await response.json()
        setScanError(data.error || 'Failed to scan receipt')
        return null
      }

      const data = await response.json()
      if (data.success && data.data) {
        setScanResult(data.data)
        return data.data
      } else {
        setScanError('Unexpected response from scanner')
        return null
      }
    } catch {
      setScanError('Network error — please try again')
      return null
    } finally {
      setIsScanning(false)
    }
  }

  const clearScan = () => {
    setScanResult(null)
    setScanError(null)
  }

  return { scanResult, isScanning, scanError, scanReceipt, clearScan }
}


--- FILE: ./src/hooks/useSettings.tsx ---

import { createContext, useContext, useState, useEffect, type ReactNode } from 'react'

interface SettingsContextType {
  darkMode: boolean
  setDarkMode: (value: boolean) => void
  showFab: boolean
  setShowFab: (value: boolean) => void
}

const SettingsContext = createContext<SettingsContextType>({
  darkMode: false,
  setDarkMode: () => {},
  showFab: true,
  setShowFab: () => {},
})

export function useSettings() {
  return useContext(SettingsContext)
}

interface SettingsProviderProps {
  children: ReactNode
}

export function SettingsProvider({ children }: SettingsProviderProps) {
  // Initialize from localStorage (with defaults)
  const [darkMode, setDarkModeState] = useState(() => {
    const saved = localStorage.getItem('settings:darkMode')
    if (saved !== null) return saved === 'true'
    return window.matchMedia('(prefers-color-scheme: dark)').matches
  })

  const [showFab, setShowFabState] = useState(() => {
    const saved = localStorage.getItem('settings:showFab')
    return saved !== 'false' // Default to true
  })

  // Apply dark mode to document
  useEffect(() => {
    document.documentElement.setAttribute('data-theme', darkMode ? 'dark' : 'light')
  }, [darkMode])

  // Persist dark mode
  const setDarkMode = (value: boolean) => {
    setDarkModeState(value)
    localStorage.setItem('settings:darkMode', String(value))
  }

  // Persist show FAB
  const setShowFab = (value: boolean) => {
    setShowFabState(value)
    localStorage.setItem('settings:showFab', String(value))
  }

  return (
    <SettingsContext.Provider value={{ darkMode, setDarkMode, showFab, setShowFab }}>
      {children}
    </SettingsContext.Provider>
  )
}

--- FILE: ./src/hooks/useYear.tsx ---

import { createContext, useContext, useState, type ReactNode } from 'react'

interface YearContextType {
  year: number
  setYear: (year: number) => void
  nextYear: () => void
  prevYear: () => void
}

const YearContext = createContext<YearContextType>({
  year: new Date().getFullYear(),
  setYear: () => {},
  nextYear: () => {},
  prevYear: () => {},
})

export function useYear() {
  return useContext(YearContext)
}

interface YearProviderProps {
  children: ReactNode
}

export function YearProvider({ children }: YearProviderProps) {
  const currentYear = new Date().getFullYear()
  const [year, setYear] = useState(currentYear)

  const nextYear = () => {
    // Don't go beyond current year
    if (year < currentYear) {
      setYear(year + 1)
    }
  }

  const prevYear = () => {
    // Don't go before 2020 (reasonable limit)
    if (year > 2020) {
      setYear(year - 1)
    }
  }

  return (
    <YearContext.Provider value={{ year, setYear, nextYear, prevYear }}>
      {children}
    </YearContext.Provider>
  )
}

--- FILE: ./src/hooks/useAuth.tsx ---

import { createContext, useContext, useState, useEffect, useCallback } from 'react';
import type { ReactNode } from 'react';

// Types
interface Tenant {
  id: string;
  name: string;
  subdomain: string;
  logoUrl: string | null;
  primaryColor?: string | null;
  secondaryColor?: string | null;
  appName?: string | null;
}

interface TenantAccess {
  tenantId: string;
  role: string;
  canEdit: boolean;
  tenant: Tenant;
}

interface User {
  id: string;
  email: string;
  name: string | null;
  tenantId: string | null;
  role: string;
  isSuperAdmin: boolean;
  isAccountant: boolean;
  theme: string | null;
  primaryTenant: Tenant | null;
  tenantAccess: TenantAccess[];
}

interface AuthContextType {
  user: User | null;
  isLoading: boolean;
  isAuthenticated: boolean;
  isSuperAdmin: boolean;
  isAccountant: boolean;
  error: string | null;
  login: (redirect?: string) => void;
  logout: () => Promise<void>;
  refreshAuth: () => Promise<void>;
}

// Context
const AuthContext = createContext<AuthContextType | null>(null);

// Provider component
interface AuthProviderProps {
  children: ReactNode;
}

export function AuthProvider({ children }: AuthProviderProps) {
  const [user, setUser] = useState<User | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // Check auth status
  const refreshAuth = useCallback(async () => {
    try {
      setError(null);
      const response = await fetch('/api/auth/me', {
        credentials: 'include', // Important: sends cookies
      });

      if (response.ok) {
        const data = await response.json();
        setUser(data.user);
      } else {
        setUser(null);
        if (response.status !== 401) {
          // Only set error for unexpected failures
          const data = await response.json().catch(() => ({}));
          setError(data.error || 'Authentication check failed');
        }
      }
    } catch (err) {
      console.error('Auth check failed:', err);
      setUser(null);
      setError('Network error');
    } finally {
      setIsLoading(false);
    }
  }, []);

  // Check auth on mount
  useEffect(() => {
    refreshAuth();
  }, [refreshAuth]);

  // Login - redirect to Google OAuth
  const login = useCallback((redirect?: string) => {
    const params = redirect ? `?redirect=${encodeURIComponent(redirect)}` : '';
    window.location.href = `/api/auth/google${params}`;
  }, []);

  // Logout
  const logout = useCallback(async () => {
    try {
      await fetch('/api/auth/logout', {
        method: 'POST',
        credentials: 'include',
      });
    } catch (err) {
      console.error('Logout error:', err);
    } finally {
      setUser(null);
      window.location.href = '/login';
    }
  }, []);

  const value: AuthContextType = {
    user,
    isLoading,
    isAuthenticated: !!user,
    isSuperAdmin: user?.isSuperAdmin ?? false,
    isAccountant: user?.isAccountant ?? false,
    error,
    login,
    logout,
    refreshAuth,
  };

  return (
    <AuthContext.Provider value={value}>
      {children}
    </AuthContext.Provider>
  );
}

// Hook
export function useAuth(): AuthContextType {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
}

// Convenience component for protected routes
interface RequireAuthProps {
  children: ReactNode;
  fallback?: ReactNode;
  requiredRole?: 'superAdmin' | 'accountant';
}

export function RequireAuth({ children, fallback, requiredRole }: RequireAuthProps) {
  const { isAuthenticated, isLoading, isSuperAdmin, isAccountant, login } = useAuth();

  if (isLoading) {
    return fallback || <div>Loading...</div>;
  }

  if (!isAuthenticated) {
    // Redirect to login
    login(window.location.pathname);
    return fallback || <div>Redirecting to login...</div>;
  }

  // Check role requirements
  if (requiredRole === 'superAdmin' && !isSuperAdmin) {
    return <div>Access denied. Super admin privileges required.</div>;
  }

  if (requiredRole === 'accountant' && !isAccountant && !isSuperAdmin) {
    return <div>Access denied. Accountant privileges required.</div>;
  }

  return <>{children}</>;
}

--- FILE: ./src/hooks/useTenant.tsx ---

import { createContext, useContext, useEffect, useState, type ReactNode } from 'react';
import { useAuth } from './useAuth';

interface Tenant {
  id: string;
  name: string;
  subdomain: string;
  logoUrl: string | null;
  primaryColor: string | null;
  appName: string | null;
  isActive: boolean;
}

interface TenantContextType {
  tenant: Tenant | null;
  isLoading: boolean;
  error: string | null;
  subdomain: string | null;
}

const TenantContext = createContext<TenantContextType>({
  tenant: null,
  isLoading: true,
  error: null,
  subdomain: null,
});

export function useTenant() {
  return useContext(TenantContext);
}

function getSubdomainFromHost(hostname: string): string | null {
  // Handle localhost development (e.g., localhost:5173?tenant=izrgrooming)
  if (hostname === 'localhost' || hostname === '127.0.0.1') {
    const params = new URLSearchParams(window.location.search);
    return params.get('tenant');
  }

  // Handle Vercel preview URLs (e.g., wayve-expense-tracker.vercel.app)
  if (hostname.endsWith('.vercel.app')) {
    const params = new URLSearchParams(window.location.search);
    return params.get('tenant');
  }

  // Handle production subdomains (e.g., izrgrooming.wayveexpenses.app)
  const parts = hostname.split('.');
  
  // Expected format: subdomain.wayveexpenses.app (3 parts)
  // or subdomain.domain.com (3 parts)
  if (parts.length >= 3) {
    const subdomain = parts[0];
    // Ignore 'www' as a subdomain
    if (subdomain === 'www') {
      // Check query param as fallback
      const params = new URLSearchParams(window.location.search);
      return params.get('tenant');
    }
    return subdomain;
  }

  // Fallback: check query param for root domain (e.g., wayveexpenses.app?tenant=sandbox)
  const params = new URLSearchParams(window.location.search);
  return params.get('tenant');
}

interface TenantProviderProps {
  children: ReactNode;
}

export function TenantProvider({ children }: TenantProviderProps) {
  const { user, isLoading: authLoading } = useAuth();
  const [tenant, setTenant] = useState<Tenant | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [subdomain, setSubdomain] = useState<string | null>(null);

  useEffect(() => {
    // Wait for auth to finish loading first
    if (authLoading) {
      return;
    }

    let detectedSubdomain = getSubdomainFromHost(window.location.hostname);
    
    // If no subdomain in URL, try to get it from user's tenant access
    if (!detectedSubdomain && user?.tenantAccess?.length === 1) {
      // User has access to exactly one tenant — use that
      detectedSubdomain = user.tenantAccess[0].tenant.subdomain;
    }
    
    setSubdomain(detectedSubdomain);

    if (!detectedSubdomain) {
      // No subdomain = root domain (marketing site or login redirect)
      // Or user has access to multiple tenants (need a picker - TODO)
      setIsLoading(false);
      return;
    }

    // Fetch tenant info
    async function fetchTenant() {
      try {
        const response = await fetch(`/api/tenant?subdomain=${detectedSubdomain}`);
        
        if (response.status === 404) {
          setError('Business not found. Please check the URL.');
          setIsLoading(false);
          return;
        }

        if (response.status === 403) {
          setError('This account is no longer active.');
          setIsLoading(false);
          return;
        }

        if (!response.ok) {
          throw new Error('Failed to load business information');
        }

        const data = await response.json();
        setTenant(data);
        
        // Apply tenant branding to CSS variables
        if (data.primaryColor) {
          document.documentElement.style.setProperty('--color-primary', data.primaryColor);
        }
        
      } catch (err) {
        console.error('Tenant fetch error:', err);
        setError('Unable to load business information. Please try again.');
      } finally {
        setIsLoading(false);
      }
    }

    fetchTenant();
  }, [authLoading, user]);

  return (
    <TenantContext.Provider value={{ tenant, isLoading, error, subdomain }}>
      {children}
    </TenantContext.Provider>
  );
}


--- FILE: ./tsconfig.json ---

{
  "files": [],
  "references": [
    { "path": "./tsconfig.app.json" },
    { "path": "./tsconfig.node.json" }
  ]
}


--- FILE: ./drizzle.config.ts ---

import { defineConfig } from 'drizzle-kit';
import 'dotenv/config';

if (!process.env.DATABASE_URL) {
  throw new Error('DATABASE_URL environment variable is not set');
}

export default defineConfig({
  schema: './src/db/schema.ts',
  out: './drizzle',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.DATABASE_URL,
  },
});

--- FILE: ./drizzle/meta/0003_snapshot.json ---

{
  "id": "bbf800cc-7178-4db1-9f76-8cdeddda7834",
  "prevId": "f61454a2-0778-4368-bca1-06af41476a2d",
  "version": "7",
  "dialect": "postgresql",
  "tables": {
    "public.accountant_invites": {
      "name": "accountant_invites",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "email": {
          "name": "email",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": true
        },
        "invite_token": {
          "name": "invite_token",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": true
        },
        "status": {
          "name": "status",
          "type": "varchar(20)",
          "primaryKey": false,
          "notNull": true,
          "default": "'pending'"
        },
        "expires_at": {
          "name": "expires_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true
        },
        "accepted_by_user_id": {
          "name": "accepted_by_user_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "accepted_at": {
          "name": "accepted_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": false
        },
        "invited_by": {
          "name": "invited_by",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "accountant_invites_tenant_id_tenants_id_fk": {
          "name": "accountant_invites_tenant_id_tenants_id_fk",
          "tableFrom": "accountant_invites",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "accountant_invites_accepted_by_user_id_users_id_fk": {
          "name": "accountant_invites_accepted_by_user_id_users_id_fk",
          "tableFrom": "accountant_invites",
          "tableTo": "users",
          "columnsFrom": [
            "accepted_by_user_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "accountant_invites_invited_by_users_id_fk": {
          "name": "accountant_invites_invited_by_users_id_fk",
          "tableFrom": "accountant_invites",
          "tableTo": "users",
          "columnsFrom": [
            "invited_by"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {
        "accountant_invites_invite_token_unique": {
          "name": "accountant_invites_invite_token_unique",
          "nullsNotDistinct": false,
          "columns": [
            "invite_token"
          ]
        }
      },
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.categories": {
      "name": "categories",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "name": {
          "name": "name",
          "type": "varchar(100)",
          "primaryKey": false,
          "notNull": true
        },
        "emoji": {
          "name": "emoji",
          "type": "varchar(10)",
          "primaryKey": false,
          "notNull": false,
          "default": "'📁'"
        },
        "expense_type": {
          "name": "expense_type",
          "type": "varchar(50)",
          "primaryKey": false,
          "notNull": true,
          "default": "'operating'"
        },
        "home_office_eligible": {
          "name": "home_office_eligible",
          "type": "boolean",
          "primaryKey": false,
          "notNull": true,
          "default": false
        },
        "is_system": {
          "name": "is_system",
          "type": "boolean",
          "primaryKey": false,
          "notNull": true,
          "default": false
        },
        "sort_order": {
          "name": "sort_order",
          "type": "integer",
          "primaryKey": false,
          "notNull": false,
          "default": 0
        },
        "is_active": {
          "name": "is_active",
          "type": "boolean",
          "primaryKey": false,
          "notNull": true,
          "default": true
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "categories_tenant_id_tenants_id_fk": {
          "name": "categories_tenant_id_tenants_id_fk",
          "tableFrom": "categories",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.expense_attachments": {
      "name": "expense_attachments",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "expense_id": {
          "name": "expense_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "blob_url": {
          "name": "blob_url",
          "type": "text",
          "primaryKey": false,
          "notNull": true
        },
        "file_name": {
          "name": "file_name",
          "type": "varchar(500)",
          "primaryKey": false,
          "notNull": true
        },
        "file_size": {
          "name": "file_size",
          "type": "integer",
          "primaryKey": false,
          "notNull": true
        },
        "mime_type": {
          "name": "mime_type",
          "type": "varchar(100)",
          "primaryKey": false,
          "notNull": true
        },
        "sort_order": {
          "name": "sort_order",
          "type": "integer",
          "primaryKey": false,
          "notNull": true,
          "default": 0
        },
        "uploaded_by": {
          "name": "uploaded_by",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "expense_attachments_tenant_id_tenants_id_fk": {
          "name": "expense_attachments_tenant_id_tenants_id_fk",
          "tableFrom": "expense_attachments",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "expense_attachments_expense_id_expenses_id_fk": {
          "name": "expense_attachments_expense_id_expenses_id_fk",
          "tableFrom": "expense_attachments",
          "tableTo": "expenses",
          "columnsFrom": [
            "expense_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "cascade",
          "onUpdate": "no action"
        },
        "expense_attachments_uploaded_by_users_id_fk": {
          "name": "expense_attachments_uploaded_by_users_id_fk",
          "tableFrom": "expense_attachments",
          "tableTo": "users",
          "columnsFrom": [
            "uploaded_by"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.expense_history": {
      "name": "expense_history",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "expense_id": {
          "name": "expense_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "action": {
          "name": "action",
          "type": "varchar(20)",
          "primaryKey": false,
          "notNull": true
        },
        "previous_values": {
          "name": "previous_values",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "new_values": {
          "name": "new_values",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "changed_by": {
          "name": "changed_by",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "changed_at": {
          "name": "changed_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "expense_history_expense_id_expenses_id_fk": {
          "name": "expense_history_expense_id_expenses_id_fk",
          "tableFrom": "expense_history",
          "tableTo": "expenses",
          "columnsFrom": [
            "expense_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "expense_history_tenant_id_tenants_id_fk": {
          "name": "expense_history_tenant_id_tenants_id_fk",
          "tableFrom": "expense_history",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "expense_history_changed_by_users_id_fk": {
          "name": "expense_history_changed_by_users_id_fk",
          "tableFrom": "expense_history",
          "tableTo": "users",
          "columnsFrom": [
            "changed_by"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.expense_policies": {
      "name": "expense_policies",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "user_id": {
          "name": "user_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "max_expense_amount": {
          "name": "max_expense_amount",
          "type": "integer",
          "primaryKey": false,
          "notNull": false
        },
        "require_notes_above": {
          "name": "require_notes_above",
          "type": "integer",
          "primaryKey": false,
          "notNull": false
        },
        "allowed_categories": {
          "name": "allowed_categories",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "created_by": {
          "name": "created_by",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "expense_policies_tenant_id_tenants_id_fk": {
          "name": "expense_policies_tenant_id_tenants_id_fk",
          "tableFrom": "expense_policies",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "expense_policies_user_id_users_id_fk": {
          "name": "expense_policies_user_id_users_id_fk",
          "tableFrom": "expense_policies",
          "tableTo": "users",
          "columnsFrom": [
            "user_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "expense_policies_created_by_users_id_fk": {
          "name": "expense_policies_created_by_users_id_fk",
          "tableFrom": "expense_policies",
          "tableTo": "users",
          "columnsFrom": [
            "created_by"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.expenses": {
      "name": "expenses",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "amount": {
          "name": "amount",
          "type": "integer",
          "primaryKey": false,
          "notNull": true
        },
        "vendor": {
          "name": "vendor",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": false
        },
        "description": {
          "name": "description",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "date": {
          "name": "date",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true
        },
        "category_id": {
          "name": "category_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "expense_type": {
          "name": "expense_type",
          "type": "varchar(50)",
          "primaryKey": false,
          "notNull": true,
          "default": "'operating'"
        },
        "is_home_office": {
          "name": "is_home_office",
          "type": "boolean",
          "primaryKey": false,
          "notNull": true,
          "default": false
        },
        "home_office_percent": {
          "name": "home_office_percent",
          "type": "integer",
          "primaryKey": false,
          "notNull": false
        },
        "receipt_url": {
          "name": "receipt_url",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "extracted_text": {
          "name": "extracted_text",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "recurring_expense_id": {
          "name": "recurring_expense_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "created_by": {
          "name": "created_by",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_by": {
          "name": "updated_by",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "expenses_tenant_id_tenants_id_fk": {
          "name": "expenses_tenant_id_tenants_id_fk",
          "tableFrom": "expenses",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "expenses_category_id_categories_id_fk": {
          "name": "expenses_category_id_categories_id_fk",
          "tableFrom": "expenses",
          "tableTo": "categories",
          "columnsFrom": [
            "category_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "expenses_created_by_users_id_fk": {
          "name": "expenses_created_by_users_id_fk",
          "tableFrom": "expenses",
          "tableTo": "users",
          "columnsFrom": [
            "created_by"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "expenses_updated_by_users_id_fk": {
          "name": "expenses_updated_by_users_id_fk",
          "tableFrom": "expenses",
          "tableTo": "users",
          "columnsFrom": [
            "updated_by"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.invites": {
      "name": "invites",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "email": {
          "name": "email",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": true
        },
        "first_name": {
          "name": "first_name",
          "type": "varchar(100)",
          "primaryKey": false,
          "notNull": false
        },
        "last_name": {
          "name": "last_name",
          "type": "varchar(100)",
          "primaryKey": false,
          "notNull": false
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "role": {
          "name": "role",
          "type": "varchar(50)",
          "primaryKey": false,
          "notNull": true,
          "default": "'owner'"
        },
        "invited_by": {
          "name": "invited_by",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "token": {
          "name": "token",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": true
        },
        "status": {
          "name": "status",
          "type": "varchar(20)",
          "primaryKey": false,
          "notNull": true,
          "default": "'pending'"
        },
        "expires_at": {
          "name": "expires_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true
        },
        "accepted_at": {
          "name": "accepted_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": false
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "invites_tenant_id_tenants_id_fk": {
          "name": "invites_tenant_id_tenants_id_fk",
          "tableFrom": "invites",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "invites_invited_by_users_id_fk": {
          "name": "invites_invited_by_users_id_fk",
          "tableFrom": "invites",
          "tableTo": "users",
          "columnsFrom": [
            "invited_by"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {
        "invites_token_unique": {
          "name": "invites_token_unique",
          "nullsNotDistinct": false,
          "columns": [
            "token"
          ]
        }
      },
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.mileage_trips": {
      "name": "mileage_trips",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "date": {
          "name": "date",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true
        },
        "description": {
          "name": "description",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": false
        },
        "start_location": {
          "name": "start_location",
          "type": "varchar(500)",
          "primaryKey": false,
          "notNull": true
        },
        "end_location": {
          "name": "end_location",
          "type": "varchar(500)",
          "primaryKey": false,
          "notNull": true
        },
        "distance_miles": {
          "name": "distance_miles",
          "type": "integer",
          "primaryKey": false,
          "notNull": true
        },
        "is_round_trip": {
          "name": "is_round_trip",
          "type": "boolean",
          "primaryKey": false,
          "notNull": true,
          "default": false
        },
        "created_by": {
          "name": "created_by",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_by": {
          "name": "updated_by",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "mileage_trips_tenant_id_tenants_id_fk": {
          "name": "mileage_trips_tenant_id_tenants_id_fk",
          "tableFrom": "mileage_trips",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "mileage_trips_created_by_users_id_fk": {
          "name": "mileage_trips_created_by_users_id_fk",
          "tableFrom": "mileage_trips",
          "tableTo": "users",
          "columnsFrom": [
            "created_by"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "mileage_trips_updated_by_users_id_fk": {
          "name": "mileage_trips_updated_by_users_id_fk",
          "tableFrom": "mileage_trips",
          "tableTo": "users",
          "columnsFrom": [
            "updated_by"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.rate_limit_usage": {
      "name": "rate_limit_usage",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "action_type": {
          "name": "action_type",
          "type": "varchar(50)",
          "primaryKey": false,
          "notNull": true
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {
        "rate_limit_tenant_action_time_idx": {
          "name": "rate_limit_tenant_action_time_idx",
          "columns": [
            {
              "expression": "tenant_id",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            },
            {
              "expression": "action_type",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            },
            {
              "expression": "created_at",
              "isExpression": false,
              "asc": true,
              "nulls": "last"
            }
          ],
          "isUnique": false,
          "concurrently": false,
          "method": "btree",
          "with": {}
        }
      },
      "foreignKeys": {
        "rate_limit_usage_tenant_id_tenants_id_fk": {
          "name": "rate_limit_usage_tenant_id_tenants_id_fk",
          "tableFrom": "rate_limit_usage",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.recurring_expenses": {
      "name": "recurring_expenses",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "amount": {
          "name": "amount",
          "type": "integer",
          "primaryKey": false,
          "notNull": true
        },
        "vendor": {
          "name": "vendor",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": false
        },
        "description": {
          "name": "description",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "category_id": {
          "name": "category_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "expense_type": {
          "name": "expense_type",
          "type": "varchar(50)",
          "primaryKey": false,
          "notNull": true,
          "default": "'operating'"
        },
        "frequency": {
          "name": "frequency",
          "type": "varchar(20)",
          "primaryKey": false,
          "notNull": true,
          "default": "'monthly'"
        },
        "day_of_month": {
          "name": "day_of_month",
          "type": "integer",
          "primaryKey": false,
          "notNull": false,
          "default": 1
        },
        "last_generated_at": {
          "name": "last_generated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": false
        },
        "next_generation_at": {
          "name": "next_generation_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": false
        },
        "is_active": {
          "name": "is_active",
          "type": "boolean",
          "primaryKey": false,
          "notNull": true,
          "default": true
        },
        "created_by": {
          "name": "created_by",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "recurring_expenses_tenant_id_tenants_id_fk": {
          "name": "recurring_expenses_tenant_id_tenants_id_fk",
          "tableFrom": "recurring_expenses",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "recurring_expenses_category_id_categories_id_fk": {
          "name": "recurring_expenses_category_id_categories_id_fk",
          "tableFrom": "recurring_expenses",
          "tableTo": "categories",
          "columnsFrom": [
            "category_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "recurring_expenses_created_by_users_id_fk": {
          "name": "recurring_expenses_created_by_users_id_fk",
          "tableFrom": "recurring_expenses",
          "tableTo": "users",
          "columnsFrom": [
            "created_by"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.saved_locations": {
      "name": "saved_locations",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "name": {
          "name": "name",
          "type": "varchar(100)",
          "primaryKey": false,
          "notNull": true
        },
        "address": {
          "name": "address",
          "type": "varchar(500)",
          "primaryKey": false,
          "notNull": true
        },
        "sort_order": {
          "name": "sort_order",
          "type": "integer",
          "primaryKey": false,
          "notNull": false,
          "default": 0
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "saved_locations_tenant_id_tenants_id_fk": {
          "name": "saved_locations_tenant_id_tenants_id_fk",
          "tableFrom": "saved_locations",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.sessions": {
      "name": "sessions",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "user_id": {
          "name": "user_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "token": {
          "name": "token",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": true
        },
        "expires_at": {
          "name": "expires_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true
        },
        "user_agent": {
          "name": "user_agent",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "ip_address": {
          "name": "ip_address",
          "type": "varchar(45)",
          "primaryKey": false,
          "notNull": false
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "sessions_user_id_users_id_fk": {
          "name": "sessions_user_id_users_id_fk",
          "tableFrom": "sessions",
          "tableTo": "users",
          "columnsFrom": [
            "user_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "sessions_tenant_id_tenants_id_fk": {
          "name": "sessions_tenant_id_tenants_id_fk",
          "tableFrom": "sessions",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {
        "sessions_token_unique": {
          "name": "sessions_token_unique",
          "nullsNotDistinct": false,
          "columns": [
            "token"
          ]
        }
      },
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.tenants": {
      "name": "tenants",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "name": {
          "name": "name",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": true
        },
        "subdomain": {
          "name": "subdomain",
          "type": "varchar(63)",
          "primaryKey": false,
          "notNull": true
        },
        "logo_url": {
          "name": "logo_url",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "primary_color": {
          "name": "primary_color",
          "type": "varchar(7)",
          "primaryKey": false,
          "notNull": false,
          "default": "'#2A9D8F'"
        },
        "app_name": {
          "name": "app_name",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": false
        },
        "custom_domain": {
          "name": "custom_domain",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": false
        },
        "home_total_sqft": {
          "name": "home_total_sqft",
          "type": "integer",
          "primaryKey": false,
          "notNull": false
        },
        "home_office_sqft": {
          "name": "home_office_sqft",
          "type": "integer",
          "primaryKey": false,
          "notNull": false
        },
        "is_active": {
          "name": "is_active",
          "type": "boolean",
          "primaryKey": false,
          "notNull": true,
          "default": true
        },
        "created_by": {
          "name": "created_by",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {},
      "compositePrimaryKeys": {},
      "uniqueConstraints": {
        "tenants_subdomain_unique": {
          "name": "tenants_subdomain_unique",
          "nullsNotDistinct": false,
          "columns": [
            "subdomain"
          ]
        }
      },
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.user_tenant_access": {
      "name": "user_tenant_access",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "user_id": {
          "name": "user_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "role": {
          "name": "role",
          "type": "varchar(50)",
          "primaryKey": false,
          "notNull": true
        },
        "can_edit": {
          "name": "can_edit",
          "type": "boolean",
          "primaryKey": false,
          "notNull": true,
          "default": false
        },
        "invited_by": {
          "name": "invited_by",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "user_tenant_access_user_id_users_id_fk": {
          "name": "user_tenant_access_user_id_users_id_fk",
          "tableFrom": "user_tenant_access",
          "tableTo": "users",
          "columnsFrom": [
            "user_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "cascade",
          "onUpdate": "no action"
        },
        "user_tenant_access_tenant_id_tenants_id_fk": {
          "name": "user_tenant_access_tenant_id_tenants_id_fk",
          "tableFrom": "user_tenant_access",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "cascade",
          "onUpdate": "no action"
        },
        "user_tenant_access_invited_by_users_id_fk": {
          "name": "user_tenant_access_invited_by_users_id_fk",
          "tableFrom": "user_tenant_access",
          "tableTo": "users",
          "columnsFrom": [
            "invited_by"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {
        "user_tenant_unique": {
          "name": "user_tenant_unique",
          "nullsNotDistinct": false,
          "columns": [
            "user_id",
            "tenant_id"
          ]
        }
      },
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.users": {
      "name": "users",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "email": {
          "name": "email",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": true
        },
        "password_hash": {
          "name": "password_hash",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": false
        },
        "email_verified": {
          "name": "email_verified",
          "type": "boolean",
          "primaryKey": false,
          "notNull": true,
          "default": false
        },
        "google_id": {
          "name": "google_id",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": false
        },
        "apple_id": {
          "name": "apple_id",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": false
        },
        "first_name": {
          "name": "first_name",
          "type": "varchar(100)",
          "primaryKey": false,
          "notNull": false
        },
        "last_name": {
          "name": "last_name",
          "type": "varchar(100)",
          "primaryKey": false,
          "notNull": false
        },
        "role": {
          "name": "role",
          "type": "varchar(50)",
          "primaryKey": false,
          "notNull": true,
          "default": "'viewer'"
        },
        "is_super_admin": {
          "name": "is_super_admin",
          "type": "boolean",
          "primaryKey": false,
          "notNull": true,
          "default": false
        },
        "is_accountant": {
          "name": "is_accountant",
          "type": "boolean",
          "primaryKey": false,
          "notNull": true,
          "default": false
        },
        "theme": {
          "name": "theme",
          "type": "varchar(50)",
          "primaryKey": false,
          "notNull": false,
          "default": "'teal-tide'"
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "last_login_at": {
          "name": "last_login_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": false
        }
      },
      "indexes": {},
      "foreignKeys": {
        "users_tenant_id_tenants_id_fk": {
          "name": "users_tenant_id_tenants_id_fk",
          "tableFrom": "users",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.vendor_category_mappings": {
      "name": "vendor_category_mappings",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "vendor_pattern": {
          "name": "vendor_pattern",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": true
        },
        "category_id": {
          "name": "category_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "use_count": {
          "name": "use_count",
          "type": "integer",
          "primaryKey": false,
          "notNull": true,
          "default": 1
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "vendor_category_mappings_tenant_id_tenants_id_fk": {
          "name": "vendor_category_mappings_tenant_id_tenants_id_fk",
          "tableFrom": "vendor_category_mappings",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "vendor_category_mappings_category_id_categories_id_fk": {
          "name": "vendor_category_mappings_category_id_categories_id_fk",
          "tableFrom": "vendor_category_mappings",
          "tableTo": "categories",
          "columnsFrom": [
            "category_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    }
  },
  "enums": {},
  "schemas": {},
  "sequences": {},
  "roles": {},
  "policies": {},
  "views": {},
  "_meta": {
    "columns": {},
    "schemas": {},
    "tables": {}
  }
}

--- FILE: ./drizzle/meta/0002_snapshot.json ---

{
  "id": "f61454a2-0778-4368-bca1-06af41476a2d",
  "prevId": "b1739a43-120b-461b-8c48-9b7efd324a31",
  "version": "7",
  "dialect": "postgresql",
  "tables": {
    "public.accountant_invites": {
      "name": "accountant_invites",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "email": {
          "name": "email",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": true
        },
        "invite_token": {
          "name": "invite_token",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": true
        },
        "status": {
          "name": "status",
          "type": "varchar(20)",
          "primaryKey": false,
          "notNull": true,
          "default": "'pending'"
        },
        "expires_at": {
          "name": "expires_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true
        },
        "accepted_by_user_id": {
          "name": "accepted_by_user_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "accepted_at": {
          "name": "accepted_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": false
        },
        "invited_by": {
          "name": "invited_by",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "accountant_invites_tenant_id_tenants_id_fk": {
          "name": "accountant_invites_tenant_id_tenants_id_fk",
          "tableFrom": "accountant_invites",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "accountant_invites_accepted_by_user_id_users_id_fk": {
          "name": "accountant_invites_accepted_by_user_id_users_id_fk",
          "tableFrom": "accountant_invites",
          "tableTo": "users",
          "columnsFrom": [
            "accepted_by_user_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "accountant_invites_invited_by_users_id_fk": {
          "name": "accountant_invites_invited_by_users_id_fk",
          "tableFrom": "accountant_invites",
          "tableTo": "users",
          "columnsFrom": [
            "invited_by"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {
        "accountant_invites_invite_token_unique": {
          "name": "accountant_invites_invite_token_unique",
          "nullsNotDistinct": false,
          "columns": [
            "invite_token"
          ]
        }
      },
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.categories": {
      "name": "categories",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "name": {
          "name": "name",
          "type": "varchar(100)",
          "primaryKey": false,
          "notNull": true
        },
        "emoji": {
          "name": "emoji",
          "type": "varchar(10)",
          "primaryKey": false,
          "notNull": false,
          "default": "'📁'"
        },
        "sort_order": {
          "name": "sort_order",
          "type": "integer",
          "primaryKey": false,
          "notNull": false,
          "default": 0
        },
        "is_active": {
          "name": "is_active",
          "type": "boolean",
          "primaryKey": false,
          "notNull": true,
          "default": true
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "categories_tenant_id_tenants_id_fk": {
          "name": "categories_tenant_id_tenants_id_fk",
          "tableFrom": "categories",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.expense_history": {
      "name": "expense_history",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "expense_id": {
          "name": "expense_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "action": {
          "name": "action",
          "type": "varchar(20)",
          "primaryKey": false,
          "notNull": true
        },
        "previous_values": {
          "name": "previous_values",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "new_values": {
          "name": "new_values",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "changed_by": {
          "name": "changed_by",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "changed_at": {
          "name": "changed_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "expense_history_expense_id_expenses_id_fk": {
          "name": "expense_history_expense_id_expenses_id_fk",
          "tableFrom": "expense_history",
          "tableTo": "expenses",
          "columnsFrom": [
            "expense_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "expense_history_tenant_id_tenants_id_fk": {
          "name": "expense_history_tenant_id_tenants_id_fk",
          "tableFrom": "expense_history",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "expense_history_changed_by_users_id_fk": {
          "name": "expense_history_changed_by_users_id_fk",
          "tableFrom": "expense_history",
          "tableTo": "users",
          "columnsFrom": [
            "changed_by"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.expense_policies": {
      "name": "expense_policies",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "user_id": {
          "name": "user_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "max_expense_amount": {
          "name": "max_expense_amount",
          "type": "integer",
          "primaryKey": false,
          "notNull": false
        },
        "require_notes_above": {
          "name": "require_notes_above",
          "type": "integer",
          "primaryKey": false,
          "notNull": false
        },
        "allowed_categories": {
          "name": "allowed_categories",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "created_by": {
          "name": "created_by",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "expense_policies_tenant_id_tenants_id_fk": {
          "name": "expense_policies_tenant_id_tenants_id_fk",
          "tableFrom": "expense_policies",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "expense_policies_user_id_users_id_fk": {
          "name": "expense_policies_user_id_users_id_fk",
          "tableFrom": "expense_policies",
          "tableTo": "users",
          "columnsFrom": [
            "user_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "expense_policies_created_by_users_id_fk": {
          "name": "expense_policies_created_by_users_id_fk",
          "tableFrom": "expense_policies",
          "tableTo": "users",
          "columnsFrom": [
            "created_by"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.expenses": {
      "name": "expenses",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "amount": {
          "name": "amount",
          "type": "integer",
          "primaryKey": false,
          "notNull": true
        },
        "vendor": {
          "name": "vendor",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": false
        },
        "description": {
          "name": "description",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "date": {
          "name": "date",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true
        },
        "category_id": {
          "name": "category_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "expense_type": {
          "name": "expense_type",
          "type": "varchar(50)",
          "primaryKey": false,
          "notNull": true,
          "default": "'operating'"
        },
        "home_office_percent": {
          "name": "home_office_percent",
          "type": "integer",
          "primaryKey": false,
          "notNull": false
        },
        "receipt_url": {
          "name": "receipt_url",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "extracted_text": {
          "name": "extracted_text",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "recurring_expense_id": {
          "name": "recurring_expense_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "created_by": {
          "name": "created_by",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_by": {
          "name": "updated_by",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "expenses_tenant_id_tenants_id_fk": {
          "name": "expenses_tenant_id_tenants_id_fk",
          "tableFrom": "expenses",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "expenses_category_id_categories_id_fk": {
          "name": "expenses_category_id_categories_id_fk",
          "tableFrom": "expenses",
          "tableTo": "categories",
          "columnsFrom": [
            "category_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "expenses_created_by_users_id_fk": {
          "name": "expenses_created_by_users_id_fk",
          "tableFrom": "expenses",
          "tableTo": "users",
          "columnsFrom": [
            "created_by"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "expenses_updated_by_users_id_fk": {
          "name": "expenses_updated_by_users_id_fk",
          "tableFrom": "expenses",
          "tableTo": "users",
          "columnsFrom": [
            "updated_by"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.mileage_trips": {
      "name": "mileage_trips",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "date": {
          "name": "date",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true
        },
        "description": {
          "name": "description",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": false
        },
        "start_location": {
          "name": "start_location",
          "type": "varchar(500)",
          "primaryKey": false,
          "notNull": true
        },
        "end_location": {
          "name": "end_location",
          "type": "varchar(500)",
          "primaryKey": false,
          "notNull": true
        },
        "distance_miles": {
          "name": "distance_miles",
          "type": "integer",
          "primaryKey": false,
          "notNull": true
        },
        "is_round_trip": {
          "name": "is_round_trip",
          "type": "boolean",
          "primaryKey": false,
          "notNull": true,
          "default": false
        },
        "created_by": {
          "name": "created_by",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_by": {
          "name": "updated_by",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "mileage_trips_tenant_id_tenants_id_fk": {
          "name": "mileage_trips_tenant_id_tenants_id_fk",
          "tableFrom": "mileage_trips",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "mileage_trips_created_by_users_id_fk": {
          "name": "mileage_trips_created_by_users_id_fk",
          "tableFrom": "mileage_trips",
          "tableTo": "users",
          "columnsFrom": [
            "created_by"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "mileage_trips_updated_by_users_id_fk": {
          "name": "mileage_trips_updated_by_users_id_fk",
          "tableFrom": "mileage_trips",
          "tableTo": "users",
          "columnsFrom": [
            "updated_by"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.recurring_expenses": {
      "name": "recurring_expenses",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "amount": {
          "name": "amount",
          "type": "integer",
          "primaryKey": false,
          "notNull": true
        },
        "vendor": {
          "name": "vendor",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": false
        },
        "description": {
          "name": "description",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "category_id": {
          "name": "category_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "expense_type": {
          "name": "expense_type",
          "type": "varchar(50)",
          "primaryKey": false,
          "notNull": true,
          "default": "'operating'"
        },
        "frequency": {
          "name": "frequency",
          "type": "varchar(20)",
          "primaryKey": false,
          "notNull": true,
          "default": "'monthly'"
        },
        "day_of_month": {
          "name": "day_of_month",
          "type": "integer",
          "primaryKey": false,
          "notNull": false,
          "default": 1
        },
        "last_generated_at": {
          "name": "last_generated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": false
        },
        "next_generation_at": {
          "name": "next_generation_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": false
        },
        "is_active": {
          "name": "is_active",
          "type": "boolean",
          "primaryKey": false,
          "notNull": true,
          "default": true
        },
        "created_by": {
          "name": "created_by",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "recurring_expenses_tenant_id_tenants_id_fk": {
          "name": "recurring_expenses_tenant_id_tenants_id_fk",
          "tableFrom": "recurring_expenses",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "recurring_expenses_category_id_categories_id_fk": {
          "name": "recurring_expenses_category_id_categories_id_fk",
          "tableFrom": "recurring_expenses",
          "tableTo": "categories",
          "columnsFrom": [
            "category_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "recurring_expenses_created_by_users_id_fk": {
          "name": "recurring_expenses_created_by_users_id_fk",
          "tableFrom": "recurring_expenses",
          "tableTo": "users",
          "columnsFrom": [
            "created_by"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.saved_locations": {
      "name": "saved_locations",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "name": {
          "name": "name",
          "type": "varchar(100)",
          "primaryKey": false,
          "notNull": true
        },
        "address": {
          "name": "address",
          "type": "varchar(500)",
          "primaryKey": false,
          "notNull": true
        },
        "sort_order": {
          "name": "sort_order",
          "type": "integer",
          "primaryKey": false,
          "notNull": false,
          "default": 0
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "saved_locations_tenant_id_tenants_id_fk": {
          "name": "saved_locations_tenant_id_tenants_id_fk",
          "tableFrom": "saved_locations",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.sessions": {
      "name": "sessions",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "user_id": {
          "name": "user_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "token": {
          "name": "token",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": true
        },
        "expires_at": {
          "name": "expires_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true
        },
        "user_agent": {
          "name": "user_agent",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "ip_address": {
          "name": "ip_address",
          "type": "varchar(45)",
          "primaryKey": false,
          "notNull": false
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "sessions_user_id_users_id_fk": {
          "name": "sessions_user_id_users_id_fk",
          "tableFrom": "sessions",
          "tableTo": "users",
          "columnsFrom": [
            "user_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "sessions_tenant_id_tenants_id_fk": {
          "name": "sessions_tenant_id_tenants_id_fk",
          "tableFrom": "sessions",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {
        "sessions_token_unique": {
          "name": "sessions_token_unique",
          "nullsNotDistinct": false,
          "columns": [
            "token"
          ]
        }
      },
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.tenants": {
      "name": "tenants",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "name": {
          "name": "name",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": true
        },
        "subdomain": {
          "name": "subdomain",
          "type": "varchar(63)",
          "primaryKey": false,
          "notNull": true
        },
        "logo_url": {
          "name": "logo_url",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "primary_color": {
          "name": "primary_color",
          "type": "varchar(7)",
          "primaryKey": false,
          "notNull": false,
          "default": "'#2A9D8F'"
        },
        "app_name": {
          "name": "app_name",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": false
        },
        "custom_domain": {
          "name": "custom_domain",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": false
        },
        "is_active": {
          "name": "is_active",
          "type": "boolean",
          "primaryKey": false,
          "notNull": true,
          "default": true
        },
        "created_by": {
          "name": "created_by",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {},
      "compositePrimaryKeys": {},
      "uniqueConstraints": {
        "tenants_subdomain_unique": {
          "name": "tenants_subdomain_unique",
          "nullsNotDistinct": false,
          "columns": [
            "subdomain"
          ]
        }
      },
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.user_tenant_access": {
      "name": "user_tenant_access",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "user_id": {
          "name": "user_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "role": {
          "name": "role",
          "type": "varchar(50)",
          "primaryKey": false,
          "notNull": true
        },
        "can_edit": {
          "name": "can_edit",
          "type": "boolean",
          "primaryKey": false,
          "notNull": true,
          "default": false
        },
        "invited_by": {
          "name": "invited_by",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "user_tenant_access_user_id_users_id_fk": {
          "name": "user_tenant_access_user_id_users_id_fk",
          "tableFrom": "user_tenant_access",
          "tableTo": "users",
          "columnsFrom": [
            "user_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "cascade",
          "onUpdate": "no action"
        },
        "user_tenant_access_tenant_id_tenants_id_fk": {
          "name": "user_tenant_access_tenant_id_tenants_id_fk",
          "tableFrom": "user_tenant_access",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "cascade",
          "onUpdate": "no action"
        },
        "user_tenant_access_invited_by_users_id_fk": {
          "name": "user_tenant_access_invited_by_users_id_fk",
          "tableFrom": "user_tenant_access",
          "tableTo": "users",
          "columnsFrom": [
            "invited_by"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {
        "user_tenant_unique": {
          "name": "user_tenant_unique",
          "nullsNotDistinct": false,
          "columns": [
            "user_id",
            "tenant_id"
          ]
        }
      },
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.users": {
      "name": "users",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "email": {
          "name": "email",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": true
        },
        "password_hash": {
          "name": "password_hash",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": false
        },
        "email_verified": {
          "name": "email_verified",
          "type": "boolean",
          "primaryKey": false,
          "notNull": true,
          "default": false
        },
        "google_id": {
          "name": "google_id",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": false
        },
        "apple_id": {
          "name": "apple_id",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": false
        },
        "first_name": {
          "name": "first_name",
          "type": "varchar(100)",
          "primaryKey": false,
          "notNull": false
        },
        "last_name": {
          "name": "last_name",
          "type": "varchar(100)",
          "primaryKey": false,
          "notNull": false
        },
        "role": {
          "name": "role",
          "type": "varchar(50)",
          "primaryKey": false,
          "notNull": true,
          "default": "'viewer'"
        },
        "is_super_admin": {
          "name": "is_super_admin",
          "type": "boolean",
          "primaryKey": false,
          "notNull": true,
          "default": false
        },
        "is_accountant": {
          "name": "is_accountant",
          "type": "boolean",
          "primaryKey": false,
          "notNull": true,
          "default": false
        },
        "theme": {
          "name": "theme",
          "type": "varchar(50)",
          "primaryKey": false,
          "notNull": false,
          "default": "'teal-tide'"
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "last_login_at": {
          "name": "last_login_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": false
        }
      },
      "indexes": {},
      "foreignKeys": {
        "users_tenant_id_tenants_id_fk": {
          "name": "users_tenant_id_tenants_id_fk",
          "tableFrom": "users",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.vendor_category_mappings": {
      "name": "vendor_category_mappings",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "vendor_pattern": {
          "name": "vendor_pattern",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": true
        },
        "category_id": {
          "name": "category_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "use_count": {
          "name": "use_count",
          "type": "integer",
          "primaryKey": false,
          "notNull": true,
          "default": 1
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "vendor_category_mappings_tenant_id_tenants_id_fk": {
          "name": "vendor_category_mappings_tenant_id_tenants_id_fk",
          "tableFrom": "vendor_category_mappings",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "vendor_category_mappings_category_id_categories_id_fk": {
          "name": "vendor_category_mappings_category_id_categories_id_fk",
          "tableFrom": "vendor_category_mappings",
          "tableTo": "categories",
          "columnsFrom": [
            "category_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    }
  },
  "enums": {},
  "schemas": {},
  "sequences": {},
  "roles": {},
  "policies": {},
  "views": {},
  "_meta": {
    "columns": {},
    "schemas": {},
    "tables": {}
  }
}

--- FILE: ./drizzle/meta/_journal.json ---

{
  "version": "7",
  "dialect": "postgresql",
  "entries": [
    {
      "idx": 0,
      "version": "7",
      "when": 1767622200722,
      "tag": "0000_rainy_black_tarantula",
      "breakpoints": true
    },
    {
      "idx": 1,
      "version": "7",
      "when": 1767627802614,
      "tag": "0001_sparkling_pride",
      "breakpoints": true
    },
    {
      "idx": 2,
      "version": "7",
      "when": 1767756387333,
      "tag": "0002_wise_krista_starr",
      "breakpoints": true
    },
    {
      "idx": 3,
      "version": "7",
      "when": 1771359838475,
      "tag": "0003_workable_terrax",
      "breakpoints": true
    }
  ]
}

--- FILE: ./drizzle/meta/0001_snapshot.json ---

{
  "id": "b1739a43-120b-461b-8c48-9b7efd324a31",
  "prevId": "4556c68c-8a10-426f-a110-1d0e4f903d65",
  "version": "7",
  "dialect": "postgresql",
  "tables": {
    "public.accountant_invites": {
      "name": "accountant_invites",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "email": {
          "name": "email",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": true
        },
        "invite_token": {
          "name": "invite_token",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": true
        },
        "status": {
          "name": "status",
          "type": "varchar(20)",
          "primaryKey": false,
          "notNull": true,
          "default": "'pending'"
        },
        "expires_at": {
          "name": "expires_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true
        },
        "accepted_by_user_id": {
          "name": "accepted_by_user_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "accepted_at": {
          "name": "accepted_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": false
        },
        "invited_by": {
          "name": "invited_by",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "accountant_invites_tenant_id_tenants_id_fk": {
          "name": "accountant_invites_tenant_id_tenants_id_fk",
          "tableFrom": "accountant_invites",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "accountant_invites_accepted_by_user_id_users_id_fk": {
          "name": "accountant_invites_accepted_by_user_id_users_id_fk",
          "tableFrom": "accountant_invites",
          "tableTo": "users",
          "columnsFrom": [
            "accepted_by_user_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "accountant_invites_invited_by_users_id_fk": {
          "name": "accountant_invites_invited_by_users_id_fk",
          "tableFrom": "accountant_invites",
          "tableTo": "users",
          "columnsFrom": [
            "invited_by"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {
        "accountant_invites_invite_token_unique": {
          "name": "accountant_invites_invite_token_unique",
          "nullsNotDistinct": false,
          "columns": [
            "invite_token"
          ]
        }
      },
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.categories": {
      "name": "categories",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "name": {
          "name": "name",
          "type": "varchar(100)",
          "primaryKey": false,
          "notNull": true
        },
        "emoji": {
          "name": "emoji",
          "type": "varchar(10)",
          "primaryKey": false,
          "notNull": false,
          "default": "'📁'"
        },
        "sort_order": {
          "name": "sort_order",
          "type": "integer",
          "primaryKey": false,
          "notNull": false,
          "default": 0
        },
        "is_active": {
          "name": "is_active",
          "type": "boolean",
          "primaryKey": false,
          "notNull": true,
          "default": true
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "categories_tenant_id_tenants_id_fk": {
          "name": "categories_tenant_id_tenants_id_fk",
          "tableFrom": "categories",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.expense_history": {
      "name": "expense_history",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "expense_id": {
          "name": "expense_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "action": {
          "name": "action",
          "type": "varchar(20)",
          "primaryKey": false,
          "notNull": true
        },
        "previous_values": {
          "name": "previous_values",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "new_values": {
          "name": "new_values",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "changed_by": {
          "name": "changed_by",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "changed_at": {
          "name": "changed_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "expense_history_expense_id_expenses_id_fk": {
          "name": "expense_history_expense_id_expenses_id_fk",
          "tableFrom": "expense_history",
          "tableTo": "expenses",
          "columnsFrom": [
            "expense_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "expense_history_tenant_id_tenants_id_fk": {
          "name": "expense_history_tenant_id_tenants_id_fk",
          "tableFrom": "expense_history",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "expense_history_changed_by_users_id_fk": {
          "name": "expense_history_changed_by_users_id_fk",
          "tableFrom": "expense_history",
          "tableTo": "users",
          "columnsFrom": [
            "changed_by"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.expense_policies": {
      "name": "expense_policies",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "user_id": {
          "name": "user_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "max_expense_amount": {
          "name": "max_expense_amount",
          "type": "integer",
          "primaryKey": false,
          "notNull": false
        },
        "require_notes_above": {
          "name": "require_notes_above",
          "type": "integer",
          "primaryKey": false,
          "notNull": false
        },
        "allowed_categories": {
          "name": "allowed_categories",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "created_by": {
          "name": "created_by",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "expense_policies_tenant_id_tenants_id_fk": {
          "name": "expense_policies_tenant_id_tenants_id_fk",
          "tableFrom": "expense_policies",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "expense_policies_user_id_users_id_fk": {
          "name": "expense_policies_user_id_users_id_fk",
          "tableFrom": "expense_policies",
          "tableTo": "users",
          "columnsFrom": [
            "user_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "expense_policies_created_by_users_id_fk": {
          "name": "expense_policies_created_by_users_id_fk",
          "tableFrom": "expense_policies",
          "tableTo": "users",
          "columnsFrom": [
            "created_by"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.expenses": {
      "name": "expenses",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "amount": {
          "name": "amount",
          "type": "integer",
          "primaryKey": false,
          "notNull": true
        },
        "vendor": {
          "name": "vendor",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": false
        },
        "description": {
          "name": "description",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "date": {
          "name": "date",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true
        },
        "category_id": {
          "name": "category_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "expense_type": {
          "name": "expense_type",
          "type": "varchar(50)",
          "primaryKey": false,
          "notNull": true,
          "default": "'operating'"
        },
        "home_office_percent": {
          "name": "home_office_percent",
          "type": "integer",
          "primaryKey": false,
          "notNull": false
        },
        "receipt_url": {
          "name": "receipt_url",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "extracted_text": {
          "name": "extracted_text",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "recurring_expense_id": {
          "name": "recurring_expense_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "created_by": {
          "name": "created_by",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_by": {
          "name": "updated_by",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "expenses_tenant_id_tenants_id_fk": {
          "name": "expenses_tenant_id_tenants_id_fk",
          "tableFrom": "expenses",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "expenses_category_id_categories_id_fk": {
          "name": "expenses_category_id_categories_id_fk",
          "tableFrom": "expenses",
          "tableTo": "categories",
          "columnsFrom": [
            "category_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "expenses_created_by_users_id_fk": {
          "name": "expenses_created_by_users_id_fk",
          "tableFrom": "expenses",
          "tableTo": "users",
          "columnsFrom": [
            "created_by"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "expenses_updated_by_users_id_fk": {
          "name": "expenses_updated_by_users_id_fk",
          "tableFrom": "expenses",
          "tableTo": "users",
          "columnsFrom": [
            "updated_by"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.mileage_trips": {
      "name": "mileage_trips",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "date": {
          "name": "date",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true
        },
        "description": {
          "name": "description",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": false
        },
        "start_location": {
          "name": "start_location",
          "type": "varchar(500)",
          "primaryKey": false,
          "notNull": true
        },
        "end_location": {
          "name": "end_location",
          "type": "varchar(500)",
          "primaryKey": false,
          "notNull": true
        },
        "distance_miles": {
          "name": "distance_miles",
          "type": "integer",
          "primaryKey": false,
          "notNull": true
        },
        "is_round_trip": {
          "name": "is_round_trip",
          "type": "boolean",
          "primaryKey": false,
          "notNull": true,
          "default": false
        },
        "created_by": {
          "name": "created_by",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_by": {
          "name": "updated_by",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "mileage_trips_tenant_id_tenants_id_fk": {
          "name": "mileage_trips_tenant_id_tenants_id_fk",
          "tableFrom": "mileage_trips",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "mileage_trips_created_by_users_id_fk": {
          "name": "mileage_trips_created_by_users_id_fk",
          "tableFrom": "mileage_trips",
          "tableTo": "users",
          "columnsFrom": [
            "created_by"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "mileage_trips_updated_by_users_id_fk": {
          "name": "mileage_trips_updated_by_users_id_fk",
          "tableFrom": "mileage_trips",
          "tableTo": "users",
          "columnsFrom": [
            "updated_by"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.recurring_expenses": {
      "name": "recurring_expenses",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "amount": {
          "name": "amount",
          "type": "integer",
          "primaryKey": false,
          "notNull": true
        },
        "vendor": {
          "name": "vendor",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": false
        },
        "description": {
          "name": "description",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "category_id": {
          "name": "category_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "expense_type": {
          "name": "expense_type",
          "type": "varchar(50)",
          "primaryKey": false,
          "notNull": true,
          "default": "'operating'"
        },
        "frequency": {
          "name": "frequency",
          "type": "varchar(20)",
          "primaryKey": false,
          "notNull": true,
          "default": "'monthly'"
        },
        "day_of_month": {
          "name": "day_of_month",
          "type": "integer",
          "primaryKey": false,
          "notNull": false,
          "default": 1
        },
        "last_generated_at": {
          "name": "last_generated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": false
        },
        "next_generation_at": {
          "name": "next_generation_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": false
        },
        "is_active": {
          "name": "is_active",
          "type": "boolean",
          "primaryKey": false,
          "notNull": true,
          "default": true
        },
        "created_by": {
          "name": "created_by",
          "type": "uuid",
          "primaryKey": false,
          "notNull": false
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "recurring_expenses_tenant_id_tenants_id_fk": {
          "name": "recurring_expenses_tenant_id_tenants_id_fk",
          "tableFrom": "recurring_expenses",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "recurring_expenses_category_id_categories_id_fk": {
          "name": "recurring_expenses_category_id_categories_id_fk",
          "tableFrom": "recurring_expenses",
          "tableTo": "categories",
          "columnsFrom": [
            "category_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "recurring_expenses_created_by_users_id_fk": {
          "name": "recurring_expenses_created_by_users_id_fk",
          "tableFrom": "recurring_expenses",
          "tableTo": "users",
          "columnsFrom": [
            "created_by"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.saved_locations": {
      "name": "saved_locations",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "name": {
          "name": "name",
          "type": "varchar(100)",
          "primaryKey": false,
          "notNull": true
        },
        "address": {
          "name": "address",
          "type": "varchar(500)",
          "primaryKey": false,
          "notNull": true
        },
        "sort_order": {
          "name": "sort_order",
          "type": "integer",
          "primaryKey": false,
          "notNull": false,
          "default": 0
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "saved_locations_tenant_id_tenants_id_fk": {
          "name": "saved_locations_tenant_id_tenants_id_fk",
          "tableFrom": "saved_locations",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.sessions": {
      "name": "sessions",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "user_id": {
          "name": "user_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "token": {
          "name": "token",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": true
        },
        "expires_at": {
          "name": "expires_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true
        },
        "user_agent": {
          "name": "user_agent",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "ip_address": {
          "name": "ip_address",
          "type": "varchar(45)",
          "primaryKey": false,
          "notNull": false
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "sessions_user_id_users_id_fk": {
          "name": "sessions_user_id_users_id_fk",
          "tableFrom": "sessions",
          "tableTo": "users",
          "columnsFrom": [
            "user_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "sessions_tenant_id_tenants_id_fk": {
          "name": "sessions_tenant_id_tenants_id_fk",
          "tableFrom": "sessions",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {
        "sessions_token_unique": {
          "name": "sessions_token_unique",
          "nullsNotDistinct": false,
          "columns": [
            "token"
          ]
        }
      },
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.tenants": {
      "name": "tenants",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "name": {
          "name": "name",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": true
        },
        "subdomain": {
          "name": "subdomain",
          "type": "varchar(63)",
          "primaryKey": false,
          "notNull": true
        },
        "logo_url": {
          "name": "logo_url",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "primary_color": {
          "name": "primary_color",
          "type": "varchar(7)",
          "primaryKey": false,
          "notNull": false,
          "default": "'#2A9D8F'"
        },
        "app_name": {
          "name": "app_name",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": false
        },
        "is_active": {
          "name": "is_active",
          "type": "boolean",
          "primaryKey": false,
          "notNull": true,
          "default": true
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {},
      "compositePrimaryKeys": {},
      "uniqueConstraints": {
        "tenants_subdomain_unique": {
          "name": "tenants_subdomain_unique",
          "nullsNotDistinct": false,
          "columns": [
            "subdomain"
          ]
        }
      },
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.users": {
      "name": "users",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "email": {
          "name": "email",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": true
        },
        "password_hash": {
          "name": "password_hash",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": true
        },
        "email_verified": {
          "name": "email_verified",
          "type": "boolean",
          "primaryKey": false,
          "notNull": true,
          "default": false
        },
        "first_name": {
          "name": "first_name",
          "type": "varchar(100)",
          "primaryKey": false,
          "notNull": false
        },
        "last_name": {
          "name": "last_name",
          "type": "varchar(100)",
          "primaryKey": false,
          "notNull": false
        },
        "role": {
          "name": "role",
          "type": "varchar(50)",
          "primaryKey": false,
          "notNull": true,
          "default": "'viewer'"
        },
        "theme": {
          "name": "theme",
          "type": "varchar(50)",
          "primaryKey": false,
          "notNull": false,
          "default": "'teal-tide'"
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "last_login_at": {
          "name": "last_login_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": false
        }
      },
      "indexes": {},
      "foreignKeys": {
        "users_tenant_id_tenants_id_fk": {
          "name": "users_tenant_id_tenants_id_fk",
          "tableFrom": "users",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.vendor_category_mappings": {
      "name": "vendor_category_mappings",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "vendor_pattern": {
          "name": "vendor_pattern",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": true
        },
        "category_id": {
          "name": "category_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "use_count": {
          "name": "use_count",
          "type": "integer",
          "primaryKey": false,
          "notNull": true,
          "default": 1
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {
        "vendor_category_mappings_tenant_id_tenants_id_fk": {
          "name": "vendor_category_mappings_tenant_id_tenants_id_fk",
          "tableFrom": "vendor_category_mappings",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        },
        "vendor_category_mappings_category_id_categories_id_fk": {
          "name": "vendor_category_mappings_category_id_categories_id_fk",
          "tableFrom": "vendor_category_mappings",
          "tableTo": "categories",
          "columnsFrom": [
            "category_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    }
  },
  "enums": {},
  "schemas": {},
  "sequences": {},
  "roles": {},
  "policies": {},
  "views": {},
  "_meta": {
    "columns": {},
    "schemas": {},
    "tables": {}
  }
}

--- FILE: ./drizzle/meta/0000_snapshot.json ---

{
  "id": "4556c68c-8a10-426f-a110-1d0e4f903d65",
  "prevId": "00000000-0000-0000-0000-000000000000",
  "version": "7",
  "dialect": "postgresql",
  "tables": {
    "public.tenants": {
      "name": "tenants",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "name": {
          "name": "name",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": true
        },
        "subdomain": {
          "name": "subdomain",
          "type": "varchar(63)",
          "primaryKey": false,
          "notNull": true
        },
        "logo_url": {
          "name": "logo_url",
          "type": "text",
          "primaryKey": false,
          "notNull": false
        },
        "primary_color": {
          "name": "primary_color",
          "type": "varchar(7)",
          "primaryKey": false,
          "notNull": false,
          "default": "'#2A9D8F'"
        },
        "app_name": {
          "name": "app_name",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": false
        },
        "is_active": {
          "name": "is_active",
          "type": "boolean",
          "primaryKey": false,
          "notNull": true,
          "default": true
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        }
      },
      "indexes": {},
      "foreignKeys": {},
      "compositePrimaryKeys": {},
      "uniqueConstraints": {
        "tenants_subdomain_unique": {
          "name": "tenants_subdomain_unique",
          "nullsNotDistinct": false,
          "columns": [
            "subdomain"
          ]
        }
      },
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    },
    "public.users": {
      "name": "users",
      "schema": "",
      "columns": {
        "id": {
          "name": "id",
          "type": "uuid",
          "primaryKey": true,
          "notNull": true,
          "default": "gen_random_uuid()"
        },
        "tenant_id": {
          "name": "tenant_id",
          "type": "uuid",
          "primaryKey": false,
          "notNull": true
        },
        "email": {
          "name": "email",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": true
        },
        "password_hash": {
          "name": "password_hash",
          "type": "varchar(255)",
          "primaryKey": false,
          "notNull": true
        },
        "email_verified": {
          "name": "email_verified",
          "type": "boolean",
          "primaryKey": false,
          "notNull": true,
          "default": false
        },
        "first_name": {
          "name": "first_name",
          "type": "varchar(100)",
          "primaryKey": false,
          "notNull": false
        },
        "last_name": {
          "name": "last_name",
          "type": "varchar(100)",
          "primaryKey": false,
          "notNull": false
        },
        "role": {
          "name": "role",
          "type": "varchar(50)",
          "primaryKey": false,
          "notNull": true,
          "default": "'viewer'"
        },
        "theme": {
          "name": "theme",
          "type": "varchar(50)",
          "primaryKey": false,
          "notNull": false,
          "default": "'teal-tide'"
        },
        "created_at": {
          "name": "created_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "updated_at": {
          "name": "updated_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": true,
          "default": "now()"
        },
        "last_login_at": {
          "name": "last_login_at",
          "type": "timestamp",
          "primaryKey": false,
          "notNull": false
        }
      },
      "indexes": {},
      "foreignKeys": {
        "users_tenant_id_tenants_id_fk": {
          "name": "users_tenant_id_tenants_id_fk",
          "tableFrom": "users",
          "tableTo": "tenants",
          "columnsFrom": [
            "tenant_id"
          ],
          "columnsTo": [
            "id"
          ],
          "onDelete": "no action",
          "onUpdate": "no action"
        }
      },
      "compositePrimaryKeys": {},
      "uniqueConstraints": {},
      "policies": {},
      "checkConstraints": {},
      "isRLSEnabled": false
    }
  },
  "enums": {},
  "schemas": {},
  "sequences": {},
  "roles": {},
  "policies": {},
  "views": {},
  "_meta": {
    "columns": {},
    "schemas": {},
    "tables": {}
  }
}

--- FILE: ./README.md ---

# React + TypeScript + Vite

This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.

Currently, two official plugins are available:

- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react) uses [Babel](https://babeljs.io/) (or [oxc](https://oxc.rs) when used in [rolldown-vite](https://vite.dev/guide/rolldown)) for Fast Refresh
- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh

## React Compiler

The React Compiler is not enabled on this template because of its impact on dev & build performances. To add it, see [this documentation](https://react.dev/learn/react-compiler/installation).

## Expanding the ESLint configuration

If you are developing a production application, we recommend updating the configuration to enable type-aware lint rules:

```js
export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      // Other configs...

      // Remove tseslint.configs.recommended and replace with this
      tseslint.configs.recommendedTypeChecked,
      // Alternatively, use this for stricter rules
      tseslint.configs.strictTypeChecked,
      // Optionally, add this for stylistic rules
      tseslint.configs.stylisticTypeChecked,

      // Other configs...
    ],
    languageOptions: {
      parserOptions: {
        project: ['./tsconfig.node.json', './tsconfig.app.json'],
        tsconfigRootDir: import.meta.dirname,
      },
      // other options...
    },
  },
])
```

You can also install [eslint-plugin-react-x](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-x) and [eslint-plugin-react-dom](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-dom) for React-specific lint rules:

```js
// eslint.config.js
import reactX from 'eslint-plugin-react-x'
import reactDom from 'eslint-plugin-react-dom'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      // Other configs...
      // Enable lint rules for React
      reactX.configs['recommended-typescript'],
      // Enable lint rules for React DOM
      reactDom.configs.recommended,
    ],
    languageOptions: {
      parserOptions: {
        project: ['./tsconfig.node.json', './tsconfig.app.json'],
        tsconfigRootDir: import.meta.dirname,
      },
      // other options...
    },
  },
])
```


--- FILE: ./tsconfig.app.json ---

{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "target": "ES2022",
    "useDefineForClassFields": true,
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "types": ["vite/client", "google.maps"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["src"]
}
